<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>2.1.reedis-服务启动 | Hexo</title>
  <meta name="description" content="初始化服务器从启动 Redis 服务器， 到服务器可以接受外来客户端的网络连接这段时间， Redis 需要执行一系列初始化操作。  整个初始化过程可以分为以下步骤：  12345678910111213初始化服务器全局状态初始化redismodulesentinel模块载入【配置为sentinel时】载入配置文件创建 daemon 进程。初始化服务器功能模块。集群初始化        &#x2F;&#x2F;clus">
<meta property="og:type" content="article">
<meta property="og:title" content="2.1.reedis-服务启动">
<meta property="og:url" content="https://wuhaocn.github.io/2022/04/07/data/redis/code/2.1.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/index.html">
<meta property="og:site_name" content="wuhaocn">
<meta property="og:description" content="初始化服务器从启动 Redis 服务器， 到服务器可以接受外来客户端的网络连接这段时间， Redis 需要执行一系列初始化操作。  整个初始化过程可以分为以下步骤：  12345678910111213初始化服务器全局状态初始化redismodulesentinel模块载入【配置为sentinel时】载入配置文件创建 daemon 进程。初始化服务器功能模块。集群初始化        &#x2F;&#x2F;clus">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-07T01:21:38.758Z">
<meta property="article:modified_time" content="2022-04-07T01:21:38.759Z">
<meta property="article:author" content="wuhao">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://wuhaocn.github.io/2022/04/07/data/redis/code/2.1.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/index.html">
  
    <link rel="alternate" href="/atom.xml" title="wuhaocn" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 6.1.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/wuhaocn" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">wuhaocn</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Java &amp; 后端 &amp; 通信</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> BeiJing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wuhaocn" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/5G/">5G</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%9F%AD%E4%BF%A1/">短信</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-shell/">编程语言 - shell</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/5G/" rel="tag">5G</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/" rel="tag">AOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MEC/" rel="tag">MEC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NGAP/" rel="tag">NGAP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai/" rel="tag">ai</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/akka/" rel="tag">akka</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/atomic/" rel="tag">atomic</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/brew/" rel="tag">brew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cmpp/" rel="tag">cmpp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/" rel="tag">design</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ftp/" rel="tag">ftp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grafana/" rel="tag">grafana</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log4j/" rel="tag">log4j</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/" rel="tag">prometheus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/" rel="tag">sort</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF/" rel="tag">动态调试技术</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E8%8A%82%E7%A0%81/" rel="tag">字节码</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E5%88%87%E7%89%87/" rel="tag">网络切片</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/5G/" style="font-size: 13.29px;">5G</a> <a href="/tags/AOP/" style="font-size: 13px;">AOP</a> <a href="/tags/DPDK/" style="font-size: 13.14px;">DPDK</a> <a href="/tags/JVM/" style="font-size: 13.57px;">JVM</a> <a href="/tags/MEC/" style="font-size: 13px;">MEC</a> <a href="/tags/NGAP/" style="font-size: 13px;">NGAP</a> <a href="/tags/ai/" style="font-size: 13px;">ai</a> <a href="/tags/akka/" style="font-size: 13.86px;">akka</a> <a href="/tags/atomic/" style="font-size: 13.29px;">atomic</a> <a href="/tags/brew/" style="font-size: 13px;">brew</a> <a href="/tags/cmpp/" style="font-size: 13px;">cmpp</a> <a href="/tags/design/" style="font-size: 13px;">design</a> <a href="/tags/docker/" style="font-size: 13.43px;">docker</a> <a href="/tags/ftp/" style="font-size: 13px;">ftp</a> <a href="/tags/grafana/" style="font-size: 13px;">grafana</a> <a href="/tags/java/" style="font-size: 13px;">java</a> <a href="/tags/jenkins/" style="font-size: 13px;">jenkins</a> <a href="/tags/log4j/" style="font-size: 13px;">log4j</a> <a href="/tags/nexus/" style="font-size: 13px;">nexus</a> <a href="/tags/prometheus/" style="font-size: 13px;">prometheus</a> <a href="/tags/redis/" style="font-size: 14px;">redis</a> <a href="/tags/sort/" style="font-size: 13.71px;">sort</a> <a href="/tags/%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF/" style="font-size: 13px;">动态调试技术</a> <a href="/tags/%E5%AD%97%E8%8A%82%E7%A0%81/" style="font-size: 13.29px;">字节码</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%88%87%E7%89%87/" style="font-size: 13px;">网络切片</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">24</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">23</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">24</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/04/07/platform/framework/" class="title">云平台建设草稿</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-07T01:21:38.762Z" itemprop="datePublished">2022-04-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/redis/">redis</a>
              </p>
              <p class="item-title">
                <a href="/2022/04/07/data/redis/command/cluster%E8%B0%83%E7%94%A8%E9%93%BE/" class="title">redis-cluster调用链</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-07T01:21:38.761Z" itemprop="datePublished">2022-04-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/redis/">redis</a>
              </p>
              <p class="item-title">
                <a href="/2022/04/07/data/redis/command/expire%E8%B0%83%E7%94%A8%E9%93%BE/" class="title">redis-expire调用链</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-07T01:21:38.761Z" itemprop="datePublished">2022-04-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/redis/">redis</a>
              </p>
              <p class="item-title">
                <a href="/2022/04/07/data/redis/command/set%E8%B0%83%E7%94%A8%E9%93%BE/" class="title">redis-set调用链</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-07T01:21:38.761Z" itemprop="datePublished">2022-04-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/redis/">redis</a>
              </p>
              <p class="item-title">
                <a href="/2022/04/07/data/redis/code/2.3.%E5%86%99%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E6%A6%82%E8%BF%B0/" class="title">2.3.redis-写数据流程概述</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-07T01:21:38.760Z" itemprop="datePublished">2022-04-07</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<meta name="referrer" content="no-referrer" />
<main class="main" role="main">
  <div class="content">
  <article id="post-data/redis/code/2.1.服务启动" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      2.1.reedis-服务启动
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/04/07/data/redis/code/2.1.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/" class="article-date">
	  <time datetime="2022-04-07T01:21:38.758Z" itemprop="datePublished">2022-04-07</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/redis/">redis</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/redis/" rel="tag">redis</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/04/07/data/redis/code/2.1.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="初始化服务器"><a href="#初始化服务器" class="headerlink" title="初始化服务器"></a>初始化服务器</h2><p>从启动 Redis 服务器， 到服务器可以接受外来客户端的网络连接这段时间， Redis 需要执行一系列初始化操作。</p>
<ul>
<li>整个初始化过程可以分为以下步骤：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">初始化服务器全局状态</span><br><span class="line">初始化redismodule</span><br><span class="line">sentinel模块载入【配置为sentinel时】</span><br><span class="line">载入配置文件</span><br><span class="line">创建 daemon 进程。</span><br><span class="line">初始化服务器功能模块。</span><br><span class="line">集群初始化        //clusterInit();</span><br><span class="line">初始化复制        //replicationScriptCacheInit();</span><br><span class="line">脚本初始化        //scriptingInit(1);</span><br><span class="line">慢查询日志初始化   //slowlogInit();</span><br><span class="line">初始化监控        //latencyMonitorInit();</span><br><span class="line">载入数据。</span><br><span class="line">开始事件循环。</span><br></pre></td></tr></table></figure>

<p>以下各个小节将介绍 Redis 服务器初始化的各个步骤。</p>
<h3 id="1-初始化服务器全局状态"><a href="#1-初始化服务器全局状态" class="headerlink" title="1.初始化服务器全局状态"></a>1.初始化服务器全局状态</h3><p>redis.h/redisServer 结构记录了和服务器相关的所有数据， 这个结构主要包含以下信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">服务器中的所有数据库。</span><br><span class="line">命令表：在执行命令时，根据字符来查找相应命令的实现函数。</span><br><span class="line">事件状态。</span><br><span class="line">服务器的网络连接信息：套接字地址、端口，以及套接字描述符。</span><br><span class="line">所有已连接客户端的信息。</span><br><span class="line">日志（log）和慢查询日志（slowlog）的选项和相关信息。</span><br><span class="line">服务器配置选项：比如要创建多少个数据库，是否将服务器进程作为 daemon 进程来运行，</span><br><span class="line">             最大连接多少个客户端，压缩结构（zip structure）的实体数量，等等。</span><br><span class="line">统计信息：比如键有多少次命令、不命中，服务器的运行时间，内存占用，等等。</span><br><span class="line">数据持久化（AOF 和 RDB）的配置和状态。</span><br><span class="line">－ slave信息</span><br><span class="line">－ master信息</span><br><span class="line">实现订阅与发布（pub/sub）功能所需的数据结构。</span><br><span class="line">－ 是否运行集群及相关选项。</span><br><span class="line">Lua 脚本的运行环境及相关选项。</span><br><span class="line">－ 调试信息选项</span><br></pre></td></tr></table></figure>

<p>详情请参考 server.h 文件,部分内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line">/*server对象*/</span><br><span class="line"></span><br><span class="line">struct redisServer &#123;</span><br><span class="line">/* General */</span><br><span class="line">        //配置文件路径</span><br><span class="line">        char *configfile;           /* Absolute config file path, or NULL */</span><br><span class="line">        //serverCron()调用频率</span><br><span class="line">        int hz;                     /* serverCron() calls frequency in hertz */</span><br><span class="line">        //数据库对象</span><br><span class="line">        redisDb *db;</span><br><span class="line">        //支持的命令列表</span><br><span class="line">        dict *commands;             /* Command table */</span><br><span class="line">        //没有转化的命令</span><br><span class="line">        dict *orig_commands;        /* Command table before command renaming. */</span><br><span class="line">        //事件</span><br><span class="line">        aeEventLoop *el;</span><br><span class="line">        //每分钟增加一次</span><br><span class="line">        unsigned lruclock:22;       /* Clock incrementing every minute, for LRU */</span><br><span class="line">        unsigned lruclock_padding:10;</span><br><span class="line">        int shutdown_asap;          /* SHUTDOWN needed ASAP */</span><br><span class="line">        int activerehashing;        /* Incremental rehash in serverCron() */</span><br><span class="line">        </span><br><span class="line">        //验证密码</span><br><span class="line">        char *requirepass;          /* Pass for AUTH command, or NULL */</span><br><span class="line">        char *pidfile;              /* PID file path */</span><br><span class="line">        int arch_bits;              /* 32 or 64 depending on sizeof(long) */</span><br><span class="line">        int cronloops;              /* Number of times the cron function run */</span><br><span class="line">        char runid[REDIS_RUN_ID_SIZE+1];  /* ID always different at every exec. */</span><br><span class="line">        int sentinel_mode;          /* True if this instance is a Sentinel. */</span><br><span class="line">        </span><br><span class="line">        /* Networking */</span><br><span class="line">        int port;                   /* TCP listening port */</span><br><span class="line">        int tcp_backlog;            /* TCP listen() backlog */</span><br><span class="line">        char *bindaddr[REDIS_BINDADDR_MAX]; /* Addresses we should bind to */</span><br><span class="line">        int bindaddr_count;         /* Number of addresses in server.bindaddr[] */</span><br><span class="line">        char *unixsocket;           /* UNIX socket path */</span><br><span class="line">        mode_t unixsocketperm;      /* UNIX socket permission */</span><br><span class="line">        int ipfd[REDIS_BINDADDR_MAX]; /* TCP socket file descriptors */</span><br><span class="line">        int ipfd_count;             /* Used slots in ipfd[] */</span><br><span class="line">        int sofd;                   /* Unix socket file descriptor */</span><br><span class="line">        int cfd[REDIS_BINDADDR_MAX];/* Cluster bus listening socket */</span><br><span class="line">        int cfd_count;              /* Used slots in cfd[] */</span><br><span class="line">        </span><br><span class="line">        //连接客户端</span><br><span class="line">        list *clients;              /* List of active clients */</span><br><span class="line">        list *clients_to_close;     /* Clients to close asynchronously */</span><br><span class="line">        list *slaves, *monitors;    /* List of slaves and MONITORs */</span><br><span class="line">        redisClient *current_client; /* Current client, only used on crash report */</span><br><span class="line">        int clients_paused;         /* True if clients are currently paused */</span><br><span class="line">        mstime_t clients_pause_end_time; /* Time when we undo clients_paused */</span><br><span class="line">        char neterr[ANET_ERR_LEN];   /* Error buffer for anet.c */</span><br><span class="line">        dict *migrate_cached_sockets;/* MIGRATE cached sockets */</span><br><span class="line">       </span><br><span class="line">        /* RDB / AOF loading information */</span><br><span class="line">        int loading;                /* We are loading data from disk if true */</span><br><span class="line">        off_t loading_total_bytes;</span><br><span class="line">        off_t loading_loaded_bytes;</span><br><span class="line">        time_t loading_start_time;</span><br><span class="line">        off_t loading_process_events_interval_bytes;</span><br><span class="line">        /* Fast pointers to often looked up command */</span><br><span class="line">        struct redisCommand *delCommand, *multiCommand, *lpushCommand, *lpopCommand,</span><br><span class="line">        *rpopCommand;</span><br><span class="line"></span><br><span class="line">        /* Fields used only for stats */</span><br><span class="line">        time_t stat_starttime;          /* Server start time */</span><br><span class="line">        long long stat_numcommands;     /* Number of processed commands */</span><br><span class="line">        long long stat_numconnections;  /* Number of connections received */</span><br><span class="line">        long long stat_expiredkeys;     /* Number of expired keys */</span><br><span class="line">        long long stat_evictedkeys;     /* Number of evicted keys (maxmemory) */</span><br><span class="line">        long long stat_keyspace_hits;   /* Number of successful lookups of keys */</span><br><span class="line">        long long stat_keyspace_misses; /* Number of failed lookups of keys */</span><br><span class="line">        size_t stat_peak_memory;        /* Max used memory record */</span><br><span class="line">        long long stat_fork_time;       /* Time needed to perform latest fork() */</span><br><span class="line">        long long stat_rejected_conn;   /* Clients rejected because of maxclients */</span><br><span class="line">        long long stat_sync_full;       /* Number of full resyncs with slaves. */</span><br><span class="line">        long long stat_sync_partial_ok; /* Number of accepted PSYNC requests. */</span><br><span class="line">        long long stat_sync_partial_err;/* Number of unaccepted PSYNC requests. */</span><br><span class="line"></span><br><span class="line">        //保存慢日志命令</span><br><span class="line">        list *slowlog;                  /* SLOWLOG list of commands */</span><br><span class="line">        long long slowlog_entry_id;     /* SLOWLOG current entry ID */</span><br><span class="line">        long long slowlog_log_slower_than; /* SLOWLOG time limit (to get logged) */</span><br><span class="line">        unsigned long slowlog_max_len;     /* SLOWLOG max number of items logged */</span><br><span class="line">        /* The following two are used to track instantaneous &quot;load&quot; in terms</span><br><span class="line">        * of operations per second. */</span><br><span class="line">        long long ops_sec_last_sample_time; /* Timestamp of last sample (in ms) */</span><br><span class="line">        long long ops_sec_last_sample_ops;  /* numcommands in last sample */</span><br><span class="line">        long long ops_sec_samples[REDIS_OPS_SEC_SAMPLES];</span><br><span class="line">        int ops_sec_idx;</span><br><span class="line"></span><br><span class="line">        /* Configuration */</span><br><span class="line">        int verbosity;                  /* Loglevel in redis.conf */</span><br><span class="line">        int maxidletime;                /* Client timeout in seconds */</span><br><span class="line">        int tcpkeepalive;               /* Set SO_KEEPALIVE if non-zero. */</span><br><span class="line">        int active_expire_enabled;      /* Can be disabled for testing purposes. */</span><br><span class="line">        size_t client_max_querybuf_len; /* Limit for client query buffer length */</span><br><span class="line">        int dbnum;                      /* Total number of configured DBs */</span><br><span class="line">        int daemonize;                  /* True if running as a daemon */</span><br><span class="line">        clientBufferLimitsConfig client_obuf_limits[REDIS_CLIENT_LIMIT_NUM_CLASSES];</span><br><span class="line"></span><br><span class="line">        /* AOF persistence */</span><br><span class="line">        int aof_state;                  /* REDIS_AOF_(ON|OFF|WAIT_REWRITE) */</span><br><span class="line">        int aof_fsync;                  /* Kind of fsync() policy */</span><br><span class="line">        char *aof_filename;             /* Name of the AOF file */</span><br><span class="line">        int aof_no_fsync_on_rewrite;    /* Don&#x27;t fsync if a rewrite is in prog. */</span><br><span class="line">        int aof_rewrite_perc;           /* Rewrite AOF if % growth is &gt; M and... */</span><br><span class="line">        off_t aof_rewrite_min_size;     /* the AOF file is at least N bytes. */</span><br><span class="line">        off_t aof_rewrite_base_size;    /* AOF size on latest startup or rewrite. */</span><br><span class="line">        off_t aof_current_size;         /* AOF current size. */</span><br><span class="line">        int aof_rewrite_scheduled;      /* Rewrite once BGSAVE terminates. */</span><br><span class="line">        pid_t aof_child_pid;            /* PID if rewriting process */</span><br><span class="line">        list *aof_rewrite_buf_blocks;   /* Hold changes during an AOF rewrite. */</span><br><span class="line">        sds aof_buf;      /* AOF buffer, written before entering the event loop */</span><br><span class="line">        int aof_fd;       /* File descriptor of currently selected AOF file */</span><br><span class="line">        int aof_selected_db; /* Currently selected DB in AOF */</span><br><span class="line">        time_t aof_flush_postponed_start; /* UNIX time of postponed AOF flush */</span><br><span class="line">        time_t aof_last_fsync;            /* UNIX time of last fsync() */</span><br><span class="line">        time_t aof_rewrite_time_last;   /* Time used by last AOF rewrite run. */</span><br><span class="line">        time_t aof_rewrite_time_start;  /* Current AOF rewrite start time. */</span><br><span class="line">        int aof_lastbgrewrite_status;   /* REDIS_OK or REDIS_ERR */</span><br><span class="line">        unsigned long aof_delayed_fsync;  /* delayed AOF fsync() counter */</span><br><span class="line">        int aof_rewrite_incremental_fsync;/* fsync incrementally while rewriting? */</span><br><span class="line">        int aof_last_write_status;      /* REDIS_OK or REDIS_ERR */</span><br><span class="line">        int aof_last_write_errno;       /* Valid if aof_last_write_status is ERR */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* RDB persistence */</span><br><span class="line">        long long dirty;                /* Changes to DB from the last save */</span><br><span class="line">        long long dirty_before_bgsave;  /* Used to restore dirty on failed BGSAVE */</span><br><span class="line">        pid_t rdb_child_pid;            /* PID of RDB saving child */</span><br><span class="line">        struct saveparam *saveparams;   /* Save points array for RDB */</span><br><span class="line">        int saveparamslen;              /* Number of saving points */</span><br><span class="line">        char *rdb_filename;             /* Name of RDB file */</span><br><span class="line">        int rdb_compression;            /* Use compression in RDB? */</span><br><span class="line">        int rdb_checksum;               /* Use RDB checksum? */</span><br><span class="line">        time_t lastsave;                /* Unix time of last successful save */</span><br><span class="line">        time_t lastbgsave_try;          /* Unix time of last attempted bgsave */</span><br><span class="line">        time_t rdb_save_time_last;      /* Time used by last RDB save run. */</span><br><span class="line">        time_t rdb_save_time_start;     /* Current RDB save start time. */</span><br><span class="line">        int lastbgsave_status;          /* REDIS_OK or REDIS_ERR */</span><br><span class="line">        int stop_writes_on_bgsave_err;  /* Don&#x27;t allow writes if can&#x27;t BGSAVE */</span><br><span class="line">        /* Propagation of commands in AOF / replication */</span><br><span class="line">        redisOpArray also_propagate;    /* Additional command to propagate. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Logging */</span><br><span class="line">        char *logfile;                  /* Path of log file */</span><br><span class="line">        int syslog_enabled;             /* Is syslog enabled? */</span><br><span class="line">        char *syslog_ident;             /* Syslog ident */</span><br><span class="line">        int syslog_facility;            /* Syslog facility */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Replication (master) */</span><br><span class="line">        int slaveseldb;                 /* Last SELECTed DB in replication output */</span><br><span class="line">        long long master_repl_offset;   /* Global replication offset */</span><br><span class="line">        int repl_ping_slave_period;     /* Master pings the slave every N seconds */</span><br><span class="line">        char *repl_backlog;             /* Replication backlog for partial syncs */</span><br><span class="line">        long long repl_backlog_size;    /* Backlog circular buffer size */</span><br><span class="line">        long long repl_backlog_histlen; /* Backlog actual data length */</span><br><span class="line">        long long repl_backlog_idx;     /* Backlog circular buffer current offset */</span><br><span class="line">        long long repl_backlog_off;     /* Replication offset of first byte in the</span><br><span class="line">        backlog buffer. */</span><br><span class="line">        time_t repl_backlog_time_limit; /* Time without slaves after the backlog</span><br><span class="line">        gets released. */</span><br><span class="line">        time_t repl_no_slaves_since;    /* We have no slaves since that time.</span><br><span class="line">        Only valid if server.slaves len is 0. */</span><br><span class="line">        int repl_min_slaves_to_write;   /* Min number of slaves to write. */</span><br><span class="line">        int repl_min_slaves_max_lag;    /* Max lag of &lt;count&gt; slaves to write. */</span><br><span class="line">        int repl_good_slaves_count;     /* Number of slaves with lag &lt;= max_lag. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Replication (slave) */</span><br><span class="line">        char *masterauth;               /* AUTH with this password with master */</span><br><span class="line">        char *masterhost;               /* Hostname of master */</span><br><span class="line">        int masterport;                 /* Port of master */</span><br><span class="line">        int repl_timeout;               /* Timeout after N seconds of master idle */</span><br><span class="line">        redisClient *master;     /* Client that is master for this slave */</span><br><span class="line">        redisClient *cached_master; /* Cached master to be reused for PSYNC. */</span><br><span class="line">        int repl_syncio_timeout; /* Timeout for synchronous I/O calls */</span><br><span class="line">        int repl_state;          /* Replication status if the instance is a slave */</span><br><span class="line">        off_t repl_transfer_size; /* Size of RDB to read from master during sync. */</span><br><span class="line">        off_t repl_transfer_read; /* Amount of RDB read from master during sync. */</span><br><span class="line">        off_t repl_transfer_last_fsync_off; /* Offset when we fsync-ed last time. */</span><br><span class="line">        int repl_transfer_s;     /* Slave -&gt; Master SYNC socket */</span><br><span class="line">        int repl_transfer_fd;    /* Slave -&gt; Master SYNC temp file descriptor */</span><br><span class="line">        char *repl_transfer_tmpfile; /* Slave-&gt; master SYNC temp file name */</span><br><span class="line">        time_t repl_transfer_lastio; /* Unix time of the latest read, for timeout */</span><br><span class="line">        int repl_serve_stale_data; /* Serve stale data when link is down? */</span><br><span class="line">        int repl_slave_ro;          /* Slave is read only? */</span><br><span class="line">        time_t repl_down_since; /* Unix time at which link with master went down */</span><br><span class="line">        int repl_disable_tcp_nodelay;   /* Disable TCP_NODELAY after SYNC? */</span><br><span class="line">        int slave_priority;             /* Reported in INFO and used by Sentinel. */</span><br><span class="line">        char repl_master_runid[REDIS_RUN_ID_SIZE+1];  /* Master run id for PSYNC. */</span><br><span class="line">        long long repl_master_initial_offset;         /* Master PSYNC offset. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Replication script cache. */</span><br><span class="line">        dict *repl_scriptcache_dict;        /* SHA1 all slaves are aware of. */</span><br><span class="line">        list *repl_scriptcache_fifo;        /* First in, first out LRU eviction. */</span><br><span class="line">        int repl_scriptcache_size;          /* Max number of elements. */</span><br><span class="line">        /* Synchronous replication. */</span><br><span class="line">        list *clients_waiting_acks;         /* Clients waiting in WAIT command. */</span><br><span class="line">        int get_ack_from_slaves;            /* If true we send REPLCONF GETACK. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Limits */</span><br><span class="line">        unsigned int maxclients;        /* Max number of simultaneous clients */</span><br><span class="line">        unsigned long long maxmemory;   /* Max number of memory bytes to use */</span><br><span class="line">        int maxmemory_policy;           /* Policy for key eviction */</span><br><span class="line">        int maxmemory_samples;          /* Pricision of random sampling */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Blocked clients */</span><br><span class="line">        unsigned int bpop_blocked_clients; /* Number of clients blocked by lists */</span><br><span class="line">        list *unblocked_clients; /* list of clients to unblock before next loop */</span><br><span class="line">        list *ready_keys;        /* List of readyList structures for BLPOP &amp; co */</span><br><span class="line">        /* Sort parameters - qsort_r() is only available under BSD so we</span><br><span class="line">        * have to take this state global, in order to pass it to sortCompare() */</span><br><span class="line">        int sort_desc;</span><br><span class="line">        int sort_alpha;</span><br><span class="line">        int sort_bypattern;</span><br><span class="line">        int sort_store;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Zip structure config, see redis.conf for more information  */</span><br><span class="line">        size_t hash_max_ziplist_entries;</span><br><span class="line">        size_t hash_max_ziplist_value;</span><br><span class="line">        size_t list_max_ziplist_entries;</span><br><span class="line">        size_t list_max_ziplist_value;</span><br><span class="line">        size_t set_max_intset_entries;</span><br><span class="line">        size_t zset_max_ziplist_entries;</span><br><span class="line">        size_t zset_max_ziplist_value;</span><br><span class="line">        time_t unixtime;        /* Unix time sampled every cron cycle. */</span><br><span class="line">        long long mstime;       /* Like &#x27;unixtime&#x27; but with milliseconds resolution. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Pubsub */</span><br><span class="line">        dict *pubsub_channels;  /* Map channels to list of subscribed clients */</span><br><span class="line">        list *pubsub_patterns;  /* A list of pubsub_patterns */</span><br><span class="line">        int notify_keyspace_events; /* Events to propagate via Pub/Sub. This is an</span><br><span class="line">        xor of REDIS_NOTIFY... flags. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Cluster */</span><br><span class="line">        int cluster_enabled;      /* Is cluster enabled? */</span><br><span class="line">        mstime_t cluster_node_timeout; /* Cluster node timeout. */</span><br><span class="line">        char *cluster_configfile; /* Cluster auto-generated config file name. */</span><br><span class="line">        struct clusterState *cluster;  /* State of the cluster */</span><br><span class="line">        int cluster_migration_barrier; /* Cluster replicas migration barrier. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Scripting */</span><br><span class="line">        lua_State *lua; /* The Lua interpreter. We use just one for all clients */</span><br><span class="line">        redisClient *lua_client;   /* The &quot;fake client&quot; to query Redis from Lua */</span><br><span class="line">        redisClient *lua_caller;   /* The client running EVAL right now, or NULL */</span><br><span class="line">        dict *lua_scripts;         /* A dictionary of SHA1 -&gt; Lua scripts */</span><br><span class="line">        mstime_t lua_time_limit;  /* Script timeout in milliseconds */</span><br><span class="line">        mstime_t lua_time_start;  /* Start time of script, milliseconds time */</span><br><span class="line">        int lua_write_dirty;  /* True if a write command was called during the</span><br><span class="line">        execution of the current script. */</span><br><span class="line">        int lua_random_dirty; /* True if a random command was called during the</span><br><span class="line">        execution of the current script. */</span><br><span class="line">        int lua_timedout;     /* True if we reached the time limit for script</span><br><span class="line">        execution. */</span><br><span class="line">        int lua_kill;         /* Kill the script if true. */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /* Assert &amp; bug reporting */</span><br><span class="line">        char *assert_failed;</span><br><span class="line">        char *assert_file;</span><br><span class="line">        int assert_line;</span><br><span class="line">        int bug_report_start; /* True if bug report header was already logged. */</span><br><span class="line">        int watchdog_period;  /* Software watchdog period in ms. 0 = off */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>程序创建一个的 redisServer 结构的实例变量server，调用函数 initServerConfig(),<br>将 server 的各个属性初始化为默认值。 当 server 变量的初始化完成之后， 程序进入服务器初始化的下一步： 读入配置文件。</p>
<h3 id="2-初始化RedisModule"><a href="#2-初始化RedisModule" class="headerlink" title="2.初始化RedisModule"></a>2.初始化RedisModule</h3><p>RedisModule为为4.0新增内容，moduleInitModulesSystem函数负责加载模块<br>module介绍：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020104277?utm_medium=referral&utm_source=tuicool">Redis Module原理</a><br>module实例：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015976157">手把手教你玩儿一下 Redis Module 之模块解读</a></p>
<h3 id="3-sentinel模块初始化"><a href="#3-sentinel模块初始化" class="headerlink" title="3.sentinel模块初始化"></a>3.sentinel模块初始化</h3><p>其实在读入配置文件前， 还要判断是不是sentinel， 如果sentinel，<br>还需要通过initSentinelConfig()和initSentinel()初始化， 才通过resetServerSaveParams()<br>重置param选项， 通过loadServerConfig(configfile,options)读入配置文件和显选项。</p>
<h3 id="4-读入配置文件"><a href="#4-读入配置文件" class="headerlink" title="4.读入配置文件"></a>4.读入配置文件</h3><p>在初始化服务器的上一步中， 程序为 server 变量（也即是服务器状态）的各个属性设置了默认值， 但这些默认值有时候并不是最合适的： 比如：</p>
<ul>
<li>用户可能想使用 AOF 持久化，而不是默认的 RDB 持久化。</li>
<li>用户可能想用其他端口来运行 Redis ，以避免端口冲突。</li>
<li>用户可能不想使用默认的 16 个数据库，而是分配更多或更少数量的数据库。</li>
<li>用户可能想对默认的内存限制措施和回收策略做调整。</li>
</ul>
<p>为了让使用者按自己的要求配置服务器， Redis 允许用户在运行服务器时， 提供相应的配置文件（config file）或者显式的选项（options），<br>Redis 在初始化完 server 变量之后， 会读入配置文件和选项，<br>然后根据这些配置来对 server 变量的属性值做相应的修改： 如果单纯执行 redis-server 命令，那么服务器以默认的配置来运行 Redis 。<br>另一方面， 如果给 Redis 服务器送入一个配置文件， 那么 Redis<br>将按配置文件的设置来更新服务器的状态。</p>
<p>比如说， 通过命令 redis-server /etc/my-redis.conf，Redis 会根据 my-redis.conf 文件的内容来对服务器状态做相应的修改。<br>除此之外， 还可以显式地给服务器传入选项， 直接修改服务器配置。<br>举个例子， 通过命令 redis-server –port 10086 ， 可以让 Redis 服务器端口变更为 10086 。<br>当然，同时使用配置文件和显式选项也是可以的， 如果文件和选项有冲突的地方，<br>那么优先使用选项所指定的配置值。 举个例子， 如果运行命令 redis-server /etc/my-redis.conf –port 10086 ，<br>并且 my-redis.conf 也指定了 port 选项， 那么服务器将优先使用<br>–port 10086 （实际上是选项指定的值覆盖了配置文件中的值。</p>
<h3 id="创建-daemon-进程"><a href="#创建-daemon-进程" class="headerlink" title="创建 daemon 进程"></a>创建 daemon 进程</h3><p>Redis 默认不以 daemon 进程的方式运行。 若服务器初始化进行到这一步时， 程序将创建 daemon 进程来运行 Redis ， 并创建相应的 pid 文件。</p>
<h3 id="初始化服务器功能模块"><a href="#初始化服务器功能模块" class="headerlink" title="初始化服务器功能模块"></a>初始化服务器功能模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">在这一步， 初始化程序完成两件事：</span><br><span class="line">为 server 变量的数据结构子属性分配内存。</span><br><span class="line">初始化这些数据结构。</span><br><span class="line">为数据结构分配内存， 并初始化这些数据结构， 等同于对相应的功能进行初始化。</span><br><span class="line">比如说， 当为订阅与发布所需的链表分配内存之后， 订阅与发布功能就处于就绪状态， 随时可以为 Redis 所用了。</span><br><span class="line">在这一步， initServer()完成的主要动作如下：</span><br><span class="line">    初始化 Redis 进程的信号功能。</span><br><span class="line">    初始化日志功能。</span><br><span class="line">    初始化客户端功能。</span><br><span class="line">    初始化共享对象。</span><br><span class="line">    初始化事件功能。</span><br><span class="line">    初始化网络连接。</span><br><span class="line">    初始化数据库。</span><br><span class="line">    初始化订阅与发布功能。</span><br><span class="line">    初始化各个统计变量。</span><br><span class="line">    关联服务器常规操作（cron job）到时间事件，关联客户端应答处理器到文件事件。</span><br><span class="line">    如果 AOF 功能已打开，那么打开或创建 AOF 文件。</span><br><span class="line">    设置内存限制。</span><br><span class="line">    初始化 Lua 脚本环境。</span><br><span class="line">    初始化慢查询功能。</span><br><span class="line">    初始化后台操作线程。</span><br><span class="line">    完成这一步之后， 服务器redisAsciiArt()打印出 Redis 的 ASCII LOGO 、服务器版本等信息， 表示所有功能模块已经就绪， 可以等待被使用了：</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">               _._</span><br><span class="line">          _.-``__ &#x27;&#x27;-._</span><br><span class="line">     _.-``    `.  `_.  &#x27;&#x27;-._           Redis 3.0.beta (7a47887b/1) 32 bit</span><br><span class="line">.-`` .-```.  ```\/    _.,_ &#x27;&#x27;-._</span><br><span class="line">(    &#x27;      ,       .-`  | `,    )     Running in stand alone mode</span><br><span class="line">|`-._`-...-` __...-.``-._|&#x27;` _.-&#x27;|     Port: 6379</span><br><span class="line">|    `-._   `._    /     _.-&#x27;    |     PID: 6717</span><br><span class="line">`-._    `-._  `-./  _.-&#x27;    _.-&#x27;</span><br><span class="line">|`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|</span><br><span class="line">|    `-._`-._        _.-&#x27;_.-&#x27;    |           http://redis.io</span><br><span class="line">`-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;</span><br><span class="line">|`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|</span><br><span class="line">|    `-._`-._        _.-&#x27;_.-&#x27;    |</span><br><span class="line">`-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;</span><br><span class="line">`-._    `-.__.-&#x27;    _.-&#x27;</span><br><span class="line">`-._        _.-&#x27;</span><br><span class="line">`-.__.-&#x27;</span><br><span class="line">虽然所有功能已经就绪， 但这时服务器的数据库还是一片空白， 程序还需要将服务器上一次执行时记录的数据载入到当前服务器中， 服务器的初始化才算真正完成。</span><br></pre></td></tr></table></figure>

<h3 id="载入数据"><a href="#载入数据" class="headerlink" title="载入数据"></a>载入数据</h3><p>在这一步， 如果不为sentinel， 程序需要将持久化在 RDB 或者 AOF 文件里的数据， 载入到服务器进程里面。</p>
<p>如果服务器有启用 AOF 功能的话， 那么使用 AOF 文件来还原数据； 否则， 程序使用 RDB 文件来还原数据。</p>
<p>当执行完这一步时， 服务器打印出一段载入完成信息：</p>
<p>[6717] 22 Feb 11:59:14.830 * DB loaded from disk: 0.068 seconds Note</p>
<p>如果是集群， 还要检查数据的一致性。</p>
<h3 id="开始事件循环"><a href="#开始事件循环" class="headerlink" title="开始事件循环"></a>开始事件循环</h3><p>到了这一步， 服务器的初始化已经完成， 程序打开事件循环， 开始接受客户端连接。</p>
<p>以下是服务器在这一步打印的信息：</p>
<p>[6717] 22 Feb 11:59:14.830 * The server is now ready to accept connections on port 6379</p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a target="_blank" rel="noopener" href="https://redissrc.readthedocs.io/en/latest/init/server.html">初始化服务器</a></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://wuhaocn.github.io/2022/04/07/data/redis/code/2.1.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/" title="2.1.reedis-服务启动" target="_blank" rel="external">https://wuhaocn.github.io/2022/04/07/data/redis/code/2.1.服务启动/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/wuhaocn" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/wuhaocn" target="_blank"><span class="text-dark">wuhaocn</span><small class="ml-1x">Java &amp; 后端 &amp; 通信</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/04/07/data/redis/code/1.5.redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/" title="1.5.redis-配置文件详解"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2022/04/07/data/redis/code/1.3.%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/" title="1.3.redis-源码调试"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wuhaocn" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/wuhaocn" target="_blank"> cofess </a>base on <a href="https://github.com/wuhaocn/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: 'UWmpsjuNfPNkkicYrPtMzVQC-gzGzoHsz',
    appKey: '825aG0XPHawp6VAXnYsrnlp3',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>