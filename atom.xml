<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wuhaocn</title>
  
  
  <link href="https://wuhaocn.github.io/atom.xml" rel="self"/>
  
  <link href="https://wuhaocn.github.io/"/>
  <updated>2023-11-15T06:28:55.384Z</updated>
  <id>https://wuhaocn.github.io/</id>
  
  <author>
    <name>wuhao</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>基础网络链路介绍</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/3gpp/%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E9%93%BE%E8%B7%AF%E4%BB%8B%E7%BB%8D/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/3gpp/%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E9%93%BE%E8%B7%AF%E4%BB%8B%E7%BB%8D/</id>
    <published>2023-11-15T06:28:30.065Z</published>
    <updated>2023-11-15T06:28:55.384Z</updated>
    
    <content type="html"><![CDATA[<h1 id="基础网络链路介绍"><a href="#基础网络链路介绍" class="headerlink" title="基础网络链路介绍"></a>基础网络链路介绍</h1><h2 id="移动网络"><a href="#移动网络" class="headerlink" title="移动网络"></a>移动网络</h2><ul><li>移动网络带宽及延迟</li></ul><table><thead><tr><th>网络类型</th><th>延迟</th><th>带宽</th><th>理论覆盖半径</th><th>典型频段</th><th>3GPP规范</th><th>推出年份</th></tr></thead><tbody><tr><td>2G</td><td>约300-400 毫秒</td><td>0.1 Mbps</td><td>5-10公里</td><td>GSM: 850 MHz, 900 MHz, 1800 MHz, 1900 MHz</td><td>GSM</td><td>1991</td></tr><tr><td>3G</td><td>约100-300 毫秒</td><td>1-10 Mbps</td><td>2-5公里</td><td>UMTS: 850 MHz, 900 MHz, 1900 MHz, 2100 MHz</td><td>UMTS</td><td>2001 (WCDMA)</td></tr><tr><td>4G</td><td>约20-50 毫秒</td><td>10-100 Mbps</td><td>1-3公里</td><td>LTE: 频段因地区而异</td><td>LTE</td><td>2009</td></tr><tr><td>5G</td><td>目标小于1毫秒</td><td>100 Mbps - 10 Gbps</td><td>100-300米</td><td>Sub-6 GHz频段 (e.g., n41, n78), 毫米波频段 (e.g., n260, n261)</td><td>5G NR</td><td>2019 (初步部署)</td></tr></tbody></table><h2 id="wifi"><a href="#wifi" class="headerlink" title="wifi"></a>wifi</h2><ul><li>不同wifi标准</li></ul><table><thead><tr><th>WiFi标准</th><th>理论带宽</th><th>理论延迟</th><th>空旷地区理论覆盖距离（半径）</th></tr></thead><tbody><tr><td>802.11a</td><td>54 Mbps</td><td>约 15 ms</td><td>较短（几十米至百米）</td></tr><tr><td>802.11b</td><td>11 Mbps</td><td>约 30 ms</td><td>较短（几十米至百米）</td></tr><tr><td>802.11g</td><td>54 Mbps</td><td>约 15 ms</td><td>较短（几十米至百米）</td></tr><tr><td>802.11n</td><td>最高 600 Mbps（4x4 MIMO）</td><td>约 8 ms</td><td>较长（百米至两百米）</td></tr><tr><td>802.11ac</td><td>最高 3.5 Gbps（8x8 MIMO）</td><td>约 3 ms</td><td>更长（数百米至千米）</td></tr><tr><td>802.11ax</td><td>最高 9.6 Gbps（8x8 MIMO）</td><td>约 2 ms</td><td>更长（数百米至千米）</td></tr></tbody></table><h2 id="网络链路"><a href="#网络链路" class="headerlink" title="网络链路"></a>网络链路</h2><ul><li><p>全球各大洲网络延迟</p><table><thead><tr><th>出发地/目的地</th><th>中国（上海）</th><th>新加坡</th><th>北美（纽约）</th><th>沙特（利雅得）</th><th>大洲</th></tr></thead><tbody><tr><td>中国（上海）</td><td>-</td><td>约 50 毫秒</td><td>约 150 毫秒</td><td>约 180 毫秒</td><td>亚洲</td></tr><tr><td>新加坡</td><td>约 50 毫秒</td><td>-</td><td>约 180 毫秒</td><td>约 110 毫秒</td><td>亚洲</td></tr><tr><td>北美（纽约）</td><td>约 150 毫秒</td><td>约 180 毫秒</td><td>-</td><td>约 230 毫秒</td><td>北美洲</td></tr><tr><td>沙特（利雅得）</td><td>约 180 毫秒</td><td>约 110 毫秒</td><td>约 230 毫秒</td><td>-</td><td>亚洲</td></tr><tr><td>伦敦</td><td>约 180 毫秒</td><td>约 250 毫秒</td><td>约 70 毫秒</td><td>约 60 毫秒</td><td>欧洲</td></tr><tr><td>圣保罗</td><td>约 250 毫秒</td><td>约 280 毫秒</td><td>约 25 毫秒</td><td>约 180 毫秒</td><td>南美洲</td></tr><tr><td>纳加克特</td><td>约 250 毫秒</td><td>约 290 毫秒</td><td>约 25 毫秒</td><td>约 180 毫秒</td><td>北美洲</td></tr><tr><td>开普敦</td><td>约 300 毫秒</td><td>约 310 毫秒</td><td>约 160 毫秒</td><td>约 220 毫秒</td><td>非洲</td></tr><tr><td>悉尼</td><td>约 180 毫秒</td><td>约 210 毫秒</td><td>约 150 毫秒</td><td>约 220 毫秒</td><td>大洋洲</td></tr></tbody></table></li><li><p>备注<br>这个表格提供了从中国（上海）、新加坡和北美（纽约）、沙特（利雅得）到一些世界主要城市的理论专线延迟估算值。<br>这些值是基于直线距离和理论网络传输速度的估算，实际延迟可能会受到多种因素的影响，包括网络拥塞、路由选择、传输介质的类型等。</p></li></ul><h2 id="协议耗时"><a href="#协议耗时" class="headerlink" title="协议耗时"></a>协议耗时</h2><table><thead><tr><th>协议</th><th>建联消耗</th><th>备注</th></tr></thead><tbody><tr><td>TCP</td><td>1-RTT</td><td>-</td></tr><tr><td>QUIC</td><td>0-1RTT</td><td>可开启0-RTT</td></tr><tr><td>TCP+TLS1.2</td><td>3-RTT</td><td>-</td></tr><tr><td>TCP+TLS1.3</td><td>1~2RTT</td><td>TLS1.3开启0-RTT，整体在1-RTT</td></tr></tbody></table><h2 id="网络覆盖率"><a href="#网络覆盖率" class="headerlink" title="网络覆盖率"></a>网络覆盖率</h2><ul><li>移动网络覆盖<ul><li><a href="https://www.gsma.com/mobileeconomy/wp-content/uploads/2023/03/270223-The-Mobile-Economy-2023.pdf">https://www.gsma.com/mobileeconomy/wp-content/uploads/2023/03/270223-The-Mobile-Economy-2023.pdf</a></li></ul></li><li>现状<ul><li>2022 中国 北美 欧洲 4/5G 覆盖率在80%以上 ，其他地域在80%以下</li><li>2030  中东和北非 4/5G 覆盖率在90%以下，其他区域在90%以上</li></ul></li><li>详细<br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/804884/1700029077781-539b1207-9621-457b-a7b5-29d24ffbb328.jpeg" alt="20231115-141123.jpeg"><br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/804884/1700029093005-910bd872-1428-4cbe-9272-ea9638d9973f.jpeg" alt="20231115-141130.jpeg"></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;基础网络链路介绍&quot;&gt;&lt;a href=&quot;#基础网络链路介绍&quot; class=&quot;headerlink&quot; title=&quot;基础网络链路介绍&quot;&gt;&lt;/a&gt;基础网络链路介绍&lt;/h1&gt;&lt;h2 id=&quot;移动网络&quot;&gt;&lt;a href=&quot;#移动网络&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    <category term="net" scheme="https://wuhaocn.github.io/categories/net/"/>
    
    
    <category term="net" scheme="https://wuhaocn.github.io/tags/net/"/>
    
  </entry>
  
  <entry>
    <title>docker-java运行环境</title>
    <link href="https://wuhaocn.github.io/2023/11/15/devops/docker/%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-Java/"/>
    <id>https://wuhaocn.github.io/2023/11/15/devops/docker/%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-Java/</id>
    <published>2023-11-15T03:43:01.859Z</published>
    <updated>2023-11-15T03:43:01.859Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基础-jar"><a href="#基础-jar" class="headerlink" title="基础 jar"></a>基础 jar</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker stop japp</span><br><span class="line">docker rm japp</span><br><span class="line">docker run --name japp --privileged=true -p 3337:3306 -e MYSQL_ROOT_PASSWORD=coral@2018 -d mysql:5.7.19</span><br></pre></td></tr></table></figure><h2 id="安装扩展-java-redis"><a href="#安装扩展-java-redis" class="headerlink" title="安装扩展 java redis"></a>安装扩展 java redis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apt-key del 5072E1F5</span><br><span class="line">apt-get update</span><br><span class="line">apt-key adv --keyserver keyserver.ubuntu.com --recv 8C718D3B5072E1F5</span><br><span class="line">apt-get update</span><br><span class="line">ls</span><br><span class="line">cd /root</span><br><span class="line">ls</span><br><span class="line">cd jdk1.8.0_251/</span><br><span class="line">ls</span><br><span class="line">cd ..</span><br><span class="line">vim /etc/profile</span><br><span class="line">apt-get install vim</span><br><span class="line">vim /etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line">java -v</span><br><span class="line">java -version</span><br><span class="line">apt-get install redis-server</span><br><span class="line">ls</span><br></pre></td></tr></table></figure><h2 id="打包推送"><a href="#打包推送" class="headerlink" title="打包推送"></a>打包推送</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker commit e9c1ad83b80a wuhaocn/javaapp:8</span><br><span class="line"></span><br><span class="line">docker tag wuhaocn/javaapp:8 wuhaocn/javaapp:8</span><br><span class="line"></span><br><span class="line">docker push wuhaocn/javaapp:8</span><br></pre></td></tr></table></figure><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker stop japp</span><br><span class="line">docker rm japp</span><br><span class="line">docker run --name japp --privileged=true -p 3337:3306 16379:6379 -d wuhaocn/javaapp:8</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;基础-jar&quot;&gt;&lt;a href=&quot;#基础-jar&quot; class=&quot;headerlink&quot; title=&quot;基础 jar&quot;&gt;&lt;/a&gt;基础 jar&lt;/h2&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    <category term="devops" scheme="https://wuhaocn.github.io/categories/devops/"/>
    
    
    <category term="docker" scheme="https://wuhaocn.github.io/tags/docker/"/>
    
    <category term="java" scheme="https://wuhaocn.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>docker-监控环境搭建.md</title>
    <link href="https://wuhaocn.github.io/2023/11/15/devops/docker/%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-%E7%9B%91%E6%8E%A7/"/>
    <id>https://wuhaocn.github.io/2023/11/15/devops/docker/%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-%E7%9B%91%E6%8E%A7/</id>
    <published>2023-11-15T03:43:01.859Z</published>
    <updated>2023-11-15T03:43:01.859Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-镜像使用-一体化"><a href="#1-镜像使用-一体化" class="headerlink" title="1.镜像使用(一体化)"></a>1.镜像使用(一体化)</h2><h3 id="1-1-镜像安装"><a href="#1-1-镜像安装" class="headerlink" title="1.1.镜像安装"></a>1.1.镜像安装</h3><ul><li><p>手工配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stop monitor</span><br><span class="line">docker rm monitor</span><br><span class="line">docker run --name monitor --privileged=true -p 9090:9090  -p 3000:3000  -d wuhaocn/monitor:1.0</span><br><span class="line">docker update monitor --restart=always</span><br></pre></td></tr></table></figure></li><li><p>自动发现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker stop monitor-consul</span><br><span class="line">docker rm monitor-consul</span><br><span class="line">docker run --name monitor-consul --privileged=true  -p 18500:8500  -p 19090:9090  -p 13000:3000  -d wuhaocn/monitor:2.0</span><br><span class="line">docker update monitor-consul --restart=always</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>注册节点信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -d &#x27;&#123;&quot;id&quot;: &quot;test1&quot;,&quot;name&quot;: &quot;test1&quot;,&quot;address&quot;: &quot;192.168.56.12&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;service&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;: &quot;http://192.168.56.12:9100/&quot;,&quot;interval&quot;: &quot;5s&quot;&#125;]&#125;&#x27; http://192.168.56.12:8502/v1/agent/service/register</span><br><span class="line"></span><br><span class="line">curl -X PUT -d &#x27;&#123;&quot;id&quot;: &quot;test1&quot;,&quot;name&quot;: &quot;test1&quot;,&quot;address&quot;: &quot;192.168.56.12&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;service&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;: &quot;http://192.168.56.12:9100/&quot;,&quot;interval&quot;: &quot;5s&quot;&#125;]&#125;&#x27; http://192.168.56.12:8502/v1/agent/service/unregister</span><br><span class="line"></span><br><span class="line">https://www.consul.io/api-docs/agent/service#register-service</span><br><span class="line">https://www.consul.io/api-docs/agent/service#deregister-service</span><br></pre></td></tr></table></figure></li></ul><h3 id="1-2-容器配置"><a href="#1-2-容器配置" class="headerlink" title="1.2.容器配置"></a>1.2.容器配置</h3><p>docker exec -it monitor bash</p><p>配置修改地址</p><ul><li> /usr/local/grafana<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@f23762ac5af0:/usr/local/grafana/conf# ll</span><br><span class="line">total 136</span><br><span class="line">drwxr-xr-x 3 root root  4096 Mar 31 12:35 ./</span><br><span class="line">drwxr-xr-x 1 root root  4096 Apr  7 02:09 ../</span><br><span class="line">-rw-r--r-- 1 root root 56590 Mar 31 12:35 defaults.ini</span><br><span class="line">-rw-r--r-- 1 root root  2270 Mar 31 12:35 ldap.toml</span><br><span class="line">-rw-r--r-- 1 root root  1045 Mar 31 12:35 ldap_multiple.toml</span><br><span class="line">drwxr-xr-x 7 root root  4096 Mar 31 12:35 provisioning/</span><br><span class="line">-rw-r--r-- 1 root root 57840 Mar 31 12:35 sample.ini</span><br></pre></td></tr></table></figure></li><li>/usr/local/prometheus</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@f23762ac5af0:/usr/local/prometheus# ll</span><br><span class="line">total 197396</span><br><span class="line">drwxr-xr-x 4 root root      4096 Apr  7 02:09 ./</span><br><span class="line">drwxr-xr-x 1 root root      4096 Apr  7 02:16 ../</span><br><span class="line">-rw-r--r-- 1 root root      6148 Apr  7 01:46 .DS_Store</span><br><span class="line">-rw-r--r-- 1 root root     11357 Mar 15 15:30 LICENSE</span><br><span class="line">-rw-r--r-- 1 root root      3773 Mar 15 15:30 NOTICE</span><br><span class="line">drwxr-xr-x 2 root root      4096 Mar 15 15:30 console_libraries/</span><br><span class="line">drwxr-xr-x 2 root root      4096 Mar 15 15:30 consoles/</span><br><span class="line">-rwxr-xr-x 1 root root 105137495 Mar 15 15:21 prometheus*</span><br><span class="line">-rw-r--r-- 1 root root       934 Apr  6 06:11 prometheus.yml</span><br><span class="line">-rwxr-xr-x 1 root root  96946761 Mar 15 15:23 promtool*</span><br><span class="line">      </span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@9852cf5a3339:/# cat /usr/local/prometheus/prometheus.yml </span><br><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#x27;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#x27;/metrics&#x27;</span><br><span class="line">    # scheme defaults to &#x27;http&#x27;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;mapplication&#x27;</span><br><span class="line">    metrics_path: /</span><br><span class="line">    static_configs:</span><br><span class="line">            - targets: [&#x27;192.168.3.41:8901&#x27;]</span><br></pre></td></tr></table></figure><h3 id="1-3-配置生效"><a href="#1-3-配置生效" class="headerlink" title="1.3 配置生效"></a>1.3 配置生效</h3><p>修改后重启配置</p><p>docker restart monitor</p><h2 id="2-镜像使用-拆分"><a href="#2-镜像使用-拆分" class="headerlink" title="2.镜像使用(拆分)"></a>2.镜像使用(拆分)</h2><h3 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1.安装"></a>2.1.安装</h3><ul><li>默认配置</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker stop prometheus</span><br><span class="line">docker rm prometheus</span><br><span class="line">docker run -d --name=prometheus  -p 9090:9090  prom/prometheus</span><br><span class="line">docker update prometheus --restart=always</span><br><span class="line"></span><br><span class="line">docker stop grafana</span><br><span class="line">docker rm grafana</span><br><span class="line">docker run -d --name=grafana  -p 3000:3000 grafana/grafana</span><br><span class="line">docker update grafana --restart=always</span><br></pre></td></tr></table></figure><ul><li>修改配置</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stop prometheus</span><br><span class="line">docker rm prometheus</span><br><span class="line">docker run -d --name=prometheus  -p 9090:9090  -v /home/rcloud/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus</span><br><span class="line">docker update prometheus --restart=always</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  # 默认情况下，每15s拉取一次目标采样点数据。</span><br><span class="line">  scrape_interval:     15s</span><br><span class="line">  # 我们可以附加一些指定标签到采样点度量标签列表中, 用于和第三方系统进行通信, 包括：federation, remote storage, Alertmanager</span><br><span class="line">  external_labels:</span><br><span class="line">    # 下面就是拉取自身服务采样点数据配置</span><br><span class="line">    monitor: &#x27;codelab-monitor&#x27;</span><br><span class="line">scrape_configs:</span><br><span class="line">  # job名称会增加到拉取到的所有采样点上，同时还有一个instance目标服务的host：port标签也会增加到采样点上</span><br><span class="line">  - job_name: &#x27;prometheus&#x27;</span><br><span class="line">    # 覆盖global的采样点，拉取时间间隔5s</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9090&#x27;]</span><br></pre></td></tr></table></figure><h3 id="2-2-登录配置"><a href="#2-2-登录配置" class="headerlink" title="2.2 登录配置"></a>2.2 登录配置</h3><ul><li>登录 <a href="http://127.0.0.1:3000/">http://127.0.0.1:3000</a></li><li>修改密码 默认 admin admin</li><li>配置 DataSource 127.0.0.1:9090</li><li>添加面板</li></ul><p>app(metrics)–data–&gt; (?) + prometheus + grafana</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-镜像使用-一体化&quot;&gt;&lt;a href=&quot;#1-镜像使用-一体化&quot; class=&quot;headerlink&quot; title=&quot;1.镜像使用(一体化)&quot;&gt;&lt;/a&gt;1.镜像使用(一体化)&lt;/h2&gt;&lt;h3 id=&quot;1-1-镜像安装&quot;&gt;&lt;a href=&quot;#1-1-镜像安装&quot; c</summary>
      
    
    
    
    <category term="devops" scheme="https://wuhaocn.github.io/categories/devops/"/>
    
    
    <category term="docker" scheme="https://wuhaocn.github.io/tags/docker/"/>
    
    <category term="grafana" scheme="https://wuhaocn.github.io/tags/grafana/"/>
    
    <category term="prometheus" scheme="https://wuhaocn.github.io/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>MySQL连接挂死原因分析</title>
    <link href="https://wuhaocn.github.io/2023/11/15/data/mysql/MySQL%E8%BF%9E%E6%8E%A5%E6%8C%82%E6%AD%BB%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90/"/>
    <id>https://wuhaocn.github.io/2023/11/15/data/mysql/MySQL%E8%BF%9E%E6%8E%A5%E6%8C%82%E6%AD%BB%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90/</id>
    <published>2023-11-15T03:43:01.853Z</published>
    <updated>2023-11-15T03:43:01.853Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h2><p>近期由测试反馈的问题有点多，其中关于系统可靠性测试提出的问题令人感到头疼，一来这类问题有时候属于“偶发”现象，难以在环境上快速复现；二来则是可靠性问题的定位链条有时候变得很长，极端情况下可能要从 a 服务追踪到 z 服务，或者是从应用代码追溯到硬件层面。<br>本次分享的是一次关于 mysql 高可用问题的定位过程，其中曲折颇多但问题本身却比较有些代表性，遂将其记录以供参考。</p><h3 id="1-1-业务架构"><a href="#1-1-业务架构" class="headerlink" title="1.1 业务架构"></a>1.1 业务架构</h3><p>首先，本系统以 mysql 作为主要的数据存储部件。整一个是典型的微服务架构（springboot + springcloud），持久层则采用了如下几个组件：</p><ul><li>mybatis，实现 sql &lt;-&gt; method 的映射</li><li>hikaricp，实现数据库连接池</li><li>mariadb-java-client，实现 jdbc 驱动</li></ul><p>在 mysql 服务端部分，后端采用了双主架构，前端以 keepalived 结合浮动ip（vip）做一层高可用。如下<br><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651111231100-ea7fc92f-bb61-45d7-8fdb-f9ce157b3ac9.png#clientId=u7254b6cc-7da7-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=304&id=ud9a0200d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=410&originWidth=558&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26491&status=done&style=none&taskId=ua54129ca-e6f8-4b36-8161-b52b1067d3b&title=&width=414" alt="image.png"><br>说明</p><ul><li><p> mysql 部署两台实例，设定为互为主备的关系。</p></li><li><p> 为每台 mysql 实例部署一个 keepalived 进程，由 keepalived 提供 vip 高可用的故障切换。实际上，keepalived 和 mysql 都实现了容器化，而 vip 端口则映射到 vm 上的 nodeport 服务端口上。</p></li><li><p>业务服务一律使用 vip 进行数据库访问。</p><pre><code>keepalived 是基于 vrrp 协议实现了路由层转换的，在同一时刻，vip 只会指向其中的一个虚拟机（master）。当主节点发生故障时，其他的 keepalived 会检测到问题并重新选举出新的 master，此后 vip 将切换到另一个可用的 mysql 实例节点上。这样一来，mysql 数据库就拥有了基础的高可用能力。</code></pre><p>   另外一点，keepalived 还会对 mysql 实例进行定时的健康检查，一旦发现 mysql 实例不可用会将自身进程杀死，进而再触发 vip 的切换动作。</p><h3 id="1-2-问题现象"><a href="#1-2-问题现象" class="headerlink" title="1.2 问题现象"></a>1.2 问题现象</h3><p>本次的测试用例也是基于虚拟机故障的场景来设计的：<br>持续以较小的压力向业务服务发起访问，随后将其中一台 mysql 的容器实例(master)重启。按照原有的评估，业务可能会产生很小的抖动，但其中断时间应该保持在秒级。<br>然而经过多次的测试后发现，在重启 mysql 主节点容器之后，有一定的概率会出现业务却再也无法访问的情况！</p><h2 id="2-分析过程"><a href="#2-分析过程" class="headerlink" title="2.分析过程"></a>2.分析过程</h2><pre><code>在发生问题之后，开发同学的第一反应是 mysql 的高可用机制出了问题。由于此前曾经出现过由于 keepalived 配置不当导致 vip 未能及时切换的问题，因此对其已经有所戒备。先是经过一通的排查，然后并没有找到 keepalived 任何配置上的毛病。然后在没有办法的情况下，重新测试了几次，问题又复现了。</code></pre><p>紧接着，我们提出了几个疑点：</p></li><li><p>1.keepalived 会根据 mysql 实例的可达性进行判断，会不会是健康检查出了问题？</p></li></ul><p>但在本次测试场景中，mysql 容器销毁会导致 keepalived 的端口探测产生失败，这同样会导致 keepalived 失效。如果 keepalived 也发生了中止，那么 vip 应该能自动发生抢占。而通过对比两台虚拟机节点的信息后，发现 vip 的确发生了切换。</p><ul><li><ol start="2"><li>业务进程所在的容器是否发生了网络不可达的问题？</li></ol></li></ul><p>尝试进入容器，对当前发生切换后的浮动ip、端口执行 telnet 测试，发现仍然能访问成功。</p><h3 id="2-1-连接池"><a href="#2-1-连接池" class="headerlink" title="2.1 连接池"></a>2.1 连接池</h3><pre><code>   在排查前面两个疑点之后，我们只能将目光转向了业务服务的db客户端上。从日志上看，在产生故障的时刻，业务侧的确出现了一些异常，如下：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">unable to acquire jdbc connection [n/a]</span><br><span class="line"></span><br><span class="line">java.sql.sqltransientconnectionexception: hikaripool-<span class="number">1</span> - connection is not available, request timed out after 30000ms.</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.hikaripool.createtimeoutexception(hikaripool.java:<span class="number">669</span>) ~[hikaricp-<span class="number">2.7</span><span class="number">.9</span>.jar!/:?]</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.hikaripool.getconnection(hikaripool.java:<span class="number">183</span>) ~[hikaricp-<span class="number">2.7</span><span class="number">.9</span>.jar!/:?] </span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><pre><code>  这里提示的是业务操作获取连接超时了（超过了30秒）。那么，会不会是连接数不够用呢？业务接入采用的是 hikaricp 连接池，这也是市面上流行度很高的一款组件了。我们随即检查了当前的连接池配置，如下：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//最小空闲连接数</span></span><br><span class="line">spring.datasource.hikari.minimum-idle=<span class="number">10</span></span><br><span class="line"><span class="comment">//连接池最大大小</span></span><br><span class="line">spring.datasource.hikari.maximum-pool-size=<span class="number">50</span></span><br><span class="line"><span class="comment">//连接最大空闲时长</span></span><br><span class="line">spring.datasource.hikari.idle-timeout=<span class="number">60000</span></span><br><span class="line"><span class="comment">//连接生命时长</span></span><br><span class="line">spring.datasource.hikari.max-lifetime=<span class="number">1800000</span></span><br><span class="line"><span class="comment">//获取连接的超时时长</span></span><br><span class="line">spring.datasource.hikari.connection-timeout=<span class="number">30000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中 注意到 hikari 连接池配置了 minimum-idle = 10，也就是说，就算在没有任何业务的情况下，连接池应该保证有 10 个连接。更何况当前的业务访问量极低，不应该存在连接数不够使用的情况。除此之外，另外一种可能性则可能是出现了“僵尸连接”，也就是说在重启的过程中，连接池一直没有释放这些不可用的连接，最终造成没有可用连接的结果。开发同学对”僵尸链接”的说法深信不疑，倾向性的认为这很可能是来自于 hikaricp 组件的某个 bug…于是开始走读 hikaricp 的源码，发现应用层向连接池请求连接的一处代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hikaripool</span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">//获取连接对象入口</span></span><br><span class="line">   <span class="keyword">public</span> connection <span class="title function_">getconnection</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> hardtimeout)</span> <span class="keyword">throws</span> sqlexception</span><br><span class="line">   &#123;</span><br><span class="line">      suspendresumelock.acquire();</span><br><span class="line">      <span class="keyword">final</span> <span class="type">long</span> <span class="variable">starttime</span> <span class="operator">=</span> currenttime();</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//使用预设的30s 超时时间</span></span><br><span class="line">         <span class="type">long</span> <span class="variable">timeout</span> <span class="operator">=</span> hardtimeout;</span><br><span class="line">         <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">//进入循环，在指定时间内获取可用连接</span></span><br><span class="line">            <span class="comment">//从 connectionbag 中获取连接</span></span><br><span class="line">            <span class="type">poolentry</span> <span class="variable">poolentry</span> <span class="operator">=</span> connectionbag.borrow(timeout, milliseconds);</span><br><span class="line">            <span class="keyword">if</span> (poolentry == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">break</span>; <span class="comment">// we timed out... break and throw exception</span></span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> currenttime();</span><br><span class="line">            <span class="comment">//连接对象被标记清除或不满足存活条件时，关闭该连接</span></span><br><span class="line">            <span class="keyword">if</span> (poolentry.ismarkedevicted() || (elapsedmillis(poolentry.lastaccessed, now) &gt; alivebypasswindowms &amp;&amp; !isconnectionalive(poolentry.connection))) &#123;</span><br><span class="line">               closeconnection(poolentry, poolentry.ismarkedevicted() ? evicted_connection_message : dead_connection_message);</span><br><span class="line">               timeout = hardtimeout - elapsedmillis(starttime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//成功获得连接对象</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               metricstracker.recordborrowstats(poolentry, starttime);</span><br><span class="line">               <span class="keyword">return</span> poolentry.createproxyconnection(leaktaskfactory.schedule(poolentry), now);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125; <span class="keyword">while</span> (timeout &gt; <span class="number">0l</span>);</span><br><span class="line"> </span><br><span class="line">         <span class="comment">//超时了，抛出异常</span></span><br><span class="line">         metricstracker.recordborrowtimeoutstats(starttime);</span><br><span class="line">         <span class="keyword">throw</span> createtimeoutexception(starttime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (interruptedexception e) &#123;</span><br><span class="line">         thread.currentthread().interrupt();</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">sqlexception</span>(poolname + <span class="string">&quot; - interrupted during connection acquisition&quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         suspendresumelock.release();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>  getconnection() 方法展示了获取连接的整个流程，其中 connectionbag 是用于存放连接对象的容器对象。如果从 connectionbag 获得的连接不再满足存活条件，那么会将其手动关闭，代码如下：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">closeconnection</span><span class="params">(<span class="keyword">final</span> poolentry poolentry, <span class="keyword">final</span> string closurereason)</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//移除连接对象</span></span><br><span class="line">      <span class="keyword">if</span> (connectionbag.remove(poolentry)) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">connection</span> <span class="variable">connection</span> <span class="operator">=</span> poolentry.close();</span><br><span class="line">         <span class="comment">//异步关闭连接</span></span><br><span class="line">         closeconnectionexecutor.execute(() -&gt; &#123;</span><br><span class="line">            quietlycloseconnection(connection, closurereason);</span><br><span class="line">            <span class="comment">//由于可用连接变少，将触发填充连接池的任务</span></span><br><span class="line">            <span class="keyword">if</span> (poolstate == pool_normal) &#123;</span><br><span class="line">               fillpool();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><pre><code>注意到，只有当连接满足下面条件中的其中一个时，会被执行 close。</code></pre><ul><li> ismarkedevicted() 的返回结果是 true，即标记为清除，如果连接存活时间超出最大生存时间(maxlifetime)，或者距离上一次使用超过了idletimeout，会被定时任务标记为清除状态，清除状态的连接在获取的时候才真正 close。</li><li> 500ms 内没有被使用，且连接已经不再存活，即 isconnectionalive() 返回 false</li></ul><p>由于我们把 idletimeout 和 maxlifetime 都设置得非常大，因此需重点检查 isconnectionalive 方法中的判断，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poolbase</span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">//判断连接是否存活</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isconnectionalive</span><span class="params">(<span class="keyword">final</span> connection connection)</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//设置 jdbc 连接的执行超时</span></span><br><span class="line">            setnetworktimeout(connection, validationtimeout);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">validationseconds</span> <span class="operator">=</span> (<span class="type">int</span>) math.max(<span class="number">1000l</span>, validationtimeout) / <span class="number">1000</span>;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//如果没有设置 testquery，使用 jdbc4 的校验接口</span></span><br><span class="line">            <span class="keyword">if</span> (isusejdbc4validation) &#123;</span><br><span class="line">               <span class="keyword">return</span> connection.isvalid(validationseconds);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//使用 testquery（如 select 1）语句对连接进行探测</span></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createstatement()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (isnetworktimeoutsupported != <span class="literal">true</span>) &#123;</span><br><span class="line">                  setquerytimeout(statement, validationseconds);</span><br><span class="line">               &#125;</span><br><span class="line"> </span><br><span class="line">               statement.execute(config.getconnectiontestquery());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">finally</span> &#123;</span><br><span class="line">            setnetworktimeout(connection, networktimeout);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (isisolateinternalqueries &amp;&amp; !isautocommit) &#123;</span><br><span class="line">               connection.rollback();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (exception e) &#123;</span><br><span class="line">         <span class="comment">//发生异常时，将失败信息记录到上下文</span></span><br><span class="line">         lastconnectionfailure.set(e);</span><br><span class="line">         logger.warn(<span class="string">&quot;&#123;&#125; - failed to validate connection &#123;&#125; (&#123;&#125;). possibly consider using a shorter maxlifetime value.&quot;</span>,</span><br><span class="line">                     poolname, connection, e.getmessage());</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>   我们看到，在poolbase.isconnectionalive 方法中对连接执行了一系列的探测，如果发生异常还会将异常信息记录到当前的线程上下文中。随后，在 hikaripool 抛出异常时会将最后一次检测失败的异常也一同收集，如下：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> sqlexception <span class="title function_">createtimeoutexception</span><span class="params">(<span class="type">long</span> starttime)</span></span><br><span class="line">&#123;</span><br><span class="line">   logpoolstate(<span class="string">&quot;timeout failure &quot;</span>);</span><br><span class="line">   metricstracker.recordconnectiontimeout();</span><br><span class="line"> </span><br><span class="line">   <span class="type">string</span> <span class="variable">sqlstate</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="comment">//获取最后一次连接失败的异常</span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">throwable</span> <span class="variable">originalexception</span> <span class="operator">=</span> getlastconnectionfailure();</span><br><span class="line">   <span class="keyword">if</span> (originalexception <span class="keyword">instanceof</span> sqlexception) &#123;</span><br><span class="line">      sqlstate = ((sqlexception) originalexception).getsqlstate();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//抛出异常</span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">sqlexception</span> <span class="variable">connectionexception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">sqltransientconnectionexception</span>(poolname + <span class="string">&quot; - connection is not available, request timed out after &quot;</span> + elapsedmillis(starttime) + <span class="string">&quot;ms.&quot;</span>, sqlstate, originalexception);</span><br><span class="line">   <span class="keyword">if</span> (originalexception <span class="keyword">instanceof</span> sqlexception) &#123;</span><br><span class="line">      connectionexception.setnextexception((sqlexception) originalexception);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">return</span> connectionexception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的异常消息和我们在业务服务中看到的异常日志基本上是吻合的，即除了超时产生的 “connection is not available, request timed out after xxxms” 消息之外，日志中还伴随输出了校验失败的信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">caused by: java.sql.sqlexception: connection.setnetworktimeout cannot be called on a closed connection</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.util.exceptions.exceptionmapper.getsqlexception(exceptionmapper.java:<span class="number">211</span>) ~[mariadb-java-client-<span class="number">2.2</span><span class="number">.6</span>.jar!/:?]</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.mariadbconnection.setnetworktimeout(mariadbconnection.java:<span class="number">1632</span>) ~[mariadb-java-client-<span class="number">2.2</span><span class="number">.6</span>.jar!/:?]</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.poolbase.setnetworktimeout(poolbase.java:<span class="number">541</span>) ~[hikaricp-<span class="number">2.7</span><span class="number">.9</span>.jar!/:?]</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.poolbase.isconnectionalive(poolbase.java:<span class="number">162</span>) ~[hikaricp-<span class="number">2.7</span><span class="number">.9</span>.jar!/:?]</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.hikaripool.getconnection(hikaripool.java:<span class="number">172</span>) ~[hikaricp-<span class="number">2.7</span><span class="number">.9</span>.jar!/:?]</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.hikaripool.getconnection(hikaripool.java:<span class="number">148</span>) ~[hikaricp-<span class="number">2.7</span><span class="number">.9</span>.jar!/:?]</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.hikaridatasource.getconnection(hikaridatasource.java:<span class="number">128</span>) ~[hikaricp-<span class="number">2.7</span><span class="number">.9</span>.jar!/:?]</span><br></pre></td></tr></table></figure><p>到这里，我们已经将应用获得连接的代码大致梳理了一遍，整个过程如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651115833161-81a5bf4d-46fb-48b7-9985-175d18fd3941.png#clientId=u7254b6cc-7da7-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=275&id=ue62f8238&margin=%5Bobject%20Object%5D&name=image.png&originHeight=313&originWidth=673&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22527&status=done&style=none&taskId=ua5895b10-27bc-4ed9-8920-f9f4639e23d&title=&width=591.5" alt="image.png"><br>       从执行逻辑上看，连接池的处理并没有问题，相反其在许多细节上都考虑到位了。在对非存活连接执行 close 时，同样调用了 removefrombag 动作将其从连接池中移除，因此也不应该存在僵尸连接对象的问题。那么，我们之前的推测应该就是错误的！</p><h3 id="2-2-陷入焦灼"><a href="#2-2-陷入焦灼" class="headerlink" title="2.2 陷入焦灼"></a>2.2 陷入焦灼</h3><p>在代码分析之余，开发同学也注意到当前使用的 hikaricp 版本为 3.4.5，而环境上出问题的业务服务却是 2.7.9 版本，这仿佛预示着什么… 让我们再次假设 hikaricp 2.7.9 版本存在某种未知的 bug，导致了问题的产生。<br>为了进一步分析连接池对于服务端故障的行为处理，我们尝试在本地机器上进行模拟，这一次使用了 hikaricp 2.7.9 版本进行测试，并同时将 hikaricp 的日志级别设置为 debug。<br>模拟场景中，会由 由本地应用程序连接本机的 mysql 数据库进行操作，步骤如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 初始化数据源，此时连接池 min-idle 设置为 <span class="number">10</span>；</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 每隔50ms 执行一次sql操作，查询当前的元数据表；</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 将 mysql 服务停止一段时间，观察业务表现；</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 将 mysql 服务重新启动，观察业务表现。</span><br></pre></td></tr></table></figure><p>最终产生的日志如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化过程，建立10个连接</span></span><br><span class="line"></span><br><span class="line">debug -hikaripool.logpoolstate - pool <span class="title function_">stats</span> <span class="params">(total=<span class="number">1</span>, active=<span class="number">1</span>, idle=<span class="number">0</span>, waiting=<span class="number">0</span>)</span></span><br><span class="line"></span><br><span class="line">debug -hikaripool$poolentrycreator.call- added connection mariadbconnection@71ab7c09</span><br><span class="line"></span><br><span class="line">debug -hikaripool$poolentrycreator.call- added connection mariadbconnection@7f6c9c4c</span><br><span class="line"></span><br><span class="line">debug -hikaripool$poolentrycreator.call- added connection mariadbconnection@7b531779</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">debug -hikaripool.logpoolstate- after adding <span class="title function_">stats</span> <span class="params">(total=<span class="number">10</span>, active=<span class="number">1</span>, idle=<span class="number">9</span>, waiting=<span class="number">0</span>)</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//执行业务操作，成功</span></span><br><span class="line"></span><br><span class="line">execute statement: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">test time -------<span class="number">1</span></span><br><span class="line"></span><br><span class="line">execute statement: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">test time -------<span class="number">2</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//停止mysql</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测到无效连接</span></span><br><span class="line"></span><br><span class="line">warn  -poolbase.isconnectionalive - failed to validate connection mariadbconnection@<span class="number">9225652</span> ((conn=<span class="number">38652</span>) </span><br><span class="line"></span><br><span class="line">connection.setnetworktimeout cannot be called on a closed connection). possibly consider using a shorter maxlifetime value.</span><br><span class="line"></span><br><span class="line">warn  -poolbase.isconnectionalive - failed to validate connection mariadbconnection@71ab7c09 ((conn=<span class="number">38653</span>) </span><br><span class="line"></span><br><span class="line">connection.setnetworktimeout cannot be called on a closed connection). possibly consider using a shorter maxlifetime value.</span><br><span class="line"></span><br><span class="line"><span class="comment">//释放连接</span></span><br><span class="line"></span><br><span class="line">debug -poolbase.quietlycloseconnection(poolbase.java:<span class="number">134</span>) - closing connection mariadbconnection@<span class="number">9225652</span>: (connection is dead) </span><br><span class="line"></span><br><span class="line">debug -poolbase.quietlycloseconnection(poolbase.java:<span class="number">134</span>) - closing connection mariadbconnection@71ab7c09: (connection is dead)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//尝试创建连接失败</span></span><br><span class="line"></span><br><span class="line">debug -hikaripool.createpoolentry - cannot acquire connection from data source</span><br><span class="line"></span><br><span class="line">java.sql.sqlnontransientconnectionexception: could not connect to address=(host=localhost)(port=<span class="number">3306</span>)(type=master) : </span><br><span class="line"></span><br><span class="line">socket fail to connect to host:localhost, port:<span class="number">3306.</span> connection refused: connect</span><br><span class="line"></span><br><span class="line">caused by: java.sql.sqlnontransientconnectionexception: socket fail to connect to host:localhost, port:<span class="number">3306.</span> connection refused: connect</span><br><span class="line"></span><br><span class="line">    at internal.util.exceptions.exceptionfactory.createexception(exceptionfactory.java:<span class="number">73</span>) ~[mariadb-java-client-<span class="number">2.6</span><span class="number">.0</span>.jar:?]</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//持续失败.. 直到mysql重启</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//重启后，自动创建连接成功</span></span><br><span class="line"></span><br><span class="line">debug -hikaripool$poolentrycreator.call -added connection mariadbconnection@42c5503e</span><br><span class="line"></span><br><span class="line">debug -hikaripool$poolentrycreator.call -added connection mariadbconnection@695a7435</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接池状态，重新建立10个连接</span></span><br><span class="line"></span><br><span class="line">debug -hikaripool.logpoolstate(hikaripool.java:<span class="number">421</span>) -after adding <span class="title function_">stats</span> <span class="params">(total=<span class="number">10</span>, active=<span class="number">1</span>, idle=<span class="number">9</span>, waiting=<span class="number">0</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//执行业务操作，成功（已经自愈）</span></span><br><span class="line"></span><br><span class="line">execute statement: <span class="literal">true</span></span><br></pre></td></tr></table></figure><pre><code>  从日志上看，hikaricp 还是能成功检测到坏死的连接并将其踢出连接池，一旦 mysql 重新启动，业务操作又能自动恢复成功了。根据这个结果，基于 hikaricp 版本问题的设想也再次落空，研发同学再次陷入焦灼。</code></pre><h3 id="2-3-拨开云雾见光明"><a href="#2-3-拨开云雾见光明" class="headerlink" title="2.3 拨开云雾见光明"></a>2.3 拨开云雾见光明</h3><p>多方面求证无果之后，我们最终尝试在业务服务所在的容器内进行抓包，看是否能发现一些蛛丝马迹。<br>进入故障容器，执行_tcpdump -i eth0 tcp port 30052_进行抓包，然后对业务接口发起访问。<br>此时令人诡异的事情发生了，没有任何网络包产生！而业务日志在 30s 之后也出现了获取连接失败的异常。<br>我们通过 netstat 命令检查网络连接，发现只有一个 established 状态的 tcp 连接。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651115938675-b4c2c525-7fc4-4b79-91c6-191a7e866eba.png#clientId=u7254b6cc-7da7-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=26&id=ueb7db788&margin=%5Bobject%20Object%5D&name=image.png&originHeight=35&originWidth=647&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7198&status=done&style=none&taskId=u82a18b53-9916-4a05-9034-743712d19e8&title=&width=474.5" alt="image.png"><br>也就是说，当前业务实例和 mysql 服务端是存在一个建好的连接的，但为什么业务还是报出可用连接呢？<br>推测可能原因有二：</p><ul><li> 该连接被某个业务（如定时器）一直占用。</li><li> 该连接实际上还没有办法使用，可能处于某种僵死的状态。</li></ul><p>对于原因一，很快就可以被推翻，一来当前服务并没有什么定时器任务，二来就算该连接被占用，按照连接池的原理，只要没有达到上限，新的业务请求应该会促使连接池进行新连接的建立，那么无论是从 netstat 命令检查还是 tcpdump 的结果来看，不应该一直是只有一个连接的状况。<br>那么，情况二的可能性就很大了。带着这个思路，继续分析 java 进程的线程栈。<br>执行 kill -3 pid 将线程栈输出后分析，果不其然，在当前 thread stack 中发现了如下的条目：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;hikaripool-1 connection adder&quot;</span> #<span class="number">121</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f1300021800</span> nid=<span class="number">0xad</span> runnable [<span class="number">0x00007f12d82e5000</span>]</span><br><span class="line"></span><br><span class="line">   java.lang.thread.state: runnable</span><br><span class="line"></span><br><span class="line">    at java.net.socketinputstream.socketread0(<span class="keyword">native</span> method)</span><br><span class="line"></span><br><span class="line">    at java.net.socketinputstream.socketread(socketinputstream.java:<span class="number">116</span>)</span><br><span class="line"></span><br><span class="line">    at java.net.socketinputstream.read(socketinputstream.java:<span class="number">171</span>)</span><br><span class="line"></span><br><span class="line">    at java.net.socketinputstream.read(socketinputstream.java:<span class="number">141</span>)</span><br><span class="line"></span><br><span class="line">    at java.io.filterinputstream.read(filterinputstream.java:<span class="number">133</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.io.input.readaheadbufferedstream.fillbuffer(readaheadbufferedstream.java:<span class="number">129</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.io.input.readaheadbufferedstream.read(readaheadbufferedstream.java:<span class="number">102</span>)</span><br><span class="line"></span><br><span class="line">    - locked &lt;<span class="number">0x00000000d7f5b480</span>&gt; (a org.mariadb.jdbc.internal.io.input.readaheadbufferedstream)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.io.input.standardpacketinputstream.getpacketarray(standardpacketinputstream.java:<span class="number">241</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.io.input.standardpacketinputstream.getpacket(standardpacketinputstream.java:<span class="number">212</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.com.read.readinitialhandshakepacket.&lt;init&gt;(readinitialhandshakepacket.java:<span class="number">90</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.protocol.abstractconnectprotocol.createconnection(abstractconnectprotocol.java:<span class="number">480</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.protocol.abstractconnectprotocol.connectwithoutproxy(abstractconnectprotocol.java:<span class="number">1236</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.internal.util.utils.retrieveproxy(utils.java:<span class="number">610</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.mariadbconnection.newconnection(mariadbconnection.java:<span class="number">142</span>)</span><br><span class="line"></span><br><span class="line">    at org.mariadb.jdbc.driver.connect(driver.java:<span class="number">86</span>)</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.util.driverdatasource.getconnection(driverdatasource.java:<span class="number">138</span>)</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.poolbase.newconnection(poolbase.java:<span class="number">358</span>)</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.poolbase.newpoolentry(poolbase.java:<span class="number">206</span>)</span><br><span class="line"></span><br><span class="line">    at com.zaxxer.hikari.pool.hikaripool.createpoolentry(hikaripool.java:<span class="number">477</span>)</span><br></pre></td></tr></table></figure><p>这里显示hikaripool-1 connection adder这个线程一直处于 socketread 的可执行状态。从命名上看该线程应该是 hikaricp 连接池用于建立连接的任务线程，socket 读操作则来自于 mariadbconnection.newconnection() 这个方法，即 mariadb-java-client 驱动层建立 mysql 连接的一个操作，其中 readinitialhandshakepacket 初始化则属于 mysql 建链协议中的一个环节。<br>简而言之，上面的线程刚好处于建链的一个过程态，关于 mariadb 驱动和 mysql 建链的过程大致如下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651115971011-d3e4acf2-0f89-4c0c-ab43-a1690fab334a.png#clientId=u7254b6cc-7da7-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=172&id=ua1d502b9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=344&originWidth=350&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15361&status=done&style=none&taskId=uf80b57a0-92e0-47f9-8e97-8082322adac&title=&width=175" alt="image.png"><br>mysql 建链首先是建立 tcp 连接（三次握手），客户端会读取 mysql 协议的一个初始化握手消息包，内部包含 mysql 版本号，鉴权算法等等信息，之后再进入身份鉴权的环节。<br>这里的问题就在于 readinitialhandshakepacket 初始化（读取握手消息包）一直处于 socket read 的一个状态。<br>如果此时 mysql 远端主机故障了，那么该操作就会一直卡住。而此时的连接虽然已经建立（处于 established 状态），但却一直没能完成协议握手和后面的身份鉴权流程，即该连接只能算一个半成品（无法进入 hikaricp 连接池的列表中）。从故障服务的 debug 日志也可以看到，连接池持续是没有可用连接的，如下：<br>debug hikaripool.logpoolstate –&gt; before cleanup stats (total=0, active=0, idle=0, waiting=3)<br>另一个需要解释的问题则是，这样一个 socket read 操作的阻塞是否就造成了整个连接池的阻塞呢？<br>经过代码走读，我们再次梳理了 hikaricp 建立连接的一个流程，其中涉及到几个模块：</p><ul><li> hikaripool，连接池实例，由该对象连接的获取、释放以及连接的维护。</li><li> connectionbag，连接对象容器，存放当前的连接对象列表，用于提供可用连接。</li><li> addconnectionexecutor，添加连接的执行器，命名如 “hikaripool-1 connection adder”，是一个单线程的线程池。</li><li> poolentrycreator，添加连接的任务，实现创建连接的具体逻辑。</li><li> housekeeper，内部定时器，用于实现连接的超时淘汰、连接池的补充等工作。</li></ul><p>housekeeper 在连接池初始化后的 100ms 触发执行，其调用 fillpool() 方法完成连接池的填充，例如 min-idle 是10，那么初始化就会创建10个连接。connectionbag 维护了当前连接对象的列表，该模块还维护了请求连接者(waiters)的一个计数器，用于评估当前连接数的需求。<br>其中，borrow 方法的逻辑如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> t <span class="title function_">borrow</span><span class="params">(<span class="type">long</span> timeout, <span class="keyword">final</span> timeunit timeunit)</span> <span class="keyword">throws</span> interruptedexception</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">// 尝试从 thread-local 中获取</span></span><br><span class="line">      <span class="keyword">final</span> list&lt;object&gt; list = threadlist.get();</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> list.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">         ...</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 计算当前等待请求的任务</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">int</span> <span class="variable">waiting</span> <span class="operator">=</span> waiters.incrementandget();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">for</span> (t bagentry : sharedlist) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bagentry.compareandset(state_not_in_use, state_in_use)) &#123;</span><br><span class="line">               <span class="comment">//如果获得了可用连接，会触发填充任务</span></span><br><span class="line">               <span class="keyword">if</span> (waiting &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                  listener.addbagitem(waiting - <span class="number">1</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> bagentry;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         <span class="comment">//没有可用连接，先触发填充任务</span></span><br><span class="line">         listener.addbagitem(waiting);</span><br><span class="line"> </span><br><span class="line">         <span class="comment">//在指定时间内等待可用连接进入</span></span><br><span class="line">         timeout = timeunit.tonanos(timeout);</span><br><span class="line">         <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> currenttime();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">t</span> <span class="variable">bagentry</span> <span class="operator">=</span> handoffqueue.poll(timeout, nanoseconds);</span><br><span class="line">            <span class="keyword">if</span> (bagentry == <span class="literal">null</span> || bagentry.compareandset(state_not_in_use, state_in_use)) &#123;</span><br><span class="line">               <span class="keyword">return</span> bagentry;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            timeout -= elapsednanos(start);</span><br><span class="line">         &#125; <span class="keyword">while</span> (timeout &gt; <span class="number">10_000</span>);</span><br><span class="line"> </span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         waiters.decrementandget();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>注意到，无论是有没有可用连接，该方法都会触发一个 listener.addbagitem() 方法，hikaripool 对该接口的实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addbagitem</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> waiting)</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">shouldadd</span> <span class="operator">=</span> waiting - addconnectionqueuereadonlyview.size() &gt;= <span class="number">0</span>; <span class="comment">// yes, &gt;= is intentional.</span></span><br><span class="line">      <span class="keyword">if</span> (shouldadd) &#123;</span><br><span class="line">         <span class="comment">//调用 addconnectionexecutor 提交创建连接的任务</span></span><br><span class="line">         addconnectionexecutor.submit(poolentrycreator);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;&#123;&#125; - add connection elided, waiting &#123;&#125;, queue &#123;&#125;&quot;</span>, poolname, waiting, addconnectionqueuereadonlyview.size());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">poolentrycreator 则实现了创建连接的具体逻辑，如下：</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poolentrycreator</span>&#123;</span><br><span class="line">     <span class="meta">@override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">call</span><span class="params">()</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="type">long</span> <span class="variable">sleepbackoff</span> <span class="operator">=</span> <span class="number">250l</span>;</span><br><span class="line">         <span class="comment">//判断是否需要建立连接</span></span><br><span class="line">         <span class="keyword">while</span> (poolstate == pool_normal &amp;&amp; shouldcreateanotherconnection()) &#123;</span><br><span class="line">            <span class="comment">//创建 mysql 连接</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">poolentry</span> <span class="variable">poolentry</span> <span class="operator">=</span> createpoolentry();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (poolentry != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="comment">//建立连接成功，直接返回。</span></span><br><span class="line">               connectionbag.add(poolentry);</span><br><span class="line">               logger.debug(<span class="string">&quot;&#123;&#125; - added connection &#123;&#125;&quot;</span>, poolname, poolentry.connection);</span><br><span class="line">               <span class="keyword">if</span> (loggingprefix != <span class="literal">null</span>) &#123;</span><br><span class="line">                  logpoolstate(loggingprefix);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="type">boolean</span>.<span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         <span class="comment">// pool is suspended or shutdown or at max size</span></span><br><span class="line">         <span class="keyword">return</span> <span class="type">boolean</span>.<span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>    由此可见，addconnectionexecutor 采用了单线程的设计，当产生新连接需求时，会异步触发 poolentrycreator 任务进行补充。其中 poolentrycreator. createpoolentry() 会完成 mysql 驱动连接建立的所有事情，而我们的情况则恰恰是mysql 建链过程产生了永久性阻塞。因此无论后面怎么获取连接，新来的建链任务都会一直排队等待，这便导致了业务上一直没有连接可用。</code></pre><p>下面这个图说明了 hikaricp 的建链过程：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651116036818-7a6e1c0e-f002-44e7-a189-66c840840795.png#clientId=u7254b6cc-7da7-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=182&id=ubcb6ae8c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=291&originWidth=850&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33936&status=done&style=none&taskId=uf133067f-59a2-40aa-99c3-53be781dc4e&title=&width=531" alt="image.png"><br>         好了，让我们在回顾一下前面关于可靠性测试的场景：<br>首先，mysql 主实例发生故障，而紧接着 hikaricp 则检测到了坏的连接(connection is dead)并将其释放，在释放关闭连接的同时又发现连接数需要补充，进而立即触发了新的建链请求。<br>而问题就刚好出在这一次建链请求上，tcp 握手的部分是成功了（客户端和 mysql vm 上 nodeport 完成连接），但在接下来由于当前的 mysql 容器已经停止（此时 vip 也切换到了另一台 mysql 实例上），因此客户端再也无法获得原 mysql 实例的握手包响应（该握手属于mysql应用层的协议），此时便陷入了长时间的阻塞式 socketread 操作。而建链请求任务恰恰好采用了单线程运作，进一步则导致了所有业务的阻塞。</p><h2 id="3-解决方案"><a href="#3-解决方案" class="headerlink" title="3.解决方案"></a>3.解决方案</h2><p>在了解了事情的来龙去脉之后，我们主要考虑从两方面进行优化：</p><ul><li> 优化一，增加 hirakipool 中 addconnectionexecutor 线程的数量，这样即使第一个线程出现挂死，还有其他的线程能参与建链任务的分配。</li><li> 优化二，出问题的 socketread 是一种同步阻塞式的调用，可通过 so_timeout 来避免长时间挂死。</li></ul><p>对于优化点一，我们一致认为用处并不大，如果连接出现了挂死那么相当于线程资源已经泄露，对服务后续的稳定运行十分不利，而且 hikaricp 在这里也已经将其写死了。因此关键的方案还是避免阻塞式的调用。<br>查阅了 mariadb-java-client 官方文档后，发现可以在 jdbc url 中指定网络io 的超时参数，如下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651116071903-125a3222-ffd6-4ef1-a209-b61138f7dba1.png#clientId=u7254b6cc-7da7-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=150&id=u4d014a28&margin=%5Bobject%20Object%5D&name=image.png&originHeight=300&originWidth=1178&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46146&status=done&style=none&taskId=uebc1b35e-4760-4e97-a55f-5a7ba427cd6&title=&width=589" alt="image.png"><br>具体参考：<a href="https://mariadb.com/kb/en/about-mariadb-connector-j/">https://mariadb.com/kb/en/about-mariadb-connector-j/</a><br>如描述所说的，sockettimeout 可以设置 socket 的 so_timeout 属性，从而达到控制超时时间的目的。默认是 0，即不超时。<br>我们在 mysql jdbc url 中加入了相关的参数，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">spring.datasource.url=jdbc:mysql:<span class="comment">//10.0.71.13:33052/appdb?sockettimeout=60000&amp;connecttimeout=30000&amp;servertimezone=utc</span></span><br></pre></td></tr></table></figure><p>此后对 mysql 可靠性场景进行多次验证，发现连接挂死的现象已经不再出现，此时问题得到解决。</p><h3 id="3-1-解决示例"><a href="#3-1-解决示例" class="headerlink" title="3.1 解决示例"></a>3.1 解决示例</h3><ul><li><p>未开启timeout</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="comment">//testdb.com:3306/app000000?useUnicode=yes&amp;charset=utf8mb4&amp;collation=utf8mb4_general_ci</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651117210644-d6a3f8cc-43ae-4a93-ad25-8c71e3363d3b.png#clientId=u8f11f2f5-2078-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=241&id=u720af2b7&margin=%5Bobject%20Object%5D&name=257ba1ce0ad9cf0f77e78eecb45a022e.png&originHeight=482&originWidth=1705&originalType=binary&ratio=1&rotation=0&showTitle=false&size=199589&status=done&style=none&taskId=u8d80f25a-8a79-439f-b7ea-f905ea097e7&title=&width=852.5" alt="257ba1ce0ad9cf0f77e78eecb45a022e.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">wuhaocn-rongcloud-macbook:web-app wuhao$ jstack <span class="number">72303</span> </span><br><span class="line"><span class="number">2022</span>-<span class="number">04</span>-<span class="number">29</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">53</span></span><br><span class="line">Full thread dump Java <span class="title function_">HotSpot</span><span class="params">(TM)</span> <span class="number">64</span>-Bit Server <span class="title function_">VM</span> <span class="params">(<span class="number">25.231</span>-b11 mixed mode)</span>:</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Attach Listener&quot;</span> #<span class="number">88</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007f819d97b000</span> nid=<span class="number">0x9777</span> waiting on condition [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;HikariPool-2 housekeeper&quot;</span> #<span class="number">47</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007f819802c000</span> nid=<span class="number">0x8503</span> waiting on condition [<span class="number">0x000070000e329000</span>]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0x000000074067e0a8</span>&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:<span class="number">215</span>)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:<span class="number">2078</span>)</span><br><span class="line">at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:<span class="number">1093</span>)</span><br><span class="line">at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:<span class="number">809</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:<span class="number">1074</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1134</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;db_pool_factory_0&quot;</span> #<span class="number">46</span> prio=<span class="number">5</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007f8199156800</span> nid=<span class="number">0x8803</span> waiting on condition [<span class="number">0x000070000e226000</span>]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0x00000007401f6558</span>&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.park(LockSupport.java:<span class="number">175</span>)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:<span class="number">2039</span>)</span><br><span class="line">at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:<span class="number">442</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:<span class="number">1074</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1134</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;HikariPool-1 housekeeper&quot;</span> #<span class="number">43</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007f8196c4d000</span> nid=<span class="number">0x8b03</span> waiting on condition [<span class="number">0x000070000df1d000</span>]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0x000000074067e288</span>&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:<span class="number">215</span>)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:<span class="number">2078</span>)</span><br><span class="line">at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:<span class="number">1093</span>)</span><br><span class="line">at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:<span class="number">809</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:<span class="number">1074</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1134</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Abandoned connection cleanup thread&quot;</span> #<span class="number">42</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007f81962dd000</span> nid=<span class="number">0x7203</span> in Object.wait() [<span class="number">0x000070000de1a000</span>]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (on object monitor)</span><br><span class="line">at java.lang.Object.wait(Native Method)</span><br><span class="line">at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:<span class="number">144</span>)</span><br><span class="line">- locked &lt;<span class="number">0x00000007401f5ae8</span>&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">at com.mysql.jdbc.AbandonedConnectionCleanupThread.run(AbandonedConnectionCleanupThread.java:<span class="number">41</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>开启timeout</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="comment">//testdb.com:3306/app000000?sockettimeout=60000&amp;connecttimeout=30000&amp;useUnicode=yes&amp;charset=utf8mb4&amp;collation=utf8mb4_general_ci</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/png/804884/1651117219754-bd7b763c-c3a2-4369-98e4-2917c39f5b67.png#clientId=u8f11f2f5-2078-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=157&id=ubcdbfc85&margin=%5Bobject%20Object%5D&name=6a7ed567d5c5f1b841491abfd82daf3e.png&originHeight=313&originWidth=1672&originalType=binary&ratio=1&rotation=0&showTitle=false&size=139687&status=done&style=none&taskId=u94163a31-bfc7-46a3-9a0b-b84eceab2c8&title=&width=836" alt="6a7ed567d5c5f1b841491abfd82daf3e.png"></p><h2 id="4-小结"><a href="#4-小结" class="headerlink" title="4.小结"></a>4.小结</h2><p>本次分享了一次关于 mysql 连接挂死问题排查的心路历程，由于环境搭建的工作量巨大，而且该问题复现存在偶然性，整个分析过程还是有些坎坷的（其中也踩了坑）。的确，我们很容易被一些表面的现象所迷惑，而觉得问题很难解决时，更容易带着偏向性思维去处理问题。例如本例中曾一致认为连接池出现了问题，但实际上却是由于 mysql jdbc 驱动（mariadb driver）的一个不严谨的配置所导致。<br>从原则上讲，应该避免一切可能导致资源挂死的行为。如果我们能在前期对代码及相关配置做好充分的排查工作，相信 996 就会离我们越来越远。<br>以上就是详解mysql连接挂死的原因的详细内容，更多关于mysql连接挂死的原因的资料请关注服务器之家其它相关文章！</p><h2 id="5-参考"><a href="#5-参考" class="headerlink" title="5.参考"></a>5.参考</h2><p><a href="http://www.zzvips.com/article/176926.html">详解MySQL连接挂死的原因</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-背景&quot;&gt;&lt;a href=&quot;#1-背景&quot; class=&quot;headerlink&quot; title=&quot;1.背景&quot;&gt;&lt;/a&gt;1.背景&lt;/h2&gt;&lt;p&gt;近期由测试反馈的问题有点多，其中关于系统可靠性测试提出的问题令人感到头疼，一来这类问题有时候属于“偶发”现象，难以在环境上快</summary>
      
    
    
    
    <category term="MySQL" scheme="https://wuhaocn.github.io/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="https://wuhaocn.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>TCP状态概述.md</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/tcp/TCP%E7%8A%B6%E6%80%81%E6%A6%82%E8%BF%B0/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/tcp/TCP%E7%8A%B6%E6%80%81%E6%A6%82%E8%BF%B0/</id>
    <published>2023-11-15T03:40:25.016Z</published>
    <updated>2023-11-15T03:40:25.016Z</updated>
    
    <content type="html"><![CDATA[<h2 id="RST产生的原因"><a href="#RST产生的原因" class="headerlink" title="RST产生的原因"></a>RST产生的原因</h2><h3 id="原因概述"><a href="#原因概述" class="headerlink" title="原因概述"></a>原因概述</h3><p>正常情况tcp四层握手关闭连接，rst基本都是异常情况，整理如下：</p><ul><li><p>GFW</p></li><li><p>对方端口未打开，发生在连接建立<br>  如果端口打开，只是sync_backlog满了的话，sync简单被丢弃，表现为超时，而不会rst。</p></li><li><p>Close Socket 时recv buffer 不为空<br>  例如，客户端发了两个请求，服务器只从buffer 读取第一个请求处理完就关闭连接，tcp层认为数据没有正确提交到应用，使用rst关闭连接。</p></li><li><p>移动链路<br> 移动网络下，国内是有5分钟后就回收信令，也就是IM产品，如果心跳&gt;5分钟后服务器再给客户端发消息，就会收到rst。也要查移动网络下IM 保持&lt;5min 心跳。</p></li><li><p>负载等设备<br>  负载设备需要维护连接转发策略，长时间无流量，连接也会被清除，而且很多都不告诉两层机器，新的包过来时才通告rst。<br>  Apple Push 服务也有这个问题，而且是不可预期的偶发性连接被rst；rst 前第一个消息write 是成功的，而第二条写才会告诉你连接被重置，<br>  曾经被它折腾没辙，因此打开每2秒一次tcp keepalive，固定5分钟tcp连接回收，而且发现连接出错时，重发之前10s内消息。</p></li><li><p>SO_LINGER<br> 同第三条，默认SO_LINGER选项关闭， 直接丢弃未发送完毕的send buffer，并发送rst，业务上表示为对端数据未收到；<br> 建议打开，但在linger time 内仍然未将buffer发送完，那依然发送rst。<br> 好像曾经测试过haproxy 某种配置下，会使用rst关闭连接，少了网络交互而且没有 TIME_WAIT 问题</p></li><li><p>超过超时重传次数、网络暂时不可达</p></li><li><p>TIME_WAIT 状态<br>tw_recycle = 1 时，sync timestamps 比上次小时，会被rst</p></li><li><p>设置 connect_timeout<br>应用设置了连接超时，sync 未完成时超时了，会发送rst终止连接。</p></li><li><p>非正常包<br> 连接已经关闭，seq 不正确等</p></li><li><p>keepalive 超时<br>公网服务tcp keepalive 最好别打开；移动网络下会增加网络负担，切容易掉线；非移动网络核心ISP设备也不一定都支持keepalive，曾经也发现过广州那边有个核心节点就不支持。</p></li></ul><h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><ul><li>业务表现：业务监控偶现超时，客户端连接服务端偶现被掐掉连接（服务端返回fin）</li><li>网络链路：lb1-&gt;nginx-&gt;lb2-&gt;服务</li><li>问题分析<ul><li>查询nginx日志及监控正常</li><li>查询服务日志及监控正常</li><li>业务量变化：前一天出现一波业务高峰，现状观察服务水位线处于安全水位</li><li>根据现有状态未发现明显问题</li></ul></li><li>现场复现<ul><li>模拟请求</li><li>发现客户端已经发到平台但没有到服务器，出现部分请求丢失</li><li>进行链路抓包<ul><li>发现lb2分别给nginx及服务发了rst</li><li>经过排查定位到lb2超时时间设置过长造成连接未及时清理</li></ul></li><li>缩短超时时间即可</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;RST产生的原因&quot;&gt;&lt;a href=&quot;#RST产生的原因&quot; class=&quot;headerlink&quot; title=&quot;RST产生的原因&quot;&gt;&lt;/a&gt;RST产生的原因&lt;/h2&gt;&lt;h3 id=&quot;原因概述&quot;&gt;&lt;a href=&quot;#原因概述&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    <category term="TCP" scheme="https://wuhaocn.github.io/categories/TCP/"/>
    
    
    <category term="TCP" scheme="https://wuhaocn.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>TCP的3次握手与4次挥手简介</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/tcp/TCP%E7%9A%843%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%B8%8E4%E6%AC%A1%E6%8C%A5%E6%89%8B%E8%AF%A6%E8%A7%A3/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/tcp/TCP%E7%9A%843%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%B8%8E4%E6%AC%A1%E6%8C%A5%E6%89%8B%E8%AF%A6%E8%A7%A3/</id>
    <published>2023-11-15T03:40:25.016Z</published>
    <updated>2023-11-15T03:40:25.016Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TCP的3次握手与4次挥手简介"><a href="#TCP的3次握手与4次挥手简介" class="headerlink" title="TCP的3次握手与4次挥手简介"></a>TCP的3次握手与4次挥手简介</h2><p>TCP是一种面向连接的单播协议，在发送数据前，通信双方必须在彼此间建立一条连接。所谓的“连接”，其实是客户端和服务器的内存里保存的一份关于对方的信息，如ip地址、端口号等。<br>TCP可以看成是一种字节流，它会处理IP层或以下的层的丢包、重复以及错误问题。在连接的建立过程中，双方需要交换一些连接的参数。这些参数可以放在TCP头部。<br>TCP提供了一种可靠、面向连接、字节流、传输层的服务，采用三次握手建立一个连接。采用4次挥手来关闭一个连接。</p><h2 id="TCP服务模型"><a href="#TCP服务模型" class="headerlink" title="TCP服务模型"></a>TCP服务模型</h2><p>在了解了建立连接、关闭连接的“三次握手和四次挥手”后，我们再来看下TCP相关的东西。<br>一个TCP连接由一个4元组构成，分别是两个IP地址和两个端口号。一个TCP连接通常分为三个阶段：启动、数据传输、退出（关闭）。<br>当TCP接收到另一端的数据时，它会发送一个确认，但这个确认不会立即发送，一般会延迟一会儿。ACK是累积的，一个确认字节号N的ACK表示所有直到N的字节（不包括N）已经成功被接收了。这样的好处是如果一个ACK丢失，很可能后续的ACK就足以确认前面的报文段了。<br>一个完整的TCP连接是双向和对称的，数据可以在两个方向上平等地流动。给上层应用程序提供一种双工服务。一旦建立了一个连接，这个连接的一个方向上的每个TCP报文段都包含了相反方向上的报文段的一个ACK。<br>序列号的作用是使得一个TCP接收端可丢弃重复的报文段，记录以杂乱次序到达的报文段。因为TCP使用IP来传输报文段，而IP不提供重复消除或者保证次序正确的功能。另一方面，TCP是一个字节流协议，绝不会以杂乱的次序给上层程序发送数据。因此TCP接收端会被迫先保持大序列号的数据不交给应用程序，直到缺失的小序列号的报文段被填满。</p><h2 id="TCP头部"><a href="#TCP头部" class="headerlink" title="TCP头部"></a>TCP头部</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203482542-8e9be091-f373-476b-8a8f-fff7c2d4a1e0.webp#averageHue=%23edeceb&clientId=u71165853-2e09-4&from=paste&id=u2b19d619&originHeight=463&originWidth=1240&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u37d837a5-7ae3-4c37-bd85-f610086377a&title="><br>源端口和目的端口在TCP层确定双方进程，序列号表示的是报文段数据中的第一个字节号，ACK表示确认号，该确认号的发送方期待接收的下一个序列号，即最后被成功接收的数据字节序列号加1，这个字段只有在ACK位被启用的时候才有效。<br>当新建一个连接时，从客户端发送到服务端的第一个报文段的SYN位被启用，这称为SYN报文段，这时序列号字段包含了在本次连接的这个方向上要使用的第一个序列号，即初始序列号ISN，之后发送的数据是ISN加1，因此SYN位字段会消耗一个序列号，这意味着使用重传进行可靠传输。而不消耗序列号的ACK则不是。<br>头部长度（图中的数据偏移）以32位字为单位，也就是以4bytes为单位，它只有4位，最大为15，因此头部最大长度为60字节，而其最小为5，也就是头部最小为20字节（可变选项为空）。<br>ACK —— 确认，使得确认号有效。 RST —— 重置连接（经常看到的reset by peer）就是此字段搞的鬼。 SYN —— 用于初如化一个连接的序列号。<br>FIN —— 该报文段的发送方已经结束向对方发送数据。<br>当一个连接被建立或被终止时，交换的报文段只包含TCP头部，而没有数据。</p><h2 id="状态转换"><a href="#状态转换" class="headerlink" title="状态转换"></a>状态转换</h2><p>三次握手和四次挥手的状态转换如下图。<br><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203482546-cd4b4f84-bc61-47ea-8c7c-b6b1ca1748e4.webp#averageHue=%23f3f3f2&clientId=u71165853-2e09-4&from=paste&id=u16cc0af7&originHeight=1362&originWidth=958&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u3d3dbee3-4d85-4000-9aef-8e419e0f8bc&title="></p><h2 id="为什么要“三次握手，四次挥手”"><a href="#为什么要“三次握手，四次挥手”" class="headerlink" title="为什么要“三次握手，四次挥手”"></a>为什么要“三次握手，四次挥手”</h2><h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p>换个易于理解的视角来看为什么要3次握手。<br>客户端和服务端通信前要进行连接，“3次握手”的作用就是双方都能明确自己和对方的收、发能力是正常的。<br>第一次握手：客户端发送网络包，服务端收到了。这样服务端就能得出结论：客户端的发送能力、服务端的接收能力是正常的。<br>第二次握手：服务端发包，客户端收到了。这样客户端就能得出结论：服务端的接收、发送能力，客户端的接收、发送能力是正常的。<br>从客户端的视角来看，我接到了服务端发送过来的响应数据包，说明服务端接收到了我在第一次握手时发送的网络包，并且成功发送了响应数据包，这就说明，服务端的接收、发送能力正常。而另一方面，我收到了服务端的响应数据包，说明我第一次发送的网络包成功到达服务端，这样，我自己的发送和接收能力也是正常的。<br>第三次握手：客户端发包，服务端收到了。这样服务端就能得出结论：客户端的接收、发送能力，服务端的发送、接收能力是正常的。<br>第一、二次握手后，服务端并不知道客户端的接收能力以及自己的发送能力是否正常。而在第三次握手时，服务端收到了客户端对第二次握手作的回应。从服务端的角度，我在第二次握手时的响应数据发送出去了，客户端接收到了。所以，我的发送能力是正常的。而客户端的接收能力也是正常的。<br>经历了上面的三次握手过程，客户端和服务端都确认了自己的接收、发送能力是正常的。之后就可以正常通信了。<br>每次都是接收到数据包的一方可以得到一些结论，发送的一方其实没有任何头绪。我虽然有发包的动作，但是我怎么知道我有没有发出去，而对方有没有接收到呢？<br>而从上面的过程可以看到，最少是需要三次握手过程的。两次达不到让双方都得出自己、对方的接收、发送能力都正常的结论。其实每次收到网络包的一方至少是可以得到：对方的发送、我方的接收是正常的。而每一步都是有关联的，下一次的“响应”是由于第一次的“请求”触发，因此每次握手其实是可以得到额外的结论的。比如第三次握手时，服务端收到数据包，表明看服务端只能得到客户端的发送能力、服务端的接收能力是正常的，但是结合第二次，说明服务端在第二次发送的响应包，客户端接收到了，并且作出了响应，从而得到额外的结论：客户端的接收、服务端的发送是正常的。<br>用表格总结一下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/804884/1676203482484-1b2a9640-2bb0-4ec3-ac42-14b03f7a4e60.png#averageHue=%23f6f7f3&clientId=u71165853-2e09-4&from=paste&id=u73802da8&originHeight=258&originWidth=1730&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u576dea56-06e9-4812-b006-e4892fbfc55&title="></p><h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p>TCP连接是双向传输的对等的模式，就是说双方都可以同时向对方发送或接收数据。当有一方要关闭连接时，会发送指令告知对方，我要关闭连接了。这时对方会回一个ACK，此时一个方向的连接关闭。但是另一个方向仍然可以继续传输数据，等到发送完了所有的数据后，会发送一个FIN段来关闭此方向上的连接。接收方发送ACK确认关闭连接。注意，接收到FIN报文的一方只能回复一个ACK,<br>它是无法马上返回对方一个FIN报文段的，因为结束数据传输的“指令”是上层应用层给出的，我只是一个“搬运工”，我无法了解“上层的意志”。</p><h2 id="“三次握手，四次挥手”怎么完成？"><a href="#“三次握手，四次挥手”怎么完成？" class="headerlink" title="“三次握手，四次挥手”怎么完成？"></a>“三次握手，四次挥手”怎么完成？</h2><p>其实3次握手的目的并不只是让通信双方都了解到一个连接正在建立，还在于利用数据包的选项来传输特殊的信息，交换初始序列号ISN。<br>3次握手是指发送了3个报文段，4次挥手是指发送了4个报文段。注意，SYN和FIN段都是会利用重传进行可靠传输的。</p><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203482530-3f4ccd63-1ba7-491a-85d5-9bd65486aa66.webp#averageHue=%23f9f8f8&clientId=u71165853-2e09-4&from=paste&id=u18821e21&originHeight=513&originWidth=982&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u835481d8-0daa-486e-9f63-10b14451f9f&title="></p><h2 id="三次握手-1"><a href="#三次握手-1" class="headerlink" title="三次握手"></a>三次握手</h2><ol><li>客户端发送一个SYN段，并指明客户端的初始序列号，即ISN(c).</li><li>服务端发送自己的SYN段作为应答，同样指明自己的ISN(s)。为了确认客户端的SYN，将ISN(c)+1作为ACK数值。这样，每发送一个SYN，序列号就会加1.<br>如果有丢失的情况，则会重传。</li><li>为了确认服务器端的SYN，客户端将ISN(s)+1作为返回的ACK数值。</li></ol><h2 id="四次挥手-1"><a href="#四次挥手-1" class="headerlink" title="四次挥手"></a>四次挥手</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203482508-b4575222-755d-42dd-a288-9cd22a44a4ac.webp#averageHue=%23f9f9f9&clientId=u71165853-2e09-4&from=paste&id=ub288cd6e&originHeight=580&originWidth=968&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u53c45ad5-9d50-4a6a-8ae2-e889745ae4e&title="></p><ol><li>客户端发送一个FIN段，并包含一个希望接收者看到的自己当前的序列号K. 同时还包含一个ACK表示确认对方最近一次发过来的数据。</li><li>服务端将K值加1作为ACK序号值，表明收到了上一个包。这时上层的应用程序会被告知另一端发起了关闭操作，通常这将引起应用程序发起自己的关闭操作。</li><li>服务端发起自己的FIN段，ACK=K+1, Seq=L</li><li>客户端确认。ACK=L+1</li></ol><h2 id="为什么建立连接是三次握手，而关闭连接却是四次挥手呢？"><a href="#为什么建立连接是三次握手，而关闭连接却是四次挥手呢？" class="headerlink" title="为什么建立连接是三次握手，而关闭连接却是四次挥手呢？"></a>为什么建立连接是三次握手，而关闭连接却是四次挥手呢？</h2><p>这是因为服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，己方是否现在关闭发送数据通道，需要上层应用来决定，因此，己方ACK和FIN一般都会分开发送。</p><h2 id="“三次握手，四次挥手”进阶"><a href="#“三次握手，四次挥手”进阶" class="headerlink" title="“三次握手，四次挥手”进阶"></a>“三次握手，四次挥手”进阶</h2><h2 id="ISN"><a href="#ISN" class="headerlink" title="ISN"></a>ISN</h2><p>三次握手的一个重要功能是客户端和服务端交换ISN(Initial Sequence Number), 以便让对方知道接下来接收数据的时候如何按序列号组装数据。<br>如果ISN是固定的，攻击者很容易猜出后续的确认号。<br>ISN = M + F(localhost, localport, remotehost, remoteport)<br>M是一个计时器，每隔4毫秒加1。 F是一个Hash算法，根据源IP、目的IP、源端口、目的端口生成一个随机数值。要保证hash算法不能被外部轻易推算得出。</p><h2 id="序列号回绕"><a href="#序列号回绕" class="headerlink" title="序列号回绕"></a>序列号回绕</h2><p>因为ISN是随机的，所以序列号容易就会超过2^31-1. 而tcp对于丢包和乱序等问题的判断都是依赖于序列号大小比较的。此时就出现了所谓的tcp序列号回绕（sequence<br>wraparound）问题。怎么解决？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* The next routines deal with comparing 32 bit unsigned ints</span><br><span class="line">* and worry about wraparound (automatic with unsigned arithmetic).</span><br><span class="line">*/</span><br><span class="line">static inline int before(__u32 seq1, __u32 seq2)</span><br><span class="line">&#123;</span><br><span class="line">    return (__s32)(seq1-seq2) &lt; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#define after(seq2, seq1) before(seq1, seq2)</span><br></pre></td></tr></table></figure><p>上述代码是内核中的解决回绕问题代码。<strong>s32是有符号整型的意思，而</strong>u32则是无符号整型。序列号发生回绕后，序列号变小，相减之后，把结果变成有符号数了，因此结果成了负数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">假设seq1=255， seq2=1（发生了回绕）。</span><br><span class="line">seq1 = 1111 1111 seq2 = 0000 0001</span><br><span class="line">我们希望比较结果是</span><br><span class="line"> seq1 - seq2=</span><br><span class="line"> 1111 1111</span><br><span class="line">-0000 0001</span><br><span class="line">-----------</span><br><span class="line"> 1111 1110</span><br><span class="line"></span><br><span class="line">由于我们将结果转化成了有符号数，由于最高位是1，因此结果是一个负数，负数的绝对值为</span><br><span class="line"> 0000 0001 + 1 = 0000 0010 = 2</span><br><span class="line"></span><br><span class="line">因此seq1 - seq2 &lt; 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="syn-flood攻击"><a href="#syn-flood攻击" class="headerlink" title="syn flood攻击"></a>syn flood攻击</h2><p>最基本的DoS攻击就是利用合理的服务请求来占用过多的服务资源，从而使合法用户无法得到服务的响应。syn flood属于Dos攻击的一种。<br>如果恶意的向某个服务器端口发送大量的SYN包，则可以使服务器打开大量的半开连接，分配TCB（Transmission Control Block）,<br>从而消耗大量的服务器资源，同时也使得正常的连接请求无法被相应。当开放了一个TCP端口后，该端口就处于Listening状态，不停地监视发到该端口的Syn报文，一<br>旦接收到Client发来的Syn报文，就需要为该请求分配一个TCB，通常一个TCB至少需要280个字节，在某些操作系统中TCB甚至需要1300个字节，并返回一个SYN<br>ACK命令，立即转为SYN-RECEIVED即半开连接状态。系统会为此耗尽资源。<br>常见的防攻击方法有：</p><h2 id="无效连接的监视释放"><a href="#无效连接的监视释放" class="headerlink" title="无效连接的监视释放"></a>无效连接的监视释放</h2><p>监视系统的半开连接和不活动连接，当达到一定阈值时拆除这些连接，从而释放系统资源。这种方法对于所有的连接一视同仁，而且由于SYN<br>Flood造成的半开连接数量很大，正常连接请求也被淹没在其中被这种方式误释放掉，因此这种方法属于入门级的SYN Flood方法。</p><h2 id="延缓TCB分配方法"><a href="#延缓TCB分配方法" class="headerlink" title="延缓TCB分配方法"></a>延缓TCB分配方法</h2><p>消耗服务器资源主要是因为当SYN数据报文一到达，系统立即分配TCB，从而占用了资源。而SYN<br>Flood由于很难建立起正常连接，因此，当正常连接建立起来后再分配TCB则可以有效地减轻服务器资源的消耗。常见的方法是使用Syn<br>Cache和Syn Cookie技术。</p><h2 id="Syn-Cache技术"><a href="#Syn-Cache技术" class="headerlink" title="Syn Cache技术"></a>Syn Cache技术</h2><p>系统在收到一个SYN报文时，在一个专用HASH表中保存这种半连接信息，直到收到正确的回应ACK报文再分配TCB。这个开销远小于TCB的开销。当然还需要保存序列号。</p><h2 id="Syn-Cookie技术"><a href="#Syn-Cookie技术" class="headerlink" title="Syn Cookie技术"></a>Syn Cookie技术</h2><p>Syn Cookie技术则完全不使用任何存储资源，这种方法比较巧妙，它使用一种特殊的算法生成Sequence<br>Number，这种算法考虑到了对方的IP、端口、己方IP、端口的固定信息，以及对方无法知道而己方比较固定的一些信息，如MSS(Maximum<br>Segment Size，最大报文段大小，指的是TCP报文的最大数据报长度，其中不包括TCP首部长度。)、时间等，在收到对方<br>的ACK报文后，重新计算一遍，看其是否与对方回应报文中的（Sequence Number-1）相同，从而决定是否分配TCB资源。</p><h2 id="使用SYN-Proxy防火墙"><a href="#使用SYN-Proxy防火墙" class="headerlink" title="使用SYN Proxy防火墙"></a>使用SYN Proxy防火墙</h2><p>一种方式是防止墙dqywb连接的有效性后，防火墙才会向内部服务器发起SYN请求。防火墙代服务器发出的SYN ACK包使用的序列号为c,<br>而真正的服务器回应的序列号为c’, 这样，在每个数据报文经过防火墙的时候进行序列号的修改。另一种方式是防火墙确定了连接的安全后，会发出一个safe<br>reset命令，client会进行重新连接，这时出现的syn报文会直接放行。这样不需要修改序列号了。但是，client需要发起两次握手过程，因此建立连接的时间将会延长。</p><h2 id="连接队列"><a href="#连接队列" class="headerlink" title="连接队列"></a>连接队列</h2><p>在外部请求到达时，被服务程序最终感知到前，连接可能处于SYN_RCVD状态或是ESTABLISHED状态，但还未被应用程序接受。</p><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203482870-9c89db77-2544-40d5-bbd5-9229b998bad6.webp#averageHue=%23f9f8f7&clientId=u71165853-2e09-4&from=paste&id=uf9ffc37d&originHeight=697&originWidth=1240&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=uc4163127-660e-47b5-82be-cbd4b436a4b&title="></p><p>对应地，服务器端也会维护两种队列，处于SYN_RCVD状态的半连接队列，而处于ESTABLISHED状态但仍未被应用程序accept的为全连接队列。如果这两个队列满了之后，就会出现各种丢包的情形。<br>查看是否有连接溢出 netstat -s | grep LISTEN</p><h2 id="半连接队列满了"><a href="#半连接队列满了" class="headerlink" title="半连接队列满了"></a>半连接队列满了</h2><p>在三次握手协议中，服务器维护一个半连接队列，该队列为每个客户端的SYN包开设一个条目(<br>服务端在接收到SYN包的时候，就已经创建了request_sock结构，存储在半连接队列中)<br>，该条目表明服务器已收到SYN包，并向客户发出确认，正在等待客户的确认包。这些条目所标识的连接在服务器处于Syn_RECV状态，当服务器收到客户的确认包时，删除该条目，服务器进入ESTABLISHED状态。<br>目前，Linux下默认会进行5次重发SYN-ACK包，重试的间隔时间从1s开始，下次的重试间隔时间是前一次的双倍，5次的重试时间间隔为1s,<br>2s, 4s, 8s, 16s, 总共31s, 称为指数退避，第5次发出后还要等32s才知道第5次也超时了，所以，总共需要 1s + 2s + 4s+ 8s+ 16s +<br>32s = 63s,<br>TCP才会把断开这个连接。由于，SYN超时需要63秒，那么就给攻击者一个攻击服务器的机会，攻击者在短时间内发送大量的SYN包给Server(<br>俗称SYN flood攻击)，用于耗尽Server的SYN队列。对于应对SYN<br>过多的问题，linux提供了几个TCP参数：tcp_syncookies、tcp_synack_retries、tcp_max_syn_backlog、tcp_abort_on_overflow 来调整应对。</p><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203482959-92895cfe-e8c6-4ab7-aed5-cc0a965f948b.webp#averageHue=%23f3f4f0&clientId=u71165853-2e09-4&from=paste&id=uc50a888b&originHeight=531&originWidth=1440&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=ue1fb468b-9c43-4152-be9e-8ef60f5943c&title="></p><h2 id="全连接队列满"><a href="#全连接队列满" class="headerlink" title="全连接队列满"></a>全连接队列满</h2><p>当第三次握手时，当server接收到ACK包之后，会进入一个新的叫 accept 的队列。<br>当accept队列满了之后，即使client继续向server发送ACK的包，也会不被响应，此时ListenOverflows+1，同时server通过tcp_abort_on_overflow来决定如何返回，0表示直接丢弃该ACK，1表示发送RST通知client；相应的，client则会分别返回read<br>timeout 或者 connection reset by<br>peer。另外，tcp_abort_on_overflow是0的话，server过一段时间再次发送syn+ack给client（也就是重新走握手的第二步），如果client超时等待比较短，就很容易异常了。而客户端收到多个<br>SYN ACK 包，则会认为之前的 ACK 丢包了。于是促使客户端再次发送 ACK ，在 accept队列有空闲的时候最终完成连接。若<br>accept队列始终满员，则最终客户端收到 RST 包（此时服务端发送syn+ack的次数超出了tcp_synack_retries）。<br>服务端仅仅只是创建一个定时器，以固定间隔重传syn和ack到服务端<br><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203482956-aa7a2f2b-ce2a-4aca-8f10-fb0085b50703.webp#averageHue=%23f5f6f2&clientId=u71165853-2e09-4&from=paste&id=u7e41fec7&originHeight=319&originWidth=1440&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=ub6bf42d4-6edc-44f7-8df9-6de8d6d67ed&title="></p><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>netstat -s命令<br>[root@server ~]# netstat -s | egrep “listen|LISTEN” 667399 times the listen queue of a socket overflowed 667399 SYNs to<br>LISTEN sockets ignored<br>比如上面看到的 667399 times ，表示全连接队列溢出的次数，隔几秒钟执行下，如果这个数字一直在增加的话肯定全连接队列偶尔满了。<br>[root@server ~]# netstat -s | grep TCPBacklogDrop 查看 Accept queue 是否有溢出</p><p>ss命令<br>[root@server ~]# ss -lnt State Recv-Q Send-Q Local Address:Port Peer Address:Port LISTEN 0 128 _:6379 <em>:</em> LISTEN 0<br>128 _:22 <em>:</em> 如果State是listen状态，Send-Q 表示第三列的listen端口上的全连接队列最大为50，第一列Recv-Q为全连接队列当前使用了多少。<br>非 LISTEN 状态中 Recv-Q 表示 receive queue 中的 bytes 数量；Send-Q 表示 send queue 中的 bytes 数值。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>当外部连接请求到来时，TCP模块会首先查看max_syn_backlog，如果处于SYN_RCVD状态的连接数目超过这一阈值，进入的连接会被拒绝。根据tcp_abort_on_overflow字段来决定是直接丢弃，还是直接reset.<br>从服务端来说，三次握手中，第一步server接受到client的syn后，把相关信息放到半连接队列中，同时回复syn+ack给client.<br>第三步当收到客户端的ack, 将连接加入到全连接队列。<br>一般，全连接队列比较小，会先满，此时半连接队列还没满。如果这时收到syn报文，则会进入半连接队列，没有问题。但是如果收到了三次握手中的第3步(<br>ACK)，则会根据tcp_abort_on_overflow字段来决定是直接丢弃，还是直接reset.此时，客户端发送了ACK,<br>那么客户端认为三次握手完成，它认为服务端已经准备好了接收数据的准备。但此时服务端可能因为全连接队列满了而无法将连接放入，会重新发送第2步的syn+ack,<br>如果这时有数据到来，服务器TCP模块会将数据存入队列中。一段时间后，client端没收到回复，超时，连接异常，client会主动关闭连接。</p><h2 id="“三次握手，四次挥手”redis实例分析"><a href="#“三次握手，四次挥手”redis实例分析" class="headerlink" title="“三次握手，四次挥手”redis实例分析"></a>“三次握手，四次挥手”redis实例分析</h2><ol><li>我在dev机器上部署redis服务，端口号为6379,</li><li>通过tcpdump工具获取数据包，使用如下命令</li></ol><p>tcpdump -w /tmp/a.cap port 6379 -s0 -w把数据写入文件，-s0设置每个数据包的大小默认为68字节，如果用-S 0则会抓到完整数据包</p><ol><li>在dev2机器上用redis-cli访问dev:6379, 发送一个ping, 得到回复pong</li><li>停止抓包，用tcpdump读取捕获到的数据包</li></ol><p>tcpdump -r /tmp/a.cap -n -nn -A -x| vim - （-x 以16进制形式展示，便于后面分析）<br>共收到了7个包。<br>抓到的是IP数据包，IP数据包分为IP头部和IP数据部分，IP数据部分是TCP头部加TCP数据部分。<br>IP的数据格式为：<br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/804884/1676203482993-bc62329e-d81f-4a1f-9d94-1f8f491dbd87.jpeg#averageHue=%23f6f6b3&clientId=u71165853-2e09-4&from=paste&id=u0d58e27e&originHeight=391&originWidth=703&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=ubf4171d7-9ceb-42cc-9553-569a92fd02b&title="><br>它由固定长度20B+可变长度构成。<br>10:55:45.662077 IP dev2.39070 &gt; dev.6379: Flags [S], seq 4133153791, win 29200,<br>options [mss 1460,sackOK,TS val 2959270704 ecr 0,nop,wscale 7], length 0 0x0000:  4500 003c 08cf 4000 3606 14a5 0ab3<br>b561 0x0010:  0a60 5cd4 989e 18eb f65a ebff 0000 0000 0x0020:  a002 7210 872f 0000 0204 05b4 0402 080a 0x0030:  b062<br>e330 0000 0000 0103 0307<br>对着IP头部格式，来拆解数据包的具体含义。<br><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203483072-2e63c138-0ab3-4af3-bf0a-7c0c3b715bf9.webp#averageHue=%23f4f5f1&clientId=u71165853-2e09-4&from=paste&id=u33e2e9f9&originHeight=1041&originWidth=1440&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=ubc22dad9-1e73-41a4-b042-20cc7e2bcb8&title="><br>剩余的数据部分即为TCP协议相关的。TCP也是20B固定长度+可变长度部分。<br><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203483236-83a401c0-479a-4804-b6b1-e2c9f52eba42.webp#averageHue=%23f4f5f1&clientId=u71165853-2e09-4&from=paste&id=ufd6c29ff&originHeight=844&originWidth=1440&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u191bdcb0-629c-42ad-94dc-0a7ca05f1fa&title="><br>可变长度部分，协议如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676203483355-b7dc5deb-1011-4d27-8218-c995544fa86b.webp#averageHue=%23f4f4f1&clientId=u71165853-2e09-4&from=paste&id=ub3a0569f&originHeight=476&originWidth=1440&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=ub8318ca7-365c-43c1-8f7d-a268ba7646e&title="><br>这样第一个包分析完了。dev2向dev发送SYN请求。也就是三次握手中的第一次了。 SYN seq(c)=4133153791<br>第二个包，dev响应连接，ack=4133153792. 表明dev下次准备接收这个序号的包，用于tcp字节注的顺序控制。dev（也就是server端）的初始序号为seq=4264776963,<br>syn=1. SYN ack=seq(c)+1 seq(s)=4264776963<br>第三个包，client包确认，这里使用了相对值应答。seq=4133153792, 等于第二个包的ack. ack=4264776964. ack=seq(s)+1, seq=seq(c)+1<br>至此，三次握手完成。接下来就是发送ping和pong的数据了。<br>接着第四个包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">10:55:48.090073 IP dev2.39070 &gt; dev.6379: Flags [P.], seq 1:15, ack 1, win 229, options [nop,nop,TS val 2959273132 ecr 3132256230], length 14</span><br><span class="line">        0x0000:  4500 0042 08d1 4000 3606 149d 0ab3 b561</span><br><span class="line">        0x0010:  0a60 5cd4 989e 18eb f65a ec00 fe33 5504</span><br><span class="line">        0x0020:  8018 00e5 4b5f 0000 0101 080a b062 ecac</span><br><span class="line">        0x0030:  bab2 6fe6 2a31 0d0a 2434 0d0a 7069 6e67</span><br><span class="line">        0x0040:  0d0a</span><br></pre></td></tr></table></figure><p>tcp首部长度为32B, 可选长度为12B. IP报文的总长度为66B, 首部长度为20B, 因此TCP数据部分长度为14B. seq=0xf65a<br>ec00=4133153792 ACK, PSH. 数据部分为2a31 0d0a 2434 0d0a 7069 6e67 0d0a</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x2a31         -&gt; *1</span><br><span class="line">0x0d0a         -&gt; \r\n</span><br><span class="line">0x2434         -&gt; $4</span><br><span class="line">0x0d0a         -&gt; \r\n</span><br><span class="line">0x7069 0x6e67  -&gt; ping</span><br><span class="line">0x0d0a         -&gt; \r\n</span><br></pre></td></tr></table></figure><p>dev2向dev发送了ping数据，第四个包完毕。<br>第五个包，dev2向dev发送ack响应。 序列号为0xfe33 5504=4264776964, ack确认号为0xf65a ec0e=4133153806=(4133153792+14).<br>第六个包，dev向dev2响应pong消息。序列号fe33 5504，确认号f65a ec0e, TCP头部可选长度为12B, IP数据报总长度为59B, 首部长度为20B,<br>因此TCP数据长度为7B. 数据部分2b50 4f4e 470d 0a, 翻译过来就是+PONG\r\n.<br>至此，Redis客户端和Server端的三次握手过程分析完毕。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://zhuanlan.zhihu.com/p/53374516">https://zhuanlan.zhihu.com/p/53374516</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;TCP的3次握手与4次挥手简介&quot;&gt;&lt;a href=&quot;#TCP的3次握手与4次挥手简介&quot; class=&quot;headerlink&quot; title=&quot;TCP的3次握手与4次挥手简介&quot;&gt;&lt;/a&gt;TCP的3次握手与4次挥手简介&lt;/h2&gt;&lt;p&gt;TCP是一种面向连接的单播协议，在发</summary>
      
    
    
    
    <category term="TCP" scheme="https://wuhaocn.github.io/categories/TCP/"/>
    
    
    <category term="TCP" scheme="https://wuhaocn.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>Linux IO模式及select、poll、epoll详解</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/tcp/Linux%20IO%E6%A8%A1%E5%BC%8F%E5%8F%8Aselect%E3%80%81poll%E3%80%81epoll%E8%AF%A6%E8%A7%A3/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/tcp/Linux%20IO%E6%A8%A1%E5%BC%8F%E5%8F%8Aselect%E3%80%81poll%E3%80%81epoll%E8%AF%A6%E8%A7%A3/</id>
    <published>2023-11-15T03:40:25.015Z</published>
    <updated>2023-11-15T03:40:25.016Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0、前言"><a href="#0、前言" class="headerlink" title="0、前言"></a>0、前言</h2><p>对于每一个从事 Web 服务器开发的后端程序员，必然绕不开网络编程，而其中最基础也是最重要的部分就是 Linux IO 模式及 Socket 编程。什么是 Socket 呢？简单理解，就是 ip地址 + 端口号。当两个进程间需要通信时，首先要创建五元组（源ip地址、目的ip地址、源端口号、目的端口号、协议），建立 tcp 连接，建立好连接之后，两个进程各自有一个 Socket 来标识，这两个 socket 组成的 socket pair 也就唯一标识了一个连接。有了连接之后，应用程序得要从 tcp 流上获取数据，然后再处理数据。于是，诞生了三种高效的 Socket 编程方法：select、poll 和 epoll.<br>本文将首先介绍下 Linux IO 的几种模式以及一些前置知识，因为这是理解 select、poll 和 epoll 的前提；接下来重点介绍下 select、poll 和 epoll 的工作原理及优缺点；最后附上样例代码<br>注：本人并不是从事 web 后端开发的工作，平时也就用用 grpc/brpc（封装了 socket 编程模型），所以尽量从概念及实现原理上把这个知识地点讲清楚，如果有讲的不对的地方，欢迎专业人士批评指正。</p><h2 id="1、几个基础概念"><a href="#1、几个基础概念" class="headerlink" title="1、几个基础概念"></a>1、几个基础概念</h2><h3 id="1-1、用户空间和内核空间"><a href="#1-1、用户空间和内核空间" class="headerlink" title="1.1、用户空间和内核空间"></a>1.1、用户空间和内核空间</h3><p>对于32位操作系统而言，它的寻址空间是4G（2的32次方），注意这里的4G是虚拟内存空间大小。以 Linux 为例，它将最高的1G字节给内核使用，称为内核空间，剩下的3G给用户进程使用，称为用户空间。这样做的好处就是隔离，保证内核安全。</p><h3 id="1-2、进程切换"><a href="#1-2、进程切换" class="headerlink" title="1.2、进程切换"></a>1.2、进程切换</h3><p>这是内核要干的事，字面意思很好理解，挂起正在运行的 A 进程，然后运行 B 进程，当然这其中的流程比较复杂，涉及到上下文切换，且非常消耗资源，感兴趣的同学可以去深入研究。</p><h3 id="1-3、进程的阻塞"><a href="#1-3、进程的阻塞" class="headerlink" title="1.3、进程的阻塞"></a>1.3、进程的阻塞</h3><ul><li>进程阻塞是本进程的行为，比如和其他进程通信时，等待请求的数据返回；</li><li>进程进入阻塞状态时不占用CPU资源的</li></ul><h3 id="1-4、文件描述符"><a href="#1-4、文件描述符" class="headerlink" title="1.4、文件描述符"></a>1.4、文件描述符</h3><p>在 Linux 世界里，一切皆文件。怎么理解呢？当程序打开一个现有文件或创建新文件时，内核会向进程返回一个文件描述符，文件描述符在形式上是一个非负整数，其实就是一个索引值，指向该进程打开文件的记录表（它是由内核维护的）。</p><h3 id="1-5、缓存-I-O"><a href="#1-5、缓存-I-O" class="headerlink" title="1.5、缓存 I/O"></a>1.5、缓存 I/O</h3><p>和标准 IO 是一个概念，当应用程序需要从内核读数据时，数据先被拷贝到操作系统的内核缓冲区（page cache），然后再从该缓冲区拷贝到应用程序的地址空间。</p><h2 id="2、Linux-IO-模式"><a href="#2、Linux-IO-模式" class="headerlink" title="2、Linux IO 模式"></a>2、Linux IO 模式</h2><p>当应用程序发起一次 read 调用时，会经历以下两个阶段：</p><ul><li>等待数据准备 (Waiting for the data to be ready)</li><li>将数据从内核拷贝到进程中 (Copying the data from the kernel to the process)</li></ul><p><strong>正式因为这两个阶段，Linux 系统产生了下述五种 IO 方式：</strong></p><ul><li>阻塞 I/O（blocking IO）</li><li>非阻塞 I/O（nonblocking IO）</li><li>异步 I/O（asynchronous IO）</li><li>I/O 多路复用（ IO multiplexing）</li><li>信号驱动 I/O（ signal driven IO）（很少见，可忽略）</li></ul><p>它们具体怎么工作，这里做下总结：</p><h3 id="2-1、blocking-和-non-blocking的区别"><a href="#2-1、blocking-和-non-blocking的区别" class="headerlink" title="2.1、blocking 和 non-blocking的区别"></a>2.1、blocking 和 non-blocking的区别</h3><p>blocking IO的特点就是在IO执行的两个阶段都被block了。<br>non-blocking IO 的特点是用户进程需要不断的主动询问内核 “ 数据好了吗？”</p><h3 id="2-2、IO-多路复用"><a href="#2-2、IO-多路复用" class="headerlink" title="2.2、IO 多路复用"></a>2.2、IO 多路复用</h3><p>I/O 多路复用的特点是通过一种机制一个进程能同时等待多个文件描述符，而这些文件描述符（套接字描述符）其中的任意一个进入读就绪状态，select()函数就可以返回。</p><h3 id="2-3、synchronous-IO和asynchronous-IO的区别"><a href="#2-3、synchronous-IO和asynchronous-IO的区别" class="headerlink" title="2.3、synchronous IO和asynchronous IO的区别"></a>2.3、synchronous IO和asynchronous IO的区别</h3><p>POSIX 中是这样定义的：</p><ul><li><p>A synchronous I/O operation causes the requesting process to be blocked until that I/O operation completes;</p></li><li><p>An asynchronous I/O operation does not cause the requesting process to be blocked;<br>两者的区别就在于synchronous IO做”IO operation”的时候会将process阻塞。按照这个定义，之前所述的blocking IO，non-blocking IO，IO multiplexing 都属于 synchronous IO。</p><h3 id="2-4、各个IO-模式的比较"><a href="#2-4、各个IO-模式的比较" class="headerlink" title="2.4、各个IO 模式的比较"></a>2.4、各个IO 模式的比较</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676087915312-7960cc52-7230-47d2-8579-36d012fbd81f.webp#averageHue=%23f0f0f0&clientId=u991cae4a-9930-4&from=paste&id=ubacb17bd&originHeight=654&originWidth=1228&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u23b55a3f-828d-412a-82fd-26cdbaf18d3&title="><br>可以发现：</p></li><li><p>对于 non-blocking IO中，虽然进程大部分时间都不会被 block，但是它仍然要求进程去主动的 check，并且当数据准备完成以后，也需要进程主动的再次调用recvfrom来将数据拷贝到用户内存。</p></li><li><p>asynchronous IO 完全不同于 no-blocking IO，它就像是用户进程将整个 IO 操作交给了内核完成，然后内核做完后发出信号通知。在此期间，用户进程不需要去检查 IO 操作的状态，也不需要主动的去拷贝数据。</p></li></ul><h2 id="3、IO-多路复用之-select、poll、epoll-详解"><a href="#3、IO-多路复用之-select、poll、epoll-详解" class="headerlink" title="3、IO 多路复用之 select、poll、epoll 详解"></a>3、IO 多路复用之 select、poll、epoll 详解</h2><p>select，poll，epoll 都是 IO 多路复用的机制，它们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的。</p><h3 id="3-1、select"><a href="#3-1、select" class="headerlink" title="3.1、select"></a>3.1、select</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676087915344-4b07e7fd-2095-408e-8b30-38e68d079411.webp#averageHue=%23f9f8f8&clientId=u991cae4a-9930-4&from=paste&id=u86da44a3&originHeight=701&originWidth=1244&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=ua639cca0-190b-4148-9beb-468de7bc37a&title="><br>select 最多能同时监视 1024 个 socket（因为 fd_set 结构体大小是 128 字节，每个 bit 表示一个文件描述符）。用户需要维护一个临时数组，存储文件描述符。当内核有事件发生时，内核将 fd_set 中没发生的文件描述符清空，然后拷贝到用户区。select 返回的是整个数组，它需要遍历整个数组才知道谁发生了变化。</p><h3 id="3-2、poll"><a href="#3-2、poll" class="headerlink" title="3.2、poll"></a>3.2、poll</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676087915317-f66fd7a2-7cda-4d58-8fa4-1c65db5a33f5.webp#averageHue=%23f9f9f9&clientId=u991cae4a-9930-4&from=paste&id=u74453309&originHeight=1115&originWidth=1440&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u471155bc-f967-40d1-9ca8-554d7fe7be2&title="><br>poll 就是把 select 中的 fd_set 数组换成了链表，其他和 select 没什么不同。</p><h3 id="3-3、epoll"><a href="#3-3、epoll" class="headerlink" title="3.3、epoll"></a>3.3、epoll</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1676087915312-7af2a901-e86a-4894-8a3c-b3d34ed8532d.webp#averageHue=%23f8f8f8&clientId=u991cae4a-9930-4&from=paste&id=ue7085e06&originHeight=960&originWidth=1440&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u99d3174d-445e-4db7-b44e-9acd1f02f19&title="><br>epoll 是基于事件驱动的 IO 方式，它没有文件描述符个数限制，它将用户关心的文件描述符的事件存放到内核的一个事件表中（简单来说，就是由内核来负责存储（红黑树）有事件的 socket 句柄），这样在用户空间和内核空间的copy只需一次。优点如下：</p><ul><li>没有最大并发连接的限制，能打开的fd上限远大于1024（1G的内存能监听约10万个端口） </li><li>采用回调的方式，效率提升。只有<strong>活跃可用</strong>的fd才会调用callback函数，也就是说 epoll 只管你“活跃”的连接，而跟连接总数无关； </li><li>内存拷贝。使用mmap()文件映射内存来加速与内核空间的消息传递，减少复制开销。</li></ul><p>epoll 有两种工作方式：</p><ul><li>LT模式（水平触发）：若就绪的事件一次没有处理完，就会一直去处理。也就是说，将没有处理完的事件继续放回到就绪队列之中（即那个内核中的链表），一直进行处理。</li><li>ET模式（边缘触发）：就绪的事件只能处理一次，若没有处理完会在下次的其它事件就绪时再进行处理。而若以后再也没有就绪的事件，那么剩余的那部分数据也会随之而丢失。</li></ul><p>由此可见：ET模式的效率比LT模式的效率要高很多。_简单点说就是，如果对于一个非阻塞 socket，如果使用 epoll 边缘模式去检测数据是否可读，触发可读事件以后，一定要一次性把 socket 上的数据收取干净才行，也就是说一定要循环调用 recv 函数直到 recv 出错，错误码是<strong>EWOULDBLOCK</strong>（<strong>EAGAIN</strong> 一样）（此时表示 socket 上本次数据已经读完）；如果使用水平模式，则不用，你可以根据业务一次性收取固定的字节数，或者收完为止。_只是如果使用ET模式，就要保证每次进行数据处理时，要将其处理完，不能造成数据丢失，这样对编写代码的人要求就比较高。</p><h3 id="3-4、select、poll、epoll-三者区别"><a href="#3-4、select、poll、epoll-三者区别" class="headerlink" title="3.4、select、poll、epoll 三者区别"></a>3.4、select、poll、epoll 三者区别</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/804884/1676087915418-6ba5d0fb-8fa5-471f-8dbd-1c87cd2d28c9.png#averageHue=%23fcfaf9&clientId=u991cae4a-9930-4&from=paste&id=u3c503c6d&originHeight=347&originWidth=959&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=ubd432f6f-e6cd-47d4-93d8-4130aaf693e&title="></p><h2 id="4、代码详解"><a href="#4、代码详解" class="headerlink" title="4、代码详解"></a>4、代码详解</h2><h3 id="4-1-select"><a href="#4-1-select" class="headerlink" title="4.1 select"></a>4.1 select</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include&lt;sys/types.h&gt;</span><br><span class="line">#include&lt;sys/socket.h&gt;</span><br><span class="line">#include&lt;unistd.h&gt;</span><br><span class="line">#include&lt;netinet/in.h&gt;</span><br><span class="line">#include&lt;arpa/inet.h&gt;</span><br><span class="line">#include&lt;stdlib.h&gt;</span><br><span class="line">#include&lt;string.h&gt;</span><br><span class="line">#include&lt;sys/time.h&gt;</span><br><span class="line">static void Usage(const char* proc)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;%s [local_ip] [local_port]\n&quot;,proc);</span><br><span class="line">&#125;</span><br><span class="line">int array[4096];</span><br><span class="line">static int start_up(const char* _ip,int _port)</span><br><span class="line">&#123;</span><br><span class="line">    int sock = socket(AF_INET,SOCK_STREAM,0);</span><br><span class="line">    if(sock &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;socket&quot;);</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line">    struct sockaddr_in local;</span><br><span class="line">    local.sin_family = AF_INET;</span><br><span class="line">    local.sin_port = htons(_port);</span><br><span class="line">    local.sin_addr.s_addr = inet_addr(_ip);</span><br><span class="line">    if(bind(sock,(struct sockaddr*)&amp;local,sizeof(local)) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;bind&quot;);</span><br><span class="line">        exit(2);</span><br><span class="line">    &#125;</span><br><span class="line">    if(listen(sock,10) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;listen&quot;);</span><br><span class="line">        exit(3);</span><br><span class="line">    &#125;</span><br><span class="line">    return sock;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc,char* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    if(argc != 3)</span><br><span class="line">    &#123;</span><br><span class="line">        Usage(argv[0]);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    int listensock = start_up(argv[1],atoi(argv[2]));</span><br><span class="line">    int maxfd = 0;</span><br><span class="line">    fd_set rfds;</span><br><span class="line">    fd_set wfds;</span><br><span class="line">    array[0] = listensock;</span><br><span class="line">    int i = 1;</span><br><span class="line">    int array_size = sizeof(array)/sizeof(array[0]);</span><br><span class="line">    for(; i &lt; array_size;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        array[i] = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;</span><br><span class="line">        FD_ZERO(&amp;rfds);</span><br><span class="line">        FD_ZERO(&amp;wfds);</span><br><span class="line">        for(i = 0;i &lt; array_size;++i)</span><br><span class="line">        &#123;</span><br><span class="line">            if(array[i] &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                FD_SET(array[i],&amp;rfds);</span><br><span class="line">                FD_SET(array[i],&amp;wfds);</span><br><span class="line">                if(array[i] &gt; maxfd)</span><br><span class="line">                &#123;</span><br><span class="line">                    maxfd = array[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        switch(select(maxfd + 1,&amp;rfds,&amp;wfds,NULL,NULL))</span><br><span class="line">        &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                &#123;</span><br><span class="line">                    printf(&quot;timeout\n&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            case -1:</span><br><span class="line">                &#123;</span><br><span class="line">                    perror(&quot;select&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">             default:</span><br><span class="line">                &#123;</span><br><span class="line">                    int j = 0;</span><br><span class="line">                    for(; j &lt; array_size; ++j)</span><br><span class="line">                    &#123;</span><br><span class="line">                        if(j == 0 &amp;&amp; FD_ISSET(array[j],&amp;rfds))</span><br><span class="line">                        &#123;</span><br><span class="line">                            //listensock happened read events</span><br><span class="line">                            struct sockaddr_in client;</span><br><span class="line">                            socklen_t len = sizeof(client);</span><br><span class="line">                            int new_sock = accept(listensock,(struct sockaddr*)&amp;client,&amp;len);</span><br><span class="line">                            if(new_sock &lt; 0)//accept failed</span><br><span class="line">                            &#123;</span><br><span class="line">                                perror(&quot;accept&quot;);</span><br><span class="line">                                continue;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else//accept success</span><br><span class="line">                            &#123;</span><br><span class="line">                                printf(&quot;get a new client%s\n&quot;,inet_ntoa(client.sin_addr));</span><br><span class="line">                                fflush(stdout);</span><br><span class="line">                                int k = 1;</span><br><span class="line">                                for(; k &lt; array_size;++k)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    if(array[k] &lt; 0)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        array[k] = new_sock;</span><br><span class="line">                                        if(new_sock &gt; maxfd)</span><br><span class="line">                                            maxfd = new_sock;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                if(k == array_size)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    close(new_sock);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;//j == 0</span><br><span class="line">                        else if(j != 0 &amp;&amp; FD_ISSET(array[j], &amp;rfds))</span><br><span class="line">                        &#123;</span><br><span class="line">                            //new_sock happend read events</span><br><span class="line">                            char buf[1024];</span><br><span class="line">                            ssize_t s = read(array[j],buf,sizeof(buf) - 1);</span><br><span class="line">                            if(s &gt; 0)//read success</span><br><span class="line">                            &#123;</span><br><span class="line">                                buf[s] = 0;</span><br><span class="line">                                printf(&quot;clientsay#%s\n&quot;,buf);</span><br><span class="line">                                if(FD_ISSET(array[j],&amp;wfds))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    char *msg = &quot;HTTP/1.0 200 OK &lt;\r\n\r\n&lt;html&gt;&lt;h1&gt;yingying beautiful&lt;/h1&gt;&lt;/html&gt;\r\n&quot;;</span><br><span class="line">                                    write(array[j],msg,strlen(msg));</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if(0 == s)</span><br><span class="line">                            &#123;</span><br><span class="line">                                printf(&quot;client quit!\n&quot;);</span><br><span class="line">                                close(array[j]);</span><br><span class="line">                                array[j] = -1;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">                                perror(&quot;read&quot;);</span><br><span class="line">                                close(array[j]);</span><br><span class="line">                                array[j] = -1;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;//else j != 0  </span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2、Poll"><a href="#4-2、Poll" class="headerlink" title="4.2、Poll"></a>4.2、Poll</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include&lt;stdlib.h&gt;</span><br><span class="line">#include&lt;string.h&gt;</span><br><span class="line">#include&lt;sys/types.h&gt;</span><br><span class="line">#include&lt;sys/socket.h&gt;</span><br><span class="line">#include&lt;netinet/in.h&gt;</span><br><span class="line">#include&lt;arpa/inet.h&gt;</span><br><span class="line">#include&lt;poll.h&gt;</span><br><span class="line">static void usage(const char *proc)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;%s [local_ip] [local_port]\n&quot;,proc);</span><br><span class="line">&#125;</span><br><span class="line">int start_up(const char*_ip,int _port)</span><br><span class="line">&#123;</span><br><span class="line">    int sock = socket(AF_INET,SOCK_STREAM,0);</span><br><span class="line">    if(sock &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;socket&quot;);</span><br><span class="line">        return 2;</span><br><span class="line">    &#125;</span><br><span class="line">    int opt = 1;</span><br><span class="line">    setsockopt(sock,SOL_SOCKET,SO_REUSEADDR,&amp;opt,sizeof(opt));</span><br><span class="line">    struct sockaddr_in local;</span><br><span class="line">    local.sin_family = AF_INET;</span><br><span class="line">    local.sin_port = htons(_port);</span><br><span class="line">    local.sin_addr.s_addr = inet_addr(_ip);</span><br><span class="line">    if(bind(sock,(struct sockaddr*)&amp;local,sizeof(local)) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;bind&quot;);</span><br><span class="line">        return 3;</span><br><span class="line">    &#125;</span><br><span class="line">    if(listen(sock,10) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;listen&quot;);</span><br><span class="line">        return 4;</span><br><span class="line">    &#125;</span><br><span class="line">    return sock;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char*argv[])</span><br><span class="line">&#123;</span><br><span class="line">    if(argc != 3)</span><br><span class="line">    &#123;</span><br><span class="line">        usage(argv[0]);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    int sock = start_up(argv[1],atoi(argv[2]));</span><br><span class="line">    struct pollfd peerfd[1024];</span><br><span class="line">    peerfd[0].fd = sock;</span><br><span class="line">    peerfd[0].events = POLLIN;</span><br><span class="line">    int nfds = 1;</span><br><span class="line">    int ret;</span><br><span class="line">    int maxsize = sizeof(peerfd)/sizeof(peerfd[0]);</span><br><span class="line">    int i = 1;</span><br><span class="line">    int timeout = -1;</span><br><span class="line">    for(; i &lt; maxsize; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        peerfd[i].fd = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;</span><br><span class="line">        switch(ret = poll(peerfd,nfds,timeout))</span><br><span class="line">        &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                printf(&quot;timeout...\n&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case -1:</span><br><span class="line">                perror(&quot;poll&quot;);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                &#123;</span><br><span class="line">                        if(peerfd[0].revents &amp; POLLIN)</span><br><span class="line">                        &#123;</span><br><span class="line">                            struct sockaddr_in client;</span><br><span class="line">                            socklen_t len = sizeof(client);</span><br><span class="line">                            int new_sock = accept(sock,\</span><br><span class="line">                                    (struct sockaddr*)&amp;client,&amp;len);</span><br><span class="line">                            printf(&quot;accept finish %d\n&quot;,new_sock);</span><br><span class="line">                            if(new_sock &lt; 0)</span><br><span class="line">                            &#123;</span><br><span class="line">                                perror(&quot;accept&quot;);</span><br><span class="line">                                continue;</span><br><span class="line">                            &#125;</span><br><span class="line">                            printf(&quot;get a new client\n&quot;);</span><br><span class="line">                                int j = 1;</span><br><span class="line">                                for(; j &lt; maxsize; ++j)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    if(peerfd[j].fd &lt; 0)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        peerfd[j].fd = new_sock;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                if(j == maxsize)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    printf(&quot;to many clients...\n&quot;);</span><br><span class="line">                                    close(new_sock);</span><br><span class="line">                                &#125;</span><br><span class="line">                                peerfd[j].events = POLLIN;</span><br><span class="line">                                if(j + 1 &gt; nfds)</span><br><span class="line">                                    nfds = j + 1;</span><br><span class="line">                        &#125;</span><br><span class="line">                        for(i = 1;i &lt; nfds;++i)</span><br><span class="line">                        &#123;</span><br><span class="line">                            if(peerfd[i].revents &amp; POLLIN)</span><br><span class="line">                        &#123;</span><br><span class="line">                            printf(&quot;read ready\n&quot;);</span><br><span class="line">                            char buf[1024];</span><br><span class="line">                            ssize_t s = read(peerfd[i].fd,buf, \</span><br><span class="line">                                    sizeof(buf) - 1);</span><br><span class="line">                            if(s &gt; 0)</span><br><span class="line">                            &#123;</span><br><span class="line">                                buf[s] = 0;</span><br><span class="line">                                printf(&quot;client say#%s&quot;,buf);</span><br><span class="line">                                fflush(stdout);</span><br><span class="line">                                peerfd[i].events = POLLOUT;</span><br><span class="line">                            &#125;</span><br><span class="line">                        else if(s &lt;= 0)</span><br><span class="line">                            &#123;</span><br><span class="line">                                close(peerfd[i].fd);</span><br><span class="line">                                peerfd[i].fd = -1;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;//i != 0</span><br><span class="line">                        else if(peerfd[i].revents &amp; POLLOUT)</span><br><span class="line">                        &#123;</span><br><span class="line">                            char *msg = &quot;HTTP/1.0 200 OK \</span><br><span class="line">                                         &lt;\r\n\r\n&lt;html&gt;&lt;h1&gt; \</span><br><span class="line">                                         yingying beautiful \</span><br><span class="line">                                         &lt;/h1&gt;&lt;/html&gt;\r\n&quot;;</span><br><span class="line">                            write(peerfd[i].fd,msg,strlen(msg));</span><br><span class="line">                            close(peerfd[i].fd);</span><br><span class="line">                            peerfd[i].fd = -1;</span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;//for</span><br><span class="line">                &#125;//default</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>具体流程如下：</p><ol><li>poll()函数返回fds集合中就绪的读、写，或出错的描述符数量，返回0表示超时，返回-1表示出错；</li><li>fds是一个struct pollfd类型的数组，用于存放需要检测其状态的socket描述符，并且调用poll函数之后fds数组不会被清空；</li><li>nfds记录数组fds中描述符的总数量；</li><li>timeout是调用poll函数阻塞的超时时间，单位毫秒；</li><li>一个pollfd结构体表示一个被监视的文件描述符，通过传递fds[]指示 poll() 监视多个文件描述符。其中，结构体的events域是监视该文件描述符的事件掩码，由用户来设置这个域，结构体的revents域是文件描述符的操作结果事件掩码，内核在调用返回时设置这个域。events域中请求的任何事件都可能在revents域中返回。</li></ol><h3 id="4-3、epoll"><a href="#4-3、epoll" class="headerlink" title="4.3、epoll"></a>4.3、epoll</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include&lt;sys/types.h&gt;</span><br><span class="line">#include&lt;sys/socket.h&gt;</span><br><span class="line">#include&lt;netinet/in.h&gt;</span><br><span class="line">#include&lt;arpa/inet.h&gt;</span><br><span class="line">#include&lt;stdlib.h&gt;</span><br><span class="line">#include&lt;string.h&gt;</span><br><span class="line">#include&lt;sys/epoll.h&gt;</span><br><span class="line">static Usage(const char* proc)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;%s [local_ip] [local_port]\n&quot;,proc);</span><br><span class="line">&#125;</span><br><span class="line">int start_up(const char*_ip,int _port)</span><br><span class="line">&#123;</span><br><span class="line">    int sock = socket(AF_INET,SOCK_STREAM,0);</span><br><span class="line">    if(sock &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;socket&quot;);</span><br><span class="line">        exit(2);</span><br><span class="line">    &#125;</span><br><span class="line">    struct sockaddr_in local;</span><br><span class="line">    local.sin_family = AF_INET;</span><br><span class="line">    local.sin_port = htons(_port);</span><br><span class="line">    local.sin_addr.s_addr = inet_addr(_ip);</span><br><span class="line">    if(bind(sock,(struct sockaddr*)&amp;local,sizeof(local)) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;bind&quot;);</span><br><span class="line">        exit(3);</span><br><span class="line">    &#125;</span><br><span class="line">    if(listen(sock,10)&lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;listen&quot;);</span><br><span class="line">        exit(4);</span><br><span class="line">    &#125;</span><br><span class="line">    return sock;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char*argv[])</span><br><span class="line">&#123;</span><br><span class="line">    if(argc != 3)</span><br><span class="line">    &#123;</span><br><span class="line">        Usage(argv[0]);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    int sock = start_up(argv[1],atoi(argv[2]));</span><br><span class="line">    int epollfd = epoll_create(256);</span><br><span class="line">    if(epollfd &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;epoll_create&quot;);</span><br><span class="line">        return 5;</span><br><span class="line">    &#125;</span><br><span class="line">    struct epoll_event ev;</span><br><span class="line">    ev.events = EPOLLIN;</span><br><span class="line">    ev.data.fd = sock;</span><br><span class="line">    if(epoll_ctl(epollfd,EPOLL_CTL_ADD,sock,&amp;ev) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;epoll_ctl&quot;);</span><br><span class="line">        return 6;</span><br><span class="line">    &#125;</span><br><span class="line">    int evnums = 0;//epoll_wait return val</span><br><span class="line">    struct epoll_event evs[64];</span><br><span class="line">    int timeout = -1;</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;</span><br><span class="line">        switch(evnums = epoll_wait(epollfd,evs,64,timeout))</span><br><span class="line">        &#123;</span><br><span class="line">            case 0:</span><br><span class="line">     printf(&quot;timeout...\n&quot;);</span><br><span class="line">     break;</span><br><span class="line">            case -1:</span><br><span class="line">     perror(&quot;epoll_wait&quot;);</span><br><span class="line">     break;</span><br><span class="line">default:</span><br><span class="line">     &#123;</span><br><span class="line">         int i = 0;</span><br><span class="line">         for(; i &lt; evnums; ++i)</span><br><span class="line">         &#123;</span><br><span class="line">             struct sockaddr_in client;</span><br><span class="line">             socklen_t len = sizeof(client);</span><br><span class="line">             if(evs[i].data.fd == sock \</span><br><span class="line">                     &amp;&amp; evs[i].events &amp; EPOLLIN)</span><br><span class="line">             &#123;</span><br><span class="line">                 int new_sock = accept(sock, \</span><br><span class="line">                         (struct sockaddr*)&amp;client,&amp;len);</span><br><span class="line">                 if(new_sock &lt; 0)</span><br><span class="line">                 &#123;</span><br><span class="line">                     perror(&quot;accept&quot;);</span><br><span class="line">                     continue;</span><br><span class="line">                 &#125;//if accept failed</span><br><span class="line">                 else </span><br><span class="line">                 &#123;</span><br><span class="line">                     printf(&quot;Get a new client[%s]\n&quot;, \</span><br><span class="line">                             inet_ntoa(client.sin_addr));</span><br><span class="line">                     ev.data.fd = new_sock;</span><br><span class="line">                     ev.events = EPOLLIN;</span><br><span class="line">                     epoll_ctl(epollfd,EPOLL_CTL_ADD,\</span><br><span class="line">                             new_sock,&amp;ev);</span><br><span class="line">                 &#125;//accept success</span><br><span class="line"></span><br><span class="line">             &#125;//if fd == sock</span><br><span class="line">             else if(evs[i].data.fd != sock &amp;&amp; \</span><br><span class="line">                     evs[i].events &amp; EPOLLIN)</span><br><span class="line">             &#123;</span><br><span class="line">                 char buf[1024];</span><br><span class="line">                 ssize_t s = read(evs[i].data.fd,buf,sizeof(buf) - 1);</span><br><span class="line">                 if(s &gt; 0)</span><br><span class="line">                 &#123;</span><br><span class="line">                     buf[s] = 0;</span><br><span class="line">                     printf(&quot;client say#%s&quot;,buf);</span><br><span class="line">                     ev.data.fd = evs[i].data.fd;</span><br><span class="line">                     ev.events = EPOLLOUT;</span><br><span class="line">                     epoll_ctl(epollfd,EPOLL_CTL_MOD, \</span><br><span class="line">                             evs[i].data.fd,&amp;ev);</span><br><span class="line">                 &#125;//s &gt; 0</span><br><span class="line">                 else</span><br><span class="line">                 &#123;</span><br><span class="line">                     close(evs[i].data.fd);</span><br><span class="line">                     epoll_ctl(epollfd,EPOLL_CTL_DEL, \</span><br><span class="line">                             evs[i].data.fd,NULL);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;//fd != sock</span><br><span class="line">             else if(evs[i].data.fd != sock \</span><br><span class="line">                     &amp;&amp; evs[i].events &amp; EPOLLOUT)</span><br><span class="line">             &#123;</span><br><span class="line">                 char *msg =  &quot;HTTP/1.0 200 OK &lt;\r\n\r\n&lt;html&gt;&lt;h1&gt;yingying beautiful &lt;/h1&gt;&lt;/html&gt;\r\n&quot;;</span><br><span class="line">                 write(evs[i].data.fd,msg,strlen(msg));</span><br><span class="line">                 close(evs[i].data.fd);</span><br><span class="line">                 epoll_ctl(epollfd,EPOLL_CTL_DEL, \</span><br><span class="line">                             evs[i].data.fd,NULL);</span><br><span class="line">             &#125;//EPOLLOUT</span><br><span class="line">             else</span><br><span class="line">             &#123;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;//for</span><br><span class="line">     &#125;//default</span><br><span class="line">     break;</span><br><span class="line">        &#125;//switch</span><br><span class="line">    &#125;//while</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>epoll_create</strong>函数创建一个epoll句柄，参数size表明内核要监听的描述符数量。调用成功时返回一个epoll句柄描述符，失败时返回-1。</li><li><strong>epoll_ct</strong>l函数注册要监听的事件类型。四个参数解释如下： epfd表示epoll句柄； op表示fd操作类型：<strong>EPOLL_CTL_ADD</strong>（注册新的fd到epfd中），<strong>EPOLL_CTL_MOD</strong>（修改已注册的fd的监听事件），<strong>EPOLL_CTL_DEL</strong>（从epfd中删除一个fd）；fd是要监听的描述符； event表示要监听的事件，epoll_event结构体定义如下：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct epoll_event &#123; </span><br><span class="line">  __uint32_t events; /* Epoll events */ </span><br><span class="line">  epoll_data_t data; /* User data variable */ </span><br><span class="line">&#125;; </span><br><span class="line">typedef union epoll_data &#123;</span><br><span class="line">  void *ptr; </span><br><span class="line">  int fd; </span><br><span class="line">  __uint32_t u32;</span><br><span class="line">  __uint64_t u64; </span><br><span class="line">&#125; epoll_data_t;</span><br></pre></td></tr></table></figure><ul><li><strong>. epoll_wait</strong> 函数等待事件的就绪，成功时返回就绪的事件数目，调用失败时返回 -1，等待超时返回 0。maxevents告诉内核events的大小，timeout表示等待的超时事件。</li></ul><p><strong>5、总结</strong><br>epoll是 Linux 目前大规模网络并发程序开发的首选模型。在绝大多数情况下性能远超 select和poll。目前流行的高性能web服务器Nginx正式依赖于epoll提供的高效网络套接字轮询服务。但是，在并发连接不高的情况下，多线程+阻塞 IO 方式可能性能更好。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;0、前言&quot;&gt;&lt;a href=&quot;#0、前言&quot; class=&quot;headerlink&quot; title=&quot;0、前言&quot;&gt;&lt;/a&gt;0、前言&lt;/h2&gt;&lt;p&gt;对于每一个从事 Web 服务器开发的后端程序员，必然绕不开网络编程，而其中最基础也是最重要的部分就是 Linux IO 模式</summary>
      
    
    
    
    <category term="TCP" scheme="https://wuhaocn.github.io/categories/TCP/"/>
    
    
    <category term="TCP" scheme="https://wuhaocn.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>IMS-短信发送</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/sip/IMS-%E7%9F%AD%E4%BF%A1%E5%8F%91%E9%80%81/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/sip/IMS-%E7%9F%AD%E4%BF%A1%E5%8F%91%E9%80%81/</id>
    <published>2023-11-15T03:40:25.015Z</published>
    <updated>2023-11-15T03:40:25.015Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-概要"><a href="#1-概要" class="headerlink" title="1.概要"></a>1.概要</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627393585310-6f9ba81e-d9fb-4245-80cf-c83aa7588bc3.png#clientId=ue276c832-69f5-4&from=paste&height=698&id=R2dku&margin=%5Bobject%20Object%5D&name=image.png&originHeight=698&originWidth=1145&originalType=binary&ratio=1&size=97410&status=done&style=none&taskId=ua3fd77d1-9e57-466e-a4f7-f3d3286a9ab&width=1145" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627487350302-314d17cd-fd39-4330-ba7e-eced2c55f0db.png#clientId=u591ad28a-e8ae-4&from=paste&height=79&id=u9eea8836&margin=%5Bobject%20Object%5D&name=image.png&originHeight=158&originWidth=2706&originalType=binary&ratio=1&size=91621&status=done&style=none&taskId=ua89d6db6-03e6-400f-9f25-a6f88a2d590&width=1353" alt="image.png"></p><h2 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h2><p>MESSAGE tel:+8615068458834 SIP/2.0<br>Max-Forwards: 70<br>Via: SIP/2.0/TCP 10.235.162.57:56808;branch=z9hG4bK-EKbwawmA<br>User-Agent: CPM-client/OMA2.2 RCS-client/UP_2.4 term-Xiaomi/MI 6-8.0.0 client-MF/1.1.0 OS-Android/8.0.0 Channel-terminal-000001 Channel-client-731184<br>Call-ID: a989baac-4e10-4e10-a64b-4ec7e161d645<br>Contribution-ID: 94d850fb-ed40-437e-9609-de9ea0e393d9<br>Conversation-ID: 4f93f0fe-86d6-462c-9ba2-e4bc3d1cafcc<br>From: <a href="tel:+8615053065637">tel:+8615053065637</a>;tag=p0Xq8Mny<br>To: <a href="tel:+8615068458834">tel:+8615068458834</a><br>CSeq: 1 MESSAGE<br>P-Preferred-Identity: tel:+8615053065637<br>P-Preferred-Service: urn:urn-7:3gpp-service.ims.icsi.oma.cpm.msg<br>Content-Type: message/cpim<br>Content-Length: 350</p><p>From: <a href="tel:+8615053065637">tel:+8615053065637</a><br>To: <a href="tel:+8615068458834">tel:+8615068458834</a><br>DateTime: 2020-09-27T04:02:25.941Z<br>NS: cpm <a href="http://www.openmobilealliance.org/cpm/">http://www.openmobilealliance.org/cpm/</a><br>cpm.Payload-Type: text/plain<br>NS: imdn <a href="urn:ietf:params:imdn">urn:ietf:params:imdn</a><br>imdn.Message-ID: 0a76cec9-c5f4-4f1d-a502-8518a57bf8be</p><p>Content-Type: text/plain<br>Content-Transfer-Encoding: base64<br>Content-Length: 8</p><p>5Z6D5Zy+</p><h2 id="应答"><a href="#应答" class="headerlink" title="应答"></a>应答</h2><p>SIP/2.0 202 Accepted<br>Server: IM-Sever/OMA5.1<br>Record-Route: <a href="sip:orig@10.10.208.199:6060;transport=tcp;lr;i=2;s=0">sip:orig@10.10.208.199:6060;transport=tcp;lr;i=2;s=0</a><br>Via: SIP/2.0/TCP 10.235.162.57:56808;branch=z9hG4bK-EKbwawmA;received=124.64.18.253;rport=50095<br>From: <a href="tel:+8615053065637">tel:+8615053065637</a>;tag=p0Xq8Mny<br>Call-ID: a989baac-4e10-4e10-a64b-4ec7e161d645<br>To: <a href="tel:+8615068458834">tel:+8615068458834</a>;tag=644677907844<br>CSeq: 1 MESSAGE<br>Max-Forwards: 70<br>Conversation-ID: 4f93f0fe-86d6-462c-9ba2-e4bc3d1cafcc<br>Contribution-ID: 94d850fb-ed40-437e-9609-de9ea0e393d9<br>Content-Length: 0</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-概要&quot;&gt;&lt;a href=&quot;#1-概要&quot; class=&quot;headerlink&quot; title=&quot;1.概要&quot;&gt;&lt;/a&gt;1.概要&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2021/png/804884/162739</summary>
      
    
    
    
    <category term="SIP" scheme="https://wuhaocn.github.io/categories/SIP/"/>
    
    
    <category term="IMS" scheme="https://wuhaocn.github.io/tags/IMS/"/>
    
  </entry>
  
  <entry>
    <title>音视频通话</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/sip/IMS-%E9%9F%B3%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E6%8A%A5%E6%96%87/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/sip/IMS-%E9%9F%B3%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E6%8A%A5%E6%96%87/</id>
    <published>2023-11-15T03:40:25.015Z</published>
    <updated>2023-11-15T03:40:25.015Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-主要流程"><a href="#1-主要流程" class="headerlink" title="1.主要流程"></a>1.主要流程</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627470940752-974ccafb-9a9f-4493-b685-fc011492c598.png#clientId=u483e4c72-e2ee-4&from=drop&id=uae785ddf&margin=%5Bobject%20Object%5D&name=%E4%B8%8B%E8%BD%BD%20%283%29.png&originHeight=1215&originWidth=1277&originalType=binary&ratio=1&size=133973&status=done&style=none&taskId=ua18dae18-1f40-42d0-8acd-04779ad4c05" alt="下载 (3).png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627471023385-85c0acc3-4b59-45fc-bca4-abf99963f673.png#clientId=u483e4c72-e2ee-4&from=paste&height=250&id=u01d42343&margin=%5Bobject%20Object%5D&name=image.png&originHeight=250&originWidth=1286&originalType=binary&ratio=1&size=234005&status=done&style=none&taskId=ue1c25eb8-003d-44f7-ac45-24f1c730440&width=1286" alt="image.png"></p><h2 id="2-音频通话"><a href="#2-音频通话" class="headerlink" title="2.音频通话"></a>2.音频通话</h2><h3 id="2-1-INVITE"><a href="#2-1-INVITE" class="headerlink" title="2.1 INVITE"></a>2.1 INVITE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">INVITE tel:+8616500000062 SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">Contact: &lt;sip:+8616500000061@222.222.2.27:5060&gt;;+sip.instance=&quot;&lt;urn:gsma:imei:86354104-407800-0&gt;&quot;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting;+g.3gpp.ps2cs-srvcc-orig-pre-alerting</span><br><span class="line">Accept-Contact: *;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">P-Preferred-Service: urn:urn-7:3gpp-service.ims.icsi.mmtel</span><br><span class="line">P-Early-Media: supported</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Accept: application/sdp,application/3gpp-ims+xml</span><br><span class="line">Session-Expires: 1800</span><br><span class="line">Min-SE: 90</span><br><span class="line">Route: &lt;sip:172.16.106.38:5060;lr&gt;</span><br><span class="line">Require: sec-agree</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKswecbCEJ7GcqBMwaay6Y;rport</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Content-Length: 772</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3211 3211 IN IP4 222.222.2.27</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 222.222.2.27</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 31022 RTP/AVP 107 106 105 104 101 102</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:106 AMR-WB/16000/1</span><br><span class="line">a=fmtp:106 octet-align=1;mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:105 AMR/8000/1</span><br><span class="line">a=fmtp:105 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:104 AMR/8000/1</span><br><span class="line">a=fmtp:104 octet-align=1;mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=rtpmap:102 telephone-event/8000</span><br><span class="line">a=fmtp:102 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local none</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos optional remote sendrecv</span><br></pre></td></tr></table></figure><h3 id="2-2-Trying"><a href="#2-2-Trying" class="headerlink" title="2.2 Trying"></a>2.2 Trying</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 100 Trying</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKswecbCEJ7GcqBMwaay6Y;rport=5060</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Server: IM-Sever/OMA5.1</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-3-183-Session-Progress"><a href="#2-3-183-Session-Progress" class="headerlink" title="2.3 183 Session Progress"></a>2.3 183 Session Progress</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 183 Session Progress</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000062@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Require: 100rel,precondition</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKswecbCEJ7GcqBMwaay6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Session-Expires: 1800</span><br><span class="line">RSeq: 1</span><br><span class="line">Content-Length: 487</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3219 3219 IN IP4 172.16.106.38</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 172.16.106.38</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 30052 RTP/AVP 107 101</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local none</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br><span class="line">a=conf:qos remote sendrecv</span><br></pre></td></tr></table></figure><h3 id="2-4-PRACK"><a href="#2-4-PRACK" class="headerlink" title="2.4 PRACK"></a>2.4 PRACK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PRACK sip:+8616500000062@172.16.106.38:5060;transport=udp SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">CSeq: 2 PRACK</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKtxecbCEJ7GcqBMwaaq6Y;rport</span><br><span class="line">RAck: 1 1 INVITE</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-5-200-OK"><a href="#2-5-200-OK" class="headerlink" title="2.5 200 OK"></a>2.5 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKtxecbCEJ7GcqBMwaaq6Y;rport=5060</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">CSeq: 2 PRACK</span><br><span class="line">Server: IM-Sever/OMA5.1</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-6-UPDATE"><a href="#2-6-UPDATE" class="headerlink" title="2.6 UPDATE"></a>2.6 UPDATE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">UPDATE sip:+8616500000062@172.16.106.38:5060;transport=udp SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">Contact: &lt;sip:+8616500000061@222.222.2.27:5060&gt;;+sip.instance=&quot;&lt;urn:gsma:imei:86354104-407800-0&gt;&quot;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting;+g.3gpp.ps2cs-srvcc-orig-pre-alerting</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Require: precondition,sec-agree</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">CSeq: 3 UPDATE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKqyecbCEJ7GcqBMwaaW6Y;rport</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Content-Length: 461</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3211 3212 IN IP4 222.222.2.27</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 222.222.2.27</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 31022 RTP/AVP 107 101</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local sendrecv</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br></pre></td></tr></table></figure><h3 id="2-7-200-OK"><a href="#2-7-200-OK" class="headerlink" title="2.7 200 OK"></a>2.7 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Min-SE: 90</span><br><span class="line">Require: precondition,timer</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Session-Expires: 1800;refresher=uas</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKqyecbCEJ7GcqBMwaaW6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">CSeq: 3 UPDATE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Content-Length: 467</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3219 3220 IN IP4 172.16.106.38</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 172.16.106.38</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 30052 RTP/AVP 107 101</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local sendrecv</span><br><span class="line">a=curr:qos remote sendrecv</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br><span class="line">SIP/2.0 180 Ringing</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000062@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKswecbCEJ7GcqBMwaay6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Session-Expires: 1800</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-8-200-OK"><a href="#2-8-200-OK" class="headerlink" title="2.8 200 OK"></a>2.8 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000062@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Min-SE: 90</span><br><span class="line">Require: timer</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Session-Expires: 1800;refresher=uas</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKswecbCEJ7GcqBMwaay6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-9-ACK"><a href="#2-9-ACK" class="headerlink" title="2.9 ACK"></a>2.9 ACK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ACK sip:+8616500000062@172.16.106.38:5060;transport=udp SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">Contact: &lt;sip:+8616500000061@222.222.2.27:5060&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Require: sec-agree</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">CSeq: 1 ACK</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKrzecbCEJ7GcqBMwaaCcs;rport</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-10-200-OK"><a href="#2-10-200-OK" class="headerlink" title="2.10 200 OK"></a>2.10 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SIP/2.0 200 OK</span><br><span class="line">Server: IM-Sever/OMA5.1</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKrzecbCEJ7GcqBMwaaCcs;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">CSeq: 1 ACK</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-11-BYE"><a href="#2-11-BYE" class="headerlink" title="2.11 BYE"></a>2.11 BYE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">BYE sip:+8616500000061@222.222.2.27:5060 SIP/2.0</span><br><span class="line">Reason: SIP;cause=200;text=&quot;User term the call.&quot;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Require: sec-agree</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Max-Forwards: 68</span><br><span class="line">CSeq: 1 BYE</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">From: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">To: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Via: SIP/2.0/UDP 172.16.106.38:5060;branch=z9hG4bK948fb923faf4;rport=54872</span><br><span class="line">Via: SIP/2.0/TCP 172.16.106.38:6060;branch=z9hG4bKe104ab646147;rport=59226</span><br><span class="line">Via: SIP/2.0/TCP 222.222.2.29:6070;branch=z9hG4bKIQecbQDRYGizsRqaayaZ;rport=41222;received=172.16.106.38</span><br><span class="line">Record-Route: &lt;sip:172.16.106.38:6060;transport=tcp;lr&gt;</span><br><span class="line">Record-Route: &lt;sip:172.16.106.38:6060;transport=tcp;lr&gt;</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="2-12-200-OK"><a href="#2-12-200-OK" class="headerlink" title="2.12 200 OK"></a>2.12 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">From: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=464889803917</span><br><span class="line">To: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=rvecbSk</span><br><span class="line">Call-ID: quecbSk9i@222.222.2.27</span><br><span class="line">CSeq: 1 BYE</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Via: SIP/2.0/UDP 172.16.106.38:5060;branch=z9hG4bK948fb923faf4;rport=5060</span><br><span class="line">Via: SIP/2.0/TCP 172.16.106.38:6060;branch=z9hG4bKe104ab646147;rport=59226</span><br><span class="line">Via: SIP/2.0/TCP 222.222.2.29:6070;branch=z9hG4bKIQecbQDRYGizsRqaayaZ;rport=41222;received=172.16.106.38</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h2 id="3-视频通话"><a href="#3-视频通话" class="headerlink" title="3.视频通话"></a>3.视频通话</h2><h3 id="3-1-INVITE"><a href="#3-1-INVITE" class="headerlink" title="3.1 INVITE"></a>3.1 INVITE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">INVITE tel:+8616500000062 SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">Contact: &lt;sip:+8616500000061@222.222.2.27:5060&gt;;+sip.instance=&quot;&lt;urn:gsma:imei:86354104-407800-0&gt;&quot;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting;+g.3gpp.ps2cs-srvcc-orig-pre-alerting</span><br><span class="line">Accept-Contact: *;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;video</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">P-Preferred-Service: urn:urn-7:3gpp-service.ims.icsi.mmtel</span><br><span class="line">P-Early-Media: supported</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Accept: application/sdp,application/3gpp-ims+xml</span><br><span class="line">Session-Expires: 1800</span><br><span class="line">Min-SE: 90</span><br><span class="line">Route: &lt;sip:172.16.106.38:5060;lr&gt;</span><br><span class="line">Require: sec-agree</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKckecbmOloqn5UNvaay6Y;rport</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Content-Length: 1596</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3209 3209 IN IP4 222.222.2.27</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 222.222.2.27</span><br><span class="line">b=AS:1001</span><br><span class="line">b=RR:7537</span><br><span class="line">b=RS:8512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 31018 RTP/AVP 107 106 105 104 101 102</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:106 AMR-WB/16000/1</span><br><span class="line">a=fmtp:106 octet-align=1;mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:105 AMR/8000/1</span><br><span class="line">a=fmtp:105 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:104 AMR/8000/1</span><br><span class="line">a=fmtp:104 octet-align=1;mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=rtpmap:102 telephone-event/8000</span><br><span class="line">a=fmtp:102 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local none</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos optional remote sendrecv</span><br><span class="line">m=video 37058 RTP/AVP 120 123</span><br><span class="line">b=AS:960</span><br><span class="line">b=RR:6000</span><br><span class="line">b=RS:8000</span><br><span class="line">a=tcap:1 RTP/AVPF</span><br><span class="line">a=pcfg:1 t=1</span><br><span class="line">a=rtpmap:120 H265/90000</span><br><span class="line">a=fmtp:120 profile-id=1; level-id=93; max-br=1340</span><br><span class="line">a=imageattr:120 send [x=480,y=640] [x=360,y=480] [x=240,y=320] recv [x=480,y=640] [x=360,y=480] [x=240,y=320]</span><br><span class="line">a=rtpmap:123 H264/90000</span><br><span class="line">a=fmtp:123 profile-level-id=42C01F; packetization-mode=1; max-br=974; sprop-parameter-sets=Z0LAHtoHgUSAeEAhUA==,aM48gA==</span><br><span class="line">a=imageattr:123 send [x=480,y=640] [x=360,y=480] [x=240,y=320] recv [x=480,y=640] [x=360,y=480] [x=240,y=320]</span><br><span class="line">a=rtcp-fb:* trr-int 5000</span><br><span class="line">a=rtcp-fb:* nack</span><br><span class="line">a=rtcp-fb:* nack pli</span><br><span class="line">a=rtcp-fb:* ccm fir</span><br><span class="line">a=rtcp-fb:* ccm tmmbr</span><br><span class="line">a=sendrecv</span><br><span class="line">a=extmap:7 urn:3gpp:video-orientation</span><br><span class="line">a=curr:qos local none</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos optional remote sendrecv</span><br></pre></td></tr></table></figure><h3 id="3-2-100-Trying"><a href="#3-2-100-Trying" class="headerlink" title="3.2 100 Trying"></a>3.2 100 Trying</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 100 Trying</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKckecbmOloqn5UNvaay6Y;rport=5060</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Server: IM-Sever/OMA5.1</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-3-183-Session-Progress"><a href="#3-3-183-Session-Progress" class="headerlink" title="3.3 183 Session Progress"></a>3.3 183 Session Progress</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 183 Session Progress</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000062@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Require: 100rel,precondition</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKckecbmOloqn5UNvaay6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Session-Expires: 1800</span><br><span class="line">RSeq: 1</span><br><span class="line">Content-Length: 1059</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3217 3217 IN IP4 172.16.106.38</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 172.16.106.38</span><br><span class="line">b=AS:1001</span><br><span class="line">b=RR:7537</span><br><span class="line">b=RS:8512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 30016 RTP/AVP 107 101</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local none</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br><span class="line">a=conf:qos remote sendrecv</span><br><span class="line">m=video 30018 RTP/AVPF 120</span><br><span class="line">b=AS:960</span><br><span class="line">b=RR:6000</span><br><span class="line">b=RS:8000</span><br><span class="line">a=acfg:1 t=1</span><br><span class="line">a=rtpmap:120 H265/90000</span><br><span class="line">a=fmtp:120 profile-id=1; level-id=93; max-br=974</span><br><span class="line">a=imageattr:120 send [x=480,y=640] [x=360,y=480] [x=240,y=320] recv [x=480,y=640] [x=360,y=480] [x=240,y=320]</span><br><span class="line">a=rtcp-fb:* trr-int 5000</span><br><span class="line">a=rtcp-fb:* nack</span><br><span class="line">a=rtcp-fb:* nack pli</span><br><span class="line">a=rtcp-fb:* ccm fir</span><br><span class="line">a=rtcp-fb:* ccm tmmbr</span><br><span class="line">a=sendrecv</span><br><span class="line">a=extmap:7 urn:3gpp:video-orientation</span><br><span class="line">a=curr:qos local none</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br><span class="line">a=conf:qos remote sendrecv</span><br></pre></td></tr></table></figure><h3 id="3-4-PRACK"><a href="#3-4-PRACK" class="headerlink" title="3.4 PRACK"></a>3.4 PRACK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PRACK sip:+8616500000062@172.16.106.38:5060;transport=udp SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">CSeq: 2 PRACK</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKdlecbSk9iWVQOxwaaq6Y;rport</span><br><span class="line">RAck: 1 1 INVITE</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-5-200-OK"><a href="#3-5-200-OK" class="headerlink" title="3.5 200 OK"></a>3.5 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKdlecbSk9iWVQOxwaaq6Y;rport=5060</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">CSeq: 2 PRACK</span><br><span class="line">Server: IM-Sever/OMA5.1</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-6-UPDATE"><a href="#3-6-UPDATE" class="headerlink" title="3.6 UPDATE"></a>3.6 UPDATE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">UPDATE sip:+8616500000062@172.16.106.38:5060;transport=udp SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">Contact: &lt;sip:+8616500000061@222.222.2.27:5060&gt;;+sip.instance=&quot;&lt;urn:gsma:imei:86354104-407800-0&gt;&quot;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting;+g.3gpp.ps2cs-srvcc-orig-pre-alerting</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Require: precondition,sec-agree</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">CSeq: 3 UPDATE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKamecbSk9iWVQOxwaaW6Y;rport</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Content-Length: 995</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3209 3210 IN IP4 222.222.2.27</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 222.222.2.27</span><br><span class="line">b=AS:1001</span><br><span class="line">b=RR:7537</span><br><span class="line">b=RS:8512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 31018 RTP/AVP 107 101</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local sendrecv</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br><span class="line">m=video 37058 RTP/AVPF 120</span><br><span class="line">b=AS:960</span><br><span class="line">b=RR:6000</span><br><span class="line">b=RS:8000</span><br><span class="line">a=rtpmap:120 H265/90000</span><br><span class="line">a=fmtp:120 profile-id=1; level-id=93; max-br=974</span><br><span class="line">a=imageattr:120 send [x=480,y=640] [x=360,y=480] [x=240,y=320] recv [x=480,y=640] [x=360,y=480] [x=240,y=320]</span><br><span class="line">a=rtcp-fb:* trr-int 5000</span><br><span class="line">a=rtcp-fb:* nack</span><br><span class="line">a=rtcp-fb:* nack pli</span><br><span class="line">a=rtcp-fb:* ccm fir</span><br><span class="line">a=rtcp-fb:* ccm tmmbr</span><br><span class="line">a=sendrecv</span><br><span class="line">a=extmap:7 urn:3gpp:video-orientation</span><br><span class="line">a=curr:qos local sendrecv</span><br><span class="line">a=curr:qos remote none</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br></pre></td></tr></table></figure><h3 id="3-7-200-OK"><a href="#3-7-200-OK" class="headerlink" title="3.7 200 OK"></a>3.7 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Min-SE: 90</span><br><span class="line">Require: precondition,timer</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Session-Expires: 1800;refresher=uas</span><br><span class="line">Content-Type: application/sdp</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKamecbSk9iWVQOxwaaW6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">CSeq: 3 UPDATE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Content-Length: 1005</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=rue 3217 3218 IN IP4 172.16.106.38</span><br><span class="line">s=-</span><br><span class="line">c=IN IP4 172.16.106.38</span><br><span class="line">b=AS:1001</span><br><span class="line">b=RR:7537</span><br><span class="line">b=RS:8512</span><br><span class="line">t=0 0</span><br><span class="line">m=audio 30016 RTP/AVP 107 101</span><br><span class="line">b=AS:41</span><br><span class="line">b=RR:1537</span><br><span class="line">b=RS:512</span><br><span class="line">a=rtpmap:107 AMR-WB/16000/1</span><br><span class="line">a=fmtp:107 mode-change-capability=2;max-red=0</span><br><span class="line">a=rtpmap:101 telephone-event/16000</span><br><span class="line">a=fmtp:101 0-15</span><br><span class="line">a=ptime:20</span><br><span class="line">a=maxptime:240</span><br><span class="line">a=sendrecv</span><br><span class="line">a=curr:qos local sendrecv</span><br><span class="line">a=curr:qos remote sendrecv</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br><span class="line">m=video 30018 RTP/AVPF 120</span><br><span class="line">b=AS:960</span><br><span class="line">b=RR:6000</span><br><span class="line">b=RS:8000</span><br><span class="line">a=rtpmap:120 H265/90000</span><br><span class="line">a=fmtp:120 profile-id=1; level-id=93; max-br=974</span><br><span class="line">a=imageattr:120 send [x=480,y=640] [x=360,y=480] [x=240,y=320] recv [x=480,y=640] [x=360,y=480] [x=240,y=320]</span><br><span class="line">a=rtcp-fb:* trr-int 5000</span><br><span class="line">a=rtcp-fb:* nack</span><br><span class="line">a=rtcp-fb:* nack pli</span><br><span class="line">a=rtcp-fb:* ccm fir</span><br><span class="line">a=rtcp-fb:* ccm tmmbr</span><br><span class="line">a=sendrecv</span><br><span class="line">a=extmap:7 urn:3gpp:video-orientation</span><br><span class="line">a=curr:qos local sendrecv</span><br><span class="line">a=curr:qos remote sendrecv</span><br><span class="line">a=des:qos mandatory local sendrecv</span><br><span class="line">a=des:qos mandatory remote sendrecv</span><br><span class="line">SIP/2.0 180 Ringing</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000062@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKckecbmOloqn5UNvaay6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Session-Expires: 1800</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-8-200-OK"><a href="#3-8-200-OK" class="headerlink" title="3.8 200 OK"></a>3.8 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">P-Preferred-Identity: &lt;sip:+8616500000062@ims.mnc000.mcc000.3gppnetwork.org&gt;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,UPDATE,INFO,PRACK,NOTIFY,MESSAGE,REFER</span><br><span class="line">Min-SE: 90</span><br><span class="line">Require: timer</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Session-Expires: 1800;refresher=uas</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKckecbmOloqn5UNvaay6Y;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">CSeq: 1 INVITE</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Contact: &lt;sip:+8616500000062@172.16.106.38:5060;transport=udp&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;;audio;video;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-9-ACK"><a href="#3-9-ACK" class="headerlink" title="3.9 ACK"></a>3.9 ACK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ACK sip:+8616500000062@172.16.106.38:5060;transport=udp SIP/2.0</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">To: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">Contact: &lt;sip:+8616500000061@222.222.2.27:5060&gt;;+g.3gpp.icsi-ref=&quot;urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel&quot;</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Require: sec-agree</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">CSeq: 1 ACK</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKbnecbSk9iWVQOxwaaCcs;rport</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-10-200-OK"><a href="#3-10-200-OK" class="headerlink" title="3.10 200 OK"></a>3.10 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">Server: IM-Sever/OMA5.1</span><br><span class="line">Via: SIP/2.0/UDP 222.222.2.27:5060;branch=z9hG4bKbnecbSk9iWVQOxwaaCcs;rport=5060</span><br><span class="line">From: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">To: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">CSeq: 1 ACK</span><br><span class="line">Max-Forwards: 70</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-11-BYE"><a href="#3-11-BYE" class="headerlink" title="3.11 BYE"></a>3.11 BYE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">BYE sip:+8616500000061@222.222.2.27:5060 SIP/2.0</span><br><span class="line">Reason: SIP;cause=200;text=&quot;User term the call.&quot;</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer,sec-agree</span><br><span class="line">Require: sec-agree</span><br><span class="line">Proxy-Require: sec-agree</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Max-Forwards: 68</span><br><span class="line">CSeq: 1 BYE</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">From: &quot;8616500000062&quot; &lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">To: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Via: SIP/2.0/UDP 172.16.106.38:5060;branch=z9hG4bK8390bf49a6da;rport=54872</span><br><span class="line">Via: SIP/2.0/TCP 172.16.106.38:6060;branch=z9hG4bK0e2a771d7b17;rport=59226</span><br><span class="line">Via: SIP/2.0/TCP 222.222.2.29:6070;branch=z9hG4bKIMecbQDRYGizsRqaayaZ;rport=41222;received=172.16.106.38</span><br><span class="line">Record-Route: &lt;sip:172.16.106.38:6060;transport=tcp;lr&gt;</span><br><span class="line">Record-Route: &lt;sip:172.16.106.38:6060;transport=tcp;lr&gt;</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="3-12-200-OK"><a href="#3-12-200-OK" class="headerlink" title="3.12 200 OK"></a>3.12 200 OK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SIP/2.0 200 OK</span><br><span class="line">From: &quot;8616500000062&quot;&lt;tel:+8616500000062&gt;;tag=635653312983</span><br><span class="line">To: &lt;sip:+8616500000061@ims.mnc000.mcc000.3gppnetwork.org&gt;;tag=bjecbmO</span><br><span class="line">Call-ID: aiecbmOlo@222.222.2.27</span><br><span class="line">CSeq: 1 BYE</span><br><span class="line">Supported: 100rel,histinfo,join,norefersub,precondition,replaces,timer</span><br><span class="line">P-Access-Network-Info: 3GPP-NR-TDD;utran-cell-id-3gpp=4600000112207A123000</span><br><span class="line">Via: SIP/2.0/UDP 172.16.106.38:5060;branch=z9hG4bK8390bf49a6da;rport=5060</span><br><span class="line">Via: SIP/2.0/TCP 172.16.106.38:6060;branch=z9hG4bK0e2a771d7b17;rport=59226</span><br><span class="line">Via: SIP/2.0/TCP 222.222.2.29:6070;branch=z9hG4bKIMecbQDRYGizsRqaayaZ;rport=41222;received=172.16.106.38</span><br><span class="line">User-Agent: IM-client/OMA1.0 HW-Rto/V1.0</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-主要流程&quot;&gt;&lt;a href=&quot;#1-主要流程&quot; class=&quot;headerlink&quot; title=&quot;1.主要流程&quot;&gt;&lt;/a&gt;1.主要流程&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2021/png/80488</summary>
      
    
    
    
    <category term="SIP" scheme="https://wuhaocn.github.io/categories/SIP/"/>
    
    
    <category term="IMS" scheme="https://wuhaocn.github.io/tags/IMS/"/>
    
  </entry>
  
  <entry>
    <title>IMS-入网注册</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/sip/IMS-%E5%85%A5%E7%BD%91%E6%B3%A8%E5%86%8C/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/sip/IMS-%E5%85%A5%E7%BD%91%E6%B3%A8%E5%86%8C/</id>
    <published>2023-11-15T03:40:25.014Z</published>
    <updated>2023-11-15T03:40:25.015Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-概要"><a href="#1-概要" class="headerlink" title="1.概要"></a>1.概要</h2><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627393550010-ab490608-c0aa-415c-8aa2-35749258d676.png#clientId=ue276c832-69f5-4&from=paste&height=614&id=iOBZl&margin=%5Bobject%20Object%5D&name=image.png&originHeight=691&originWidth=704&originalType=binary&ratio=1&size=72864&status=done&style=none&taskId=ucd354c72-30eb-4676-b873-8e303c3f0cd&width=626" alt="image.png"></h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627487171816-e2da3602-ee5c-4e68-b644-12bb3e575d29.png#clientId=u591ad28a-e8ae-4&from=paste&height=103&id=u801e3236&margin=%5Bobject%20Object%5D&name=image.png&originHeight=206&originWidth=2832&originalType=binary&ratio=1&size=179904&status=done&style=none&taskId=u4579b25f-b3f9-4e2b-b287-cee9c146a5e&width=1416" alt="image.png"></p><h2 id="2-register"><a href="#2-register" class="headerlink" title="2.register"></a>2.register</h2><p>REGISTER sip:ims.mnc000.mcc000.3gppnetwork.org SIP/2.0<br>Contact: <a href="sip:460003911000057@172.16.106.92">sip:460003911000057@172.16.106.92</a>;+g.3gpp.icsi-ref=”urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel”;+g.3gpp.ics=”principal”<br>Authorization: Digest username=”<a href="mailto:&#56;&#54;&#x31;&#x33;&#x39;&#x31;&#x31;&#48;&#48;&#x30;&#48;&#x35;&#x37;&#x40;&#x69;&#x6d;&#x73;&#46;&#x6d;&#110;&#99;&#48;&#x30;&#48;&#46;&#x6d;&#x63;&#x63;&#48;&#x30;&#48;&#x2e;&#x33;&#103;&#x70;&#112;&#x6e;&#101;&#116;&#119;&#x6f;&#x72;&#x6b;&#46;&#111;&#114;&#103;">&#56;&#54;&#x31;&#x33;&#x39;&#x31;&#x31;&#48;&#48;&#x30;&#48;&#x35;&#x37;&#x40;&#x69;&#x6d;&#x73;&#46;&#x6d;&#110;&#99;&#48;&#x30;&#48;&#46;&#x6d;&#x63;&#x63;&#48;&#x30;&#48;&#x2e;&#x33;&#103;&#x70;&#112;&#x6e;&#101;&#116;&#119;&#x6f;&#x72;&#x6b;&#46;&#111;&#114;&#103;</a>“,realm=”ims.mnc000.mcc000.3gppnetwork.org”,nonce=””,uri=”sip:ims.mnc000.mcc000.3gppnetwork.org”,response=””,integrity-protected=”no”<br>Expires: 600000<br>Supported: sec-agree,path<br>CSeq: 1 REGISTER<br>Call-ID: <a href="mailto:&#x32;&#x39;&#x39;&#x30;&#54;&#64;&#x31;&#x37;&#50;&#46;&#49;&#x36;&#x2e;&#x31;&#x30;&#54;&#x2e;&#x39;&#50;">&#x32;&#x39;&#x39;&#x30;&#54;&#64;&#x31;&#x37;&#50;&#46;&#49;&#x36;&#x2e;&#x31;&#x30;&#54;&#x2e;&#x39;&#50;</a><br>From: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a>;tag=3196215<br>To: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a><br>P-Visited-Network-ID: “sip:<a href="mailto:&#x70;&#99;&#x73;&#x63;&#x66;&#64;&#x31;&#55;&#x32;&#x2e;&#49;&#54;&#46;&#49;&#48;&#x36;&#46;&#56;&#x31;">&#x70;&#99;&#x73;&#x63;&#x66;&#64;&#x31;&#55;&#x32;&#x2e;&#49;&#54;&#46;&#49;&#48;&#x36;&#46;&#56;&#x31;</a>:6070”<br>Feature-Caps: *;+g.3gpp.atcf=”<a href="tel:+12340000000">tel:+12340000000</a>“;+g.3gpp.atcf-mgmt-uri=”<a href="sip:172.16.106.81:6070">sip:172.16.106.81:6070</a>“;+g.3gpp.atcf-path=”<a href="sip:pcscf@172.16.106.81:6070;transport=udp;lr">sip:pcscf@172.16.106.81:6070;transport=udp;lr</a>“;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting<br>P-Track-ID: c98ce46bbb951afc2305297a67<br>Route: <a href="sip:proxy@172.16.106.94:5060;lr;transport=udp">sip:proxy@172.16.106.94:5060;lr;transport=udp</a><br>Service-Route: <a href="sip:172.16.106.95:5060;transport=udp;lr">sip:172.16.106.95:5060;transport=udp;lr</a><br>Path: <a href="sip:172.16.106.81:6070;transport=udp;lr;key=a02907193feadf0b3e14932b37">sip:172.16.106.81:6070;transport=udp;lr;key=a02907193feadf0b3e14932b37</a><br>P-UserAgent-Info: <a href="sip:172.16.106.92:5060;transport=udp">sip:172.16.106.92:5060;transport=udp</a>;+sbc.address=”<a href="sip:172.16.106.81:5060;lr;transport=udp">sip:172.16.106.81:5060;lr;transport=udp</a>“<br>Via: SIP/2.0/UDP 172.16.106.81:6070;branch=z9hG4bK19fae5599197<br>Via: SIP/2.0/UDP 172.16.106.92:5060;branch=z9hG4bK57ab028-c4e752e3<br>P-Access-Network-Info: 3GPP-NR-TDD; sip:172.16.106.81:5060;lr;transport=udp;ue-ip=172.16.106.92;ue-port=5060;raw-ip=172.16.106.92;raw-port=5060<br>Require: path<br>P-Charging-Vector: icid-value=2cd85e11b34b4fe68c4d8c698938d022;icid-generated-at=pcscf.visited.net;orig-ioi=visited.net<br>Max-Forwards: 69<br>Content-Length: 0</p><h2 id="3-401-Unauthorized"><a href="#3-401-Unauthorized" class="headerlink" title="3.401 Unauthorized"></a>3.401 Unauthorized</h2><p>SIP/2.0 401 Unauthorized<br>Via: SIP/2.0/UDP 172.16.106.81:6070;branch=z9hG4bK19fae5599197<br>Via: SIP/2.0/UDP 172.16.106.92:5060;branch=z9hG4bK57ab028-c4e752e3<br>From: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a>;tag=3196215<br>To: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a>;tag=228495176<br>Call-ID: <a href="mailto:&#x32;&#57;&#57;&#48;&#x36;&#x40;&#x31;&#55;&#50;&#46;&#49;&#54;&#46;&#x31;&#48;&#54;&#x2e;&#57;&#x32;">&#x32;&#57;&#57;&#48;&#x36;&#x40;&#x31;&#55;&#50;&#46;&#49;&#54;&#46;&#x31;&#48;&#54;&#x2e;&#57;&#x32;</a><br>CSeq: 1 REGISTER<br>Require: path<br>Content-Length: 0</p><h2 id="4-register"><a href="#4-register" class="headerlink" title="4.register"></a>4.register</h2><p>REGISTER sip:ims.mnc000.mcc000.3gppnetwork.org SIP/2.0<br>Contact: <a href="sip:460003911000057@172.16.106.92">sip:460003911000057@172.16.106.92</a>;+g.3gpp.icsi-ref=”urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel”;+g.3gpp.ics=”principal”<br>Authorization: Digest username=”<a href="mailto:&#56;&#x36;&#x31;&#51;&#57;&#x31;&#49;&#x30;&#48;&#x30;&#48;&#x35;&#x37;&#64;&#105;&#x6d;&#115;&#x2e;&#x6d;&#110;&#x63;&#x30;&#48;&#x30;&#46;&#x6d;&#99;&#x63;&#48;&#48;&#x30;&#x2e;&#51;&#x67;&#x70;&#112;&#x6e;&#x65;&#x74;&#119;&#x6f;&#x72;&#107;&#x2e;&#x6f;&#114;&#x67;">&#56;&#x36;&#x31;&#51;&#57;&#x31;&#49;&#x30;&#48;&#x30;&#48;&#x35;&#x37;&#64;&#105;&#x6d;&#115;&#x2e;&#x6d;&#110;&#x63;&#x30;&#48;&#x30;&#46;&#x6d;&#99;&#x63;&#48;&#48;&#x30;&#x2e;&#51;&#x67;&#x70;&#112;&#x6e;&#x65;&#x74;&#119;&#x6f;&#x72;&#107;&#x2e;&#x6f;&#114;&#x67;</a>“,realm=”ims.mnc000.mcc000.3gppnetwork.org”,nonce=”89pxm4eQF/BAwKVAYTTZYQAAAAAAALm5/UxxNqNHseE=”,uri=”sip:ims.mnc000.mcc000.3gppnetwork.org”,qop=auth,nc=00000001,cnonce=”a1b2c3d4e5f6”,response=”2c8fd97ca4f530ad249af5e4662ddf4c”,algorithm=AKAv1-MD5,integrity-protected=”no”<br>Expires: 600000<br>Supported: sec-agree,path<br>CSeq: 2 REGISTER<br>Call-ID: <a href="mailto:&#x32;&#57;&#57;&#48;&#x36;&#64;&#x31;&#x37;&#x32;&#x2e;&#49;&#x36;&#x2e;&#x31;&#x30;&#x36;&#x2e;&#57;&#x32;">&#x32;&#57;&#57;&#48;&#x36;&#64;&#x31;&#x37;&#x32;&#x2e;&#49;&#x36;&#x2e;&#x31;&#x30;&#x36;&#x2e;&#57;&#x32;</a><br>From: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a>;tag=243426378<br>To: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a><br>P-Visited-Network-ID: “sip:<a href="mailto:&#x70;&#x63;&#x73;&#99;&#x66;&#x40;&#49;&#x37;&#x32;&#x2e;&#49;&#x36;&#x2e;&#49;&#x30;&#x36;&#46;&#x38;&#49;">&#x70;&#x63;&#x73;&#99;&#x66;&#x40;&#49;&#x37;&#x32;&#x2e;&#49;&#x36;&#x2e;&#49;&#x30;&#x36;&#46;&#x38;&#49;</a>:6070”<br>Feature-Caps: *;+g.3gpp.atcf=”<a href="tel:+12340000000">tel:+12340000000</a>“;+g.3gpp.atcf-mgmt-uri=”<a href="sip:172.16.106.81:6070">sip:172.16.106.81:6070</a>“;+g.3gpp.atcf-path=”<a href="sip:pcscf@172.16.106.81:6070;transport=udp;lr">sip:pcscf@172.16.106.81:6070;transport=udp;lr</a>“;+g.3gpp.mid-call;+g.3gpp.srvcc-alerting<br>P-Track-ID: 754087c87c51f31bcc99457db8<br>Route: <a href="sip:proxy@172.16.106.94:5060;lr;transport=udp">sip:proxy@172.16.106.94:5060;lr;transport=udp</a><br>Path: <a href="sip:172.16.106.81:6070;transport=udp;lr;key=0a04f65a2b9bdd01d9d7a4b866">sip:172.16.106.81:6070;transport=udp;lr;key=0a04f65a2b9bdd01d9d7a4b866</a><br>P-UserAgent-Info: <a href="sip:172.16.106.92:5060;transport=udp">sip:172.16.106.92:5060;transport=udp</a>;+sbc.address=”<a href="sip:172.16.106.81:5060;lr;transport=udp">sip:172.16.106.81:5060;lr;transport=udp</a>“<br>Via: SIP/2.0/UDP 172.16.106.81:6070;branch=z9hG4bKb2f5b1801e38<br>Via: SIP/2.0/UDP 172.16.106.92:5060;branch=z9hG4bK57ab028-c4e7c91f<br>P-Access-Network-Info: 3GPP-NR-TDD; sip:172.16.106.81:5060;lr;transport=udp;ue-ip=172.16.106.92;ue-port=5060;raw-ip=172.16.106.92;raw-port=5060<br>Require: path<br>P-Charging-Vector: icid-value=2d834d66ac1947be8d2c75938ce7038e;icid-generated-at=pcscf.visited.net;orig-ioi=visited.net<br>Max-Forwards: 69<br>Content-Length: 0</p><h2 id="5-200-OK"><a href="#5-200-OK" class="headerlink" title="5.200 OK"></a>5.200 OK</h2><p>SIP/2.0 200 OK<br>Via: SIP/2.0/UDP 172.16.106.81:6070;branch=z9hG4bKb2f5b1801e38<br>Via: SIP/2.0/UDP 172.16.106.92:5060;branch=z9hG4bK57ab028-c4e7c91f<br>From: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a>;tag=243426378<br>To: <a href="sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org">sip:460003911000057@ims.mnc000.mcc000.3gppnetwork.org</a>;tag=0-ac106a5f-210323031846-2112256181<br>Call-ID: <a href="mailto:&#x32;&#x39;&#57;&#48;&#54;&#64;&#x31;&#55;&#x32;&#x2e;&#x31;&#54;&#46;&#x31;&#48;&#x36;&#46;&#x39;&#x32;">&#x32;&#x39;&#57;&#48;&#54;&#64;&#x31;&#55;&#x32;&#x2e;&#x31;&#54;&#46;&#x31;&#48;&#x36;&#46;&#x39;&#x32;</a><br>CSeq: 2 REGISTER<br>Contact: <a href="sip:460003911000057@172.16.106.94">sip:460003911000057@172.16.106.94</a>;q=1.0;expires=600000<br>Require: path<br>Content-Length: 0<br>Service-Route: <a href="sip:172.16.106.95:5060;transport=udp;lr">sip:172.16.106.95:5060;transport=udp;lr</a><br>Path: <a href="sip:172.16.106.81:6070;transport=udp;lr;key=0a04f65a2b9bdd01d9d7a4b866">sip:172.16.106.81:6070;transport=udp;lr;key=0a04f65a2b9bdd01d9d7a4b866</a><br>P-Charging-Vector: 2d834d66ac1947be8d2c75938ce7038e;icid-generated-at=pcscf.visited.net;orig-ioi=visited.net;term-ioi=ims.mnc000.mcc000.3gppnetwork.org;access-network-charging-info=test</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-概要&quot;&gt;&lt;a href=&quot;#1-概要&quot; class=&quot;headerlink&quot; title=&quot;1.概要&quot;&gt;&lt;/a&gt;1.概要&lt;/h2&gt;&lt;h2 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;img src=&quot;h</summary>
      
    
    
    
    <category term="SIP" scheme="https://wuhaocn.github.io/categories/SIP/"/>
    
    
    <category term="IMS" scheme="https://wuhaocn.github.io/tags/IMS/"/>
    
  </entry>
  
  <entry>
    <title>5GC-网络切片</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/5gc/5GC-%E7%BD%91%E7%BB%9C%E5%88%87%E7%89%87/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/5gc/5GC-%E7%BD%91%E7%BB%9C%E5%88%87%E7%89%87/</id>
    <published>2023-11-15T03:40:25.013Z</published>
    <updated>2023-11-15T03:40:25.014Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-切片概述"><a href="#1-切片概述" class="headerlink" title="1.切片概述"></a>1.切片概述</h2><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627466041353-07197c90-661f-4580-8395-c783fbea80d4.png#clientId=u0a72d6f7-f525-4&from=paste&height=423&id=ue0a385c8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=423&originWidth=752&originalType=binary&ratio=1&size=128451&status=done&style=none&taskId=u074cf0b9-aa6c-4e68-aeb0-e641603fa04&width=752" alt="image.png"></h2><p>5G网络基于三大业务场景的网络切片，使切片场景更加多样化。</p><ul><li>eMBB，提供大带宽流量通道，主要是借助无线侧提升带宽上限。</li><li>uRLLC，提供低时延网络，主要借助边缘网络进行边缘计算降低端到端网络距离。</li><li>mMTC，提供大规模机器通信，及4G中NB-IOT规范在制定中预计R16版本制定。现在采用4G核心网eLTE增强实现。</li></ul><p>切片实现基于核心网信令侧提供切片标识传输，用户面实现切片能力提供。</p><h3 id="2-切片关键点"><a href="#2-切片关键点" class="headerlink" title="2. 切片关键点"></a>2. 切片关键点</h3><h4 id="2-1-核心参数"><a href="#2-1-核心参数" class="headerlink" title="2.1 核心参数"></a>2.1 核心参数</h4><ul><li>NSSAI</li></ul><p>当 UE 发起注册流程时，接入网络（gNB）根据 UE 请求携带的 NSSAI（Network Slice Selection Assistance Information，网络切片选择辅助信息）来选择核心网络子切片的入口AMF。NSSAI是S-NSSAI的集合。NSSAI可以是已配置的NSSAI、请求的NSSAI或允许的NSSAI（Configured NSSAI, a Requested NSSAI or an Allowed NSSAI）。在UE和网络之间的信令消息中，允许和请求的NSSAI最多可以有8个。</p><ul><li>S-NSSAI</li></ul><p>网络切片主要体现在接纳控制、网络选择和资源分离。标准主要是通过S-NSSAI (Single Network Slice Selection Assistance Information)参数来进行识别</p><ul><li>SST</li></ul><p>切片/服务类型（SST），它是指在功能和服务方面预期的网络片行为；<br>SST指示S-NSSAI的切片和服务类型，而sst-SD是S-NSSAI参数切片、服务类型的组成和切片分量。该参数的结构如下：</p><ul><li>SD</li></ul><p>切片分量（SD），它是对切片/服务类型进行补充以在同一切片/服务类型的多个网络切片l之间进行区分的可选信息。<br>SD字段有一个保留值“no SD value associated with The SST”定义为十六进制FFFFFF。在某些协议中，不包括SD字段以指示没有SD值与SST关联。</p><ul><li> Subscribed S-NSSAIs：订阅S-NSSAI，属于用户的订阅数据。 </li><li> Default S-NSSAI：默认S-NSSAI，根据运营商的策略，用户的订阅S-NSSAI中可能会一个或多个被设置为默认S-NSSAI；如果UE在注册请求消息（Registration Request）没有携带Allowed NSSAI，则网络会使用默认S-NSSAI来给UE提供服务，如果默认S-NSSAI存在的话。 </li><li> Requested NSSAI：请求NSSAI，也就是UE在注册请求消息(Registration Request)携带的Allowed NSSAI。 </li><li> Allowed NSSAI：允许NSSAI，表示UE请求的NSSAI中，哪些S-NSSAI被网络允许了，网络会在注册接收消息（Registration Accept）的”Allowed NSSAI” IE 带给UE。 </li><li> Rejected NSSAI：拒绝NSSAI，表示UE请求的NSSAI中，哪些S-NSSAI被网络拒绝了，网络会在注册接收消息（Registration Accept）的”Rejected NSSAI” IE 带给UE。 </li><li> Configured NSSAI：配置NSSAI，网络配置给UE使用的NSSAI，收到这个配置参数收，UE就知道网络下有哪些S-NSSAI可用；网络会在注册接收消息（Registration Accept）的”Configured NSSAI” IE 带给UE，如果注册后UE的配置有变化，则网络可通过Configuration update command通知UE更新；UE会在非易失存储空间保存每个网络给它配置的Configured NSSAI 【见TS24.501 Annex C】；每个PLMN最多只能配置一个Configured NSSAI。 </li><li> 参数结构 </li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nssai</span><br><span class="line">    s-nssai</span><br><span class="line">        sst</span><br><span class="line">        sd</span><br><span class="line">    s-nssai</span><br><span class="line">        sst</span><br><span class="line">        sd</span><br></pre></td></tr></table></figure><h4 id="2-2-切片需求来源"><a href="#2-2-切片需求来源" class="headerlink" title="2.2 切片需求来源"></a>2.2 切片需求来源</h4><p>网络切片的需求来自于业务对网络提出的差异化要求，网络切片设计的出发点是按照业务对网络的不同需求灵活组织网络，形成为特定业务提供专属服务的网络，达到网络与业务的高度匹配。</p><h4 id="2-3-切片类型"><a href="#2-3-切片类型" class="headerlink" title="2.3 切片类型"></a>2.3 切片类型</h4><ul><li>增强型移动宽带（eMBB）：需要关注峰值速率，容量，频谱效率，移动性，网络能效等这些指标，和 3G、4G 类似。AR/VR、4K/8K 超高清视频等业务属于该类型。</li><li>海量机器通信（mMTC）：主要关注连接数。对下载速率，移动性等指标不太关心。针对大规模物联网业务。</li><li>高可靠低时延通信（uRLLC）：主要关注高可靠性，移动性和超低时延。对连接数，峰值速率，容量，频谱效率，网络能效等指标都没有太大需求。例如无人驾驶等业务。</li></ul><h4 id="2-4-切片特性"><a href="#2-4-切片特性" class="headerlink" title="2.4 切片特性"></a>2.4 切片特性</h4><p>网络切片具有以下四个特性：</p><ul><li>1.隔离性：不同的网络切片之间互相隔离，一个切片的异常不会影响到其他的切片。</li><li>2.虚拟化：网络切片是在物理网络上划分出来的虚拟网络。</li><li>3.按需定制：可以根据不同的业务需求去自定义网络切片的业务、功能、容量、服务质量与连接关系，还可以按需进行切片的生命周期管理。</li><li>4.端到端：网络切片是针对整个网络而言，不仅需要核心网，还要包括接入网、传输网、管理网络等。</li></ul><h4 id="2-5-切片层次"><a href="#2-5-切片层次" class="headerlink" title="2.5 切片层次"></a>2.5 切片层次</h4><ul><li>无线接入网络子切片：切片资源划分和隔离，切片感知，切片选择，移动性管理，每个切片的 QoS 保障。</li><li>承载网络子切片：基于 SDN 的统一管理，承载也可以被抽象成资源池来进行灵活分配，从而切割成网络切片。</li><li>核心网络子切片：5G 核心网基于SBA 架构，核心网的微服务模块就像搭积木一样按需拼装成网络切片。</li></ul><h3 id="3-切片选择流程"><a href="#3-切片选择流程" class="headerlink" title="3.切片选择流程"></a>3.切片选择流程</h3><p>UE对网络切片的选择涉及两个关键过程，一个是UE注册流程，一个是PDUSession建立流程。<br>在实际应用中，一个 UE 可能同时接入一个或多个网络切片，当 UE 发起注册流程时，接入网络（gNB）根据 UE 请求携带的 NSSAI（Network Slice Selection Assistance Information，网络切片选择辅助信息）来选择核心网络子切片的入口AMF。NSSAI 包括切片/业务的类型和切片区分标识（Slice Differentiator），这些信息可以是标准定义的，也可以是运营商自定义的。如果 UE 发起注册时，请求没有携带任何 NSSAI 信息，接入网将选择默认的 AMF 提供服务。默认的 AMF 将根据运营商的策略和用户签约信息进一步选择 Target AMF 提供服务。AMF 将与 AUSF 一同对 UE 进行鉴权，鉴权通过后，UE 成功注册到网络。UE 注册成功后，AMF 将向 UE 提供被允许的 NSSAI 和临时用户标识（Temporary User ID），后续 UE 将携带这些信息接入网络，网络根据临时用户标识可以得到之前服务的 AMF 信息。<br>接下来，UE 可以发起业务请求，建立 UE 和 AMF 之间的信令连接，连接过程中或连接建立成功后，UE 和网络之间可以建立 PDU Session。在建立 PDU Session 的过程中，AMF 应综合签约信息、本地策略以及 NSSAI 等信息选择合适的 SMF，SMF 进行 PDU Session 的鉴权，为 UE 分配 IP 地址，指定提供服务的 UPF 提供后续的用户平面服务等。会话建立成功后，AMF 将保存 SMF 和终端的对应关系，SMF 也会保存 AMF 和终端识别的对应关系，以便后续的网络交互。以上是 3GPP 网络切片选择、终端注册、连接建立和会话建立的基本框架。</p><ul><li>开户</li></ul><p>用户开户时，签约数据中会包含用户支持的切片信息（例如切片 A、B、C，其中 A 和 B 被标记为 “default”，“default” 表示在终端不携带切片信息时，网络侧默认用户支持接入的切片。UE 侧存储在 USIM 卡，网络侧存储在 UDM）。</p><ul><li>终端注册</li></ul><p>终端初次入网注册时，不会在用户面建立 QoS Flow，所以终端未携带切片信息，AMF 将本地配置的切片信息与从 UDM 获取的用户签约数据中的切片信息进行匹配。</p><ul><li>切片校验</li></ul><p>如果 AMF 本地配置的切片信息包含签约的默认切片信息，则 AMF 判断可以为终端提供对应切片服务，在注册响应消息中携带用户在当前网络下可以使用的切片 A、B。</p><ul><li>接入切换</li></ul><p>如果 AMF 本地配置的切片信息中不包含签约的默认切片信息，则 AMF 判断自身不能为终端提供对应切片服务，AMF 查询 NSSF 获取可提供切片服务的其他 AMF 信息，NSSF 响应消息中携带为终端分配的切片配置信息。Target AMF 在注册响应消息中携带用户在当前网络下可以使用的切片 A、B。</p><ul><li>应用接入<br>用户激活业务时（例如，用户打开一个 APP）才会携带切片信息，终端会根据步骤 2 中的切片选择策略，选择对应的切片 ID（例如网络切片 A）进行业务触发，AMF 选择切片 A 对应的 SMF 为终端建立 PDU Session。</li></ul><h3 id="4-参考"><a href="#4-参考" class="headerlink" title="4.参考"></a>4.参考</h3><p><a href="https://blog.csdn.net/u010178611/article/details/82109791">https://blog.csdn.net/u010178611/article/details/82109791</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-切片概述&quot;&gt;&lt;a href=&quot;#1-切片概述&quot; class=&quot;headerlink&quot; title=&quot;1.切片概述&quot;&gt;&lt;/a&gt;1.切片概述&lt;/h2&gt;&lt;h2 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;im</summary>
      
    
    
    
    <category term="5G" scheme="https://wuhaocn.github.io/categories/5G/"/>
    
    
    <category term="5G" scheme="https://wuhaocn.github.io/tags/5G/"/>
    
  </entry>
  
  <entry>
    <title>5GC-入网注册报文</title>
    <link href="https://wuhaocn.github.io/2023/11/15/network/protocol/5gc/5GC-%E5%85%A5%E7%BD%91%E6%B3%A8%E5%86%8C%E6%8A%A5%E6%96%87/"/>
    <id>https://wuhaocn.github.io/2023/11/15/network/protocol/5gc/5GC-%E5%85%A5%E7%BD%91%E6%B3%A8%E5%86%8C%E6%8A%A5%E6%96%87/</id>
    <published>2023-11-15T03:40:25.013Z</published>
    <updated>2023-11-15T03:40:25.013Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-总体流程"><a href="#1-总体流程" class="headerlink" title="1.总体流程"></a>1.总体流程</h3><p>业务流程</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/804884/1627391117254-6a03844b-4b03-48cf-9627-b467ca6564fa.png#clientId=u3633912e-e1d8-4&from=paste&height=826&id=u3d62431a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=826&originWidth=841&originalType=binary&ratio=1&size=228847&status=done&style=none&taskId=u2addc2dd-1a6b-4d56-81eb-4ef03b62ca3&width=841" alt="image.png"></p><h3 id="2-流程报文"><a href="#2-流程报文" class="headerlink" title="2.流程报文"></a>2.流程报文</h3><h4 id="2-1-Registration-request"><a href="#2-1-Registration-request" class="headerlink" title="2.1 Registration request"></a>2.1 Registration request</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-InitialUEMessage (15)</span><br><span class="line">        criticality: ignore (1)</span><br><span class="line">        value</span><br><span class="line">            InitialUEMessage</span><br><span class="line">                protocolIEs: 5 items</span><br><span class="line">                    Item 0: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 1: id-NAS-PDU</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-NAS-PDU (38)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                NAS-PDU: 7e004179000d0164f000f0ff000001400224022e02f0f0</span><br><span class="line">                                    Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                        Plain NAS 5GS Message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                            Message type: Registration request (0x41)</span><br><span class="line">                                            5GS registration type</span><br><span class="line">                                                .... 1... = Follow-On Request bit (FOR): Follow-on request pending</span><br><span class="line">                                                .... .001 = 5GS registration type: initial registration (1)</span><br><span class="line">                                            NAS key set identifier</span><br><span class="line">                                                0... .... = Type of security context flag (TSC): Native security context (for KSIAMF)</span><br><span class="line">                                                .111 .... = NAS key set identifier: 7</span><br><span class="line">                                            5GS mobile identity</span><br><span class="line">                                                Length: 13</span><br><span class="line">                                                0... .... = Spare: 0</span><br><span class="line">                                                .000 .... = SUPI format: IMSI (0)</span><br><span class="line">                                                .... 0... = Spare: 0</span><br><span class="line">                                                .... .001 = Type of identity: SUCI (1)</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                Routing indicator: 0</span><br><span class="line">                                                .... 0000 = Protection scheme Id: NULL scheme (0)</span><br><span class="line">                                                Home network public key identifier: 0</span><br><span class="line">                                                Scheme output: 1004204220</span><br><span class="line">                                            UE security capability</span><br><span class="line">                                                Element ID: 0x2e</span><br><span class="line">                                                Length: 2</span><br><span class="line">                                                1... .... = 5G-EA0: Supported</span><br><span class="line">                                                .1.. .... = 128-5G-EA1: Supported</span><br><span class="line">                                                ..1. .... = 128-5G-EA2: Supported</span><br><span class="line">                                                ...1 .... = 128-5G-EA3: Supported</span><br><span class="line">                                                .... 0... = 5G-EA4: Not supported</span><br><span class="line">                                                .... .0.. = 5G-EA5: Not supported</span><br><span class="line">                                                .... ..0. = 5G-EA6: Not supported</span><br><span class="line">                                                .... ...0 = 5G-EA7: Not supported</span><br><span class="line">                                                1... .... = 5G-IA0: Supported</span><br><span class="line">                                                .1.. .... = 128-5G-IA1: Supported</span><br><span class="line">                                                ..1. .... = 128-5G-IA2: Supported</span><br><span class="line">                                                ...1 .... = 128-5G-IA3: Supported</span><br><span class="line">                                                .... 0... = 5G-IA4: Not supported</span><br><span class="line">                                                .... .0.. = 5G-IA5: Not supported</span><br><span class="line">                                                .... ..0. = 5G-IA6: Not supported</span><br><span class="line">                                                .... ...0 = 5G-IA7: Not supported</span><br><span class="line">                    Item 2: id-UserLocationInformation</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UserLocationInformation (121)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                UserLocationInformation: userLocationInformationNR (1)</span><br><span class="line">                                    userLocationInformationNR</span><br><span class="line">                                        nR-CGI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            nRCellIdentity: 0x00044880f0</span><br><span class="line">                                        tAI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            tAC: 4388 (0x001124)</span><br><span class="line">                    Item 3: id-RRCEstablishmentCause</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RRCEstablishmentCause (90)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                RRCEstablishmentCause: mo-Signalling (3)</span><br><span class="line">                    Item 4: id-UEContextRequest</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UEContextRequest (112)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                UEContextRequest: requested (0)</span><br></pre></td></tr></table></figure><h4 id="2-2-Authentication-request"><a href="#2-2-Authentication-request" class="headerlink" title="2.2 Authentication request"></a>2.2 Authentication request</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">initiatingMessage</span><br><span class="line">    procedureCode: id-DownlinkNASTransport (4)</span><br><span class="line">    criticality: ignore (1)</span><br><span class="line">    value</span><br><span class="line">        DownlinkNASTransport</span><br><span class="line">            protocolIEs: 3 items</span><br><span class="line">                Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                    ProtocolIE-Field</span><br><span class="line">                        id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                        criticality: reject (0)</span><br><span class="line">                        value</span><br><span class="line">                            AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                    ProtocolIE-Field</span><br><span class="line">                        id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                        criticality: reject (0)</span><br><span class="line">                        value</span><br><span class="line">                            RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                Item 2: id-NAS-PDU</span><br><span class="line">                    ProtocolIE-Field</span><br><span class="line">                        id: id-NAS-PDU (38)</span><br><span class="line">                        criticality: reject (0)</span><br><span class="line">                        value</span><br><span class="line">                            NAS-PDU: 7e0056000200002125e821e3a8691f4997ac4956ac6569a8…</span><br><span class="line">                                Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                    Plain NAS 5GS Message</span><br><span class="line">                                        Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                        0000 .... = Spare Half Octet: 0</span><br><span class="line">                                        .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                        Message type: Authentication request (0x56)</span><br><span class="line">                                        0000 .... = Spare Half Octet: 0</span><br><span class="line">                                        NAS key set identifier - ngKSI</span><br><span class="line">                                            .... 0... = Type of security context flag (TSC): Native security context (for KSIAMF)</span><br><span class="line">                                            .... .000 = NAS key set identifier: 0</span><br><span class="line">                                        ABBA</span><br><span class="line">                                            Length: 2</span><br><span class="line">                                            ABBA Contents: 0x0000</span><br><span class="line">                                        Authentication Parameter RAND - 5G authentication challenge</span><br><span class="line">                                            Element ID: 0x21</span><br><span class="line">                                            RAND value: 25e821e3a8691f4997ac4956ac6569a8</span><br><span class="line">                                        Authentication Parameter AUTN (UMTS and EPS authentication challenge) - 5G authentication challenge</span><br><span class="line">                                            Element ID: 0x20</span><br><span class="line">                                            Length: 16</span><br><span class="line">                                            AUTN value: 00c6123fefd980001404cf321750dc4c</span><br><span class="line">                                                SQN xor AK: 00c6123fefd9</span><br><span class="line">                                                AMF: 8000</span><br><span class="line">                                                MAC: 1404cf321750dc4c</span><br></pre></td></tr></table></figure><h4 id="2-3-Authentication-response"><a href="#2-3-Authentication-response" class="headerlink" title="2.3 Authentication response"></a>2.3 Authentication response</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-UplinkNASTransport (46)</span><br><span class="line">        criticality: ignore (1)</span><br><span class="line">        value</span><br><span class="line">            UplinkNASTransport</span><br><span class="line">                protocolIEs: 4 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-NAS-PDU</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-NAS-PDU (38)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                NAS-PDU: 7e00572d10481e2e467f57406efa0caf1e985956ab</span><br><span class="line">                                    Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                        Plain NAS 5GS Message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                            Message type: Authentication response (0x57)</span><br><span class="line">                                            Authentication response parameter</span><br><span class="line">                                                Element ID: 0x2d</span><br><span class="line">                                                Length: 16</span><br><span class="line">                                                RES: 481e2e467f57406efa0caf1e985956ab</span><br><span class="line">                    Item 3: id-UserLocationInformation</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UserLocationInformation (121)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                UserLocationInformation: userLocationInformationNR (1)</span><br><span class="line">                                    userLocationInformationNR</span><br><span class="line">                                        nR-CGI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            nRCellIdentity: 0x00044880f0</span><br><span class="line">                                        tAI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            tAC: 4388 (0x001124)</span><br></pre></td></tr></table></figure><h4 id="2-4-Security-mode-command"><a href="#2-4-Security-mode-command" class="headerlink" title="2.4 Security mode command"></a>2.4 Security mode command</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-DownlinkNASTransport (4)</span><br><span class="line">        criticality: ignore (1)</span><br><span class="line">        value</span><br><span class="line">            DownlinkNASTransport</span><br><span class="line">                protocolIEs: 3 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-NAS-PDU</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-NAS-PDU (38)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                NAS-PDU: 7e039b1e5653007e005d030002f0f057033601021904f0f0…</span><br><span class="line">                                    Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                        Security protected NAS 5GS message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0011 = Security header type: Integrity protected with new 5GS security context (3)</span><br><span class="line">                                            Message authentication code: 0x9b1e5653</span><br><span class="line">                                            Sequence number: 0</span><br><span class="line">                                        Plain NAS 5GS Message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                            Message type: Security mode command (0x5d)</span><br><span class="line">                                            NAS security algorithms</span><br><span class="line">                                                0000 .... = Type of ciphering algorithm: 5G-EA0 (null ciphering algorithm) (0)</span><br><span class="line">                                                .... 0011 = Type of integrity protection algorithm: 128-5G-IA3 (3)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            NAS key set identifier - ngKSI</span><br><span class="line">                                                .... 0... = Type of security context flag (TSC): Native security context (for KSIAMF)</span><br><span class="line">                                                .... .000 = NAS key set identifier: 0</span><br><span class="line">                                            UE security capability - Replayed UE security capabilities</span><br><span class="line">                                                Length: 2</span><br><span class="line">                                                1... .... = 5G-EA0: Supported</span><br><span class="line">                                                .1.. .... = 128-5G-EA1: Supported</span><br><span class="line">                                                ..1. .... = 128-5G-EA2: Supported</span><br><span class="line">                                                ...1 .... = 128-5G-EA3: Supported</span><br><span class="line">                                                .... 0... = 5G-EA4: Not supported</span><br><span class="line">                                                .... .0.. = 5G-EA5: Not supported</span><br><span class="line">                                                .... ..0. = 5G-EA6: Not supported</span><br><span class="line">                                                .... ...0 = 5G-EA7: Not supported</span><br><span class="line">                                                1... .... = 5G-IA0: Supported</span><br><span class="line">                                                .1.. .... = 128-5G-IA1: Supported</span><br><span class="line">                                                ..1. .... = 128-5G-IA2: Supported</span><br><span class="line">                                                ...1 .... = 128-5G-IA3: Supported</span><br><span class="line">                                                .... 0... = 5G-IA4: Not supported</span><br><span class="line">                                                .... .0.. = 5G-IA5: Not supported</span><br><span class="line">                                                .... ..0. = 5G-IA6: Not supported</span><br><span class="line">                                                .... ...0 = 5G-IA7: Not supported</span><br><span class="line">                                            NAS security algorithms - Selected EPS NAS security algorithms</span><br><span class="line">                                                Element ID: 0x57</span><br><span class="line">                                                0... .... = Spare bit(s): 0x00</span><br><span class="line">                                                .000 .... = Type of ciphering algorithm: EPS encryption algorithm EEA0 (null ciphering algorithm) (0)</span><br><span class="line">                                                .... 0... = Spare bit(s): 0x00</span><br><span class="line">                                                .... .011 = Type of integrity protection algorithm: EPS integrity algorithm 128-EIA3 (3)</span><br><span class="line">                                            Additional 5G security information</span><br><span class="line">                                                Element ID: 0x36</span><br><span class="line">                                                Length: 1</span><br><span class="line">                                                .... 0... = Spare: 0</span><br><span class="line">                                                .... .0.. = Spare: 0</span><br><span class="line">                                                .... ..1. = Retransmission of initial NAS message request(RINMR): Requested</span><br><span class="line">                                                .... ...0 = Horizontal derivation parameter (HDP): Not required</span><br><span class="line">                                            UE security capability - Replayed S1 UE security capabilities</span><br><span class="line">                                                Element ID: 0x19</span><br><span class="line">                                                Length: 4</span><br><span class="line">                                                1... .... = EEA0: Supported</span><br><span class="line">                                                .1.. .... = 128-EEA1: Supported</span><br><span class="line">                                                ..1. .... = 128-EEA2: Supported</span><br><span class="line">                                                ...1 .... = 128-EEA3: Supported</span><br><span class="line">                                                .... 0... = EEA4: Not supported</span><br><span class="line">                                                .... .0.. = EEA5: Not supported</span><br><span class="line">                                                .... ..0. = EEA6: Not supported</span><br><span class="line">                                                .... ...0 = EEA7: Not supported</span><br><span class="line">                                                1... .... = EIA0: Supported</span><br><span class="line">                                                .1.. .... = 128-EIA1: Supported</span><br><span class="line">                                                ..1. .... = 128-EIA2: Supported</span><br><span class="line">                                                ...1 .... = 128-EIA3: Supported</span><br><span class="line">                                                .... 0... = EIA4: Not supported</span><br><span class="line">                                                .... .0.. = EIA5: Not supported</span><br><span class="line">                                                .... ..0. = EIA6: Not supported</span><br><span class="line">                                                .... ...0 = EIA7: Not supported</span><br><span class="line">                                                1... .... = UEA0: Supported</span><br><span class="line">                                                .1.. .... = UEA1: Supported</span><br><span class="line">                                                ..0. .... = UEA2: Not supported</span><br><span class="line">                                                ...0 .... = UEA3: Not supported</span><br><span class="line">                                                .... 0... = UEA4: Not supported</span><br><span class="line">                                                .... .0.. = UEA5: Not supported</span><br><span class="line">                                                .... ..0. = UEA6: Not supported</span><br><span class="line">                                                .... ...0 = UEA7: Not supported</span><br><span class="line">                                                1... .... = Spare bit(s): 0x1</span><br><span class="line">                                                .1.. .... = UMTS integrity algorithm UIA1: Supported</span><br><span class="line">                                                ..0. .... = UMTS integrity algorithm UIA2: Not supported</span><br><span class="line">                                                ...0 .... = UMTS integrity algorithm UIA3: Not supported</span><br><span class="line">                                                .... 0... = UMTS integrity algorithm UIA4: Not supported</span><br><span class="line">                                                .... .0.. = UMTS integrity algorithm UIA5: Not supported</span><br><span class="line">                                                .... ..0. = UMTS integrity algorithm UIA6: Not supported</span><br><span class="line">                                                .... ...0 = UMTS integrity algorithm UIA7: Not supported</span><br></pre></td></tr></table></figure><h4 id="2-5-Security-mode-complete-Registration-request"><a href="#2-5-Security-mode-complete-Registration-request" class="headerlink" title="2.5 Security mode complete Registration request"></a>2.5 Security mode complete Registration request</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-UplinkNASTransport (46)</span><br><span class="line">        criticality: ignore (1)</span><br><span class="line">        value</span><br><span class="line">            UplinkNASTransport</span><br><span class="line">                protocolIEs: 4 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-NAS-PDU</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-NAS-PDU (38)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                NAS-PDU: 7e04504ffe7e007e005e7100307e004179000d0164f000f0…</span><br><span class="line">                                    Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                        Security protected NAS 5GS message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0100 = Security header type: Integrity protected and ciphered with new 5GS security context (4)</span><br><span class="line">                                            Message authentication code: 0x504ffe7e</span><br><span class="line">                                            Sequence number: 0</span><br><span class="line">                                        Plain NAS 5GS Message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                            Message type: Security mode complete (0x5e)</span><br><span class="line">                                            NAS message container</span><br><span class="line">                                                Element ID: 0x71</span><br><span class="line">                                                Length: 48</span><br><span class="line">                                                Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                                    Plain NAS 5GS Message</span><br><span class="line">                                                        Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                                        0000 .... = Spare Half Octet: 0</span><br><span class="line">                                                        .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                                        Message type: Registration request (0x41)</span><br><span class="line">                                                        5GS registration type</span><br><span class="line">                                                            .... 1... = Follow-On Request bit (FOR): Follow-on request pending</span><br><span class="line">                                                            .... .001 = 5GS registration type: initial registration (1)</span><br><span class="line">                                                        NAS key set identifier</span><br><span class="line">                                                            0... .... = Type of security context flag (TSC): Native security context (for KSIAMF)</span><br><span class="line">                                                            .111 .... = NAS key set identifier: 7</span><br><span class="line">                                                        5GS mobile identity</span><br><span class="line">                                                            Length: 13</span><br><span class="line">                                                            0... .... = Spare: 0</span><br><span class="line">                                                            .000 .... = SUPI format: IMSI (0)</span><br><span class="line">                                                            .... 0... = Spare: 0</span><br><span class="line">                                                            .... .001 = Type of identity: SUCI (1)</span><br><span class="line">                                                            Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                            Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                            Routing indicator: 0</span><br><span class="line">                                                            .... 0000 = Protection scheme Id: NULL scheme (0)</span><br><span class="line">                                                            Home network public key identifier: 0</span><br><span class="line">                                                            Scheme output: 1004204220</span><br><span class="line">                                                        5GMM capability</span><br><span class="line">                                                            Element ID: 0x10</span><br><span class="line">                                                            Length: 1</span><br><span class="line">                                                            0... .... = Spare: 0</span><br><span class="line">                                                            .0.. .... = Spare: 0</span><br><span class="line">                                                            ..0. .... = Spare: 0</span><br><span class="line">                                                            ...0 .... = Spare: 0</span><br><span class="line">                                                            .... 0... = Spare: 0</span><br><span class="line">                                                            .... .0.. = LTE Positioning Protocol (LPP) capability: Not Requested</span><br><span class="line">                                                            .... ..1. = HO attach: Supported</span><br><span class="line">                                                            .... ...1 = S1 mode: Requested</span><br><span class="line">                                                        UE security capability</span><br><span class="line">                                                            Element ID: 0x2e</span><br><span class="line">                                                            Length: 2</span><br><span class="line">                                                            1... .... = 5G-EA0: Supported</span><br><span class="line">                                                            .1.. .... = 128-5G-EA1: Supported</span><br><span class="line">                                                            ..1. .... = 128-5G-EA2: Supported</span><br><span class="line">                                                            ...1 .... = 128-5G-EA3: Supported</span><br><span class="line">                                                            .... 0... = 5G-EA4: Not supported</span><br><span class="line">                                                            .... .0.. = 5G-EA5: Not supported</span><br><span class="line">                                                            .... ..0. = 5G-EA6: Not supported</span><br><span class="line">                                                            .... ...0 = 5G-EA7: Not supported</span><br><span class="line">                                                            1... .... = 5G-IA0: Supported</span><br><span class="line">                                                            .1.. .... = 128-5G-IA1: Supported</span><br><span class="line">                                                            ..1. .... = 128-5G-IA2: Supported</span><br><span class="line">                                                            ...1 .... = 128-5G-IA3: Supported</span><br><span class="line">                                                            .... 0... = 5G-IA4: Not supported</span><br><span class="line">                                                            .... .0.. = 5G-IA5: Not supported</span><br><span class="line">                                                            .... ..0. = 5G-IA6: Not supported</span><br><span class="line">                                                            .... ...0 = 5G-IA7: Not supported</span><br><span class="line">                                                        NSSAI - Requested NSSAI</span><br><span class="line">                                                            Element ID: 0x2f</span><br><span class="line">                                                            Length: 5</span><br><span class="line">                                                            S-NSSAI 1</span><br><span class="line">                                                                Length: 4</span><br><span class="line">                                                                Slice/service type (SST): 1</span><br><span class="line">                                                                Slice differentiator (SD): 1</span><br><span class="line">                                                        UE network capability</span><br><span class="line">                                                            Element ID: 0x17</span><br><span class="line">                                                            Length: 7</span><br><span class="line">                                                            1... .... = EEA0: Supported</span><br><span class="line">                                                            .1.. .... = 128-EEA1: Supported</span><br><span class="line">                                                            ..1. .... = 128-EEA2: Supported</span><br><span class="line">                                                            ...1 .... = 128-EEA3: Supported</span><br><span class="line">                                                            .... 0... = EEA4: Not supported</span><br><span class="line">                                                            .... .0.. = EEA5: Not supported</span><br><span class="line">                                                            .... ..0. = EEA6: Not supported</span><br><span class="line">                                                            .... ...0 = EEA7: Not supported</span><br><span class="line">                                                            1... .... = EIA0: Supported</span><br><span class="line">                                                            .1.. .... = 128-EIA1: Supported</span><br><span class="line">                                                            ..1. .... = 128-EIA2: Supported</span><br><span class="line">                                                            ...1 .... = 128-EIA3: Supported</span><br><span class="line">                                                            .... 0... = EIA4: Not supported</span><br><span class="line">                                                            .... .0.. = EIA5: Not supported</span><br><span class="line">                                                            .... ..0. = EIA6: Not supported</span><br><span class="line">                                                            .... ...0 = EIA7: Not supported</span><br><span class="line">                                                            1... .... = UEA0: Supported</span><br><span class="line">                                                            .1.. .... = UEA1: Supported</span><br><span class="line">                                                            ..0. .... = UEA2: Not supported</span><br><span class="line">                                                            ...0 .... = UEA3: Not supported</span><br><span class="line">                                                            .... 0... = UEA4: Not supported</span><br><span class="line">                                                            .... .0.. = UEA5: Not supported</span><br><span class="line">                                                            .... ..0. = UEA6: Not supported</span><br><span class="line">                                                            .... ...0 = UEA7: Not supported</span><br><span class="line">                                                            1... .... = UCS2 support (UCS2): The UE has no preference between the use of the default alphabet and the use of UCS2</span><br><span class="line">                                                            .1.. .... = UMTS integrity algorithm UIA1: Supported</span><br><span class="line">                                                            ..0. .... = UMTS integrity algorithm UIA2: Not supported</span><br><span class="line">                                                            ...0 .... = UMTS integrity algorithm UIA3: Not supported</span><br><span class="line">                                                            .... 0... = UMTS integrity algorithm UIA4: Not supported</span><br><span class="line">                                                            .... .0.. = UMTS integrity algorithm UIA5: Not supported</span><br><span class="line">                                                            .... ..0. = UMTS integrity algorithm UIA6: Not supported</span><br><span class="line">                                                            .... ...0 = UMTS integrity algorithm UIA7: Not supported</span><br><span class="line">                                                            0... .... = ProSe direct discovery: Not supported</span><br><span class="line">                                                            .0.. .... = ProSe: Not supported</span><br><span class="line">                                                            ..0. .... = H.245 After SRVCC Handover: Not supported</span><br><span class="line">                                                            ...0 .... = Access class control for CSFB: Not supported</span><br><span class="line">                                                            .... 0... = LTE Positioning Protocol: Not supported</span><br><span class="line">                                                            .... .0.. = Location services (LCS) notification mechanisms: Not supported</span><br><span class="line">                                                            .... ..0. = SRVCC from E-UTRAN to cdma2000 1xCS: Not supported</span><br><span class="line">                                                            .... ...1 = Notification procedure: Supported</span><br><span class="line">                                                            1... .... = Extended protocol configuration options: Supported</span><br><span class="line">                                                            .0.. .... = Header compression for control plane CIoT EPS optimization: Not supported</span><br><span class="line">                                                            ..0. .... = EMM-REGISTERED w/o PDN connectivity: Not supported</span><br><span class="line">                                                            ...0 .... = S1-U data transfer: Not supported</span><br><span class="line">                                                            .... 0... = User plane CIoT EPS optimization: Not supported</span><br><span class="line">                                                            .... .0.. = Control plane CIoT EPS optimization: Not supported</span><br><span class="line">                                                            .... ..0. = ProSe UE-to-network relay: Not supported</span><br><span class="line">                                                            .... ...0 = ProSe direct communication: Not supported</span><br><span class="line">                                                            0... .... = Spare bit(s): 0x00</span><br><span class="line">                                                            0... .... = Signalling for a maximum number of 15 EPS bearer contexts: Not supported</span><br><span class="line">                                                            .0.. .... = Service gap control: Not supported</span><br><span class="line">                                                            ..1. .... = N1 mode: Supported</span><br><span class="line">                                                            ...1 .... = Dual connectivity with NR: Supported</span><br><span class="line">                                                            .... 0... = Control plane data backoff: Not supported</span><br><span class="line">                                                            .... .0.. = Restriction on use of enhanced coverage: Not supported</span><br><span class="line">                                                            .... ..0. = V2X communication over PC5: Not supported</span><br><span class="line">                                                            .... ...0 = Multiple DRB: Not supported</span><br><span class="line">                                                        UE&#x27;s usage setting</span><br><span class="line">                                                            Element ID: 0x18</span><br><span class="line">                                                            Length: 1</span><br><span class="line">                                                            .... 0... = Spare: 0</span><br><span class="line">                                                            .... .0.. = Spare: 0</span><br><span class="line">                                                            .... ..0. = Spare: 0</span><br><span class="line">                                                            .... ...0 = UE&#x27;s usage setting: Voice centric</span><br><span class="line">                                                        5GS update type</span><br><span class="line">                                                            Element ID: 0x53</span><br><span class="line">                                                            Length: 1</span><br><span class="line">                                                            .... 0... = Spare: 0</span><br><span class="line">                                                            .... .0.. = Spare: 0</span><br><span class="line">                                                            .... ..0. = NG-RAN Radio Capability Update (NG-RAN-RCU): Not Needed</span><br><span class="line">                                                            .... ...1 = SMS requested: SMS over NAS supported</span><br><span class="line">                    Item 3: id-UserLocationInformation</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UserLocationInformation (121)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                UserLocationInformation: userLocationInformationNR (1)</span><br><span class="line">                                    userLocationInformationNR</span><br><span class="line">                                        nR-CGI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            nRCellIdentity: 0x00044880f0</span><br><span class="line">                                        tAI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            tAC: 4388 (0x001124)</span><br></pre></td></tr></table></figure><h4 id="2-6-InitialContextSetupRequest-Registration-Accept"><a href="#2-6-InitialContextSetupRequest-Registration-Accept" class="headerlink" title="2.6 InitialContextSetupRequest Registration Accept"></a>2.6 InitialContextSetupRequest Registration Accept</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-InitialContextSetup (14)</span><br><span class="line">        criticality: reject (0)</span><br><span class="line">        value</span><br><span class="line">            InitialContextSetupRequest</span><br><span class="line">                protocolIEs: 11 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-UEAggregateMaximumBitRate</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UEAggregateMaximumBitRate (110)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                UEAggregateMaximumBitRate</span><br><span class="line">                                    uEAggregateMaximumBitRateDL: 1024bits/s</span><br><span class="line">                                    uEAggregateMaximumBitRateUL: 256bits/s</span><br><span class="line">                    Item 3: id-CoreNetworkAssistanceInformationForInactive</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-CoreNetworkAssistanceInformationForInactive (18)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                CoreNetworkAssistanceInformationForInactive</span><br><span class="line">                                    uEIdentityIndexValue: indexLength10 (0)</span><br><span class="line">                                        indexLength10: 7200 [bit length 10, 6 LSB pad bits, 0111 0010  00.. .... decimal value 456]</span><br><span class="line">                                    periodicRegistrationUpdateTimer: 0 sec (96)</span><br><span class="line">                                    tAIListForInactive: 1 item</span><br><span class="line">                                        Item 0</span><br><span class="line">                                            TAIListForInactiveItem</span><br><span class="line">                                                tAI</span><br><span class="line">                                                    pLMNIdentity: 64f000</span><br><span class="line">                                                        Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                        Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                    tAC: 4388 (0x001124)</span><br><span class="line">                    Item 4: id-GUAMI</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-GUAMI (28)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                GUAMI</span><br><span class="line">                                    pLMNIdentity: 64f000</span><br><span class="line">                                        Mobile Country Code (MCC): China (000)</span><br><span class="line">                                        Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                    aMFRegionID: 02 [bit length 8, 0000 0010 decimal value 2]</span><br><span class="line">                                    aMFSetID: 0080 [bit length 10, 6 LSB pad bits, 0000 0000  10.. .... decimal value 2]</span><br><span class="line">                                    aMFPointer: 20 [bit length 6, 2 LSB pad bits, 0010 00.. decimal value 8]</span><br><span class="line">                    Item 5: id-AllowedNSSAI</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AllowedNSSAI (0)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AllowedNSSAI: 1 item</span><br><span class="line">                                    Item 0</span><br><span class="line">                                        AllowedNSSAI-Item</span><br><span class="line">                                            s-NSSAI</span><br><span class="line">                                                sST: 01</span><br><span class="line">                                                sD: 000001</span><br><span class="line">                    Item 6: id-UESecurityCapabilities</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UESecurityCapabilities (119)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                UESecurityCapabilities</span><br><span class="line">                                    nRencryptionAlgorithms: e000 [bit length 16, 1110 0000  0000 0000 decimal value 57344]</span><br><span class="line">                                        1... .... .... .... = 128-NEA1: Supported</span><br><span class="line">                                        .1.. .... .... .... = 128-NEA2: Supported</span><br><span class="line">                                        ..1. .... .... .... = 128-NEA3: Supported</span><br><span class="line">                                        ...0 0000 0000 0000 = Reserved: 0x0000</span><br><span class="line">                                    nRintegrityProtectionAlgorithms: e000 [bit length 16, 1110 0000  0000 0000 decimal value 57344]</span><br><span class="line">                                        1... .... .... .... = 128-NIA1: Supported</span><br><span class="line">                                        .1.. .... .... .... = 128-NIA2: Supported</span><br><span class="line">                                        ..1. .... .... .... = 128-NIA3: Supported</span><br><span class="line">                                        ...0 0000 0000 0000 = Reserved: 0x0000</span><br><span class="line">                                    eUTRAencryptionAlgorithms: 0000 [bit length 16, 0000 0000  0000 0000 decimal value 0]</span><br><span class="line">                                        0... .... .... .... = 128-EEA1: Not supported</span><br><span class="line">                                        .0.. .... .... .... = 128-EEA2: Not supported</span><br><span class="line">                                        ..0. .... .... .... = 128-EEA3: Not supported</span><br><span class="line">                                        ...0 0000 0000 0000 = Reserved: 0x0000</span><br><span class="line">                                    eUTRAintegrityProtectionAlgorithms: 0000 [bit length 16, 0000 0000  0000 0000 decimal value 0]</span><br><span class="line">                                        0... .... .... .... = 128-EIA1: Not supported</span><br><span class="line">                                        .0.. .... .... .... = 128-EIA2: Not supported</span><br><span class="line">                                        ..0. .... .... .... = 128-EIA3: Not supported</span><br><span class="line">                                        ...0 0000 0000 0000 = Reserved: 0x0000</span><br><span class="line">                    Item 7: id-SecurityKey</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-SecurityKey (94)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                SecurityKey: f712ad9fc4f3cbd91bdf25d72e9a18643be1ae6ee397e209… [bit length 256]</span><br><span class="line">                    Item 8: id-MobilityRestrictionList</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-MobilityRestrictionList (36)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                MobilityRestrictionList</span><br><span class="line">                                    servingPLMN: 64f000</span><br><span class="line">                                        Mobile Country Code (MCC): China (000)</span><br><span class="line">                                        Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                    rATRestrictions: 1 item</span><br><span class="line">                                        Item 0</span><br><span class="line">                                            RATRestrictions-Item</span><br><span class="line">                                                pLMNIdentity: 64f000</span><br><span class="line">                                                    Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                    Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                rATRestrictionInformation: 00 [bit length 8, 0000 0000 decimal value 0]</span><br><span class="line">                                                    0... .... = e-UTRA: Not restricted</span><br><span class="line">                                                    .0.. .... = nR: Not restricted</span><br><span class="line">                                                    ..00 0000 = reserved: 0x00</span><br><span class="line">                                    serviceAreaInformation: 1 item</span><br><span class="line">                                        Item 0</span><br><span class="line">                                            ServiceAreaInformation-Item</span><br><span class="line">                                                pLMNIdentity: 64f000</span><br><span class="line">                                                    Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                    Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                allowedTACs: 2 items</span><br><span class="line">                                                    Item 0</span><br><span class="line">                                                        TAC: 4386 (0x001122)</span><br><span class="line">                                                    Item 1</span><br><span class="line">                                                        TAC: 4388 (0x001124)</span><br><span class="line">                                    iE-Extensions: 1 item</span><br><span class="line">                                        Item 0</span><br><span class="line">                                            ProtocolExtensionField</span><br><span class="line">                                                id: id-CNTypeRestrictionsForServing (161)</span><br><span class="line">                                                criticality: ignore (1)</span><br><span class="line">                                                extensionValue</span><br><span class="line">                                                    CNTypeRestrictionsForServing: epc-forbidden (0)</span><br><span class="line">                    Item 9: id-IndexToRFSP</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-IndexToRFSP (31)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                IndexToRFSP: 8</span><br><span class="line">                    Item 10: id-NAS-PDU</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-NAS-PDU (38)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                NAS-PDU: 7e02af04712c017e0042010177000bf264f0000200880040…</span><br><span class="line">                                    Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                        Security protected NAS 5GS message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0010 = Security header type: Integrity protected and ciphered (2)</span><br><span class="line">                                            Message authentication code: 0xaf04712c</span><br><span class="line">                                            Sequence number: 1</span><br><span class="line">                                        Plain NAS 5GS Message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                            Message type: Registration accept (0x42)</span><br><span class="line">                                            5GS registration result</span><br><span class="line">                                                Length: 1</span><br><span class="line">                                                ...0 .... = NSSAA Performed: False</span><br><span class="line">                                                .... 0... = SMS over NAS: Not Allowed</span><br><span class="line">                                                .... .001 = 5GS registration result: 3GPP access (1)</span><br><span class="line">                                            5GS mobile identity - 5G-GUTI</span><br><span class="line">                                                Element ID: 0x77</span><br><span class="line">                                                Length: 11</span><br><span class="line">                                                .... 0... = Odd/even indication: Even number of identity digits</span><br><span class="line">                                                .... .010 = Type of identity: 5G-GUTI (2)</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                AMF Region ID: 2</span><br><span class="line">                                                0000 0000 10.. .... = AMF Set ID: 2</span><br><span class="line">                                                ..00 1000 = AMF Pointer: 8</span><br><span class="line">                                                5G-TMSI: 0x004001c8</span><br><span class="line">                                            5GS tracking area identity list</span><br><span class="line">                                                Element ID: 0x54</span><br><span class="line">                                                Length: 7</span><br><span class="line">                                                Partial tracking area list  1</span><br><span class="line">                                                    .01. .... = Type of list: list of TACs belonging to one PLMN, with consecutive TAC values (1)</span><br><span class="line">                                                    ...0 0000 = Number of elements: 1 element (0)</span><br><span class="line">                                                    Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                    Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                    TAC: 4388</span><br><span class="line">                                            NSSAI - Allowed NSSAI</span><br><span class="line">                                                Element ID: 0x15</span><br><span class="line">                                                Length: 5</span><br><span class="line">                                                S-NSSAI 1</span><br><span class="line">                                                    Length: 4</span><br><span class="line">                                                    Slice/service type (SST): 1</span><br><span class="line">                                                    Slice differentiator (SD): 1</span><br><span class="line">                                            5GS network feature support</span><br><span class="line">                                                Element ID: 0x21</span><br><span class="line">                                                Length: 2</span><br><span class="line">                                                0... .... = MPS indicator (MPSI): Access identity 1 not valid in RPLMN or equivalent PLMN</span><br><span class="line">                                                .0.. .... = Interworking without N26: Not supported</span><br><span class="line">                                                ..00 .... = Emergency service fallback indicator (EMF): Emergency services fallback not supported (0)</span><br><span class="line">                                                .... 00.. = Emergency service support indicator (EMC): Emergency services not supported (0)</span><br><span class="line">                                                .... ..0. = IMS voice over PS session over non-3GPP access indicator (IMS-VoPS-N3GPP): Not supported</span><br><span class="line">                                                .... ...1 = IMS voice over PS session indicator (IMS VoPS): Supported</span><br><span class="line">                                                0... .... = Spare: 0</span><br><span class="line">                                                .0.. .... = Spare: 0</span><br><span class="line">                                                ..0. .... = Spare: 0</span><br><span class="line">                                                ...0 .... = Spare: 0</span><br><span class="line">                                                .... 0... = Spare: 0</span><br><span class="line">                                                .... .0.. = Spare: 0</span><br><span class="line">                                                .... ..0. = MCS indicator (MCSI): Not supported</span><br><span class="line">                                                .... ...0 = Emergency services over non-3GPP access (EMCN3): Not supported</span><br><span class="line">                                            LADN information</span><br><span class="line">                                                Element ID: 0x79</span><br><span class="line">                                                Length: 36</span><br><span class="line">                                                LADN 1</span><br><span class="line">                                                    Length: 6</span><br><span class="line">                                                    DNN: cmnet</span><br><span class="line">                                                    Length: 28</span><br><span class="line">                                                    Partial tracking area list  1</span><br><span class="line">                                                        .00. .... = Type of list: list of TACs belonging to one PLMN, with non-consecutive TAC values (0)</span><br><span class="line">                                                        ...0 0111 = Number of elements: 8 elements (7)</span><br><span class="line">                                                        Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                        Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                                        TAC: 4386</span><br><span class="line">                                                        TAC: 4388</span><br><span class="line">                                                        TAC: 4387</span><br><span class="line">                                                        TAC: 4384</span><br><span class="line">                                                        TAC: 4385</span><br><span class="line">                                                        TAC: 4381</span><br><span class="line">                                                        TAC: 4382</span><br><span class="line">                                                        TAC: 4383</span><br><span class="line">                                            Service area list</span><br><span class="line">                                            GPRS Timer 3 - T3512 value</span><br><span class="line">                                                Element ID: 0x5e</span><br><span class="line">                                                Length: 1</span><br><span class="line">                                                GPRS Timer: 0 sec</span><br><span class="line">                                                    011. .... = Unit: value is incremented in multiples of 2 seconds (3)</span><br><span class="line">                                                    ...0 0000 = Timer value: 0</span><br></pre></td></tr></table></figure><h4 id="2-7-InitialContextSetupResponse"><a href="#2-7-InitialContextSetupResponse" class="headerlink" title="2.7 InitialContextSetupResponse"></a>2.7 InitialContextSetupResponse</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NG Application Protocol</span><br><span class="line">    NGAP-PDU: successfulOutcome (1)</span><br><span class="line">        successfulOutcome</span><br><span class="line">            procedureCode: id-InitialContextSetup (14)</span><br><span class="line">            criticality: reject (0)</span><br><span class="line">            value</span><br><span class="line">                InitialContextSetupResponse</span><br><span class="line">                    protocolIEs: 2 items</span><br><span class="line">                        Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                            ProtocolIE-Field</span><br><span class="line">                                id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                                criticality: ignore (1)</span><br><span class="line">                                value</span><br><span class="line">                                    AMF-UE-NGAP-ID: 9</span><br><span class="line">                        Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                            ProtocolIE-Field</span><br><span class="line">                                id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                                criticality: ignore (1)</span><br><span class="line">                                value</span><br><span class="line">                                    RAN-UE-NGAP-ID: 13</span><br></pre></td></tr></table></figure><h4 id="2-8-UERadioAccessCapabilityInformation"><a href="#2-8-UERadioAccessCapabilityInformation" class="headerlink" title="2.8 UERadioAccessCapabilityInformation"></a>2.8 UERadioAccessCapabilityInformation</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-UERadioCapabilityInfoIndication (44)</span><br><span class="line">        criticality: ignore (1)</span><br><span class="line">        value</span><br><span class="line">            UERadioCapabilityInfoIndication</span><br><span class="line">                protocolIEs: 3 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-UERadioCapability</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UERadioCapability (117)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                UERadioCapability: 040b5888168e1a0000007465a031e000380a03c1260c0000…</span><br><span class="line">                                    UERadioAccessCapabilityInformation</span><br><span class="line">                                        criticalExtensions: c1 (0)</span><br><span class="line">                                            c1: ueRadioAccessCapabilityInformation (0)</span><br><span class="line">                                                ueRadioAccessCapabilityInformation</span><br><span class="line">                                                    ue-RadioAccessCapabilityInfo: 1102d1c34000000e8cb4063c000701407824c1800010f010…</span><br><span class="line">                                                        UE-CapabilityRAT-ContainerList: 1 item</span><br><span class="line">                                                            Item 0</span><br><span class="line">                                                                UE-CapabilityRAT-Container</span><br><span class="line">                                                                    rat-Type: nr (0)</span><br><span class="line">                                                                    ue-CapabilityRAT-Container: e1a0000007465a031e000380a03c1260c000087808188068…</span><br><span class="line">                                                                        UE-NR-Capability</span><br><span class="line">                                                                            accessStratumRelease: rel15 (0)</span><br><span class="line">                                                                            pdcp-Parameters</span><br><span class="line">                                                                                supportedROHC-Profiles</span><br><span class="line">                                                                                    .... ..0. profile0x0000: False</span><br><span class="line">                                                                                    .... ...0 profile0x0001: False</span><br><span class="line">                                                                                    0... .... profile0x0002: False</span><br><span class="line">                                                                                    .0.. .... profile0x0003: False</span><br><span class="line">                                                                                    ..0. .... profile0x0004: False</span><br><span class="line">                                                                                    ...0 .... profile0x0006: False</span><br><span class="line">                                                                                    .... 0... profile0x0101: False</span><br><span class="line">                                                                                    .... .0.. profile0x0102: False</span><br><span class="line">                                                                                    .... ..0. profile0x0103: False</span><br><span class="line">                                                                                    .... ...0 profile0x0104: False</span><br><span class="line">                                                                                maxNumberROHC-ContextSessions: cs2 (0)</span><br><span class="line">                                                                            rlc-Parameters</span><br><span class="line">                                                                                am-WithShortSN: supported (0)</span><br><span class="line">                                                                                um-WithShortSN: supported (0)</span><br><span class="line">                                                                                um-WithLongSN: supported (0)</span><br><span class="line">                                                                            mac-Parameters</span><br><span class="line">                                                                                mac-ParametersXDD-Diff</span><br><span class="line">                                                                                    longDRX-Cycle: supported (0)</span><br><span class="line">                                                                                    shortDRX-Cycle: supported (0)</span><br><span class="line">                                                                            phy-Parameters</span><br><span class="line">                                                                                phy-ParametersCommon</span><br><span class="line">                                                                                    dynamicHARQ-ACK-Codebook: supported (0)</span><br><span class="line">                                                                                    semiStaticHARQ-ACK-Codebook: supported (0)</span><br><span class="line">                                                                                    ra-Type0-PUSCH: supported (0)</span><br><span class="line">                                                                                    dynamicSwitchRA-Type0-1-PDSCH: supported (0)</span><br><span class="line">                                                                                    dynamicSwitchRA-Type0-1-PUSCH: supported (0)</span><br><span class="line">                                                                                    pdsch-MappingTypeA: supported (0)</span><br><span class="line">                                                                                    rateMatchingResrcSetSemi-Static: supported (0)</span><br><span class="line">                                                                                    rateMatchingResrcSetDynamic: supported (0)</span><br><span class="line">                                                                                    bwp-SwitchingDelay: type1 (0)</span><br><span class="line">                                                                                    maxNumberSearchSpaces: n10 (0)</span><br><span class="line">                                                                                    rateMatchingCtrlResrcSetDynamic: supported (0)</span><br><span class="line">                                                                                    maxLayersMIMO-Indication: supported (0)</span><br><span class="line">                                                                                phy-ParametersFRX-Diff</span><br><span class="line">                                                                                    twoFL-DMRS: c0 [bit length 2, 6 LSB pad bits, 11.. .... decimal value 3]</span><br><span class="line">                                                                                    supportedDMRS-TypeDL: type1And2 (1)</span><br><span class="line">                                                                                    supportedDMRS-TypeUL: type1And2 (1)</span><br><span class="line">                                                                                    pucch-F2-WithFH: supported (0)</span><br><span class="line">                                                                                    pucch-F3-WithFH: supported (0)</span><br><span class="line">                                                                                    almostContiguousCP-OFDM-UL: supported (0)</span><br><span class="line">                                                                                    mux-SR-HARQ-ACK-CSI-PUCCH-OncePerSlot</span><br><span class="line">                                                                                        sameSymbol: supported (0)</span><br><span class="line">                                                                                    oneFL-DMRS-TwoAdditionalDMRS-UL: supported (0)</span><br><span class="line">                                                                                    twoFL-DMRS-TwoAdditionalDMRS-UL: supported (0)</span><br><span class="line">                                                                                phy-ParametersFR1</span><br><span class="line">                                                                                    pdsch-256QAM-FR1: supported (0)</span><br><span class="line">                                                                                    pdsch-RE-MappingFR1-PerSymbol: n10 (0)</span><br><span class="line">                                                                                    pdsch-RE-MappingFR1-PerSlot: n16 (0)</span><br><span class="line">                                                                            rf-Parameters</span><br><span class="line">                                                                                supportedBandListNR: 7 items</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        BandNR</span><br><span class="line">                                                                                            bandNR: 1</span><br><span class="line">                                                                                            mimo-ParametersPerBand</span><br><span class="line">                                                                                                tci-StatePDSCH</span><br><span class="line">                                                                                                    maxNumberConfiguredTCIstatesPerCC: n16 (2)</span><br><span class="line">                                                                                                    maxNumberActiveTCI-PerBWP: n1 (0)</span><br><span class="line">                                                                                                pusch-TransCoherence: nonCoherent (0)</span><br><span class="line">                                                                                                periodicBeamReport: supported (0)</span><br><span class="line">                                                                                                aperiodicBeamReport: supported (0)</span><br><span class="line">                                                                                                maxNumberNonGroupBeamReporting: n1 (0)</span><br><span class="line">                                                                                                dummy5</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSRS-Ports-PerResource: n1 (0)</span><br><span class="line">                                                                                                beamManagementSSB-CSI-RS</span><br><span class="line">                                                                                                    maxNumberSSB-CSI-RS-ResourceOneTx: n8 (1)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-Resource: n0 (0)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-ResourceTwoTx: n0 (0)</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-RS-Resource: n4 (2)</span><br><span class="line">                                                                                                codebookParameters</span><br><span class="line">                                                                                                    type1</span><br><span class="line">                                                                                                        singlePanel</span><br><span class="line">                                                                                                            supportedCSI-RS-ResourceList: 1 item</span><br><span class="line">                                                                                                                Item 0</span><br><span class="line">                                                                                                                    SupportedCSI-RS-Resource</span><br><span class="line">                                                                                                                        maxNumberTxPortsPerResource: p16 (4)</span><br><span class="line">                                                                                                                        maxNumberResourcesPerBand: 8</span><br><span class="line">                                                                                                                        totalNumberTxPortsPerBand: 16</span><br><span class="line">                                                                                                            modes: mode1andMode2 (1)</span><br><span class="line">                                                                                                            maxNumberCSI-RS-PerResourceSet: 8</span><br><span class="line">                                                                                                csi-RS-IM-ReceptionForFeedback</span><br><span class="line">                                                                                                    maxConfigNumberNZP-CSI-RS-PerCC: 8</span><br><span class="line">                                                                                                    maxConfigNumberPortsAcrossNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                    maxConfigNumberCSI-IM-PerCC: n4 (2)</span><br><span class="line">                                                                                                    maxNumberSimultaneousNZP-CSI-RS-PerCC: 4</span><br><span class="line">                                                                                                    totalNumberPortsSimultaneousNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                csi-ReportFramework</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForCSI-Report: 0</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-triggeringStatePerCC: n15 (2)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForBeamReport: 0</span><br><span class="line">                                                                                                    simultaneousCSI-ReportsPerCC: 2</span><br><span class="line">                                                                                                csi-RS-ForTracking</span><br><span class="line">                                                                                                    maxBurstLength: 2</span><br><span class="line">                                                                                                    maxSimultaneousResourceSetsPerCC: 2</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsPerCC: 16</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsAllCC: 32</span><br><span class="line">                                                                                            multipleTCI: supported (0)</span><br><span class="line">                                                                                            bwp-SameNumerology: upto4 (1)</span><br><span class="line">                                                                                            pusch-256QAM: supported (0)</span><br><span class="line">                                                                                            channelBWs-DL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-30kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                            channelBWs-UL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-30kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                    Item 1</span><br><span class="line">                                                                                        BandNR</span><br><span class="line">                                                                                            bandNR: 3</span><br><span class="line">                                                                                            mimo-ParametersPerBand</span><br><span class="line">                                                                                                tci-StatePDSCH</span><br><span class="line">                                                                                                    maxNumberConfiguredTCIstatesPerCC: n16 (2)</span><br><span class="line">                                                                                                    maxNumberActiveTCI-PerBWP: n1 (0)</span><br><span class="line">                                                                                                pusch-TransCoherence: nonCoherent (0)</span><br><span class="line">                                                                                                periodicBeamReport: supported (0)</span><br><span class="line">                                                                                                aperiodicBeamReport: supported (0)</span><br><span class="line">                                                                                                maxNumberNonGroupBeamReporting: n1 (0)</span><br><span class="line">                                                                                                dummy5</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSRS-Ports-PerResource: n1 (0)</span><br><span class="line">                                                                                                beamManagementSSB-CSI-RS</span><br><span class="line">                                                                                                    maxNumberSSB-CSI-RS-ResourceOneTx: n8 (1)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-Resource: n0 (0)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-ResourceTwoTx: n0 (0)</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-RS-Resource: n4 (2)</span><br><span class="line">                                                                                                codebookParameters</span><br><span class="line">                                                                                                    type1</span><br><span class="line">                                                                                                        singlePanel</span><br><span class="line">                                                                                                            supportedCSI-RS-ResourceList: 1 item</span><br><span class="line">                                                                                                                Item 0</span><br><span class="line">                                                                                                                    SupportedCSI-RS-Resource</span><br><span class="line">                                                                                                                        maxNumberTxPortsPerResource: p16 (4)</span><br><span class="line">                                                                                                                        maxNumberResourcesPerBand: 8</span><br><span class="line">                                                                                                                        totalNumberTxPortsPerBand: 16</span><br><span class="line">                                                                                                            modes: mode1andMode2 (1)</span><br><span class="line">                                                                                                            maxNumberCSI-RS-PerResourceSet: 8</span><br><span class="line">                                                                                                csi-RS-IM-ReceptionForFeedback</span><br><span class="line">                                                                                                    maxConfigNumberNZP-CSI-RS-PerCC: 8</span><br><span class="line">                                                                                                    maxConfigNumberPortsAcrossNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                    maxConfigNumberCSI-IM-PerCC: n4 (2)</span><br><span class="line">                                                                                                    maxNumberSimultaneousNZP-CSI-RS-PerCC: 4</span><br><span class="line">                                                                                                    totalNumberPortsSimultaneousNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                csi-ReportFramework</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForCSI-Report: 0</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-triggeringStatePerCC: n15 (2)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForBeamReport: 0</span><br><span class="line">                                                                                                    simultaneousCSI-ReportsPerCC: 2</span><br><span class="line">                                                                                                csi-RS-ForTracking</span><br><span class="line">                                                                                                    maxBurstLength: 2</span><br><span class="line">                                                                                                    maxSimultaneousResourceSetsPerCC: 2</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsPerCC: 16</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsAllCC: 32</span><br><span class="line">                                                                                            multipleTCI: supported (0)</span><br><span class="line">                                                                                            bwp-SameNumerology: upto4 (1)</span><br><span class="line">                                                                                            pusch-256QAM: supported (0)</span><br><span class="line">                                                                                            channelBWs-DL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: f000 [bit length 10, 6 LSB pad bits, 1111 0000  00.. .... decimal value 960]</span><br><span class="line">                                                                                                    scs-30kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                            channelBWs-UL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: f000 [bit length 10, 6 LSB pad bits, 1111 0000  00.. .... decimal value 960]</span><br><span class="line">                                                                                                    scs-30kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                    Item 2</span><br><span class="line">                                                                                        BandNR</span><br><span class="line">                                                                                            bandNR: 28</span><br><span class="line">                                                                                            mimo-ParametersPerBand</span><br><span class="line">                                                                                                tci-StatePDSCH</span><br><span class="line">                                                                                                    maxNumberConfiguredTCIstatesPerCC: n16 (2)</span><br><span class="line">                                                                                                    maxNumberActiveTCI-PerBWP: n1 (0)</span><br><span class="line">                                                                                                pusch-TransCoherence: nonCoherent (0)</span><br><span class="line">                                                                                                periodicBeamReport: supported (0)</span><br><span class="line">                                                                                                aperiodicBeamReport: supported (0)</span><br><span class="line">                                                                                                maxNumberNonGroupBeamReporting: n1 (0)</span><br><span class="line">                                                                                                dummy5</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSRS-Ports-PerResource: n1 (0)</span><br><span class="line">                                                                                                beamManagementSSB-CSI-RS</span><br><span class="line">                                                                                                    maxNumberSSB-CSI-RS-ResourceOneTx: n8 (1)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-Resource: n0 (0)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-ResourceTwoTx: n0 (0)</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-RS-Resource: n4 (2)</span><br><span class="line">                                                                                                codebookParameters</span><br><span class="line">                                                                                                    type1</span><br><span class="line">                                                                                                        singlePanel</span><br><span class="line">                                                                                                            supportedCSI-RS-ResourceList: 1 item</span><br><span class="line">                                                                                                                Item 0</span><br><span class="line">                                                                                                                    SupportedCSI-RS-Resource</span><br><span class="line">                                                                                                                        maxNumberTxPortsPerResource: p16 (4)</span><br><span class="line">                                                                                                                        maxNumberResourcesPerBand: 8</span><br><span class="line">                                                                                                                        totalNumberTxPortsPerBand: 16</span><br><span class="line">                                                                                                            modes: mode1andMode2 (1)</span><br><span class="line">                                                                                                            maxNumberCSI-RS-PerResourceSet: 8</span><br><span class="line">                                                                                                csi-RS-IM-ReceptionForFeedback</span><br><span class="line">                                                                                                    maxConfigNumberNZP-CSI-RS-PerCC: 8</span><br><span class="line">                                                                                                    maxConfigNumberPortsAcrossNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                    maxConfigNumberCSI-IM-PerCC: n4 (2)</span><br><span class="line">                                                                                                    maxNumberSimultaneousNZP-CSI-RS-PerCC: 4</span><br><span class="line">                                                                                                    totalNumberPortsSimultaneousNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                csi-ReportFramework</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForCSI-Report: 0</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-triggeringStatePerCC: n15 (2)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForBeamReport: 0</span><br><span class="line">                                                                                                    simultaneousCSI-ReportsPerCC: 2</span><br><span class="line">                                                                                                csi-RS-ForTracking</span><br><span class="line">                                                                                                    maxBurstLength: 2</span><br><span class="line">                                                                                                    maxSimultaneousResourceSetsPerCC: 2</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsPerCC: 16</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsAllCC: 32</span><br><span class="line">                                                                                            multipleTCI: supported (0)</span><br><span class="line">                                                                                            bwp-SameNumerology: upto4 (1)</span><br><span class="line">                                                                                            pusch-256QAM: supported (0)</span><br><span class="line">                                                                                            channelBWs-DL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-30kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                            channelBWs-UL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-30kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                    Item 3</span><br><span class="line">                                                                                        BandNR</span><br><span class="line">                                                                                            bandNR: 41</span><br><span class="line">                                                                                            mimo-ParametersPerBand</span><br><span class="line">                                                                                                tci-StatePDSCH</span><br><span class="line">                                                                                                    maxNumberConfiguredTCIstatesPerCC: n16 (2)</span><br><span class="line">                                                                                                    maxNumberActiveTCI-PerBWP: n1 (0)</span><br><span class="line">                                                                                                pusch-TransCoherence: nonCoherent (0)</span><br><span class="line">                                                                                                periodicBeamReport: supported (0)</span><br><span class="line">                                                                                                aperiodicBeamReport: supported (0)</span><br><span class="line">                                                                                                maxNumberNonGroupBeamReporting: n1 (0)</span><br><span class="line">                                                                                                dummy5</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSRS-Ports-PerResource: n1 (0)</span><br><span class="line">                                                                                                beamReportTiming</span><br><span class="line">                                                                                                    scs-30kHz: sym28 (3)</span><br><span class="line">                                                                                                beamManagementSSB-CSI-RS</span><br><span class="line">                                                                                                    maxNumberSSB-CSI-RS-ResourceOneTx: n8 (1)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-Resource: n0 (0)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-ResourceTwoTx: n0 (0)</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-RS-Resource: n4 (2)</span><br><span class="line">                                                                                                codebookParameters</span><br><span class="line">                                                                                                    type1</span><br><span class="line">                                                                                                        singlePanel</span><br><span class="line">                                                                                                            supportedCSI-RS-ResourceList: 1 item</span><br><span class="line">                                                                                                                Item 0</span><br><span class="line">                                                                                                                    SupportedCSI-RS-Resource</span><br><span class="line">                                                                                                                        maxNumberTxPortsPerResource: p16 (4)</span><br><span class="line">                                                                                                                        maxNumberResourcesPerBand: 8</span><br><span class="line">                                                                                                                        totalNumberTxPortsPerBand: 16</span><br><span class="line">                                                                                                            modes: mode1andMode2 (1)</span><br><span class="line">                                                                                                            maxNumberCSI-RS-PerResourceSet: 8</span><br><span class="line">                                                                                                csi-RS-IM-ReceptionForFeedback</span><br><span class="line">                                                                                                    maxConfigNumberNZP-CSI-RS-PerCC: 8</span><br><span class="line">                                                                                                    maxConfigNumberPortsAcrossNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                    maxConfigNumberCSI-IM-PerCC: n4 (2)</span><br><span class="line">                                                                                                    maxNumberSimultaneousNZP-CSI-RS-PerCC: 4</span><br><span class="line">                                                                                                    totalNumberPortsSimultaneousNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                csi-ReportFramework</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForCSI-Report: 0</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-triggeringStatePerCC: n15 (2)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForBeamReport: 0</span><br><span class="line">                                                                                                    simultaneousCSI-ReportsPerCC: 2</span><br><span class="line">                                                                                                csi-RS-ForTracking</span><br><span class="line">                                                                                                    maxBurstLength: 2</span><br><span class="line">                                                                                                    maxSimultaneousResourceSetsPerCC: 2</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsPerCC: 16</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsAllCC: 32</span><br><span class="line">                                                                                            multipleTCI: supported (0)</span><br><span class="line">                                                                                            bwp-SameNumerology: upto4 (1)</span><br><span class="line">                                                                                            pusch-256QAM: supported (0)</span><br><span class="line">                                                                                            ue-PowerClass: pc2 (1)</span><br><span class="line">                                                                                            channelBWs-DL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-30kHz: 13c0 [bit length 10, 6 LSB pad bits, 0001 0011  11.. .... decimal value 79]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                            channelBWs-UL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-30kHz: 13c0 [bit length 10, 6 LSB pad bits, 0001 0011  11.. .... decimal value 79]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                    Item 4</span><br><span class="line">                                                                                        BandNR</span><br><span class="line">                                                                                            bandNR: 77</span><br><span class="line">                                                                                            mimo-ParametersPerBand</span><br><span class="line">                                                                                                tci-StatePDSCH</span><br><span class="line">                                                                                                    maxNumberConfiguredTCIstatesPerCC: n16 (2)</span><br><span class="line">                                                                                                    maxNumberActiveTCI-PerBWP: n1 (0)</span><br><span class="line">                                                                                                pusch-TransCoherence: nonCoherent (0)</span><br><span class="line">                                                                                                periodicBeamReport: supported (0)</span><br><span class="line">                                                                                                aperiodicBeamReport: supported (0)</span><br><span class="line">                                                                                                maxNumberNonGroupBeamReporting: n1 (0)</span><br><span class="line">                                                                                                dummy5</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSRS-Ports-PerResource: n1 (0)</span><br><span class="line">                                                                                                beamReportTiming</span><br><span class="line">                                                                                                    scs-30kHz: sym28 (3)</span><br><span class="line">                                                                                                beamManagementSSB-CSI-RS</span><br><span class="line">                                                                                                    maxNumberSSB-CSI-RS-ResourceOneTx: n8 (1)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-Resource: n0 (0)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-ResourceTwoTx: n0 (0)</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-RS-Resource: n4 (2)</span><br><span class="line">                                                                                                codebookParameters</span><br><span class="line">                                                                                                    type1</span><br><span class="line">                                                                                                        singlePanel</span><br><span class="line">                                                                                                            supportedCSI-RS-ResourceList: 1 item</span><br><span class="line">                                                                                                                Item 0</span><br><span class="line">                                                                                                                    SupportedCSI-RS-Resource</span><br><span class="line">                                                                                                                        maxNumberTxPortsPerResource: p16 (4)</span><br><span class="line">                                                                                                                        maxNumberResourcesPerBand: 8</span><br><span class="line">                                                                                                                        totalNumberTxPortsPerBand: 16</span><br><span class="line">                                                                                                            modes: mode1andMode2 (1)</span><br><span class="line">                                                                                                            maxNumberCSI-RS-PerResourceSet: 8</span><br><span class="line">                                                                                                csi-RS-IM-ReceptionForFeedback</span><br><span class="line">                                                                                                    maxConfigNumberNZP-CSI-RS-PerCC: 8</span><br><span class="line">                                                                                                    maxConfigNumberPortsAcrossNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                    maxConfigNumberCSI-IM-PerCC: n4 (2)</span><br><span class="line">                                                                                                    maxNumberSimultaneousNZP-CSI-RS-PerCC: 4</span><br><span class="line">                                                                                                    totalNumberPortsSimultaneousNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                csi-ReportFramework</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForCSI-Report: 0</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-triggeringStatePerCC: n15 (2)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForBeamReport: 0</span><br><span class="line">                                                                                                    simultaneousCSI-ReportsPerCC: 2</span><br><span class="line">                                                                                                csi-RS-ForTracking</span><br><span class="line">                                                                                                    maxBurstLength: 2</span><br><span class="line">                                                                                                    maxSimultaneousResourceSetsPerCC: 2</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsPerCC: 16</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsAllCC: 32</span><br><span class="line">                                                                                            multipleTCI: supported (0)</span><br><span class="line">                                                                                            bwp-SameNumerology: upto4 (1)</span><br><span class="line">                                                                                            pusch-256QAM: supported (0)</span><br><span class="line">                                                                                            ue-PowerClass: pc2 (1)</span><br><span class="line">                                                                                            channelBWs-DL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-30kHz: 13c0 [bit length 10, 6 LSB pad bits, 0001 0011  11.. .... decimal value 79]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                            channelBWs-UL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-30kHz: 13c0 [bit length 10, 6 LSB pad bits, 0001 0011  11.. .... decimal value 79]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                    Item 5</span><br><span class="line">                                                                                        BandNR</span><br><span class="line">                                                                                            bandNR: 78</span><br><span class="line">                                                                                            mimo-ParametersPerBand</span><br><span class="line">                                                                                                tci-StatePDSCH</span><br><span class="line">                                                                                                    maxNumberConfiguredTCIstatesPerCC: n16 (2)</span><br><span class="line">                                                                                                    maxNumberActiveTCI-PerBWP: n1 (0)</span><br><span class="line">                                                                                                pusch-TransCoherence: nonCoherent (0)</span><br><span class="line">                                                                                                periodicBeamReport: supported (0)</span><br><span class="line">                                                                                                aperiodicBeamReport: supported (0)</span><br><span class="line">                                                                                                maxNumberNonGroupBeamReporting: n1 (0)</span><br><span class="line">                                                                                                dummy5</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSRS-Ports-PerResource: n1 (0)</span><br><span class="line">                                                                                                beamReportTiming</span><br><span class="line">                                                                                                    scs-30kHz: sym28 (3)</span><br><span class="line">                                                                                                beamManagementSSB-CSI-RS</span><br><span class="line">                                                                                                    maxNumberSSB-CSI-RS-ResourceOneTx: n8 (1)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-Resource: n0 (0)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-ResourceTwoTx: n0 (0)</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-RS-Resource: n4 (2)</span><br><span class="line">                                                                                                codebookParameters</span><br><span class="line">                                                                                                    type1</span><br><span class="line">                                                                                                        singlePanel</span><br><span class="line">                                                                                                            supportedCSI-RS-ResourceList: 1 item</span><br><span class="line">                                                                                                                Item 0</span><br><span class="line">                                                                                                                    SupportedCSI-RS-Resource</span><br><span class="line">                                                                                                                        maxNumberTxPortsPerResource: p16 (4)</span><br><span class="line">                                                                                                                        maxNumberResourcesPerBand: 8</span><br><span class="line">                                                                                                                        totalNumberTxPortsPerBand: 16</span><br><span class="line">                                                                                                            modes: mode1andMode2 (1)</span><br><span class="line">                                                                                                            maxNumberCSI-RS-PerResourceSet: 8</span><br><span class="line">                                                                                                csi-RS-IM-ReceptionForFeedback</span><br><span class="line">                                                                                                    maxConfigNumberNZP-CSI-RS-PerCC: 8</span><br><span class="line">                                                                                                    maxConfigNumberPortsAcrossNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                    maxConfigNumberCSI-IM-PerCC: n4 (2)</span><br><span class="line">                                                                                                    maxNumberSimultaneousNZP-CSI-RS-PerCC: 4</span><br><span class="line">                                                                                                    totalNumberPortsSimultaneousNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                csi-ReportFramework</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForCSI-Report: 0</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-triggeringStatePerCC: n15 (2)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForBeamReport: 0</span><br><span class="line">                                                                                                    simultaneousCSI-ReportsPerCC: 2</span><br><span class="line">                                                                                                csi-RS-ForTracking</span><br><span class="line">                                                                                                    maxBurstLength: 2</span><br><span class="line">                                                                                                    maxSimultaneousResourceSetsPerCC: 2</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsPerCC: 16</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsAllCC: 32</span><br><span class="line">                                                                                            multipleTCI: supported (0)</span><br><span class="line">                                                                                            bwp-SameNumerology: upto4 (1)</span><br><span class="line">                                                                                            pusch-256QAM: supported (0)</span><br><span class="line">                                                                                            ue-PowerClass: pc2 (1)</span><br><span class="line">                                                                                            channelBWs-DL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-30kHz: 13c0 [bit length 10, 6 LSB pad bits, 0001 0011  11.. .... decimal value 79]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                            channelBWs-UL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-30kHz: 13c0 [bit length 10, 6 LSB pad bits, 0001 0011  11.. .... decimal value 79]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                    Item 6</span><br><span class="line">                                                                                        BandNR</span><br><span class="line">                                                                                            bandNR: 79</span><br><span class="line">                                                                                            mimo-ParametersPerBand</span><br><span class="line">                                                                                                tci-StatePDSCH</span><br><span class="line">                                                                                                    maxNumberConfiguredTCIstatesPerCC: n16 (2)</span><br><span class="line">                                                                                                    maxNumberActiveTCI-PerBWP: n1 (0)</span><br><span class="line">                                                                                                pusch-TransCoherence: nonCoherent (0)</span><br><span class="line">                                                                                                periodicBeamReport: supported (0)</span><br><span class="line">                                                                                                aperiodicBeamReport: supported (0)</span><br><span class="line">                                                                                                maxNumberNonGroupBeamReporting: n1 (0)</span><br><span class="line">                                                                                                dummy5</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                    maxNumberSRS-Ports-PerResource: n1 (0)</span><br><span class="line">                                                                                                beamReportTiming</span><br><span class="line">                                                                                                    scs-30kHz: sym28 (3)</span><br><span class="line">                                                                                                beamManagementSSB-CSI-RS</span><br><span class="line">                                                                                                    maxNumberSSB-CSI-RS-ResourceOneTx: n8 (1)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-Resource: n0 (0)</span><br><span class="line">                                                                                                    maxNumberCSI-RS-ResourceTwoTx: n0 (0)</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-RS-Resource: n4 (2)</span><br><span class="line">                                                                                                codebookParameters</span><br><span class="line">                                                                                                    type1</span><br><span class="line">                                                                                                        singlePanel</span><br><span class="line">                                                                                                            supportedCSI-RS-ResourceList: 1 item</span><br><span class="line">                                                                                                                Item 0</span><br><span class="line">                                                                                                                    SupportedCSI-RS-Resource</span><br><span class="line">                                                                                                                        maxNumberTxPortsPerResource: p16 (4)</span><br><span class="line">                                                                                                                        maxNumberResourcesPerBand: 8</span><br><span class="line">                                                                                                                        totalNumberTxPortsPerBand: 16</span><br><span class="line">                                                                                                            modes: mode1andMode2 (1)</span><br><span class="line">                                                                                                            maxNumberCSI-RS-PerResourceSet: 8</span><br><span class="line">                                                                                                csi-RS-IM-ReceptionForFeedback</span><br><span class="line">                                                                                                    maxConfigNumberNZP-CSI-RS-PerCC: 8</span><br><span class="line">                                                                                                    maxConfigNumberPortsAcrossNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                    maxConfigNumberCSI-IM-PerCC: n4 (2)</span><br><span class="line">                                                                                                    maxNumberSimultaneousNZP-CSI-RS-PerCC: 4</span><br><span class="line">                                                                                                    totalNumberPortsSimultaneousNZP-CSI-RS-PerCC: 16</span><br><span class="line">                                                                                                csi-ReportFramework</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForCSI-Report: 1</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForCSI-Report: 0</span><br><span class="line">                                                                                                    maxNumberPeriodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-PerBWP-ForBeamReport: 1</span><br><span class="line">                                                                                                    maxNumberAperiodicCSI-triggeringStatePerCC: n15 (2)</span><br><span class="line">                                                                                                    maxNumberSemiPersistentCSI-PerBWP-ForBeamReport: 0</span><br><span class="line">                                                                                                    simultaneousCSI-ReportsPerCC: 2</span><br><span class="line">                                                                                                csi-RS-ForTracking</span><br><span class="line">                                                                                                    maxBurstLength: 2</span><br><span class="line">                                                                                                    maxSimultaneousResourceSetsPerCC: 2</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsPerCC: 16</span><br><span class="line">                                                                                                    maxConfiguredResourceSetsAllCC: 32</span><br><span class="line">                                                                                            multipleTCI: supported (0)</span><br><span class="line">                                                                                            bwp-SameNumerology: upto4 (1)</span><br><span class="line">                                                                                            pusch-256QAM: supported (0)</span><br><span class="line">                                                                                            ue-PowerClass: pc2 (1)</span><br><span class="line">                                                                                            channelBWs-DL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                            channelBWs-UL-v1530: fr1 (0)</span><br><span class="line">                                                                                                fr1</span><br><span class="line">                                                                                                    scs-15kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                                    scs-60kHz: 0000 [bit length 10, 6 LSB pad bits, 0000 0000  00.. .... decimal value 0]</span><br><span class="line">                                                                                supportedBandCombinationList: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        BandCombination</span><br><span class="line">                                                                                            bandList: 1 item</span><br><span class="line">                                                                                                Item 0</span><br><span class="line">                                                                                                    BandParameters: nr (1)</span><br><span class="line">                                                                                                        nr</span><br><span class="line">                                                                                                            bandNR: 41</span><br><span class="line">                                                                                                            ca-BandwidthClassDL-NR: a (0)</span><br><span class="line">                                                                                                            ca-BandwidthClassUL-NR: a (0)</span><br><span class="line">                                                                                            featureSetCombination: 0</span><br><span class="line">                                                                                            powerClass-v1530: pc2 (0)</span><br><span class="line">                                                                                appliedFreqBandListFilter: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        FreqBandInformation: bandInformationNR (1)</span><br><span class="line">                                                                                            bandInformationNR</span><br><span class="line">                                                                                                bandNR: 41</span><br><span class="line">                                                                                supportedBandCombinationList-v1540: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        BandCombination-v1540</span><br><span class="line">                                                                                            bandList-v1540: 1 item</span><br><span class="line">                                                                                                Item 0</span><br><span class="line">                                                                                                    BandParameters-v1540</span><br><span class="line">                                                                                                        srs-TxSwitch</span><br><span class="line">                                                                                                            supportedSRS-TxPortSwitch: t2r4 (2)</span><br><span class="line">                                                                            measAndMobParameters</span><br><span class="line">                                                                                measAndMobParametersCommon</span><br><span class="line">                                                                                    ssb-RLM: supported (0)</span><br><span class="line">                                                                                    eventB-MeasAndReport: supported (0)</span><br><span class="line">                                                                                    handoverFDD-TDD: supported (0)</span><br><span class="line">                                                                                    eutra-CGI-Reporting: supported (0)</span><br><span class="line">                                                                                    nr-CGI-Reporting: supported (0)</span><br><span class="line">                                                                                    periodicEUTRA-MeasAndReport: supported (0)</span><br><span class="line">                                                                                measAndMobParametersXDD-Diff</span><br><span class="line">                                                                                    intraAndInterF-MeasAndReport: supported (0)</span><br><span class="line">                                                                                    eventA-MeasAndReport: supported (0)</span><br><span class="line">                                                                                    handoverInterF: supported (0)</span><br><span class="line">                                                                                    handoverLTE-EPC: supported (0)</span><br><span class="line">                                                                                measAndMobParametersFRX-Diff</span><br><span class="line">                                                                                    ss-SINR-Meas: supported (0)</span><br><span class="line">                                                                                    handoverInterF: supported (0)</span><br><span class="line">                                                                                    handoverLTE-EPC: supported (0)</span><br><span class="line">                                                                            featureSets</span><br><span class="line">                                                                                featureSetsDownlink: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        FeatureSetDownlink</span><br><span class="line">                                                                                            featureSetListPerDownlinkCC: 1 item</span><br><span class="line">                                                                                                Item 0</span><br><span class="line">                                                                                                    FeatureSetDownlinkPerCC-Id: 1</span><br><span class="line">                                                                                featureSetsDownlinkPerCC: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        FeatureSetDownlinkPerCC</span><br><span class="line">                                                                                            supportedSubcarrierSpacingDL: kHz30 (1)</span><br><span class="line">                                                                                            supportedBandwidthDL: fr1 (0)</span><br><span class="line">                                                                                                fr1: mhz100 (10)</span><br><span class="line">                                                                                            channelBW-90mhz: supported (0)</span><br><span class="line">                                                                                            maxNumberMIMO-LayersPDSCH: fourLayers (1)</span><br><span class="line">                                                                                            supportedModulationOrderDL: qam256 (5)</span><br><span class="line">                                                                                featureSetsUplink: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        FeatureSetUplink</span><br><span class="line">                                                                                            featureSetListPerUplinkCC: 1 item</span><br><span class="line">                                                                                                Item 0</span><br><span class="line">                                                                                                    FeatureSetUplinkPerCC-Id: 1</span><br><span class="line">                                                                                            supportedSRS-Resources</span><br><span class="line">                                                                                                maxNumberAperiodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                maxNumberAperiodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                maxNumberPeriodicSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                maxNumberPeriodicSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                maxNumberSemiPersistentSRS-PerBWP: n16 (4)</span><br><span class="line">                                                                                                maxNumberSemiPersistentSRS-PerBWP-PerSlot: 6</span><br><span class="line">                                                                                                maxNumberSRS-Ports-PerResource: n2 (1)</span><br><span class="line">                                                                                featureSetsUplinkPerCC: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        FeatureSetUplinkPerCC</span><br><span class="line">                                                                                            supportedSubcarrierSpacingUL: kHz30 (1)</span><br><span class="line">                                                                                            supportedBandwidthUL: fr1 (0)</span><br><span class="line">                                                                                                fr1: mhz100 (10)</span><br><span class="line">                                                                                            channelBW-90mhz: supported (0)</span><br><span class="line">                                                                                            mimo-CB-PUSCH</span><br><span class="line">                                                                                                maxNumberMIMO-LayersCB-PUSCH: twoLayers (1)</span><br><span class="line">                                                                                                maxNumberSRS-ResourcePerSet: 1</span><br><span class="line">                                                                                            supportedModulationOrderUL: qam256 (5)</span><br><span class="line">                                                                                featureSetsDownlink-v1540: 1 item</span><br><span class="line">                                                                                    Item 0</span><br><span class="line">                                                                                        FeatureSetDownlink-v1540</span><br><span class="line">                                                                                            oneFL-DMRS-TwoAdditionalDMRS-DL: supported (0)</span><br><span class="line">                                                                                            twoFL-DMRS-TwoAdditionalDMRS-DL: supported (0)</span><br><span class="line">                                                                                            oneFL-DMRS-ThreeAdditionalDMRS-DL: supported (0)</span><br><span class="line">                                                                            featureSetCombinations: 1 item</span><br><span class="line">                                                                                Item 0</span><br><span class="line">                                                                                    FeatureSetCombination: 1 item</span><br><span class="line">                                                                                        Item 0</span><br><span class="line">                                                                                            FeatureSetsPerBand: 1 item</span><br><span class="line">                                                                                                Item 0</span><br><span class="line">                                                                                                    FeatureSet: nr (1)</span><br><span class="line">                                                                                                        nr</span><br><span class="line">                                                                                                            downlinkSetNR: 1</span><br><span class="line">                                                                                                            uplinkSetNR: 1</span><br><span class="line">                                                                            nonCriticalExtension</span><br><span class="line">                                                                                interRAT-Parameters</span><br><span class="line">                                                                                    eutra</span><br><span class="line">                                                                                        supportedBandListEUTRA: 21 items</span><br><span class="line">                                                                                            Item 0</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 1</span><br><span class="line">                                                                                            Item 1</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 2</span><br><span class="line">                                                                                            Item 2</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 3</span><br><span class="line">                                                                                            Item 3</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 4</span><br><span class="line">                                                                                            Item 4</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 5</span><br><span class="line">                                                                                            Item 5</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 6</span><br><span class="line">                                                                                            Item 6</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 7</span><br><span class="line">                                                                                            Item 7</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 8</span><br><span class="line">                                                                                            Item 8</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 9</span><br><span class="line">                                                                                            Item 9</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 12</span><br><span class="line">                                                                                            Item 10</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 17</span><br><span class="line">                                                                                            Item 11</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 18</span><br><span class="line">                                                                                            Item 12</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 19</span><br><span class="line">                                                                                            Item 13</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 20</span><br><span class="line">                                                                                            Item 14</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 26</span><br><span class="line">                                                                                            Item 15</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 28</span><br><span class="line">                                                                                            Item 16</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 34</span><br><span class="line">                                                                                            Item 17</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 38</span><br><span class="line">                                                                                            Item 18</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 39</span><br><span class="line">                                                                                            Item 19</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 40</span><br><span class="line">                                                                                            Item 20</span><br><span class="line">                                                                                                FreqBandIndicatorEUTRA: 41</span><br><span class="line">                                                                                        eutra-ParametersCommon</span><br><span class="line">                                                                                            mfbi-EUTRA: supported (0)</span><br><span class="line">                                                                                            rs-SINR-MeasEUTRA: supported (0)</span><br><span class="line">                                                                                        eutra-ParametersXDD-Diff</span><br><span class="line">                                                                                            rsrqMeasWidebandEUTRA: supported (0)</span><br><span class="line">                                                                                inactiveState: supported (0)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: successfulOutcome (1)</span><br><span class="line">    successfulOutcome</span><br><span class="line">        procedureCode: id-InitialContextSetup (14)</span><br><span class="line">        criticality: reject (0)</span><br><span class="line">        value</span><br><span class="line">            InitialContextSetupResponse</span><br><span class="line">                protocolIEs: 2 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-UplinkNASTransport (46)</span><br><span class="line">        criticality: ignore (1)</span><br><span class="line">        value</span><br><span class="line">            UplinkNASTransport</span><br><span class="line">                protocolIEs: 4 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-NAS-PDU</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-NAS-PDU (38)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                NAS-PDU: 7e026e3a64f8017e0043</span><br><span class="line">                                    Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                        Security protected NAS 5GS message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0010 = Security header type: Integrity protected and ciphered (2)</span><br><span class="line">                                            Message authentication code: 0x6e3a64f8</span><br><span class="line">                                            Sequence number: 1</span><br><span class="line">                                        Plain NAS 5GS Message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                            Message type: Registration complete (0x43)</span><br><span class="line">                    Item 3: id-UserLocationInformation</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UserLocationInformation (121)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                UserLocationInformation: userLocationInformationNR (1)</span><br><span class="line">                                    userLocationInformationNR</span><br><span class="line">                                        nR-CGI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            nRCellIdentity: 0x00044880f0</span><br><span class="line">                                        tAI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            tAC: 4388 (0x001124)</span><br></pre></td></tr></table></figure><h4 id="2-9-PDU-session-establishment-request"><a href="#2-9-PDU-session-establishment-request" class="headerlink" title="2.9 PDU session establishment request"></a>2.9 PDU session establishment request</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-UplinkNASTransport (46)</span><br><span class="line">        criticality: ignore (1)</span><br><span class="line">        value</span><br><span class="line">            UplinkNASTransport</span><br><span class="line">                protocolIEs: 4 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-NAS-PDU</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-NAS-PDU (38)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                NAS-PDU: 7e02dbf0810f027e006701001e2e050fc1ffff93a17b0013…</span><br><span class="line">                                    Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                        Security protected NAS 5GS message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0010 = Security header type: Integrity protected and ciphered (2)</span><br><span class="line">                                            Message authentication code: 0xdbf0810f</span><br><span class="line">                                            Sequence number: 2</span><br><span class="line">                                        Plain NAS 5GS Message</span><br><span class="line">                                            Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                            Message type: UL NAS transport (0x67)</span><br><span class="line">                                            0000 .... = Spare Half Octet: 0</span><br><span class="line">                                            Payload container type</span><br><span class="line">                                                .... 0001 = Payload container type: N1 SM information (1)</span><br><span class="line">                                            Payload container</span><br><span class="line">                                                Length: 30</span><br><span class="line">                                                Plain NAS 5GS Message</span><br><span class="line">                                                    Extended protocol discriminator: 5G session management messages (46)</span><br><span class="line">                                                    PDU session identity: PDU session identity value 5 (5)</span><br><span class="line">                                                    Procedure transaction identity: 15</span><br><span class="line">                                                    Message type: PDU session establishment request (0xc1)</span><br><span class="line">                                                    Integrity protection maximum data rate</span><br><span class="line">                                                        Integrity protection maximum data rate for uplink: Full data rate (255)</span><br><span class="line">                                                        Integrity protection maximum data rate for downlink: Full data rate (255)</span><br><span class="line">                                                    PDU session type</span><br><span class="line">                                                        1001 .... = Element ID: 0x9-</span><br><span class="line">                                                        .... 0011 = PDU session type: Ipv4v6 (3)</span><br><span class="line">                                                    SSC mode</span><br><span class="line">                                                        1010 .... = Element ID: 0xa-</span><br><span class="line">                                                        .... 0001 = SSC mode: SSC mode 1 (1)</span><br><span class="line">                                                    Extended protocol configuration options</span><br><span class="line">                                                        Element ID: 0x7b</span><br><span class="line">                                                        Length: 19</span><br><span class="line">                                                        [Link direction: MS to network (0)]</span><br><span class="line">                                                        1... .... = Extension: True</span><br><span class="line">                                                        .... .000 = Configuration Protocol: PPP for use with IP PDP type or IP PDN type (0)</span><br><span class="line">                                                        Protocol or Container ID: IP address allocation via NAS signalling (0x000a)</span><br><span class="line">                                                            Length: 0x00 (0)</span><br><span class="line">                                                        Protocol or Container ID: IM CN Subsystem Signaling Flag (0x0002)</span><br><span class="line">                                                            Length: 0x00 (0)</span><br><span class="line">                                                        Protocol or Container ID: P-CSCF IPv6 Address Request (0x0001)</span><br><span class="line">                                                            Length: 0x00 (0)</span><br><span class="line">                                                        Protocol or Container ID: P-CSCF IPv4 Address Request (0x000c)</span><br><span class="line">                                                            Length: 0x00 (0)</span><br><span class="line">                                                        Protocol or Container ID: DNS Server IPv6 Address Request (0x0003)</span><br><span class="line">                                                            Length: 0x00 (0)</span><br><span class="line">                                                        Protocol or Container ID: DNS Server IPv4 Address Request (0x000d)</span><br><span class="line">                                                            Length: 0x00 (0)</span><br><span class="line">                                            PDU session identity 2 - PDU session ID</span><br><span class="line">                                                Element ID: 0x12</span><br><span class="line">                                                PDU session identity: PDU session identity value 5 (5)</span><br><span class="line">                                            Request type</span><br><span class="line">                                                1000 .... = Element ID: 0x8-</span><br><span class="line">                                                .... 0001 = Request type: Initial request (1)</span><br><span class="line">                                            DNN</span><br><span class="line">                                                Element ID: 0x25</span><br><span class="line">                                                Length: 4</span><br><span class="line">                                                DNN: ims</span><br><span class="line">                    Item 3: id-UserLocationInformation</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UserLocationInformation (121)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                UserLocationInformation: userLocationInformationNR (1)</span><br><span class="line">                                    userLocationInformationNR</span><br><span class="line">                                        nR-CGI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            nRCellIdentity: 0x00044880f0</span><br><span class="line">                                        tAI</span><br><span class="line">                                            pLMNIdentity: 64f000</span><br><span class="line">                                                Mobile Country Code (MCC): China (000)</span><br><span class="line">                                                Mobile Network Code (MNC): China Mobile (00)</span><br><span class="line">                                            tAC: 4388 (0x001124)</span><br></pre></td></tr></table></figure><h4 id="2-10-PDUSessionResourceSetupRequest-PDU-session-establishment-accept"><a href="#2-10-PDUSessionResourceSetupRequest-PDU-session-establishment-accept" class="headerlink" title="2.10 PDUSessionResourceSetupRequest PDU session establishment accept"></a>2.10 PDUSessionResourceSetupRequest PDU session establishment accept</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: initiatingMessage (0)</span><br><span class="line">    initiatingMessage</span><br><span class="line">        procedureCode: id-PDUSessionResourceSetup (29)</span><br><span class="line">        criticality: reject (0)</span><br><span class="line">        value</span><br><span class="line">            PDUSessionResourceSetupRequest</span><br><span class="line">                protocolIEs: 4 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-PDUSessionResourceSetupListSUReq</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-PDUSessionResourceSetupListSUReq (74)</span><br><span class="line">                            criticality: reject (0)</span><br><span class="line">                            value</span><br><span class="line">                                PDUSessionResourceSetupListSUReq: 1 item</span><br><span class="line">                                    Item 0</span><br><span class="line">                                        PDUSessionResourceSetupItemSUReq</span><br><span class="line">                                            pDUSessionID: 5</span><br><span class="line">                                            pDUSessionNAS-PDU: 7e02663fcf8d027e00680100742e050fc211000901000631…</span><br><span class="line">                                                Non-Access-Stratum 5GS (NAS)PDU</span><br><span class="line">                                                    Security protected NAS 5GS message</span><br><span class="line">                                                        Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                                        0000 .... = Spare Half Octet: 0</span><br><span class="line">                                                        .... 0010 = Security header type: Integrity protected and ciphered (2)</span><br><span class="line">                                                        Message authentication code: 0x663fcf8d</span><br><span class="line">                                                        Sequence number: 2</span><br><span class="line">                                                    Plain NAS 5GS Message</span><br><span class="line">                                                        Extended protocol discriminator: 5G mobility management messages (126)</span><br><span class="line">                                                        0000 .... = Spare Half Octet: 0</span><br><span class="line">                                                        .... 0000 = Security header type: Plain NAS message, not security protected (0)</span><br><span class="line">                                                        Message type: DL NAS transport (0x68)</span><br><span class="line">                                                        0000 .... = Spare Half Octet: 0</span><br><span class="line">                                                        Payload container type</span><br><span class="line">                                                            .... 0001 = Payload container type: N1 SM information (1)</span><br><span class="line">                                                        Payload container</span><br><span class="line">                                                            Length: 116</span><br><span class="line">                                                            Plain NAS 5GS Message</span><br><span class="line">                                                                Extended protocol discriminator: 5G session management messages (46)</span><br><span class="line">                                                                PDU session identity: PDU session identity value 5 (5)</span><br><span class="line">                                                                Procedure transaction identity: 15</span><br><span class="line">                                                                Message type: PDU session establishment accept (0xc2)</span><br><span class="line">                                                                0001 .... = Selected SSC mode: SSC mode 1 (1)</span><br><span class="line">                                                                PDU session type - Selected PDU session type</span><br><span class="line">                                                                    .... 0001 = PDU session type: IPv4 (1)</span><br><span class="line">                                                                QoS rules - Authorized QoS rules</span><br><span class="line">                                                                    Length: 9</span><br><span class="line">                                                                    QoS rule 1</span><br><span class="line">                                                                        QoS rule identifier: 1</span><br><span class="line">                                                                        Length: 6</span><br><span class="line">                                                                        001. .... = Rule operation code: Create new QoS rule (1)</span><br><span class="line">                                                                        ...1 .... = DQR: The QoS rule is the default QoS rule</span><br><span class="line">                                                                        .... 0001 = Number of packet filters: 1</span><br><span class="line">                                                                        Packet filter 1</span><br><span class="line">                                                                            ..11 .... = Packet filter direction: Bidirectional (3)</span><br><span class="line">                                                                            .... 0000 = Packet filter identifier: 0</span><br><span class="line">                                                                            Length: 1</span><br><span class="line">                                                                            Packet filter component 1</span><br><span class="line">                                                                                Packet filter component type: Match-all type (1)</span><br><span class="line">                                                                        QoS rule precedence: 254</span><br><span class="line">                                                                        0... .... = Spare: 0</span><br><span class="line">                                                                        .0.. .... = Spare: 0</span><br><span class="line">                                                                        ..00 0001 = Qos flow identifier: 1</span><br><span class="line">                                                                Session-AMBR</span><br><span class="line">                                                                    Length: 6</span><br><span class="line">                                                                    Unit for Session-AMBR for downlink: value is incremented in multiples of 1 Mbps (6)</span><br><span class="line">                                                                    Session-AMBR for downlink: 2001 Mbps (2001)</span><br><span class="line">                                                                    Unit for Session-AMBR for uplink: value is incremented in multiples of 1 Mbps (6)</span><br><span class="line">                                                                    Session-AMBR for uplink: 2000 Mbps (2000)</span><br><span class="line">                                                                PDU address</span><br><span class="line">                                                                    Element ID: 0x29</span><br><span class="line">                                                                    Length: 5</span><br><span class="line">                                                                    .... 0001 = PDU session type: IPv4 (1)</span><br><span class="line">                                                                    PDU address information: 222.222.1.231</span><br><span class="line">                                                                S-NSSAI</span><br><span class="line">                                                                    Element ID: 0x22</span><br><span class="line">                                                                    Length: 4</span><br><span class="line">                                                                    Slice/service type (SST): 1</span><br><span class="line">                                                                    Slice differentiator (SD): 1</span><br><span class="line">                                                                Mapped EPS bearer contexts</span><br><span class="line">                                                                    Element ID: 0x75</span><br><span class="line">                                                                    Length: 27</span><br><span class="line">                                                                    Mapped EPS bearer context 1</span><br><span class="line">                                                                        0101 .... = EPS bearer identity: 5</span><br><span class="line">                                                                        Length: 24</span><br><span class="line">                                                                        01.. .... = Operation code: Create new EPS bearer (1)</span><br><span class="line">                                                                        ..0. .... = Spare: 0</span><br><span class="line">                                                                        ...1 .... = E bit: parameters list is included (1)</span><br><span class="line">                                                                        .... 0010 = Number of EPS parameters: 2</span><br><span class="line">                                                                        EPS parameter 1 - Mapped EPS QoS parameters</span><br><span class="line">                                                                        EPS parameter 2 - APN-AMBR</span><br><span class="line">                                                                QoS flow descriptions - Authorized</span><br><span class="line">                                                                Extended protocol configuration options</span><br><span class="line">                                                                    Element ID: 0x7b</span><br><span class="line">                                                                    Length: 27</span><br><span class="line">                                                                    [Link direction: Network to MS (1)]</span><br><span class="line">                                                                    1... .... = Extension: True</span><br><span class="line">                                                                    .... .000 = Configuration Protocol: PPP for use with IP PDP type or IP PDN type (0)</span><br><span class="line">                                                                    Protocol or Container ID: P-CSCF IPv6 Address (0x0001)</span><br><span class="line">                                                                        Length: 0x10 (16)</span><br><span class="line">                                                                        IPv6: ::</span><br><span class="line">                                                                    Protocol or Container ID: P-CSCF IPv4 Address (0x000c)</span><br><span class="line">                                                                        Length: 0x04 (4)</span><br><span class="line">                                                                        IPv4: 16.16.16.220</span><br><span class="line">                                                                DNN</span><br><span class="line">                                                                    Element ID: 0x25</span><br><span class="line">                                                                    Length: 6</span><br><span class="line">                                                                    DNN: cmnet</span><br><span class="line">                                                        PDU session identity 2 - PDU session ID</span><br><span class="line">                                                            Element ID: 0x12</span><br><span class="line">                                                            PDU session identity: PDU session identity value 5 (5)</span><br><span class="line">                                            s-NSSAI</span><br><span class="line">                                                sST: 01</span><br><span class="line">                                                sD: 000001</span><br><span class="line">                                            pDUSessionResourceSetupRequestTransfer: 0000050082000a0c7744d6403077359400008b000a01f010…</span><br><span class="line">                                                PDUSessionResourceSetupRequestTransfer</span><br><span class="line">                                                    protocolIEs: 5 items</span><br><span class="line">                                                        Item 0: id-PDUSessionAggregateMaximumBitRate</span><br><span class="line">                                                            ProtocolIE-Field</span><br><span class="line">                                                                id: id-PDUSessionAggregateMaximumBitRate (130)</span><br><span class="line">                                                                criticality: reject (0)</span><br><span class="line">                                                                value</span><br><span class="line">                                                                    PDUSessionAggregateMaximumBitRate</span><br><span class="line">                                                                        pDUSessionAggregateMaximumBitRateDL: 2001000000bits/s</span><br><span class="line">                                                                        pDUSessionAggregateMaximumBitRateUL: 2000000000bits/s</span><br><span class="line">                                                        Item 1: id-UL-NGU-UP-TNLInformation</span><br><span class="line">                                                            ProtocolIE-Field</span><br><span class="line">                                                                id: id-UL-NGU-UP-TNLInformation (139)</span><br><span class="line">                                                                criticality: reject (0)</span><br><span class="line">                                                                value</span><br><span class="line">                                                                    UPTransportLayerInformation: gTPTunnel (0)</span><br><span class="line">                                                                        gTPTunnel</span><br><span class="line">                                                                            transportLayerAddress: 10100d71 [bit length 32, 0001 0000  0001 0000  0000 1101  0111 0001 decimal value 269487473]</span><br><span class="line">                                                                                TransportLayerAddress (IPv4): 16.16.13.113</span><br><span class="line">                                                                            gTP-TEID: 00c00178</span><br><span class="line">                                                        Item 2: id-PDUSessionType</span><br><span class="line">                                                            ProtocolIE-Field</span><br><span class="line">                                                                id: id-PDUSessionType (134)</span><br><span class="line">                                                                criticality: reject (0)</span><br><span class="line">                                                                value</span><br><span class="line">                                                                    PDUSessionType: ipv4 (0)</span><br><span class="line">                                                        Item 3: id-SecurityIndication</span><br><span class="line">                                                            ProtocolIE-Field</span><br><span class="line">                                                                id: id-SecurityIndication (138)</span><br><span class="line">                                                                criticality: reject (0)</span><br><span class="line">                                                                value</span><br><span class="line">                                                                    SecurityIndication</span><br><span class="line">                                                                        integrityProtectionIndication: required (0)</span><br><span class="line">                                                                        confidentialityProtectionIndication: required (0)</span><br><span class="line">                                                                        maximumIntegrityProtectedDataRate-UL: maximum-UE-rate (1)</span><br><span class="line">                                                        Item 4: id-QosFlowSetupRequestList</span><br><span class="line">                                                            ProtocolIE-Field</span><br><span class="line">                                                                id: id-QosFlowSetupRequestList (136)</span><br><span class="line">                                                                criticality: reject (0)</span><br><span class="line">                                                                value</span><br><span class="line">                                                                    QosFlowSetupRequestList: 1 item</span><br><span class="line">                                                                        Item 0</span><br><span class="line">                                                                            QosFlowSetupRequestItem</span><br><span class="line">                                                                                qosFlowIdentifier: 1</span><br><span class="line">                                                                                qosFlowLevelQosParameters</span><br><span class="line">                                                                                    qosCharacteristics: nonDynamic5QI (0)</span><br><span class="line">                                                                                        nonDynamic5QI</span><br><span class="line">                                                                                            fiveQI: 9</span><br><span class="line">                                                                                    allocationAndRetentionPriority</span><br><span class="line">                                                                                        priorityLevelARP: 10</span><br><span class="line">                                                                                        pre-emptionCapability: may-trigger-pre-emption (1)</span><br><span class="line">                                                                                        pre-emptionVulnerability: not-pre-emptable (0)</span><br><span class="line">                                                                                e-RAB-ID: 5</span><br><span class="line">                    Item 3: id-UEAggregateMaximumBitRate</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-UEAggregateMaximumBitRate (110)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                UEAggregateMaximumBitRate</span><br><span class="line">                                    uEAggregateMaximumBitRateDL: 256bits/s</span><br><span class="line">                                    uEAggregateMaximumBitRateUL: 1024bits/s</span><br></pre></td></tr></table></figure><h4 id="2-11-PDUSessionResourceSetupResponse"><a href="#2-11-PDUSessionResourceSetupResponse" class="headerlink" title="2.11 PDUSessionResourceSetupResponse"></a>2.11 PDUSessionResourceSetupResponse</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">NGAP-PDU: successfulOutcome (1)</span><br><span class="line">    successfulOutcome</span><br><span class="line">        procedureCode: id-PDUSessionResourceSetup (29)</span><br><span class="line">        criticality: reject (0)</span><br><span class="line">        value</span><br><span class="line">            PDUSessionResourceSetupResponse</span><br><span class="line">                protocolIEs: 3 items</span><br><span class="line">                    Item 0: id-AMF-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-AMF-UE-NGAP-ID (10)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                AMF-UE-NGAP-ID: 2155872278</span><br><span class="line">                    Item 1: id-RAN-UE-NGAP-ID</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-RAN-UE-NGAP-ID (85)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                RAN-UE-NGAP-ID: 4194571</span><br><span class="line">                    Item 2: id-PDUSessionResourceSetupListSURes</span><br><span class="line">                        ProtocolIE-Field</span><br><span class="line">                            id: id-PDUSessionResourceSetupListSURes (75)</span><br><span class="line">                            criticality: ignore (1)</span><br><span class="line">                            value</span><br><span class="line">                                PDUSessionResourceSetupListSURes: 1 item</span><br><span class="line">                                    Item 0</span><br><span class="line">                                        PDUSessionResourceSetupItemSURes</span><br><span class="line">                                            pDUSessionID: 5</span><br><span class="line">                                            pDUSessionResourceSetupResponseTransfer: 0003e00a0a0ac8800c01240001</span><br><span class="line">                                                PDUSessionResourceSetupResponseTransfer</span><br><span class="line">                                                    dLQosFlowPerTNLInformation</span><br><span class="line">                                                        uPTransportLayerInformation: gTPTunnel (0)</span><br><span class="line">                                                            gTPTunnel</span><br><span class="line">                                                                transportLayerAddress: 0a0a0ac8 [bit length 32, 0000 1010  0000 1010  0000 1010  1100 1000 decimal value 168430280]</span><br><span class="line">                                                                    TransportLayerAddress (IPv4): 10.10.10.200</span><br><span class="line">                                                                gTP-TEID: 800c0124</span><br><span class="line">                                                        associatedQosFlowList: 1 item</span><br><span class="line">                                                            Item 0</span><br><span class="line">                                                                AssociatedQosFlowItem</span><br><span class="line">                                                                    qosFlowIdentifier: 1</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-总体流程&quot;&gt;&lt;a href=&quot;#1-总体流程&quot; class=&quot;headerlink&quot; title=&quot;1.总体流程&quot;&gt;&lt;/a&gt;1.总体流程&lt;/h3&gt;&lt;p&gt;业务流程&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/20</summary>
      
    
    
    
    <category term="5G" scheme="https://wuhaocn.github.io/categories/5G/"/>
    
    
    <category term="5G" scheme="https://wuhaocn.github.io/tags/5G/"/>
    
  </entry>
  
  <entry>
    <title>Sentinel热点参数限流原理</title>
    <link href="https://wuhaocn.github.io/2023/11/15/framework/sentinel/Sentinel%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81%E5%8E%9F%E7%90%86/"/>
    <id>https://wuhaocn.github.io/2023/11/15/framework/sentinel/Sentinel%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81%E5%8E%9F%E7%90%86/</id>
    <published>2023-11-15T03:40:25.012Z</published>
    <updated>2023-11-15T03:40:25.012Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Sentinel热点参数限流原理"><a href="#Sentinel热点参数限流原理" class="headerlink" title="Sentinel热点参数限流原理"></a>Sentinel热点参数限流原理</h2><h3 id="何为热点"><a href="#何为热点" class="headerlink" title="何为热点"></a>何为热点</h3><p>热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制，比如：</p><ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li><li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li></ul><h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><h4 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1.引入依赖"></a>1.引入依赖</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sentinel-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;sentinel.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- 热点参数限流 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sentinel-parameter-flow-control&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;sentinel.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h4 id="2-定义ParamFlowRule"><a href="#2-定义ParamFlowRule" class="headerlink" title="2.定义ParamFlowRule"></a>2.定义ParamFlowRule</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private static void loadRules() &#123;</span><br><span class="line"> ParamFlowRule rule = new ParamFlowRule(RESOURCE_KEY)</span><br><span class="line">   .setParamIdx(0) // 指定当前 rule 对应的热点参数索引</span><br><span class="line">   .setGrade(RuleConstant.FLOW_GRADE_QPS) // 限流的维度，该策略针对 QPS 限流</span><br><span class="line">   .setDurationInSec(1) // 限流的单位时间</span><br><span class="line">   .setCount(50) // 未使用指定热点参数时，该资源限流大小为50</span><br><span class="line">   .setParamFlowItemList(new ArrayList&lt;&gt;());</span><br><span class="line"></span><br><span class="line"> // item1 设置了对 goods_id = goods_uuid1 的限流，单位时间（DurationInSec）内只能访问10次</span><br><span class="line"> ParamFlowItem item1 = new ParamFlowItem().setObject(&quot;goods_uuid1&quot;) // 热点参数 value</span><br><span class="line">   .setClassType(String.class.getName()) // 热点参数数据类型</span><br><span class="line">   .setCount(10); // 针对该value的限流值</span><br><span class="line"></span><br><span class="line"> ParamFlowRuleManager.loadRules(Collections.singletonList(rule));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的配置属性后文讲源码的时候都会看到，所以要重点关注一下</p><ul><li>Rule 本身可以定义一个限流阈值，每个热点参数也可以定义自己的限流阈值</li><li>还可以为限流阀值设置一个单位时间</li></ul><h4 id="3-调用"><a href="#3-调用" class="headerlink" title="3.调用"></a>3.调用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line"> // 调用限流</span><br><span class="line"> entry = SphU.entry(RESOURCE_KEY, EntryType.IN, 1, hotParamValue);</span><br><span class="line"> // 业务代码...</span><br><span class="line"></span><br><span class="line">&#125; catch (BlockException e) &#123;</span><br><span class="line"> // 当前请求被限流</span><br><span class="line"> e.printStackTrace();</span><br><span class="line">&#125; finally &#123;</span><br><span class="line"> if (entry != null) &#123;</span><br><span class="line">  entry.exit(1, hotParamValue);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整实例参考<a href="https://github.com/TavenYin/taven-springcloud-learning/blob/master/sentinel-example/src/main/java/com/github/taven/limit/param/SimpleParamFlowDemo.java">DEMO</a></p><p>之前有用过 Sentinel 的同学的话其实很好理解。配置方面的话 Rule 属性有些不同，调用方面，需要添加上本次调用相关的参数<br>举个例子，我们配置了对商品 ID = 1 的限流规则，每次请求商品接口之前调用 Sentinel 的限流 API，指定 Resource 并传入当前要访问的商品<br>ID。<br>如果 Sentinel 能找到 Resource 对应的 Rule，则根据 Rule 进行限流。Rule 中如果找到 arg 对应的热点参数配置，则使用热点参数的阈值进行限流。找不到的话，则使用<br>Rule 中的阈值。</p><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>Sentinel 整体采用了责任链的设计模式（类似 Servlet Filter），每次调用 SphU.entry 时，都会经历一系列功能插槽（slot chain）。<br>不同的 Slot 职责不同，有的是负责收集信息，有的是负责根据不同的算法策略进行熔断限流操作，<br>关于整体流程大家可以阅读下 <a href="https://link.zhihu.com/?target=https://sentinelguard.io/zh-cn/docs/basic-implementation.html">官网</a><br>中对 Sentinel 工作流程的介绍。</p><h4 id="ParamFlowSlot"><a href="#ParamFlowSlot" class="headerlink" title="ParamFlowSlot"></a>ParamFlowSlot</h4><p>关于热点参数限流的逻辑在 com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowSlot 中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">public class ParamFlowSlot extends AbstractLinkedProcessorSlot&lt;DefaultNode&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,</span><br><span class="line">                      boolean prioritized, Object... args) throws Throwable &#123;</span><br><span class="line">        // ParamFlowManager 中没有对应的 Rule，则执行下一个Slot</span><br><span class="line">        if (!ParamFlowRuleManager.hasRules(resourceWrapper.getName())) &#123;</span><br><span class="line">            fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 限流检查</span><br><span class="line">        checkFlow(resourceWrapper, count, args);</span><br><span class="line">        // 执行下一个Slot</span><br><span class="line">        fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) &#123;</span><br><span class="line">        // 执行下一个Slot</span><br><span class="line">        fireExit(context, resourceWrapper, count, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void applyRealParamIdx(/*@NonNull*/ ParamFlowRule rule, int length) &#123;</span><br><span class="line">        int paramIdx = rule.getParamIdx();</span><br><span class="line">        if (paramIdx &lt; 0) &#123;</span><br><span class="line">            if (-paramIdx &lt;= length) &#123;</span><br><span class="line">                rule.setParamIdx(length + paramIdx);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // Illegal index, give it a illegal positive value, latter rule checking will pass.</span><br><span class="line">                rule.setParamIdx(-paramIdx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void checkFlow(ResourceWrapper resourceWrapper, int count, Object... args) throws BlockException &#123;</span><br><span class="line">        if (args == null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!ParamFlowRuleManager.hasRules(resourceWrapper.getName())) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取 resource 对应的全部 ParamFlowRule </span><br><span class="line">        List&lt;ParamFlowRule&gt; rules = ParamFlowRuleManager.getRulesOfResource(resourceWrapper.getName());</span><br><span class="line"></span><br><span class="line">        for (ParamFlowRule rule : rules) &#123;</span><br><span class="line">            applyRealParamIdx(rule, args.length);</span><br><span class="line"></span><br><span class="line">            // 初始化该 Rule 需要的限流指标数据</span><br><span class="line">            ParameterMetricStorage.initParamMetricsFor(resourceWrapper, rule);</span><br><span class="line">            // 如果不满足某个 Rule 则抛出异常，代表当前请求被限流</span><br><span class="line">            if (!ParamFlowChecker.passCheck(resourceWrapper, rule, count, args)) &#123;</span><br><span class="line">                String triggeredParam = &quot;&quot;;</span><br><span class="line">                if (args.length &gt; rule.getParamIdx()) &#123;</span><br><span class="line">                    Object value = args[rule.getParamIdx()];</span><br><span class="line">                    triggeredParam = String.valueOf(value);</span><br><span class="line">                &#125;</span><br><span class="line">                throw new ParamFlowException(resourceWrapper.getName(), triggeredParam, rule);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ParamFlowSlot 中代码不多，也没做什么事。参考注释的话应该很好理解。咱们直接挑干的讲，来看下 ParamFlowChecker 中是如何实现限流的</p><h4 id="ParamFlowChecker数据结构"><a href="#ParamFlowChecker数据结构" class="headerlink" title="ParamFlowChecker数据结构"></a>ParamFlowChecker数据结构</h4><p>热点参数限流使用的算法为令牌桶算法，首先来看一下数据结构是如何存储的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class ParameterMetric &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Format: (rule, (value, timeRecorder))</span><br><span class="line">     *</span><br><span class="line">     * @since 1.6.0</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;ParamFlowRule, CacheMap&lt;Object, AtomicLong&gt;&gt; ruleTimeCounters = new HashMap&lt;&gt;();</span><br><span class="line">    /**</span><br><span class="line">     * Format: (rule, (value, tokenCounter))</span><br><span class="line">     *</span><br><span class="line">     * @since 1.6.0</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;ParamFlowRule, CacheMap&lt;Object, AtomicLong&gt;&gt; ruleTokenCounter = new HashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    private final Map&lt;Integer, CacheMap&lt;Object, AtomicInteger&gt;&gt; threadCountMap = new HashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line"> // 省略...</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Sentinel 中 Resource 代表当前要访问的资源（方法或者api接口），一个 Resource 可以对应多个 Rule，这些 Rule 可以是相同的 class。<br>现在再来看 ParameterMetric 的结构，每个 Resource 对应一个 ParameterMetric 对象，上述 CacheMap&lt;Object, AtomicLong&gt; 的 Key<br>代表热点参数的值，Value 则是对应的计数器。<br>所以这里数据结构的关系是这样的</p><ul><li>一个 Resource 有一个 ParameterMetric</li><li>一个 ParameterMetric 统计了多个 Rule 所需要的限流指标数据</li><li>每个 Rule 又可以配置多个热点参数</li></ul><p>CacheMap 的默认实现，包装了 com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap<br>使用该类的主要原因是为了实现热点参数的 LRU</p><p>详细解释一下，这三个变量</p><ul><li>ruleTimeCounters ：记录令牌桶的最后添加时间，用于 QPS 限流</li><li>ruleTokenCounter ：记录令牌桶的令牌数量，用于 QPS 限流</li><li>threadCountMap ：用于线程级别限流，这个其实和令牌桶算法没有关系了，线程限流只是在 Rule<br>中定义了最大线程数，请求时判断一下当前的线程数是否大于最大线程，具体的应用在 ParamFlowChecker#passSingleValueCheck</li></ul><p>实际使用 ParameterMetric 时，使用 ParameterMetricStorage 获取 Resource 对应的 ParameterMetric</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public final class ParameterMetricStorage &#123;</span><br><span class="line">    // Format (Resource, ParameterMetric)</span><br><span class="line">    private static final Map&lt;String, ParameterMetric&gt; metricsMap = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    // 省略相关代码 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ParamFlowChecker执行逻辑"><a href="#ParamFlowChecker执行逻辑" class="headerlink" title="ParamFlowChecker执行逻辑"></a>ParamFlowChecker执行逻辑</h4><p>ParamFlowChecker 中 QPS 级限流支持两种策略</p><ul><li>CONTROL_BEHAVIOR_RATE_LIMITER ：请求速率限制，对应的方法ParamFlowChecker#passThrottleLocalCheck</li><li>DEFAULT ：只要桶中还有令牌，就可以通过，对应的方法ParamFlowChecker#passDefaultLocalCheck</li></ul><p>接下来我们将以 passDefaultLocalCheck 为例，进行分析。但是在这之前，先来捋一下，从 ParamFlowSlot#checkFlow 到<br>ParamFlowChecker#passDefaultLocalCheck 这中间都经历了什么，详见</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// 伪代码，忽略了一些参数传递</span><br><span class="line">checkFlow() &#123;</span><br><span class="line"> // if 没有对应的 rule，跳出 ParamFlowSlot 逻辑</span><br><span class="line"></span><br><span class="line"> // if args == null，跳出 ParamFlowSlot 逻辑</span><br><span class="line"></span><br><span class="line"> List&lt;ParamFlowRule&gt; rules = ParamFlowRuleManager.getRulesOfResource(resourceWrapper.getName());</span><br><span class="line"></span><br><span class="line"> rules.forEach(r -&gt; &#123;</span><br><span class="line">                // 初始化该 Rule 需要的限流指标数据</span><br><span class="line">  ParameterMetricStorage.initParamMetricsFor(resourceWrapper, rule);</span><br><span class="line">  </span><br><span class="line">  if (!ParamFlowChecker.passCheck(resourceWrapper, rule, count, args)) &#123;</span><br><span class="line">   // 抛出限流异常</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">passCheck() &#123;</span><br><span class="line"> // 从 args 中获取本次限流需要使用的 value</span><br><span class="line"> int paramIdx = rule.getParamIdx();</span><br><span class="line"> Object value = args[paramIdx];</span><br><span class="line"> </span><br><span class="line"> // 根据 rule 判断是该请求使用集群限流还是本地限流</span><br><span class="line"> if (rule.isClusterMode() &amp;&amp; rule.getGrade() == RuleConstant.FLOW_GRADE_QPS) &#123;</span><br><span class="line">  return passClusterCheck(resourceWrapper, rule, count, value);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> return passLocalCheck(resourceWrapper, rule, count, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">passLocalCheck() &#123;</span><br><span class="line"> // 如果 value 是 Collection 或者 Array</span><br><span class="line"> // Sentinel 认为这一组数据都需要经过热点参数限流校验</span><br><span class="line">        // 遍历所有值调用热点参数限流校验</span><br><span class="line"> if (isCollectionOrArray(value)) &#123;</span><br><span class="line">  value.forEach(v -&gt; &#123;</span><br><span class="line">   // 当数组中某个 value 无法通过限流校验时，return false 外部会抛出限流异常</span><br><span class="line">   if (!passSingleValueCheck(resourceWrapper, rule, count, param)) &#123;</span><br><span class="line">    return false;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">passSingleValueCheck() &#123;</span><br><span class="line"> if (rule.getGrade() == RuleConstant.FLOW_GRADE_QPS) &#123;</span><br><span class="line">  if (rule.getControlBehavior() == RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER) &#123;</span><br><span class="line">   // 速率限制</span><br><span class="line">   return passThrottleLocalCheck(resourceWrapper, rule, acquireCount, value);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">   // 默认限流</span><br><span class="line">   return passDefaultLocalCheck(resourceWrapper, rule, acquireCount, value);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125; else if (rule.getGrade() == RuleConstant.FLOW_GRADE_THREAD) &#123;</span><br><span class="line">  // 线程级限流逻辑</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面提到了一个集群限流，和上一篇中说到的集群限流实现原理是一样的，选出一台 Server 来做限流决策，所有客户端的限流请求都咨询<br>Server，由 Server 来决定。由于不是本文重点，就不多说了。</p><h4 id="ParamFlowChecker限流核心代码"><a href="#ParamFlowChecker限流核心代码" class="headerlink" title="ParamFlowChecker限流核心代码"></a>ParamFlowChecker限流核心代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">static boolean passDefaultLocalCheck(ResourceWrapper resourceWrapper, ParamFlowRule rule, int acquireCount,</span><br><span class="line">          Object value) &#123;</span><br><span class="line"> // 根据 resource 获取 ParameterMetric</span><br><span class="line"> ParameterMetric metric = getParameterMetric(resourceWrapper);</span><br><span class="line"> // 根据 rule 从 metric 中获取当前 rule 的计数器</span><br><span class="line"> CacheMap&lt;Object, AtomicLong&gt; tokenCounters = metric == null ? null : metric.getRuleTokenCounter(rule);</span><br><span class="line"> CacheMap&lt;Object, AtomicLong&gt; timeCounters = metric == null ? null : metric.getRuleTimeCounter(rule);</span><br><span class="line"></span><br><span class="line"> if (tokenCounters == null || timeCounters == null) &#123;</span><br><span class="line">  return true;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // Calculate max token count (threshold)</span><br><span class="line"> Set&lt;Object&gt; exclusionItems = rule.getParsedHotItems().keySet();</span><br><span class="line"> long tokenCount = (long)rule.getCount();</span><br><span class="line"> // 如果热点参数中包含当前 value，则使用热点参数配置的count，否则使用 rule 中定义的 count</span><br><span class="line"> if (exclusionItems.contains(value)) &#123;</span><br><span class="line">  tokenCount = rule.getParsedHotItems().get(value);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> if (tokenCount == 0) &#123;</span><br><span class="line">  return false;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> long maxCount = tokenCount + rule.getBurstCount();</span><br><span class="line"> // 当前申请的流量 和 最大流量比较</span><br><span class="line"> if (acquireCount &gt; maxCount) &#123;</span><br><span class="line">  return false;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> while (true) &#123;</span><br><span class="line">  long currentTime = TimeUtil.currentTimeMillis();</span><br><span class="line">  </span><br><span class="line">  // 这里相当于对当前 value 对应的令牌桶进行初始化</span><br><span class="line">  AtomicLong lastAddTokenTime = timeCounters.putIfAbsent(value, new AtomicLong(currentTime));</span><br><span class="line">  if (lastAddTokenTime == null) &#123;</span><br><span class="line">   // Token never added, just replenish the tokens and consume &#123;@code acquireCount&#125; immediately.</span><br><span class="line">   tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - acquireCount));</span><br><span class="line">   return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Calculate the time duration since last token was added.</span><br><span class="line">  long passTime = currentTime - lastAddTokenTime.get();</span><br><span class="line">  // A simplified token bucket algorithm that will replenish the tokens only when statistic window has passed.</span><br><span class="line">  if (passTime &gt; rule.getDurationInSec() * 1000) &#123;</span><br><span class="line">   // 补充 token</span><br><span class="line">   AtomicLong oldQps = tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - acquireCount));</span><br><span class="line">   if (oldQps == null) &#123;</span><br><span class="line">    // Might not be accurate here.</span><br><span class="line">    lastAddTokenTime.set(currentTime);</span><br><span class="line">    return true;</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">    long restQps = oldQps.get();</span><br><span class="line">    // 每毫秒应该生成的 token = tokenCount / (rule.getDurationInSec() * 1000)</span><br><span class="line">    // 再 * passTime 即等于应该补充的 token</span><br><span class="line">    long toAddCount = (passTime * tokenCount) / (rule.getDurationInSec() * 1000);</span><br><span class="line">    // 补充的 token 不会超过最大值</span><br><span class="line">    long newQps = toAddCount + restQps &gt; maxCount ? (maxCount - acquireCount)</span><br><span class="line">     : (restQps + toAddCount - acquireCount);</span><br><span class="line"></span><br><span class="line">    if (newQps &lt; 0) &#123;</span><br><span class="line">     return false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (oldQps.compareAndSet(restQps, newQps)) &#123;</span><br><span class="line">     lastAddTokenTime.set(currentTime);</span><br><span class="line">     return true;</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.yield();</span><br><span class="line">   &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">   // 直接操作计数器扣减即可</span><br><span class="line">   AtomicLong oldQps = tokenCounters.get(value);</span><br><span class="line">   if (oldQps != null) &#123;</span><br><span class="line">    long oldQpsValue = oldQps.get();</span><br><span class="line">    if (oldQpsValue - acquireCount &gt;= 0) &#123;</span><br><span class="line">     if (oldQps.compareAndSet(oldQpsValue, oldQpsValue - acquireCount)) &#123;</span><br><span class="line">      return true;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">     return false;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   Thread.yield();</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>令牌桶算法核心思想如下图所示，结合这个图咱们再来理解理解代码<br><img src="https://cdn.nlark.com/yuque/0/2023/webp/804884/1672846031117-714aa636-6f58-4ca4-855e-f93fcb06b4e6.webp#averageHue=%23f6f6f6&clientId=u5e430d1a-bdd7-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uf4f4f9f2&margin=%5Bobject%20Object%5D&originHeight=456&originWidth=357&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ua6371456-ed84-487c-8aa6-4b43f7b97fe&title="><br>核心逻辑在 while 循环中，咱们直接挑干的讲<br>先回顾一下上面说过 tokenCounters 和 timeCounters，在默认限流实现中，这两个参数分别代表最后添加令牌时间，令牌剩余数量<br>while 逻辑：</p><ol><li>首先如果当前 value 对应的令牌桶为空，则执行初始化</li><li>计算当前时间到上次添加 token 时间经历了多久，即 passTime = currentTime - lastAddTokenTime.get() 用于判断是否需要添加<br>token<br>2.1) if (pass &gt; rule 中设定的限流单位时间) ，则使用原子操作为令牌桶补充 token（具体补充 token 的逻辑详见上面代码注释）<br>2.2) else 不需要补充 token，使用原子操作扣减令牌</li></ol><p>可以看到关于 token 的操作全是使用原子操作（CAS），保证了线程安全。如果原子操作更新失败，则会继续执行。</p><h4 id="速率限制的实现"><a href="#速率限制的实现" class="headerlink" title="速率限制的实现"></a>速率限制的实现</h4><p>再顺便叨咕下上面说过CONTROL_BEHAVIOR_RATE_LIMITER 速率限制策略是如何实现的，只简单说说思路，具体细节大家可以自己看下源码<br>该策略中，仅使用 timeCounters，该参数存储的数据变成了 lastPassTime（最后通过时间），所以这个实现和令牌桶也没啥关系了<br>新的请求到来时，首先根据 Rule 中定义时间范围，count 计算 costTime，代表每隔多久才能通过一个请求<br>long costTime = Math.round(1.0 * 1000 * acquireCount * rule.getDurationInSec() / tokenCount);<br>只有 lastPassTime + costTime &lt;= currentTime ，请求才有可能成功通过，lastPassTime + costTime 过大会导致限流。</p><h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a href="https://zhuanlan.zhihu.com/p/394124184">https://zhuanlan.zhihu.com/p/394124184</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Sentinel热点参数限流原理&quot;&gt;&lt;a href=&quot;#Sentinel热点参数限流原理&quot; class=&quot;headerlink&quot; title=&quot;Sentinel热点参数限流原理&quot;&gt;&lt;/a&gt;Sentinel热点参数限流原理&lt;/h2&gt;&lt;h3 id=&quot;何为热点&quot;&gt;&lt;a </summary>
      
    
    
    
    <category term="sentinel" scheme="https://wuhaocn.github.io/categories/sentinel/"/>
    
    
    <category term="sentinel" scheme="https://wuhaocn.github.io/tags/sentinel/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://wuhaocn.github.io/2023/11/15/language/java/java%E9%9B%86%E5%90%88%E7%B1%BB/%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8/"/>
    <id>https://wuhaocn.github.io/2023/11/15/language/java/java%E9%9B%86%E5%90%88%E7%B1%BB/%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8/</id>
    <published>2023-11-15T03:40:25.012Z</published>
    <updated>2023-11-15T03:40:25.012Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ConcurrentModificationException"><a href="#ConcurrentModificationException" class="headerlink" title="ConcurrentModificationException"></a>ConcurrentModificationException</h2><ul><li>定义<br>  ConcurrentModificationException 是 Java 集合框架中的一个异常类，它表示在迭代过程中，同时修改了集合。<br>  这种异常通常在多线程环境下出现，因为在一个线程迭代集合的同时，另一个线程在修改集合。这种情况下，<br>  Java 会抛出 ConcurrentModificationException 异常，以防止数据不一致。</li><li>解决<ul><li>如果需要避免这种异常，可以使用以下方法：</li><li>使用同步集合，例如 Collections.synchronizedList。</li><li>使用锁机制，例如 ReentrantLock。</li><li>在迭代过程中使用副本，例如 ArrayList 的副本。</li><li>使用迭代器的 remove 方法进行删除操作，而不是直接删除集合中的元素。</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ConcurrentModificationException&quot;&gt;&lt;a href=&quot;#ConcurrentModificationException&quot; class=&quot;headerlink&quot; title=&quot;ConcurrentModificationExceptio</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>MyBatis简介</title>
    <link href="https://wuhaocn.github.io/2023/11/15/framework/mybatis/MyBatis%E7%AE%80%E4%BB%8B/"/>
    <id>https://wuhaocn.github.io/2023/11/15/framework/mybatis/MyBatis%E7%AE%80%E4%BB%8B/</id>
    <published>2023-11-15T03:40:25.010Z</published>
    <updated>2023-11-15T03:40:25.010Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、什么是MyBatis"><a href="#一、什么是MyBatis" class="headerlink" title="一、什么是MyBatis"></a>一、什么是MyBatis</h2><p>Mybatis是一个优秀的ORM框架.应用在持久层. 它对jdbc的 操作数据库过程 进行封装，使开发者只需要关注 SQL 本身，<br>而不需要花费精力去处理例如注册驱动、创建connection、等jdbc繁杂的过程代码。</p><h2 id="二、Mybatis执行流程"><a href="#二、Mybatis执行流程" class="headerlink" title="二、Mybatis执行流程"></a>二、Mybatis执行流程</h2><p>1、创建 SqlSessionFactory<br>2、通过 SqlSessionFactory 创建 SqlSession<br>3、通过 sqlsession 执行数据库操作<br>4、调用 session.commit()提交事务<br>5、调用 session.close()关闭会话</p><h2 id="三、Mybatis中-和-的区别"><a href="#三、Mybatis中-和-的区别" class="headerlink" title="三、Mybatis中#和$的区别"></a>三、Mybatis中#和$的区别</h2><p>#{}是预编译处理，相当于对数据加上 双引号<br>${}是字符串替换，相当于直接显示数据<br>#方式能够很大程度防止 sql 注入<br>$方式无法防止 Sql 注入<br>$方式一般用于传入数据库对象，例如传入表名<br>一般能用#的就别用$</p><h2 id="四、使用-MyBatis-的-mapper-接口调用时有哪些要求？"><a href="#四、使用-MyBatis-的-mapper-接口调用时有哪些要求？" class="headerlink" title="四、使用 MyBatis 的 mapper 接口调用时有哪些要求？"></a>四、使用 MyBatis 的 mapper 接口调用时有哪些要求？</h2><p>Mapper 接口方法名和 mapper.xml 中定义的每个 sql 的 id 相同<br>Mapper 接口方法的输入参数类型和 mapper.xml 中定义的每个 sql 的 parameterType 的类型相同<br>Mapper 接口方法的输出参数类型和 mapper.xml 中定义的每个 sql 的 resultType 的类型相同<br>Mapper.xml 文件中的 namespace 即是 mapper 接口的类路径</p><h2 id="五、JDBC-编程有哪些不足之处，MyBatis-是如何解决这些问题的？"><a href="#五、JDBC-编程有哪些不足之处，MyBatis-是如何解决这些问题的？" class="headerlink" title="五、JDBC 编程有哪些不足之处，MyBatis 是如何解决这些问题的？"></a>五、JDBC 编程有哪些不足之处，MyBatis 是如何解决这些问题的？</h2><ul><li><p>数据库链接创建、释放频繁造成系统资源浪费从而影响系统性能，如果使用数据库链接池可解决此问题。<br>解决：在 SqlMapConfig.xml 中配置数据链接池，使用连接池管理数据库链接。</p></li><li><p>Sql 语句写在代码中造成代码不易维护，实际应用 sql 变化的可能较大，sql 变动需要改变 java 代码。</p></li></ul><p>解决：将 Sql 语句配置在 XXXXmapper.xml 文件中与 java 代码分离。</p><ul><li>向 sql 语句传参数麻烦，因为 sql 语句的 where 条件不一定，可能多也可能少，占位符需要和参数一一对应。</li></ul><p>解决： Mybatis 自动将 java 对象映射至 sql 语句。</p><ul><li>对结果集解析麻烦，sql 变化导致解析代码变化，且解析前需要遍历，如果能将数据库记录封装成 pojo 对象解析比较方便。</li></ul><p>解决：Mybatis 自动将 sql 执行结果映射至 java 对象。</p><h2 id="六、MyBatis-在-insert-插入操作时返回主键-ID"><a href="#六、MyBatis-在-insert-插入操作时返回主键-ID" class="headerlink" title="六、MyBatis 在 insert 插入操作时返回主键 ID"></a>六、MyBatis 在 insert 插入操作时返回主键 ID</h2><ul><li>1、数据库为 MySql 时：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insert&quot; parameterType=&quot;com.test.User&quot; keyProperty=&quot;userId&quot; useGeneratedKeys=&quot;true&quot; &gt;</span><br><span class="line">注：</span><br><span class="line"></span><br><span class="line">“keyProperty”表示返回的 id 要保存到对象的那个属性中；</span><br><span class="line">“useGeneratedKeys”表示主键 id 为自增长模式。</span><br><span class="line">MySQL 中做以上配置就 OK 了</span><br></pre></td></tr></table></figure><p>2、数据库为 Oracle时：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insert&quot; parameterType=&quot;com.test.User&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;selectKey resultType=&quot;INTEGER&quot; order=&quot;BEFORE&quot; keyProperty=&quot;userId&quot;&gt;</span><br><span class="line">SELECT SEQ_USER.NEXTVAL as userId from DUAL</span><br><span class="line">&lt;/selectKey&gt;</span><br><span class="line"></span><br><span class="line">insert into user (user_id, user_name, modified, state)</span><br><span class="line"> values (#&#123;userId,jdbcType=INTEGER&#125;, #&#123;userName,jdbcType=VARCHAR&#125;,</span><br><span class="line">#&#123;modified,jdbcType=TIMESTAMP&#125;, #&#123;state,jdbcType=INTEGER&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure><ul><li>注：</li></ul><p>由于 Oracle 没有自增长一说法，只有序列这种模仿自增的形式，所以不能再使用“useGeneratedKeys”属性。而是使用将 ID 获取并赋值到对象的属性中，insert 插入操作时正常插入 id。</p><h2 id="七、Mybatis-中的一级缓存与二级缓存？"><a href="#七、Mybatis-中的一级缓存与二级缓存？" class="headerlink" title="七、Mybatis 中的一级缓存与二级缓存？"></a>七、Mybatis 中的一级缓存与二级缓存？</h2><ul><li>一级缓存:<br>基于 PerpetualCache 的 HashMap 本地缓存，其存储作用域为 Session，当 Session flush 或close 之后，该 Session 中的所有 Cache 就将清空。</li><li>二级缓存<br>二级缓存与一级缓存其机制相同，默认也是采用 PerpetualCache，HashMap 存储，不同在于其存储作用域为Mapper(Namespace)，并且可自定义存储源，如 Ehcache。作用域为 namespance 是指对该 namespance 对应的配置文件中所有的 select 操作结果都缓存，这样不同线程之间就可以共用二级缓存。启动二级缓存：在 mapper 配置文件中：&lt; cache /&gt;<br>二级缓存可以设置返回的缓存对象策略：。当 readOnly=”true”时，表示二级缓存返回给所有调用者同一个缓存对象实例，调用者可以 update 获取的缓存实例，但是这样可能会造成其他调用者出现数据不一致的情况（因为所有调用者调用的是同一个实例）。<br>当 readOnly=”false”时，返回给调用者的是二级缓存总缓存对象的拷贝，即不同调用者获取的是缓存对象不同的实例，这样调用者对各自的缓存对象的修改不会影响到其他的调用者，即是安全的，所以默认是 readOnly=“false”;<br>对于缓存数据更新机制，当某一个作用域(一级缓存 Session/二级缓存 Namespaces)的进行了 C/U/D 操作后，<br>默认该作用域下所有 select 中的缓存将被 clear</li></ul><h2 id="八、Hibernate-和-Mybatis-有哪些不同？"><a href="#八、Hibernate-和-Mybatis-有哪些不同？" class="headerlink" title="八、Hibernate 和 Mybatis 有哪些不同？"></a>八、Hibernate 和 Mybatis 有哪些不同？</h2><ul><li><p>1）Mybatis 和 hibernate 不同，它不完全是一个 ORM 框架，因为 MyBatis 需要程序员自己编写 Sql 语句，不过 mybatis 可以通过 XML 或注解方式灵活配置要运行的 sql 语句，并将java 对象和 sql 语句映射生成最终执行的 sql，最后将 sql 执行的结果再映射生成 java 对象。</p></li><li><p>2）Mybatis 学习门槛低，简单易学，程序员直接编写原生态 sql，可严格控制 sql 执行性能，灵活度高，非常适合对关系数据模型要求不高的软件开发，例如互联网软件、企业运营类软件等，因为这类软件需求变化频繁，一但需求变化要求成果输出迅速。但是灵活的前提是 mybatis 无法做到数据库无关性，如果需要实现支持多种数据库的软件则需要自定义多套 sql 映射文件，工作量大。</p></li><li><p>3）Hibernate 对象/关系映射能力强，数据库无关性好，对于关系模型要求高的软件（例如需求固定的定制化软件）如果用 hibernate 开发可以节省很多代码，提高效率。但是Hibernate 的缺点是学习门槛高，要精通门槛更高，而且怎么设计 O/R 映射，在性能和对象模型之间如何权衡，以及怎样用好 Hibernate 需要具有很强的经验和能力才行。</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;一、什么是MyBatis&quot;&gt;&lt;a href=&quot;#一、什么是MyBatis&quot; class=&quot;headerlink&quot; title=&quot;一、什么是MyBatis&quot;&gt;&lt;/a&gt;一、什么是MyBatis&lt;/h2&gt;&lt;p&gt;Mybatis是一个优秀的ORM框架.应用在持久层. 它对j</summary>
      
    
    
    
    <category term="MyBatis" scheme="https://wuhaocn.github.io/categories/MyBatis/"/>
    
    
    <category term="MyBatis" scheme="https://wuhaocn.github.io/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>docker-nexus服务搭建</title>
    <link href="https://wuhaocn.github.io/2023/11/15/devops/docker/%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-nexus/"/>
    <id>https://wuhaocn.github.io/2023/11/15/devops/docker/%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-nexus/</id>
    <published>2023-11-15T03:40:25.009Z</published>
    <updated>2023-11-15T03:40:25.010Z</updated>
    
    <content type="html"><![CDATA[<h2 id="nexus"><a href="#nexus" class="headerlink" title="nexus"></a>nexus</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /home/wuhao/nexus</span><br><span class="line">mkdir /home/wuhao/nexus</span><br><span class="line">docker stop nexus</span><br><span class="line">docker rm nexus</span><br><span class="line">docker run -d --name nexus -p 5260:8081 -p 5261:8082 -p 5262:8083 -p 5263:8084  -p 5264:5000 -v /home/wuhao/nexus:/var/nexus-data sonatype/nexus3</span><br><span class="line">docker logs -f nexus</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http://10.10.208.193:5260/</span><br><span class="line"></span><br><span class="line">bash-4.0$ cd /nexus-data/</span><br><span class="line"></span><br><span class="line">bash-4.0$ ls</span><br><span class="line">admin.passwordblobs  cache  db  elasticsearch  etc  generated-bundles  instances  javaprefs  kar  keystores  lock  log  orient  portrestore-from-backup  tmp</span><br><span class="line"></span><br><span class="line">bash-4.0$ cat admin.password</span><br><span class="line">51a030af-f7ab-43d5-875e-3c2775dbae2c</span><br><span class="line"></span><br><span class="line">登录进去修改密码~~</span><br><span class="line">注意修改密码之后，提示是否开启anonymous模式，这个要勾选，否则public需要密码访问</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;nexus&quot;&gt;&lt;a href=&quot;#nexus&quot; class=&quot;headerlink&quot; title=&quot;nexus&quot;&gt;&lt;/a&gt;nexus&lt;/h2&gt;&lt;h3 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安</summary>
      
    
    
    
    <category term="devops" scheme="https://wuhaocn.github.io/categories/devops/"/>
    
    
    <category term="docker" scheme="https://wuhaocn.github.io/tags/docker/"/>
    
    <category term="nexus" scheme="https://wuhaocn.github.io/tags/nexus/"/>
    
  </entry>
  
  <entry>
    <title>rabbitmq简介</title>
    <link href="https://wuhaocn.github.io/2023/11/15/data/rabbmitmq/rabbitmq%E7%AE%80%E4%BB%8B/"/>
    <id>https://wuhaocn.github.io/2023/11/15/data/rabbmitmq/rabbitmq%E7%AE%80%E4%BB%8B/</id>
    <published>2023-11-15T03:40:25.007Z</published>
    <updated>2023-11-15T03:40:25.007Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1、什么是-rabbitmq"><a href="#1、什么是-rabbitmq" class="headerlink" title="1、什么是 rabbitmq"></a>1、什么是 rabbitmq</h2><p>采用 AMQP 高级消息队列协议的一种消息队列技术,最大的特点就是消费并不需要确保提供方存在,实现了服务之间的高度解耦</p><h2 id="2、为什么要使用-rabbitmq"><a href="#2、为什么要使用-rabbitmq" class="headerlink" title="2、为什么要使用 rabbitmq"></a>2、为什么要使用 rabbitmq</h2><p>（1）在分布式系统下具备异步,削峰,负载均衡等一系列高级功能;<br>（2）拥有持久化的机制，进程消息，队列中的信息也可以保存下来。<br>（3）实现消费者和生产者之间的解耦。<br>（4）对于高并发场景下，利用消息队列可以使得同步访问变为串行访问达到一定量的限流，利于数据库的操作。<br>（5）可以使用消息队列达到异步下单的效果，排队中，后台进行逻辑下单。</p><h2 id="3、使用-rabbitmq-的场景"><a href="#3、使用-rabbitmq-的场景" class="headerlink" title="3、使用 rabbitmq 的场景"></a>3、使用 rabbitmq 的场景</h2><p>（1）服务间异步通信<br>（2）顺序消费<br>（3）定时任务<br>（4）请求削峰</p><h2 id="4、如何确保消息正确地发送至-RabbitMQ？-如何确保消息接收方消费了消息？"><a href="#4、如何确保消息正确地发送至-RabbitMQ？-如何确保消息接收方消费了消息？" class="headerlink" title="4、如何确保消息正确地发送至 RabbitMQ？ 如何确保消息接收方消费了消息？"></a>4、如何确保消息正确地发送至 RabbitMQ？ 如何确保消息接收方消费了消息？</h2><h3 id="发送方确认模式"><a href="#发送方确认模式" class="headerlink" title="发送方确认模式"></a>发送方确认模式</h3><p>将信道设置成 confirm 模式（发送方确认模式），则所有在信道上发布的消息都会被指派一个唯一的 ID。<br>一旦消息被投递到目的队列后，或者消息被写入磁盘后（可持久化的消息），信道会发送一个确认给生产者（包含消息唯一 ID）。<br>如果 RabbitMQ 发生内部错误从而导致消息丢失，会发送一条 nack（notacknowledged，未确认）消息。<br>发送方确认模式是异步的，生产者应用程序在等待确认的同时，可以继续发送消息。当确认消息到达生产者应用程序，生产者应用程序的回调方法就会被触发来处理确认消息。</p><h3 id="接收方确认机制"><a href="#接收方确认机制" class="headerlink" title="接收方确认机制"></a>接收方确认机制</h3><p>消费者接收每一条消息后都必须进行确认（消息接收和消息确认是两个不同操作）。只有消费者确认了消息，RabbitMQ 才能安全地把消息从队列中删除。<br>这里并没有用到超时机制，RabbitMQ 仅通过 Consumer 的连接中断来确认是否需要重新发送消息。也就是说，只要连接不中断，RabbitMQ 给了 Consumer 足够长的时间来处理消息。保证数据的最终一致性；<br>下面罗列几种特殊情况<br>（1）如果消费者接收到消息，在确认之前断开了连接或取消订阅，RabbitMQ 会认为消息没有被分发，然后重新分发给下一个订阅的消费者。（可能存在消息重复消费的隐患，需要去重）<br>（1）2如果消费者接收到消息却没有确认消息，连接也未断开，则 RabbitMQ 认为该消费者繁忙，将不会给该消费者分发更多的消息。</p><h2 id="5-如何避免消息重复投递或重复消费？"><a href="#5-如何避免消息重复投递或重复消费？" class="headerlink" title="5.如何避免消息重复投递或重复消费？"></a>5.如何避免消息重复投递或重复消费？</h2><p>在消息生产时，MQ 内部针对每条生产者发送的消息生成一个 inner-msg-id，作为去重的依据（消息投递失败并重传），避免重复的消息进入队列；在消息消费时，要求消息体中必须要有一个 bizId（对于同一业务全局唯一，如支付 ID、订单 ID、帖子 ID 等）作为去重的依据，避免同一条消息被重复消费。</p><h2 id="6、消息基于什么传输？"><a href="#6、消息基于什么传输？" class="headerlink" title="6、消息基于什么传输？"></a>6、消息基于什么传输？</h2><p>由于 TCP 连接的创建和销毁开销较大，且并发数受系统资源限制，会造成性能瓶颈。RabbitMQ 使用信道的方式来传输数据。信道是建立在真实的 TCP 连接内的虚拟连接，且每条 TCP 连接上的信道数量没有限制。</p><h2 id="7、消息如何分发？"><a href="#7、消息如何分发？" class="headerlink" title="7、消息如何分发？"></a>7、消息如何分发？</h2><p>若该队列至少有一个消费者订阅，消息将以循环（round-robin）的方式发送给消费者。每条消息只会分发给一个订阅的消费者（前提是消费者能够正常处理消息并进行确认）。通过路由可实现多消费的功能</p><h2 id="8、消息怎么路由？"><a href="#8、消息怎么路由？" class="headerlink" title="8、消息怎么路由？"></a>8、消息怎么路由？</h2><p>消息提供方-&gt;路由-&gt;一至多个队列消息发布到交换器时，消息将拥有一个路由键（routing key），在消息创建时设定。通过队列路由键，可以把队列绑定到交换器上。消息到达交换器后，RabbitMQ 会将消息的路由键与队列的路由键进行匹配（针对不同的交换器有不同的路由规则）；<br>常用的交换器主要分为一下三种：<br>fanout：如果交换器收到消息，将会广播到所有绑定的队列上<br>direct：如果路由键完全匹配，消息就被投递到相应的队列<br>topic：可以使来自不同源头的消息能够到达同一个队列。 使用 topic 交换器时，可以使用通配符</p><h2 id="9、如何确保消息不丢失？"><a href="#9、如何确保消息不丢失？" class="headerlink" title="9、如何确保消息不丢失？"></a>9、如何确保消息不丢失？</h2><p>消息持久化，当然前提是队列必须持久化<br>RabbitMQ 确保持久性消息能从服务器重启中恢复的方式是，将它们写入磁盘上的一个持久化日志文件，当发布一条持久性消息到持久交换器上时，Rabbit 会在消息提交到日志文件后才发送响应。一旦消费者从持久队列中消费了一条持久化消息，RabbitMQ 会在持久化日志中把这条消息标记为等待垃圾收集。如果持久化消息在被消费之前 RabbitMQ 重启，那么 Rabbit 会自动重建交换器和队列（以及绑定），并重新发布持久化日志文件中的消息到合适的队列。</p><h2 id="10、使用-RabbitMQ-有什么好处？"><a href="#10、使用-RabbitMQ-有什么好处？" class="headerlink" title="10、使用 RabbitMQ 有什么好处？"></a>10、使用 RabbitMQ 有什么好处？</h2><p>（1）服务间高度解耦<br>（2）异步通信性能高<br>（3）流量削峰</p><h2 id="11、RabbitMQ-的集群"><a href="#11、RabbitMQ-的集群" class="headerlink" title="11、RabbitMQ 的集群"></a>11、RabbitMQ 的集群</h2><p>镜像集群模式<br>你创建的 queue，无论元数据还是 queue 里的消息都会存在于多个实例上，然后每次你写消息到 queue 的时候，都会自动把消息到多个实例的 queue 里进行消息同步。<br>好处在于，你任何一个机器宕机了，没事儿，别的机器都可以用。坏处在于，第一，这个性能开销也太大了吧，消息同步所有机器，导致网络带宽压力和消耗很重！第二，这么玩儿，就没有扩展性可言了，如果某个 queue 负载很重，你加机器，新增的机器也包含了这个 queue 的所有数据，并没有办法线性扩展你的 queue</p><h2 id="12、mq-的缺点"><a href="#12、mq-的缺点" class="headerlink" title="12、mq 的缺点"></a>12、mq 的缺点</h2><h3 id="（1）系统可用性降低"><a href="#（1）系统可用性降低" class="headerlink" title="（1）系统可用性降低"></a>（1）系统可用性降低</h3><p>系统引入的外部依赖越多，越容易挂掉，本来你就是 A 系统调用 BCD 三个系统的接口就好了，人 ABCD 四个系统好好的，没啥问题，你偏加个 MQ 进来，万一MQ 挂了咋整？MQ 挂了，整套系统崩溃了，你不就完了么。</p><h3 id="（2）系统复杂性提高"><a href="#（2）系统复杂性提高" class="headerlink" title="（2）系统复杂性提高"></a>（2）系统复杂性提高</h3><p>硬生生加个 MQ 进来，你怎么保证消息没有重复消费？怎么处理消息丢失的情况？怎么保证消息传递的顺序性？头大头大，问题一大堆，痛苦不已</p><h3 id="（3）一致性问题"><a href="#（3）一致性问题" class="headerlink" title="（3）一致性问题"></a>（3）一致性问题</h3><p>A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，咋整？你这数据就不一致了。<br>所以消息队列实际是一种非常复杂的架构，你引入它有很多好处，但是也得针对它带来的坏处做各种额外的技术方案和架构来规避掉，最好之后，你会发现，妈呀，系统复杂度提升了一个数量级，也许是复杂了 10 倍。但是关键时刻，用，还是得用的。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1、什么是-rabbitmq&quot;&gt;&lt;a href=&quot;#1、什么是-rabbitmq&quot; class=&quot;headerlink&quot; title=&quot;1、什么是 rabbitmq&quot;&gt;&lt;/a&gt;1、什么是 rabbitmq&lt;/h2&gt;&lt;p&gt;采用 AMQP 高级消息队列协议的一种消息队</summary>
      
    
    
    
    <category term="mq" scheme="https://wuhaocn.github.io/categories/mq/"/>
    
    
    <category term="mq" scheme="https://wuhaocn.github.io/tags/mq/"/>
    
  </entry>
  
  <entry>
    <title>zookeeper简介</title>
    <link href="https://wuhaocn.github.io/2023/11/15/data/zookeeper/zookeeper%E7%AE%80%E4%BB%8B/"/>
    <id>https://wuhaocn.github.io/2023/11/15/data/zookeeper/zookeeper%E7%AE%80%E4%BB%8B/</id>
    <published>2023-11-15T03:40:25.007Z</published>
    <updated>2023-11-15T03:40:25.008Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。<br>ZooKeeper 的目标就是封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。</p><h2 id="常见知识点"><a href="#常见知识点" class="headerlink" title="常见知识点"></a>常见知识点</h2><h3 id="1-ZooKeeper-是什么？"><a href="#1-ZooKeeper-是什么？" class="headerlink" title="1. ZooKeeper 是什么？"></a>1. ZooKeeper 是什么？</h3><p>ZooKeeper 是一个开放源码的分布式协调服务，它是集群的管理者，监视着集群中各个节点的状态根据节点提交的反馈进行下一步合理操作。最终，将简单易用的接口和性能高效、功能稳定的系统提供给用户。<br>分布式应用程序可以基于 Zookeeper 实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master<br>选举、分布式锁和分布式队列等功能。<br>Zookeeper 保证了如下分布式一致性特性：<br>（1）顺序一致性<br>（2）原子性<br>（3）单一视图<br>（4）可靠性<br>（5）实时性（最终一致性）<br>客户端的读请求可以被集群中的任意一台机器处理，如果读请求在节点上注册了监听器，这个监听器也是由所连接的 zookeeper<br>机器来处理。对于写请求，这些请求会同时发给其他 zookeeper 机器并且达成一致后，请求才会返回成功。因此，随着 zookeeper<br>的集群机器增多，读请求的吞吐会提高但是写请求的吞吐会下降。<br>有序性是 zookeeper 中非常重要的一个特性，所有的更新都是全局有序的，每个更新都有一个唯一的时间戳，这个时间戳称为<br>zxid（Zookeeper Transaction Id）。而读请求只会相对于更新有序，也就是读请求的返回结果中会带有这个zookeeper 最新的 zxid。</p><h3 id="2-ZooKeeper-提供了什么？"><a href="#2-ZooKeeper-提供了什么？" class="headerlink" title="2. ZooKeeper 提供了什么？"></a>2. ZooKeeper 提供了什么？</h3><p>（1）文件系统<br>（2）通知机制</p><h3 id="3-Zookeeper-文件系统"><a href="#3-Zookeeper-文件系统" class="headerlink" title="3.Zookeeper 文件系统"></a>3.Zookeeper 文件系统</h3><p>Zookeeper 提供一个多层级的节点命名空间（节点称为 znode）。与文件系统不同的是，这些节点都可以设置关联的数据，而文件系统中只有文件节点可以存放数据而目录节点不行。<br>Zookeeper 为了保证高吞吐和低延迟，在内存中维护了这个树状的目录结构，这种特性使得 Zookeeper 不能用于存放大量的数据，每个节点的存放数据上限为1M。</p><h3 id="4-ZAB-协议？"><a href="#4-ZAB-协议？" class="headerlink" title="4. ZAB 协议？"></a>4. ZAB 协议？</h3><p>ZAB 协议是为分布式协调服务 Zookeeper 专门设计的一种支持崩溃恢复的原子广播协议。<br>ZAB 协议包括两种基本的模式：崩溃恢复和消息广播。<br>当整个 zookeeper 集群刚刚启动或者 Leader 服务器宕机、重启或者网络故障导致不存在过半的服务器与 Leader<br>服务器保持正常通信时，所有进程（服务器）进入崩溃恢复模式，首先选举产生新的 Leader 服务器，然后集群中 Follower 服务器开始与新的<br>Leader 服务器进行数据同步，当集群中超过半数机器与该 Leader服务器完成数据同步之后，退出恢复模式进入消息广播模式，Leader<br>服务器开始接收客户端的事务请求生成事物提案来进行事务请求处理。</p><h3 id="5-四种类型的数据节点-Znode"><a href="#5-四种类型的数据节点-Znode" class="headerlink" title="5. 四种类型的数据节点 Znode"></a>5. 四种类型的数据节点 Znode</h3><p>（1）PERSISTENT-持久节点<br>除非手动删除，否则节点一直存在于 Zookeeper 上<br>（2）EPHEMERAL-临时节点<br>临时节点的生命周期与客户端会话绑定，一旦客户端会话失效（客户端与zookeeper 连接断开不一定会话失效），那么这个客户端创建的所有临时节点都会被移除。<br>（3）PERSISTENT_SEQUENTIAL-持久顺序节点<br>基本特性同持久节点，只是增加了顺序属性，节点名后边会追加一个由父节点维护的自增整型数字。<br>（4）EPHEMERAL_SEQUENTIAL-临时顺序节点<br>基本特性同临时节点，增加了顺序属性，节点名后边会追加一个由父节点维护的自增整型数字。</p><h3 id="6-Zookeeper-Watcher-机制-–-数据变更通知"><a href="#6-Zookeeper-Watcher-机制-–-数据变更通知" class="headerlink" title="6. Zookeeper Watcher 机制 – 数据变更通知"></a>6. Zookeeper Watcher 机制 – 数据变更通知</h3><p>Zookeeper 允许客户端向服务端的某个 Znode 注册一个 Watcher 监听，当服务端的一些指定事件触发了这个<br>Watcher，服务端会向指定客户端发送一个事件通知来实现分布式的通知功能，然后客户端根据 Watcher 通知状态和事件类型做出业务上的改变。<br>工作机制：<br>（1）客户端注册 watcher<br>（2）服务端处理 watcher<br>（3）客户端回调 watcher<br>Watcher 特性总结：<br>（1）一次性<br>无论是服务端还是客户端，一旦一个 Watcher 被 触 发 ，Zookeeper<br>都会将其从相应的存储中移除。这样的设计有效的减轻了服务端的压力，不然对于更新非常频繁的节点，服务端会不断的向客户端发送事件通知，无论对于网络还是服务端的压力都非常大。<br>（2）客户端串行执行<br>客户端 Watcher 回调的过程是一个串行同步的过程。<br>（3）轻量<br>3.1、Watcher 通知非常简单，只会告诉客户端发生了事件，而不会说明事件的具体内容。<br>3.2、客户端向服务端注册 Watcher 的时候，并不会把客户端真实的 Watcher 对象实体传递到服务端，仅仅是在客户端请求中使用 boolean<br>类型属性进行了标记。<br>（4）watcher event 异步发送 watcher 的通知事件从 server 发送到 client 是异步的，这就存在一个问题，不同的客户端和服务器之间通过<br>socket 进行通信，由于网络延迟或其他因素导致客户端在不通的时刻监听到事件，由于 Zookeeper 本身提供了 ordering<br>guarantee，即客户端监听事件后，才会感知它所监视 znode发生了变化。所以我们使用 Zookeeper 不能期望能够监控到节点每次的变化。Zookeeper<br>只能保证最终的一致性，而无法保证强一致性。<br>（5）注册 watcher getData、exists、getChildren<br>（6）触发 watcher create、delete、setData<br>（7）当一个客户端连接到一个新的服务器上时，watch 将会被以任意会话事件触发。当与一个服务器失去连接的时候，是无法接收到 watch<br>的。而当 client 重新连接时，如果需要的话，所有先前注册过的 watch，都会被重新注册。通常这是完全透明的。只有在一个特殊情况下，watch<br>可能会丢失：对于一个未创建的 znode的 exist watch，如果在客户端断开连接期间被创建了，并且随后在客户端连接上之前又删除了，这种情况下，这个<br>watch 事件可能会被丢失。</p><h3 id="7-客户端注册-Watcher-实现"><a href="#7-客户端注册-Watcher-实现" class="headerlink" title="7. 客户端注册 Watcher 实现"></a>7. 客户端注册 Watcher 实现</h3><p>（1）调用 getData()/getChildren()/exist()三个 API，传入 Watcher 对象<br>（2）标记请求 request，封装 Watcher 到 WatchRegistration<br>（3）封装成 Packet 对象，发服务端发送 request<br>（4）收到服务端响应后，将 Watcher 注册到 ZKWatcherManager 中进行管理<br>（5）请求返回，完成注册。</p><h3 id="8-服务端处理-Watcher-实现"><a href="#8-服务端处理-Watcher-实现" class="headerlink" title="8. 服务端处理 Watcher 实现"></a>8. 服务端处理 Watcher 实现</h3><p>（1）服务端接收 Watcher 并存储<br>接收到客户端请求，处理请求判断是否需要注册 Watcher，需要的话将数据节点的节点路径和 ServerCnxn（ServerCnxn<br>代表一个客户端和服务端的连接，实现了 Watcher 的 process 接口，此时可以看成一个 Watcher 对象）存储在WatcherManager 的<br>WatchTable 和 watch2Paths 中去。<br>（2）Watcher 触发<br>以服务端接收到 setData() 事务请求触发 NodeDataChanged 事件为例：<br>2.1 封装 WatchedEvent<br>将通知状态（SyncConnected）、事件类型（NodeDataChanged）以及节点路径封装成一个 WatchedEvent 对象<br>2.2 查询 Watcher<br>从 WatchTable 中根据节点路径查找 Watcher<br>2.3 没找到；说明没有客户端在该数据节点上注册过 Watcher<br>2.4 找到；提取并从 WatchTable 和 Watch2Paths 中删除对应 Watcher（从这里可以看出 Watcher 在服务端是一次性的，触发一次就失效了）<br>（3）调用 process 方法来触发 Watcher<br>这里 process 主要就是通过 ServerCnxn 对应的 TCP 连接发送 Watcher 事件通知。</p><h3 id="9-客户端回调-Watcher"><a href="#9-客户端回调-Watcher" class="headerlink" title="9. 客户端回调 Watcher"></a>9. 客户端回调 Watcher</h3><p>客户端 SendThread 线程接收事件通知，交由 EventThread 线程回调 Watcher。<br>客户端的 Watcher 机制同样是一次性的，一旦被触发后，该 Watcher 就失效了。</p><h3 id="10-ACL-权限控制机制"><a href="#10-ACL-权限控制机制" class="headerlink" title="10. ACL 权限控制机制"></a>10. ACL 权限控制机制</h3><p>UGO（User/Group/Others）<br>目前在 Linux/Unix 文件系统中使用，也是使用最广泛的权限控制方式。是一种粗粒度的文件系统权限控制模式。<br>ACL（Access Control List）访问控制列表<br>包括三个方面：<br>权限模式（Scheme）<br>（1）IP：从 IP 地址粒度进行权限控制<br>（2）Digest：最常用，用类似于 username:password 的权限标识来进行权限配置，便于区分不同应用来进行权限控制<br>（3）World：最开放的权限控制方式，是一种特殊的 digest 模式，只有一个权限标识“world:anyone”<br>（4）Super：超级用户<br>授权对象<br>授权对象指的是权限赋予的用户或一个指定实体，例如 IP 地址或是机器灯。<br>权限 Permission<br>（1）CREATE：数据节点创建权限，允许授权对象在该 Znode 下创建子节点<br>（2）DELETE：子节点删除权限，允许授权对象删除该数据节点的子节点<br>（3）READ：数据节点的读取权限，允许授权对象访问该数据节点并读取其数据内容或子节点列表等<br>（4）WRITE：数据节点更新权限，允许授权对象对该数据节点进行更新操作<br>（5）ADMIN：数据节点管理权限，允许授权对象对该数据节点进行 ACL 相关设置操作</p><h3 id="11-Chroot-特性"><a href="#11-Chroot-特性" class="headerlink" title="11. Chroot 特性"></a>11. Chroot 特性</h3><p>3.2.0 版本后，添加了 Chroot 特性，该特性允许每个客户端为自己设置一个命名空间。如果一个客户端设置了<br>Chroot，那么该客户端对服务器的任何操作，都将会被限制在其自己的命名空间下。<br>通过设置 Chroot，能够将一个客户端应用于 Zookeeper 服务端的一颗子树相对应，在那些多个应用公用一个 Zookeeper<br>进群的场景下，对实现不同应用间的相互隔离非常有帮助。</p><h3 id="12-会话管理"><a href="#12-会话管理" class="headerlink" title="12. 会话管理"></a>12. 会话管理</h3><p>分桶策略：将类似的会话放在同一区块中进行管理，以便于 Zookeeper 对会话进行不同区块的隔离处理以及同一区块的统一处理。<br>分配原则：每个会话的“下次超时时间点”（ExpirationTime）<br>计算公式：<br>ExpirationTime_ = currentTime + sessionTimeout<br>ExpirationTime = (ExpirationTime_ / ExpirationInrerval + 1) *<br>ExpirationInterval , ExpirationInterval 是指 Zookeeper 会话超时检查时间间隔，默认 tickTime</p><h3 id="13-服务器角色"><a href="#13-服务器角色" class="headerlink" title="13. 服务器角色"></a>13. 服务器角色</h3><p>Leader<br>（1）事务请求的唯一调度和处理者，保证集群事务处理的顺序性<br>（2）集群内部各服务的调度者<br>Follower<br>（1）处理客户端的非事务请求，转发事务请求给 Leader 服务器<br>（2）参与事务请求 Proposal 的投票<br>（3）参与 Leader 选举投票<br>Observer<br>（1）3.0 版本以后引入的一个服务器角色，在不影响集群事务处理能力的基础上提升集群的非事务处理能力<br>（2）处理客户端的非事务请求，转发事务请求给 Leader 服务器<br>（3）不参与任何形式的投票</p><h3 id="14-Zookeeper-下-Server-工作状态"><a href="#14-Zookeeper-下-Server-工作状态" class="headerlink" title="14. Zookeeper 下 Server 工作状态"></a>14. Zookeeper 下 Server 工作状态</h3><p>服务器具有四种状态，分别是 LOOKING、FOLLOWING、LEADING、OBSERVING。<br>（1）LOOKING：寻 找 Leader 状态。当服务器处于该状态时，它会认为当前集群中没有 Leader，因此需要进入 Leader 选举状态。<br>（2）FOLLOWING：跟随者状态。表明当前服务器角色是 Follower。<br>（3）LEADING：领导者状态。表明当前服务器角色是 Leader。<br>（4）OBSERVING：观察者状态。表明当前服务器角色是 Observer。</p><h3 id="15-数据同步"><a href="#15-数据同步" class="headerlink" title="15. 数据同步"></a>15. 数据同步</h3><p>整个集群完成 Leader 选举之后，Learner（Follower 和 Observer 的统称）回向Leader 服务器进行注册。当 Learner 服务器想 Leader<br>服务器完成注册后，进入数据同步环节。<br>数据同步流程：（均以消息传递的方式进行）<br>Learner 向 Learder 注册<br>数据同步<br>同步确认<br>Zookeeper 的数据同步通常分为四类：<br>（1）直接差异化同步（DIFF 同步）<br>（2）先回滚再差异化同步（TRUNC+DIFF 同步）<br>（3）仅回滚同步（TRUNC 同步）<br>（4）全量同步（SNAP 同步）<br>在进行数据同步前，Leader 服务器会完成数据同步初始化：<br>peerLastZxid：<br>· 从 learner 服务器注册时发送的 ACKEPOCH 消息中提取 lastZxid（该Learner 服务器最后处理的 ZXID）<br>minCommittedLog：<br>· Leader 服务器 Proposal 缓存队列 committedLog 中最小 ZXIDmaxCommittedLog：<br>· Leader 服务器 Proposal 缓存队列 committedLog 中最大 ZXID直接差异化同步（DIFF 同步）<br>· 场景：peerLastZxid 介于 minCommittedLog 和 maxCommittedLog之间先回滚再差异化同步（TRUNC+DIFF 同步）<br>· 场景：当新的 Leader 服务器发现某个 Learner 服务器包含了一条自己没有的事务记录，那么就需要让该 Learner 服务器进行事务回滚–回滚到<br>Leader服务器上存在的，同时也是最接近于 peerLastZxid 的 ZXID仅回滚同步（TRUNC 同步）<br>· 场景：peerLastZxid 大于 maxCommittedLog<br>全量同步（SNAP 同步）<br>· 场景一：peerLastZxid 小于 minCommittedLog<br>· 场景二：Leader 服务器上没有 Proposal 缓存队列且 peerLastZxid 不等于 lastProcessZxid</p><h3 id="16-zookeeper-是如何保证事务的顺序一致性的？"><a href="#16-zookeeper-是如何保证事务的顺序一致性的？" class="headerlink" title="16. zookeeper 是如何保证事务的顺序一致性的？"></a>16. zookeeper 是如何保证事务的顺序一致性的？</h3><p>zookeeper 采用了全局递增的事务 Id 来标识，所有的 proposal（提议）都在被提出的时候加上了 zxid，zxid 实际上是一个 64 位的数字，高<br>32 位是 epoch（ 时期; 纪元; 世; 新时代）用来标识 leader 周期，如果有新的 leader 产生出来，epoch会自增，低 32 位用来递增计数。当新产生<br>proposal 的时候，会依据数据库的两阶段过程，首先会向其他的 server 发出事务执行请求，如果超过半数的机器都能执行并且能够成功，那么就会开始执行。</p><h3 id="17-分布式集群中为什么会有-Master？"><a href="#17-分布式集群中为什么会有-Master？" class="headerlink" title="17. 分布式集群中为什么会有 Master？"></a>17. 分布式集群中为什么会有 Master？</h3><p>在分布式环境中，有些业务逻辑只需要集群中的某一台机器进行执行，其他的机器可以共享这个结果，这样可以大大减少重复计算，提高性能，于是就需要进行leader<br>选举。</p><h3 id="18-zk-节点宕机如何处理？"><a href="#18-zk-节点宕机如何处理？" class="headerlink" title="18. zk 节点宕机如何处理？"></a>18. zk 节点宕机如何处理？</h3><p>Zookeeper 本身也是集群，推荐配置不少于 3 个服务器。Zookeeper 自身也要保证当一个节点宕机时，其他节点会继续提供服务。<br>如果是一个 Follower 宕机，还有 2 台服务器提供访问，因为 Zookeeper 上的数据是有多个副本的，数据并不会丢失；<br>如果是一个 Leader 宕机，Zookeeper 会选举出新的 Leader。<br>ZK 集群的机制是只要超过半数的节点正常，集群就能正常提供服务。只有在 ZK节点挂得太多，只剩一半或不到一半节点能工作，集群才失效。<br>所以<br>3 个节点的 cluster 可以挂掉 1 个节点(leader 可以得到 2 票&gt;1.5)<br>2 个节点的 cluster 就不能挂掉任何 1 个节点了(leader 可以得到 1 票&lt;=1)</p><h3 id="19-zookeeper-负载均衡和-nginx-负载均衡区别"><a href="#19-zookeeper-负载均衡和-nginx-负载均衡区别" class="headerlink" title="19. zookeeper 负载均衡和 nginx 负载均衡区别"></a>19. zookeeper 负载均衡和 nginx 负载均衡区别</h3><p>zk 的负载均衡是可以调控，nginx 只是能调权重，其他需要可控的都需要自己写插件；但是 nginx 的吞吐量比 zk 大很多，应该说按业务选择用哪种方式。</p><h3 id="20-Zookeeper-有哪几种几种部署模式？"><a href="#20-Zookeeper-有哪几种几种部署模式？" class="headerlink" title="20. Zookeeper 有哪几种几种部署模式？"></a>20. Zookeeper 有哪几种几种部署模式？</h3><p>部署模式：单机模式、伪集群模式、集群模式。</p><h3 id="21-集群最少要几台机器，集群规则是怎样的"><a href="#21-集群最少要几台机器，集群规则是怎样的" class="headerlink" title="21. 集群最少要几台机器，集群规则是怎样的?"></a>21. 集群最少要几台机器，集群规则是怎样的?</h3><p>集群规则为 2N+1 台，N&gt;0，即 3 台。</p><h3 id="22-集群支持动态添加机器吗？"><a href="#22-集群支持动态添加机器吗？" class="headerlink" title="22. 集群支持动态添加机器吗？"></a>22. 集群支持动态添加机器吗？</h3><p>其实就是水平扩容了，Zookeeper 在这方面不太好。两种方式：<br>全部重启：关闭所有 Zookeeper 服务，修改配置之后启动。不影响之前客户端的会话。<br>逐个重启：在过半存活即可用的原则下，一台机器重启不影响整个集群对外提供服务。这是比较常用的方式。<br>3.5 版本开始支持动态扩容。</p><h3 id="23-Zookeeper-对节点的-watch-监听通知是永久的吗？为什么不是永久的"><a href="#23-Zookeeper-对节点的-watch-监听通知是永久的吗？为什么不是永久的" class="headerlink" title="23. Zookeeper 对节点的 watch 监听通知是永久的吗？为什么不是永久的?"></a>23. Zookeeper 对节点的 watch 监听通知是永久的吗？为什么不是永久的?</h3><p>不是。官方声明：一个 Watch 事件是一个一次性的触发器，当被设置了 Watch的数据发生了改变的时候，则服务器将这个改变发送给设置了<br>Watch 的客户端，以便通知它们。<br>为什么不是永久的，举个例子，如果服务端变动频繁，而监听的客户端很多情况下，每次变动都要通知到所有的客户端，给网络和服务器造成很大压力。<br>一般是客户端执行 getData(“/节点 A”,true)，如果节点 A 发生了变更或删除，客户端会得到它的 watch 事件，但是在之后节点 A<br>又发生了变更，而客户端又没有设置 watch 事件，就不再给客户端发送。<br>在实际应用中，很多情况下，我们的客户端不需要知道服务端的每一次变动，我只要最新的数据即可。</p><h3 id="24-Zookeeper-的-java-客户端都有哪些？"><a href="#24-Zookeeper-的-java-客户端都有哪些？" class="headerlink" title="24. Zookeeper 的 java 客户端都有哪些？"></a>24. Zookeeper 的 java 客户端都有哪些？</h3><p>java 客户端：zk 自带的 zkclient 及 Apache 开源的 Curator。</p><h3 id="25-chubby-是什么，和-zookeeper-比你怎么看？"><a href="#25-chubby-是什么，和-zookeeper-比你怎么看？" class="headerlink" title="25. chubby 是什么，和 zookeeper 比你怎么看？"></a>25. chubby 是什么，和 zookeeper 比你怎么看？</h3><p>chubby 是 google 的，完全实现 paxos 算法，不开源。zookeeper 是 chubby的开源实现，使用 zab 协议，paxos 算法的变种。</p><h3 id="26-说几个-zookeeper-常用的命令。"><a href="#26-说几个-zookeeper-常用的命令。" class="headerlink" title="26. 说几个 zookeeper 常用的命令。"></a>26. 说几个 zookeeper 常用的命令。</h3><p>常用命令：ls get set create delete 等。</p><h3 id="27-ZAB-和-Paxos-算法的联系与区别？"><a href="#27-ZAB-和-Paxos-算法的联系与区别？" class="headerlink" title="27. ZAB 和 Paxos 算法的联系与区别？"></a>27. ZAB 和 Paxos 算法的联系与区别？</h3><p>相同点：<br>（1）两者都存在一个类似于 Leader 进程的角色，由其负责协调多个 Follower 进程的运行<br>（2）Leader 进程都会等待超过半数的 Follower 做出正确的反馈后，才会将一个提案进行提交<br>（3）ZAB 协议中，每个 Proposal 中都包含一个 epoch 值来代表当前的 Leader周期，Paxos 中名字为 Ballot<br>不同点：<br>ZAB 用来构建高可用的分布式数据主备系统（Zookeeper），Paxos 是用来构建分布式一致性状态机系统。</p><h3 id="28-Zookeeper-的典型应用场景"><a href="#28-Zookeeper-的典型应用场景" class="headerlink" title="28. Zookeeper 的典型应用场景"></a>28. Zookeeper 的典型应用场景</h3><p>Zookeeper 是一个典型的发布/订阅模式的分布式数据管理与协调框架，开发人员可以使用它来进行分布式数据的发布和订阅。<br>通过对 Zookeeper 中丰富的数据节点进行交叉使用，配合 Watcher 事件通知机制，可以非常方便的构建一系列分布式应用中年都会涉及的核心功能，如：<br>（1）数据发布/订阅<br>（2）负载均衡<br>（3）命名服务<br>（4）分布式协调/通知<br>（5）集群管理<br>（6）Master 选举<br>（7）分布式锁<br>（8）分布式队列</p><p><strong>数据发布/订阅</strong></p><p>介绍<br>数据发布/订阅系统，即所谓的配置中心，顾名思义就是发布者发布数据供订阅者进行数据订阅。<br>目的<br>动态获取数据（配置信息）<br>实现数据（配置信息）的集中式管理和数据的动态更新<br>设计模式<br>Push 模式<br>Pull 模式<br>数据（配置信息）特性<br>（1）数据量通常比较小<br>（2）数据内容在运行时会发生动态更新<br>（3）集群中各机器共享，配置一致<br>如：机器列表信息、运行时开关配置、数据库配置信息等<br>基于 Zookeeper 的实现方式<br>· 数据存储：将数据（配置信息）存储到 Zookeeper 上的一个数据节点<br>· 数据获取：应用在启动初始化节点从 Zookeeper 数据节点读取数据，并在该节点上注册一个数据变更 Watcher<br>· 数据变更：当变更数据时，更新 Zookeeper 对应节点数据，Zookeeper会将数据变更通知发到各客户端，客户端接到通知后重新读取变更后的数据即可。</p><p><strong>负载均衡</strong></p><p>zk 的命名服务<br>命名服务是指通过指定的名字来获取资源或者服务的地址，利用 zk 创建一个全局的路径，这个路径就可以作为一个名字，指向集群中的集群，提供的服务的地址，或者一个远程的对象等等。</p><p><strong>分布式通知和协调</strong></p><p>对于系统调度来说：操作人员发送通知实际是通过控制台改变某个节点的状态，然后 zk 将这些变化发送给注册了这个节点的 watcher<br>的所有客户端。<br>对于执行情况汇报：每个工作进程都在某个目录下创建一个临时节点。并携带工作的进度数据，这样汇总的进程可以监控目录子节点的变化获得工作进度的实时的全局情况。</p><p><strong>zk 的命名服务（文件系统）</strong></p><p>命名服务是指通过指定的名字来获取资源或者服务的地址，利用 zk<br>创建一个全局的路径，即是唯一的路径，这个路径就可以作为一个名字，指向集群中的集群，提供的服务的地址，或者一个远程的对象等等。</p><p><strong>zk 的配置管理（文件系统、通知机制）</strong></p><p>程序分布式的部署在不同的机器上，将程序的配置信息放在 zk 的 znode 下，当有配置发生改变时，也就是 znode 发生变化时，可以通过改变<br>zk 中某个目录节点的内容，利用 watcher 通知给各个客户端，从而更改配置。</p><p><strong>Zookeeper 集群管理（文件系统、通知机制）</strong></p><p>所谓集群管理无在乎两点：是否有机器退出和加入、选举 master。<br>对于第一点，所有机器约定在父目录下创建临时目录节点，然后监听父目录节点<br>的子节点变化消息。一旦有机器挂掉，该机器与 zookeeper 的连接断开，其所创建的临时目录节点被删除，所有其他机器都收到通知：某个兄弟目录被删除，于是，所有人都知道：它上船了。<br>新机器加入也是类似，所有机器收到通知：新兄弟目录加入，highcount 又有了，对于第二点，我们稍微改变一下，所有机器创建临时顺序编号目录节点，每次选取编号最小的机器作为<br>master 就好。</p><p><strong>Zookeeper 分布式锁（文件系统、通知机制）</strong></p><p>有了 zookeeper 的一致性文件系统，锁的问题变得容易。锁服务可以分为两类，一个是保持独占，另一个是控制时序。<br>对于第一类，我们将 zookeeper 上的一个 znode 看作是一把锁，通过 createznode的方式来实现。所有客户端都去创建 /distribute_lock<br>节点，最终成功创建的那个客户端也即拥有了这把锁。用完删除掉自己创建的 distribute_lock 节点就释放出锁。<br>对于第二类， /distribute_lock 已经预先存在，所有客户端在它下面创建临时顺序编号目录节点，和选 master 一样，编号最小的获得锁，用完删除，依次方便。<br>Zookeeper 队列管理（文件系统、通知机制）<br>两种类型的队列：<br>（1）同步队列，当一个队列的成员都聚齐时，这个队列才可用，否则一直等待所有成员到达。<br>（2）队列按照 FIFO 方式进行入队和出队操作。<br>第一类，在约定目录下创建临时目录节点，监听节点数目是否是我们要求的数目。<br>第二类，和分布式锁服务中的控制时序场景基本原理一致，入列有编号，出列按编号。在特定的目录下创建 PERSISTENT_SEQUENTIAL<br>节点，创建成功时Watcher 通知等待的队列，队列删除序列号最小的节点用以消费。此场景下Zookeeper 的 znode 用于消息存储，znode<br>存储的数据就是消息队列中的消息内容，SEQUENTIAL 序列号就是消息的编号，按序取出即可。由于创建的节点是持久化的，所以不必担心队列消息的丢失问题。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域</summary>
      
    
    
    
    <category term="zookeeper" scheme="https://wuhaocn.github.io/categories/zookeeper/"/>
    
    
    <category term="zookeeper" scheme="https://wuhaocn.github.io/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>MySQL事务详解</title>
    <link href="https://wuhaocn.github.io/2023/11/15/data/mysql/MySQL%E4%BA%8B%E5%8A%A1%E8%AF%A6%E8%A7%A3/"/>
    <id>https://wuhaocn.github.io/2023/11/15/data/mysql/MySQL%E4%BA%8B%E5%8A%A1%E8%AF%A6%E8%A7%A3/</id>
    <published>2023-11-15T03:40:25.006Z</published>
    <updated>2023-11-15T03:40:25.006Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-MySQL事务特性"><a href="#1-MySQL事务特性" class="headerlink" title="1.MySQL事务特性"></a>1.MySQL事务特性</h2><p>数据库的事务（Transaction）是一种机制、一个操作序列，包含了一组数据库操作命令。事务把所有的命令作为一个整体一起向系统提交或撤销操作请求，即这一组数据库命令要么都执行，要么都不执行，因此事务是一个不可分割的工作逻辑单元。<br>在数据库系统上执行并发操作时，事务是作为最小的控制单元来使用的，特别适用于多用户同时操作的数据库系统。例如，航空公司的订票系统、银行、保险公司以及证券交易系统等。<br>事务具有 4 个特性，即原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）和持久性（Durability），这 4 个特性通常简称为 ACID。</p><h3 id="1-1-原子性"><a href="#1-1-原子性" class="headerlink" title="1.1. 原子性"></a>1.1. 原子性</h3><p>事务是一个完整的操作。事务的各元素是不可分的（原子的）。事务中的所有元素必须作为一个整体提交或回滚。如果事务中的任何元素失败，则整个事务将失败。<br>以银行转账事务为例，如果该事务提交了，则这两个账户的数据将会更新。如果由于某种原因，事务在成功更新这两个账户之前终止了，则不会更新这两个账户的余额，并且会撤销对任何账户余额的修改，事务不能部分提交。</p><h3 id="1-2-一致性"><a href="#1-2-一致性" class="headerlink" title="1.2. 一致性"></a>1.2. 一致性</h3><p>当事务完成时，数据必须处于一致状态。也就是说，在事务开始之前，数据库中存储的数据处于一致状态。在正在进行的事务中. 数据可能处于不一致的状态，如数据可能有部分被修改。然而，当事务成功完成时，数据必须再次回到已知的一致状态。通过事务对数据所做的修改不能损坏数据，或者说事务不能使数据存储处于不稳定的状态。<br>以银行转账事务事务为例。在事务开始之前，所有账户余额的总额处于一致状态。在事务进行的过程中，一个账户余额减少了，而另一个账户余额尚未修改。因此，所有账户余额的总额处于不一致状态。事务完成以后，账户余额的总额再次恢复到一致状态。</p><h3 id="1-3-隔离性"><a href="#1-3-隔离性" class="headerlink" title="1.3. 隔离性"></a>1.3. 隔离性</h3><p>对数据进行修改的所有并发事务是彼此隔离的，这表明事务必须是独立的，它不应以任何方式依赖于或影响其他事务。修改数据的事务可以在另一个使用相同数据的事务开始之前访问这些数据，或者在另一个使用相同数据的事务结束之后访问这些数据。<br>另外，当事务修改数据时，如果任何其他进程正在同时使用相同的数据，则直到该事务成功提交之后，对数据的修改才能生效。张三和李四之间的转账与王五和赵二之间的转账，永远是相互独立的。</p><h3 id="1-4-持久性"><a href="#1-4-持久性" class="headerlink" title="1.4. 持久性"></a>1.4. 持久性</h3><p>事务的持久性指不管系统是否发生了故障，事务处理的结果都是永久的。<br>一个事务成功完成之后，它对数据库所作的改变是永久性的，即使系统出现故障也是如此。也就是说，一旦事务被提交，事务对数据所做的任何变动都会被永久地保留在数据库中。<br>事务的 ACID 原则保证了一个事务或者成功提交，或者失败回滚，二者必居其一。因此，它对事务的修改具有可恢复性。即当事务失败时，它对数据的修改都会恢复到该事务执行前的状态。</p><h2 id="2-重要介绍"><a href="#2-重要介绍" class="headerlink" title="2.重要介绍"></a>2.重要介绍</h2><h3 id="2-1-事务隔离级别"><a href="#2-1-事务隔离级别" class="headerlink" title="2.1 事务隔离级别"></a>2.1 事务隔离级别</h3><h2 id="3-事物隔离级别"><a href="#3-事物隔离级别" class="headerlink" title="3.事物隔离级别"></a>3.事物隔离级别</h2><p>上文介绍了 MySQL 事务的四大特性，其中事务的隔离性就是指当多个事务同时运行时，各事务之间相互隔离，不可互相干扰。如果事务没有隔离性，就容易出现脏读、不可重复读和幻读等情况。为了保证并发时操作数据的正确性，数据库都会有事务隔离级别的概念。</p><ul><li> 脏读</li></ul><p>脏读是指一个事务正在访问数据，并且对数据进行了修改，但是这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。</p><ul><li>不可重复读</li></ul><p>不可重复读是指在一个事务内，多次读取同一个数据。在这个事务还没有结束时，另外一个事务也访问了该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。</p><ul><li>幻读</li></ul><p>幻读是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。为了解决以上这些问题，标准 SQL 定义了 4 类事务隔离级别，用来指定事务中的哪些数据改变是可见的，哪些数据改变是不可见的。<br>MySQL 包括的事务隔离级别如下：</p><ul><li>读未提交（READ UNCOMITTED）</li><li>读提交（READ COMMITTED）</li><li>可重复读（REPEATABLE READ）</li><li>串行化（SERIALIZABLE）</li></ul><p>MySQL 事务隔离级别可能产生的问题如下表所示：</p><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>READ UNCOMITTED</td><td>√</td><td>√</td><td>√</td></tr><tr><td>READ COMMITTED</td><td>×</td><td>√</td><td>√</td></tr><tr><td>REPEATABLE READ</td><td>×</td><td>×</td><td>√</td></tr><tr><td>SERIALIZABLE</td><td>×</td><td>×</td><td>×</td></tr></tbody></table><p>MySQL 的事务的隔离级别由低到高分别为 READ UNCOMITTED、READ COMMITTED、REPEATABLE READ、SERIALIZABLE。低级别的隔离级别可以支持更高的并发处理，同时占用的系统资源更少。</p><p>下面根据实例来一一阐述它们的概念和联系。</p><h3 id="3-1-读未提交（READ-UNCOMITTED，RU）"><a href="#3-1-读未提交（READ-UNCOMITTED，RU）" class="headerlink" title="3.1. 读未提交（READ UNCOMITTED，RU）"></a>3.1. 读未提交（READ UNCOMITTED，RU）</h3><p>顾名思义，读未提交就是可以读到未提交的内容。<br>如果一个事务读取到了另一个未提交事务修改过的数据，那么这种隔离级别就称之为读未提交。<br>在该隔离级别下，所有事务都可以看到其它未提交事务的执行结果。因为它的性能与其他隔离级别相比没有高多少，所以一般情况下，该隔离级别在实际应用中很少使用。</p><ul><li><p>例 1 主要演示了在读未提交隔离级别中产生的脏读现象。</p><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h4></li><li><ol><li>先在 test 数据库中创建 testnum 数据表，并插入数据。SQL 语句和执行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE testnum( num INT(4)); </span><br><span class="line">Query OK, 0 rows affected (0.57 sec) </span><br><span class="line">mysql&gt; INSERT INTO test.testnum (num) VALUES(1),(2),(3),(4),(5); </span><br><span class="line">Query OK, 5 rows affected (0.09 sec)</span><br></pre></td></tr></table></figure></li></ol></li><li><ol start="2"><li>下面的语句需要在两个命令行窗口中执行。为了方便理解，我们分别称之为 A 窗口和 B 窗口。<br>在 A 窗口中修改事务隔离级别，因为 A 窗口和 B 窗口的事务隔离级别需要保持一致，</li></ol></li></ul><p>所以我们使用 SET GLOBAL TRANSACTION 修改全局变量。SQL 语句如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; </span><br><span class="line">Query OK, 0 rows affected (0.04 sec) flush privileges; </span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure><p> 查询事务隔离级别，SQL 语句和运行结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%tx_isolation%&#x27;\G *************************** 1. row *************************** Variable_name: tx_isolation         Value: READ-UNCOMMITTED 1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><p>结果显示，现在 MySQL 的事务隔离级别为 READ-UNCOMMITTED。</p><ol start="3"><li><p>在 A 窗口中开启一个事务，并查询 testnum 数据表，SQL 语句和运行结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) </span><br><span class="line">mysql&gt; SELECT * FROM testnum; +------+ | num  | +------+ |    1 | |    2 | |    3 | |    4 | |    5 | +------+ 5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>打开 B 窗口，查看当前 MySQL 的事务隔离级别，SQL 语句如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%tx_isolation%&#x27;\G *************************** 1. row *************************** Variable_name: tx_isolation         Value: READ-UNCOMMITTED 1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure></li></ol><p>确定事务隔离级别是 READ-UNCOMMITTED 后，开启一个事务，并使用 UPDATE 语句更新 testnum 数据表，SQL 语句和运行结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) mysql&gt; UPDATE test.testnum SET num=num*2 WHERE num=2; Query OK, 1 row affected (0.02 sec) Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure><ol start="5"><li>现在返回 A 窗口，再次查询 testnum 数据表，SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM testnum; +------+ | num  | +------+ |    1 | |    4 | |    3 | |    4 | |    5 | +------+ 5 rows in set (0.02 sec)</span><br></pre></td></tr></table></figure>由结果可以看出，A 窗口中的事务读取到了更新后的数据。</li><li>下面在 B 窗口中回滚事务，SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ROLLBACK; Query OK, 0 rows affected (0.09 sec)</span><br></pre></td></tr></table></figure></li><li>在 A 窗口中查询 testnum 数据表，SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM testnum; +------+ | num  | +------+ |    1 | |    2 | |    3 | |    4 | |    5 | +------+ 5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>当 MySQL 的事务隔离级别为 READ UNCOMITTED 时，首先分别在 A 窗口和 B 窗口中开启事务，在 B 窗口中的事务更新但未提交之前， A 窗口中的事务就已经读取到了更新后的数据。但由于 B 窗口中的事务回滚了，所以 A 事务出现了脏读现象。</li></ol><p>使用读提交隔离级别可以解决实例中产生的脏读问题。</p><h3 id="3-2-读提交（READ-COMMITTED，RC）"><a href="#3-2-读提交（READ-COMMITTED，RC）" class="headerlink" title="3.2. 读提交（READ COMMITTED，RC）"></a>3.2. 读提交（READ COMMITTED，RC）</h3><p>顾名思义，读提交就是只能读到已经提交了的内容。</p><p>如果一个事务只能读取到另一个已提交事务修改过的数据，并且其它事务每对该数据进行一次修改并提交后，该事务都能查询得到最新值，那么这种隔离级别就称之为读提交。</p><p>该隔离级别满足了隔离的简单定义：一个事务从开始到提交前所做的任何改变都是不可见的，事务只能读取到已经提交的事务所做的改变。</p><p>这是大多数数据库系统的默认事务隔离级别（例如 Oracle、SQL Server），但不是 MySQL 默认的。</p><p>例 2 演示了在读提交隔离级别中产生的不可重复读问题。</p><h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h4><ol><li>使用 SET 语句将 MySQL 事务隔离级别修改为 READ COMMITTED，并查看。SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL TRANSACTION ISOLATION LEVEL READ COMMITTED; Query OK, 0 rows affected (0.00 sec) mysql&gt; show variables like &#x27;%tx_isolation%&#x27;\G *************************** 1. row *************************** Variable_name: tx_isolation         Value: READ-COMMITTED 1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure></li><li>确定当前事务隔离级别为 READ COMMITTED 后，开启一个事务，SQL 语句和运行结果如下：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN; Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><ol start="3"><li>在 B 窗口中开启事务，并使用 UPDATE 语句更新 testnum 数据表，SQL 语句和运行结果如下：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) mysql&gt;  UPDATE test.testnum SET num=num*2 WHERE num=2; Query OK, 1 row affected (0.07 sec) Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure><ol start="4"><li>在 A 窗口中查询 testnum 数据表，SQL 语句和运行结果如下：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * from test.testnum; +------+ | num  | +------+ |    1 | |    2 | |    3 | |    4 | |    5 | +------+ 5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ol start="5"><li>提交 B 窗口中的事务，SQL 语句和运行结果如下：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; COMMIT; Query OK, 0 rows affected (0.07 sec)</span><br></pre></td></tr></table></figure><ol start="6"><li>在 A 窗口中查询 testnum 数据表，SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * from test.testnum; +------+ | num  | +------+ |    1 | |    4 | |    3 | |    4 | |    5 | +------+ 5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>当 MySQL 的事务隔离级别为 READ COMMITTED 时，首先分别在 A 窗口和 B 窗口中开启事务，在 B 窗口中的事务更新并提交后，A 窗口中的事务读取到了更新后的数据。在该过程中，A 窗口中的事务必须要等待 B 窗口中的事务提交后才能读取到更新后的数据，这样就解决了脏读问题。而处于 A 窗口中的事务出现了不同的查询结果，即不可重复读现象。</li></ol><p>使用可重复读隔离级别可以解决实例中产生的不可重复读问题。</p><h3 id="3-3-可重复读（REPEATABLE-READ，RR）"><a href="#3-3-可重复读（REPEATABLE-READ，RR）" class="headerlink" title="3.3. 可重复读（REPEATABLE READ，RR）"></a>3.3. 可重复读（REPEATABLE READ，RR）</h3><p>顾名思义，可重复读是专门针对不可重复读这种情况而制定的隔离级别，可以有效的避免不可重复读。</p><p>在一些场景中，一个事务只能读取到另一个已提交事务修改过的数据，但是第一次读过某条记录后，即使其它事务修改了该记录的值并且提交，之后该事务再读该条记录时，读到的仍是第一次读到的值，而不是每次都读到不同的数据。那么这种隔离级别就称之为可重复读。</p><p>可重复读是 MySQL 的默认事务隔离级别，它能确保同一事务的多个实例在并发读取数据时，会看到同样的数据行。在该隔离级别下，如果有事务正在读取数据，就不允许有其它事务进行修改操作，这样就解决了可重复读问题。</p><p>例 3 演示了在可重复读隔离级别中产生的幻读问题。</p><h4 id="示例-3"><a href="#示例-3" class="headerlink" title="示例 3"></a>示例 3</h4><ol><li>在 test 数据库中创建 testuser 数据表，SQL 语句和执行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE testuser(     -&gt; id INT (4) PRIMARY KEY,     -&gt; name VARCHAR(20)); Query OK, 0 rows affected (0.29 sec)</span><br></pre></td></tr></table></figure></li><li>使用 SET 语句修改事务隔离级别，SQL 语句如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ; Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></li><li>在 A 窗口中开启事务，并查询 testuser 数据表，SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) mysql&gt; SELECT * FROM test.testuser where id=1; Empty set (0.04 sec)</span><br></pre></td></tr></table></figure></li><li>在 B 窗口中开启一个事务，并向 testuser 表中插入一条数据，SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) mysql&gt;  INSERT INTO test.testuser VALUES(1,&#x27;zhangsan&#x27;); Query OK, 1 row affected (0.04 sec) mysql&gt; COMMIT; Query OK, 0 rows affected (0.06 sec)</span><br></pre></td></tr></table></figure></li><li>现在返回 A 窗口，向 testnum 数据表中插入数据，SQL 语句和运行结果如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO test.testuser VALUES(1,&#x27;lisi&#x27;); ERROR 1062 (23000): Duplicate entry &#x27;1&#x27; for key &#x27;PRIMARY&#x27; mysql&gt;  SELECT * FROM test.testuser where id=1; Empty set (0.00 sec)</span><br></pre></td></tr></table></figure></li></ol><p>使用串行化隔离级别可以解决实例中产生的幻读问题。</p><h2 id="3-4-串行化（SERIALIZABLE）"><a href="#3-4-串行化（SERIALIZABLE）" class="headerlink" title="3.4. 串行化（SERIALIZABLE）"></a>3.4. 串行化（SERIALIZABLE）</h2><p>如果一个事务先根据某些条件查询出一些记录，之后另一个事务又向表中插入了符合这些条件的记录，原先的事务再次按照该条件查询时，能把另一个事务插入的记录也读出来。那么这种隔离级别就称之为串行化。</p><p>SERIALIZABLE 是最高的事务隔离级别，主要通过强制事务排序来解决幻读问题。简单来说，就是在每个读取的数据行上加上共享锁实现，这样就避免了脏读、不可重复读和幻读等问题。但是该事务隔离级别执行效率低下，且性能开销也最大，所以一般情况下不推荐使用。</p><p><a href="https://zhuanlan.zhihu.com/p/506585990">https://zhuanlan.zhihu.com/p/506585990</a></p><p><a href="https://blog.51cto.com/u_15714244/5461724">https://blog.51cto.com/u_15714244/5461724</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-MySQL事务特性&quot;&gt;&lt;a href=&quot;#1-MySQL事务特性&quot; class=&quot;headerlink&quot; title=&quot;1.MySQL事务特性&quot;&gt;&lt;/a&gt;1.MySQL事务特性&lt;/h2&gt;&lt;p&gt;数据库的事务（Transaction）是一种机制、一个操作序列，包含</summary>
      
    
    
    
    <category term="MySQL" scheme="https://wuhaocn.github.io/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="https://wuhaocn.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL日志分析</title>
    <link href="https://wuhaocn.github.io/2023/11/15/data/mysql/MySQL%E6%97%A5%E5%BF%97/"/>
    <id>https://wuhaocn.github.io/2023/11/15/data/mysql/MySQL%E6%97%A5%E5%BF%97/</id>
    <published>2023-11-15T03:40:25.006Z</published>
    <updated>2023-11-15T03:40:25.006Z</updated>
    
    <content type="html"><![CDATA[<h2 id="慢日志"><a href="#慢日志" class="headerlink" title="慢日志"></a>慢日志</h2><h2 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h2><p>/usr/local/mysql/bin/mysqlbinlog –no-defaults –base64-output=decode-rows –database=testdb -v  mysql-bin.007849 | grep -10 DELETE | grep -3 12345678</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;慢日志&quot;&gt;&lt;a href=&quot;#慢日志&quot; class=&quot;headerlink&quot; title=&quot;慢日志&quot;&gt;&lt;/a&gt;慢日志&lt;/h2&gt;&lt;h2 id=&quot;binlog&quot;&gt;&lt;a href=&quot;#binlog&quot; class=&quot;headerlink&quot; title=&quot;binlog&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="MySQL" scheme="https://wuhaocn.github.io/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="https://wuhaocn.github.io/tags/MySQL/"/>
    
  </entry>
  
</feed>
